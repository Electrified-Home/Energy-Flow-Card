<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Energy Flow Card Simulator</title>
  <style>
    :root {
      --card-background-color: #1c1c1c;
      --primary-background-color: #111111;
      --divider-color: #333333;
      --primary-text-color: #e1e1e1;
      --secondary-text-color: #9b9b9b;
      --success-color: #4caf50;
      --error-color: #f44336;
      --warning-color: #ff9800;
    }

    body {
      font-family: 'Roboto', 'Noto', sans-serif;
      margin: 0;
      padding: 20px;
      background: #111111;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 20px;
      align-items: start;
    }

    .controls {
      background: var(--card-background-color);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      max-height: calc(100vh - 40px);
      overflow-y: auto;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }

    .control-item {
      display: flex;
      flex-direction: column;
    }

    .control-item label {
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--primary-text-color);
    }

    .control-item input {
      padding: 8px;
      border: 1px solid var(--divider-color);
      border-radius: 4px;
      font-size: 14px;
      background: var(--primary-background-color);
      color: var(--primary-text-color);
    }

    .control-item small {
      color: var(--secondary-text-color);
      font-size: 12px;
      margin-top: 4px;
    }

    .presets {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .preset-btn {
      padding: 10px 16px;
      background: var(--primary-background-color);
      border: 1px solid var(--divider-color);
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      color: var(--primary-text-color);
      text-align: left;
      width: 100%;
    }

    .preset-btn:hover {
      background: var(--divider-color);
    }

    ha-card {
      display: block;
      background: var(--card-background-color);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    h1 {
      margin: 0 0 20px 0;
      color: var(--primary-text-color);
      grid-column: 1 / -1;
    }

    h3 {
      margin: 0 0 12px 0;
      color: var(--primary-text-color);
    }

    .card-wrapper {
      position: relative;
      width: 800px;
      min-width: 400px;
      max-width: 100%;
      resize: both;
      overflow: auto;
      border: 2px dashed var(--divider-color);
      border-radius: 8px;
      padding: 10px;
    }

    .card-wrapper::after {
      content: '‚á≤';
      position: absolute;
      bottom: 0;
      right: 0;
      font-size: 20px;
      color: var(--secondary-text-color);
      pointer-events: none;
      padding: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Energy Flow Card Simulator</h1>
    
    <div class="controls">
      <h3>Controls</h3>
      <div class="control-group">
        <div class="control-item">
          <label for="grid-input">Grid (W)</label>
          <input type="number" id="grid-input" value="0" step="100">
          <small>Positive = Import, Negative = Export</small>
        </div>
        <div class="control-item">
          <label for="load-input">Load (W)</label>
          <input type="number" id="load-input" value="2000" step="100">
        </div>
        <div class="control-item">
          <label for="production-input">Production (W)</label>
          <input type="number" id="production-input" value="3000" step="100">
        </div>
        <div class="control-item">
          <label for="battery-input">Battery (W)</label>
          <input type="number" id="battery-input" value="-500" step="100">
          <small>Positive = Discharge, Negative = Charge</small>
        </div>
      </div>
      
      <div class="control-group">
        <div class="control-item">
          <label for="view-mode-select">View Mode</label>
          <select id="view-mode-select" style="padding: 8px; border: 1px solid var(--divider-color); border-radius: 4px; background: var(--primary-background-color); color: var(--primary-text-color); font-size: 14px;">
            <option value="default">Default (Gauges)</option>
            <option value="compact">Compact Bar</option>
            <option value="compact-battery">Compact with Battery</option>
          </select>
        </div>
        <div class="control-item">
          <label for="battery-soc-input">Battery SOC (%)</label>
          <input type="number" id="battery-soc-input" value="85" step="0.1" min="0" max="100">
          <small>For compact-battery view</small>
        </div>
        <div class="control-item">
          <label>
            <input type="checkbox" id="invert-battery-data">
            Invert Battery Data
          </label>
          <small>Inverts value interpretation (affects flow calculation)</small>
        </div>
        <div class="control-item">
          <label>
            <input type="checkbox" id="invert-battery-view">
            Invert Battery View
          </label>
          <small>Inverts displayed value only (visual only)</small>
        </div>
      </div>

      <h3>Scenarios</h3>
      <div class="presets">
        <button class="preset-btn" onclick="setScenario('sunny')">‚òÄÔ∏è Sunny Day</button>
        <button class="preset-btn" onclick="setScenario('night')">üåô Night</button>
        <button class="preset-btn" onclick="setScenario('cloudy')">‚õÖ Cloudy</button>
        <button class="preset-btn" onclick="setScenario('export')">‚ö° Heavy Export</button>
        <button class="preset-btn" onclick="setScenario('import')">üîå Heavy Import</button>
        <button class="preset-btn" onclick="setScenario('battery-charge')">üîã Battery Charging</button>
        <button class="preset-btn" onclick="setScenario('battery-discharge')">üîã Battery Discharging</button>
      </div>

      <h3>Anomalous Conditions</h3>
      <div class="presets">
        <button class="preset-btn" onclick="setScenario('overflow')">‚ö†Ô∏è Production Overflow</button>
        <button class="preset-btn" onclick="setScenario('underflow')">‚ö†Ô∏è Load Underflow</button>
        <button class="preset-btn" onclick="setScenario('tiny-battery')">üîã Tiny Battery (5W)</button>
        <button class="preset-btn" onclick="setScenario('imbalanced')">‚öñÔ∏è Sensor Imbalance</button>
        <button class="preset-btn" onclick="setScenario('discrepancy')">üìä 560W Battery ‚Üí 590W Load</button>
        <button class="preset-btn" onclick="setScenario('battery-only-load')">üîã Battery 100% ‚Üí Load</button>
        <button class="preset-btn" onclick="setScenario('grid-zero-surplus')">üîå Grid=0 + Surplus</button>
        <button class="preset-btn" onclick="setScenario('grid-zero-deficit')">üîå Grid=0 + Deficit</button>
        <button class="preset-btn" onclick="setScenario('all-zero')">üö´ All Zero</button>
        <button class="preset-btn" onclick="setScenario('micro-export')">‚¨áÔ∏è Micro Export (-5W)</button>
        <button class="preset-btn" onclick="setScenario('threshold-test')">üéØ Threshold Test (10W)</button>
        <button class="preset-btn" onclick="setScenario('battery-split')">üîã‚ö° Battery ‚Üí Load + Grid</button>
      </div>
    </div>

    <div class="card-wrapper">
      <div id="card-container"></div>
    </div>
  </div>

  <script src="./dist/energy-flow-card.js?v=sim"></script>
  <script>
    // Mock ha-svg-icon web component (inner component with actual SVG)
    class MockHaSvgIcon extends HTMLElement {
      constructor() {
        super();
        this.attachShadow({ mode: 'open' });
      }

      static get observedAttributes() {
        return ['path'];
      }

      connectedCallback() {
        this.render();
      }

      attributeChangedCallback() {
        this.render();
      }

      render() {
        const pathData = this.getAttribute('path') || 'M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2Z';

        this.shadowRoot.innerHTML = `
          <svg viewBox="0 0 24 24" style="display: block; width: 100%; height: 100%;">
            <path d="${pathData}" fill="currentColor"></path>
          </svg>
        `;
      }
    }

    // Mock ha-icon web component (mimics Home Assistant's nested structure)
    class MockHaIcon extends HTMLElement {
      constructor() {
        super();
        this.attachShadow({ mode: 'open' });
      }

      static get observedAttributes() {
        return ['icon'];
      }

      connectedCallback() {
        this.render();
      }

      attributeChangedCallback() {
        this.render();
      }

      render() {
        const icon = this.getAttribute('icon');
        const iconPaths = {
          'mdi:solar-power': 'M11.45,2V5.55L15,3.77L11.45,2M10.45,8L8,10.46L11,11.95L10.45,8M2,11.45L3.77,15L5.55,11.45H2M10,2H2V10A8,8 0 0,0 10,18A8,8 0 0,0 18,10C18,5.37 14.63,2 10,2Z',
          'mdi:battery': 'M16.67,4H15V2H9V4H7.33A1.33,1.33 0 0,0 6,5.33V20.67C6,21.4 6.6,22 7.33,22H16.67A1.33,1.33 0 0,0 18,20.67V5.33C18,4.6 17.4,4 16.67,4Z',
          'mdi:transmission-tower': 'M8.28,5.45L6.5,4.55L7.76,2.16L9.54,3.06M11,1H13V4.06L11,5.06M14.5,2.16L15.76,4.55L14,5.45L12.7,3.06M7.5,7L9,8.61L11,7.37V10H13V7.37L15,8.61L16.5,7L14.13,4.59L12,6.15L9.87,4.59M7.46,8L5.73,9.73L7.5,11.5L9.23,9.77M15,11.5L16.77,9.73L15.04,8L13.31,9.73M11,11V13H13V11M7,14V15H9.43L9,16.87L10.24,17.4L10.67,15.6L12,16.4L13.33,15.6L13.76,17.4L15,16.87L14.57,15H17V14H14L13.33,11.22L12,12.4L10.67,11.22L10,14M5,15V17H7L6.5,19H8L8.5,17H10L10.5,19H12L11.5,17H13L13.5,19H15L14.5,17H16L16.5,19H18L17.5,17H19V15H17L16,10L14.5,11.5L15.37,15H8.63L9.5,11.5L8,10L7,15M8,21V22H9V21M11,21V22H13V21M15,21V22H16V21',
          'mdi:home': 'M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z',
          'mdi:home-lightning-bolt': 'M12 3L2 12H5V20H19V12H22L12 3M12 18C10.9 18 10 17.11 10 16H9C9 17.66 10.34 19 12 19C13.66 19 15 17.66 15 16H14C14 17.11 13.11 18 12 18M11 11V13H10L12 16L14 13H13V11H11Z',
          'mdi:solar-power-variant': 'M11.45,2V5.55L15,3.77L11.45,2M10.45,8L8,10.46L11,11.95L10.45,8M2,11.45L3.77,15L5.55,11.45H2M10,2H2V10A8,8 0 0,0 10,18A8,8 0 0,0 18,10C18,5.37 14.63,2 10,2Z',
          'mdi:home-battery': 'M12,3L2,12H5V20H19V12H22M11,18V14H8L13,9V13H16'
        };

        const pathData = iconPaths[icon] || 'M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2Z';

        // Mimic Home Assistant's nested structure: ha-icon ‚Üí ha-svg-icon
        this.shadowRoot.innerHTML = `<!----><ha-svg-icon path="${pathData}"></ha-svg-icon>`;
      }
    }

    // Register mock components
    if (!customElements.get('ha-svg-icon')) {
      customElements.define('ha-svg-icon', MockHaSvgIcon);
    }
    if (!customElements.get('ha-icon')) {
      customElements.define('ha-icon', MockHaIcon);
    }

    // Mock Home Assistant environment
    class MockHass {
      constructor() {
        this.states = {
          'sensor.grid': { state: '0', attributes: { unit_of_measurement: 'W' } },
          'sensor.load': { state: '2000', attributes: { unit_of_measurement: 'W' } },
          'sensor.production': { state: '3000', attributes: { unit_of_measurement: 'W' } },
          'sensor.battery': { state: '-500', attributes: { unit_of_measurement: 'W' } },
          'sensor.battery_soc': { state: '85', attributes: { unit_of_measurement: '%' } }
        };
      }

      updateState(entity, value) {
        if (this.states[entity]) {
          this.states[entity].state = String(value);
        }
      }
    }

    const hass = new MockHass();
    const cardContainer = document.getElementById('card-container');
    
    // Create card instance
    const card = document.createElement('energy-flow-card');
    card.setConfig({
      mode: 'default',
      load: {
        entity: 'sensor.load'
      },
      grid: {
        entity: 'sensor.grid'
      },
      production: {
        entity: 'sensor.production'
      },
      battery: {
        entity: 'sensor.battery',
        soc_entity: 'sensor.battery_soc',
        invert: {
          data: false,
          view: false
        }
      }
    });
    card.hass = hass;
    cardContainer.appendChild(card);

    // Update function
    function updateCard() {
      const grid = parseFloat(document.getElementById('grid-input').value) || 0;
      const load = parseFloat(document.getElementById('load-input').value) || 0;
      const production = parseFloat(document.getElementById('production-input').value) || 0;
      const battery = parseFloat(document.getElementById('battery-input').value) || 0;
      const batterySoc = parseFloat(document.getElementById('battery-soc-input').value) || 0;
      const invertData = document.getElementById('invert-battery-data').checked;
      const invertView = document.getElementById('invert-battery-view').checked;
      const viewMode = document.getElementById('view-mode-select').value;

      hass.updateState('sensor.grid', grid);
      hass.updateState('sensor.load', load);
      hass.updateState('sensor.production', production);
      hass.updateState('sensor.battery', battery);
      hass.updateState('sensor.battery_soc', batterySoc);

      // Update config with invert options
      card.setConfig({
        mode: viewMode,
        load: {
          entity: 'sensor.load'
        },
        grid: {
          entity: 'sensor.grid'
        },
        production: {
          entity: 'sensor.production'
        },
        battery: {
          entity: 'sensor.battery',
          soc_entity: 'sensor.battery_soc',
          invert: {
            data: invertData,
            view: invertView
          }
        }
      });
      
      card.hass = { ...hass };
    }

    // Attach event listeners
    document.getElementById('grid-input').addEventListener('input', updateCard);
    document.getElementById('load-input').addEventListener('input', updateCard);
    document.getElementById('production-input').addEventListener('input', updateCard);
    document.getElementById('battery-input').addEventListener('input', updateCard);
    document.getElementById('battery-soc-input').addEventListener('input', updateCard);
    document.getElementById('invert-battery-data').addEventListener('change', updateCard);
    document.getElementById('invert-battery-view').addEventListener('change', updateCard);
    document.getElementById('view-mode-select').addEventListener('change', updateCard);

    // Scenario presets with tweening
    let tweenInterval = null;
    
    function setScenario(scenario) {
      const scenarios = {
        // Normal scenarios
        'sunny': { grid: -1500, load: 2000, production: 4000, battery: -500 },
        'night': { grid: 1500, load: 1000, production: 0, battery: 500 },
        'cloudy': { grid: 500, load: 2000, production: 1000, battery: 500 },
        'export': { grid: -3000, load: 1000, production: 5000, battery: -1000 },
        'import': { grid: 3000, load: 4000, production: 500, battery: 500 },
        'battery-charge': { grid: 0, load: 2000, production: 3500, battery: -1500 },
        'battery-discharge': { grid: 0, load: 3000, production: 1000, battery: 2000 },
        'battery-split': { grid: -1000, load: 2000, production: 1000, battery: 2000 },
        
        // Anomalous conditions
        'overflow': { grid: 0, load: 1000, production: 5000, battery: 0 },
        'underflow': { grid: 0, load: 3000, production: 500, battery: 0 },
        'tiny-battery': { grid: 2000, load: 3000, production: 1000, battery: 5 },
        'imbalanced': { grid: -50, load: 1800, production: 2200, battery: -300 },
        'discrepancy': { grid: 0, load: 590, production: 0, battery: 560 },  // Battery 560W but load 590W
        'battery-only-load': { grid: 0, load: 1500, production: 0, battery: 1500 }, // 100% battery to load
        'grid-zero-surplus': { grid: 0, load: 800, production: 3000, battery: -500 },
        'grid-zero-deficit': { grid: 0, load: 4000, production: 1200, battery: 300 },
        'all-zero': { grid: 0, load: 0, production: 0, battery: 0 },
        'micro-export': { grid: -5, load: 1000, production: 1005, battery: 0 },
        'threshold-test': { grid: 10, load: 1010, production: 1000, battery: 0 }
      };

      if (scenarios[scenario]) {
        // Clear any existing tween
        if (tweenInterval) {
          clearInterval(tweenInterval);
        }
        
        const target = scenarios[scenario];
        const start = {
          grid: parseFloat(document.getElementById('grid-input').value) || 0,
          load: parseFloat(document.getElementById('load-input').value) || 0,
          production: parseFloat(document.getElementById('production-input').value) || 0,
          battery: parseFloat(document.getElementById('battery-input').value) || 0
        };
        
        const duration = 1500; // 1.5 seconds
        const fps = 60;
        const frames = (duration / 1000) * fps;
        let currentFrame = 0;
        
        tweenInterval = setInterval(() => {
          currentFrame++;
          const progress = currentFrame / frames;
          
          // Ease-in-out cubic easing
          const eased = progress < 0.5
            ? 4 * progress * progress * progress
            : 1 - Math.pow(-2 * progress + 2, 3) / 2;
          
          // Interpolate values
          const grid = start.grid + (target.grid - start.grid) * eased;
          const load = start.load + (target.load - start.load) * eased;
          const production = start.production + (target.production - start.production) * eased;
          const battery = start.battery + (target.battery - start.battery) * eased;
          
          document.getElementById('grid-input').value = Math.round(grid);
          document.getElementById('load-input').value = Math.round(load);
          document.getElementById('production-input').value = Math.round(production);
          document.getElementById('battery-input').value = Math.round(battery);
          
          updateCard();
          
          if (currentFrame >= frames) {
            clearInterval(tweenInterval);
            tweenInterval = null;
          }
        }, 1000 / fps);
      }
    }

    // Initial render
    updateCard();
  </script>
</body>
</html>
