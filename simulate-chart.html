<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Energy Flow Card - Chart View Simulation</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      background: #1a1a1a;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: white;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      margin-bottom: 20px;
      font-size: 24px;
      font-weight: 500;
    }
    
    energy-flow-card {
      display: block;
      margin-bottom: 20px;
    }
    
    .info {
      background: #2a2a2a;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .info h2 {
      margin-top: 0;
      font-size: 16px;
      color: #4caf50;
    }
    
    .info code {
      background: #1a1a1a;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Energy Flow Card - Chart View (Simulated Data)</h1>
    
    <energy-flow-card></energy-flow-card>
    
    <div class="info">
      <h2>üìä Simulated 12-Hour Pattern</h2>
      <p><strong>Solar Production:</strong> Bell curve peaking at noon (~5000W)</p>
      <p><strong>Battery:</strong> Charges during solar surplus, discharges evening/night</p>
      <p><strong>Grid:</strong> Import during low production, export during solar surplus</p>
      <p><strong>Load:</strong> Baseline ~1500W with peaks morning/evening</p>
      
      <h2>üé® Color Scheme</h2>
      <p><code style="color: #256028;">‚óè Green (#256028)</code> - Solar Production</p>
      <p><code style="color: #104b79;">‚óè Blue (#104b79)</code> - Battery (charge/discharge)</p>
      <p><code style="color: #7a211b;">‚óè Red (#7a211b)</code> - Grid Import</p>
      <p><code style="color: #7a6b1b;">‚óè Yellow (#7a6b1b)</code> - Grid Export</p>
      <p><code style="color: #808080;">‚óè Gray (#808080)</code> - Load</p>
    </div>
  </div>

  <script type="module">
    // Mock ha-icon element for icon extraction
    class MockHaIcon extends HTMLElement {
      constructor() {
        super();
        this.attachShadow({ mode: 'open' });
      }

      connectedCallback() {
        const icon = this.getAttribute('icon') || 'mdi:help';
        
        // Simple icon path mapping
        const iconPaths = {
          'mdi:solar-power': 'M4 2h16a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-7v2h2v2H9v-2h2v-2H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2m0 2v10h16V4H4m8.5 12a4.5 4.5 0 0 0 4.5-4.5c0-1.82-1.09-3.39-2.66-4.12C14.61 6.46 15 5.5 15 4.5c0-1.93-1.57-3.5-3.5-3.5S8 2.57 8 4.5c0 1 .39 1.96 1.16 2.88C7.59 8.11 6.5 9.68 6.5 11.5a4.5 4.5 0 0 0 4.5 4.5z',
          'mdi:battery': 'M16.67 4H15V2h-2v2H9V2H7v2H5.33C4.6 4 4 4.6 4 5.33v15.33C4 21.4 4.6 22 5.33 22h11.33c.74 0 1.34-.6 1.34-1.33V5.33C18 4.6 17.4 4 16.67 4M7 20v-7.5H5.5v-1H7V4h8v7.5h1.5v1H15V20H7z',
          'mdi:transmission-tower': 'M8 18h2v2H8zm-2-2h2v2H6zm4 0h2v2h-2zm4 0h2v2h-2zm2 2h2v2h-2zm-3-8.95L7 10v2l5-1zm1 .9L17 10v2l-4-1zM12 2l-4 4h2v2L7 9v2l5-1v7h2V10l5 1V9l-3-1V6h2l-4-4z',
          'mdi:home-lightning-bolt': 'M12 3L2 12h3v8h14v-8h3L12 3m0 4.7c2.1 0 3.8 1.7 3.8 3.8c0 2-3.8 6.5-3.8 6.5s-3.8-4.5-3.8-6.5c0-2.1 1.7-3.8 3.8-3.8m0 2.3c-.8 0-1.5.7-1.5 1.5S11.2 13 12 13s1.5-.7 1.5-1.5S12.8 10 12 10z',
          'mdi:home': 'M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z'
        };

        const pathData = iconPaths[icon] || 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z';

        this.shadowRoot.innerHTML = `
          <svg viewBox="0 0 24 24" style="width: 100%; height: 100%;">
            <path d="${pathData}" fill="currentColor"/>
          </svg>
        `;
      }
    }

    customElements.define('ha-icon', MockHaIcon);

    // Mock Home Assistant object with simulated history data
    class MockHass {
      constructor() {
        this.states = {
          'sensor.solar_production': { state: '2500', attributes: { friendly_name: 'Solar Production' } },
          'sensor.grid_power': { state: '500', attributes: { friendly_name: 'Grid Power' } },
          'sensor.house_load': { state: '1800', attributes: { friendly_name: 'House Load' } },
          'sensor.battery_power': { state: '-200', attributes: { friendly_name: 'Battery Power' } },
          'sensor.battery_soc': { state: '75', attributes: { friendly_name: 'Battery SOC' } }
        };
      }

      // Generate realistic 24-hour history data
      async callApi(method, url) {
        console.log('Mock API call:', method, url);
        
        // Parse entity_id from URL
        const entityMatch = url.match(/filter_entity_id=([^&]+)/);
        if (!entityMatch) return [[]];
        
        const entityId = entityMatch[1];
        
        // Generate 24 hours of data points (every 15 minutes = 96 points)
        const points = [];
        const now = new Date();
        const hoursToShow = 24;
        const pointsPerHour = 4;
        const totalPoints = hoursToShow * pointsPerHour;
        
        for (let i = 0; i < totalPoints; i++) {
          const timestamp = new Date(now.getTime() - (totalPoints - i) * 15 * 60 * 1000);
          const hour = timestamp.getHours() + timestamp.getMinutes() / 60;
          
          let value = 0;
          
          if (entityId.includes('solar_production')) {
            // Bell curve for solar: 0 at night, peak at noon
            if (hour >= 6 && hour <= 18) {
              const solarHour = hour - 12; // Center at noon
              value = Math.max(0, 5000 * Math.exp(-Math.pow(solarHour / 4, 2)));
            }
          } else if (entityId.includes('grid_power')) {
            // Grid = Load - (Solar + Battery discharge)
            const solar = hour >= 6 && hour <= 18 
              ? Math.max(0, 5000 * Math.exp(-Math.pow((hour - 12) / 4, 2)))
              : 0;
            const load = 1500 + 
              (hour >= 6 && hour <= 9 ? 500 : 0) + // Morning peak
              (hour >= 18 && hour <= 22 ? 800 : 0); // Evening peak
            const battery = this._getBatteryPower(hour, solar, load);
            value = load - solar - battery;
          } else if (entityId.includes('house_load')) {
            // Base load + morning/evening peaks
            value = 1500 + 
              (hour >= 6 && hour <= 9 ? 500 : 0) + // Morning peak
              (hour >= 18 && hour <= 22 ? 800 : 0); // Evening peak
          } else if (entityId.includes('battery_power')) {
            const solar = hour >= 6 && hour <= 18 
              ? Math.max(0, 5000 * Math.exp(-Math.pow((hour - 12) / 4, 2)))
              : 0;
            const load = 1500 + 
              (hour >= 6 && hour <= 9 ? 500 : 0) +
              (hour >= 18 && hour <= 22 ? 800 : 0);
            value = this._getBatteryPower(hour, solar, load);
          }
          
          points.push({
            state: value.toFixed(1),
            last_changed: timestamp.toISOString()
          });
        }
        
        return [points];
      }

      _getBatteryPower(hour, solar, load) {
        // Battery charges when solar > load (negative = charging)
        // Battery discharges when solar < load (positive = discharging)
        const surplus = solar - load;
        
        if (surplus > 500) {
          // Charge battery during surplus (cap at 3000W)
          return -Math.min(3000, surplus * 0.8);
        } else if (surplus < -500 && hour >= 18 && hour <= 23) {
          // Discharge battery during evening deficit
          return Math.min(2000, -surplus * 0.6);
        }
        return 0;
      }

      callService(domain, service, data, target) {
        console.log('Mock service call:', domain, service, data, target);
      }
    }

    // Wait for custom element to be defined
    customElements.whenDefined('energy-flow-card').then(() => {
      const card = document.querySelector('energy-flow-card');
      
      // Set mock hass
      card.hass = new MockHass();
      
      // Configure card for chart view
      card.setConfig({
        mode: 'chart',
        load: {
          entity: 'sensor.house_load'
        },
        grid: {
          entity: 'sensor.grid_power'
        },
        production: {
          entity: 'sensor.solar_production'
        },
        battery: {
          entity: 'sensor.battery_power',
          soc_entity: 'sensor.battery_soc'
        }
      });
    });
  </script>

  <script type="module" src="./dist/energy-flow-card.js"></script>
</body>
</html>
