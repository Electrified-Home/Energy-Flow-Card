{"version":3,"file":"energy-flow-card.js","sources":["src/flow-calculator.ts","src/utils/helpers.ts","src/renderers/CompactRenderer.ts","src/Meter.ts","src/renderers/FlowRenderer.ts","src/renderers/DefaultRenderer.ts","src/chart/chart-utils.ts","src/renderers/chart-renderer.ts","src/energy-flow-card.ts"],"sourcesContent":["/**\r\n * Energy Flow Calculator\r\n * \r\n * Calculates energy flows between components (production, battery, grid, load)\r\n * based on sensor readings.\r\n */\r\n\r\nimport type { SensorValues, EnergyFlows } from './types/EnergyFlow';\r\n\r\n/**\r\n * Calculate energy flows between components based on sensor readings.\r\n * \r\n * Strategy: Trust sensor readings and only show flows when confirmed by the relevant sensors.\r\n * The sensors may not perfectly balance due to measurement timing, conversion losses, and \r\n * unaccounted consumption (e.g., battery charging inefficiency). This is normal and expected.\r\n * \r\n * @param sensors - Power sensor values for all components\r\n * @returns Calculated flow values for each connection between components\r\n */\r\nexport function calculateEnergyFlows(sensors: SensorValues): EnergyFlows {\r\n  const productionFlow = Math.max(0, sensors.production);\r\n  const gridFlow = sensors.grid; // positive = import, negative = export\r\n  const batteryFlow = sensors.battery; // positive = discharge, negative = charge\r\n  const loadDemand = Math.max(0, sensors.load);\r\n  \r\n  // Initialize all possible flows\r\n  const flows: EnergyFlows = {\r\n    productionToLoad: 0,\r\n    productionToBattery: 0,\r\n    productionToGrid: 0,\r\n    gridToLoad: 0,\r\n    gridToBattery: 0,\r\n    batteryToLoad: 0\r\n  };\r\n  \r\n  // Track remaining capacity\r\n  let remainingProduction = productionFlow;\r\n  let remainingLoad = loadDemand;\r\n  \r\n  // Step 1: Production → Load (highest priority)\r\n  // Production first serves the home load\r\n  if (remainingProduction > 0 && remainingLoad > 0) {\r\n    flows.productionToLoad = Math.min(remainingProduction, remainingLoad);\r\n    remainingProduction -= flows.productionToLoad;\r\n    remainingLoad -= flows.productionToLoad;\r\n  }\r\n  \r\n  // Step 2: Production → Battery (when charging)\r\n  // Excess production can charge the battery\r\n  if (batteryFlow < 0 && remainingProduction > 0) {\r\n    flows.productionToBattery = Math.min(remainingProduction, Math.abs(batteryFlow));\r\n    remainingProduction -= flows.productionToBattery;\r\n  }\r\n  \r\n  // Step 3: Battery → Load (when discharging)\r\n  // Battery can supplement production to meet load\r\n  if (batteryFlow > 0 && remainingLoad > 0) {\r\n    flows.batteryToLoad = Math.min(batteryFlow, remainingLoad);\r\n    remainingLoad -= flows.batteryToLoad;\r\n  }\r\n  \r\n  // Step 4: Grid → Load (importing)\r\n  // Grid imports to cover any remaining load\r\n  if (remainingLoad > 0 && gridFlow > 0) {\r\n    flows.gridToLoad = Math.min(gridFlow, remainingLoad);\r\n    remainingLoad -= flows.gridToLoad;\r\n  }\r\n  \r\n  // Step 5: Grid → Battery (importing to charge)\r\n  // Grid can charge battery when production is insufficient\r\n  // Use threshold to avoid showing noise from measurement fluctuations\r\n  if (batteryFlow < 0 && gridFlow > 10) {\r\n    const batteryNeed = Math.abs(batteryFlow) - flows.productionToBattery;\r\n    if (batteryNeed > 1) { // Threshold to avoid micro-flows from noise\r\n      flows.gridToBattery = Math.min(gridFlow - flows.gridToLoad, batteryNeed);\r\n    }\r\n  }\r\n  \r\n  // Step 6: Production → Grid (exporting)\r\n  // Only show export flow when grid sensor confirms export (negative value)\r\n  // Use threshold to avoid showing phantom exports at zero\r\n  if (gridFlow < -10) { // Threshold: grid must be clearly exporting\r\n    flows.productionToGrid = Math.abs(gridFlow);\r\n  }\r\n  \r\n  return flows;\r\n}\r\n","/**\r\n * General utility functions for the energy flow card\r\n */\r\n\r\nimport type { EnergyFlowCardConfig, EntityConfig } from '../types/Config.d.ts';\r\nimport type { HomeAssistant } from '../types/HASS.d.ts';\r\n\r\nexport function getDisplayName(\r\n  config: EnergyFlowCardConfig,\r\n  hass: HomeAssistant | undefined,\r\n  entityType: 'grid' | 'load' | 'production' | 'battery',\r\n  fallback: string\r\n): string {\r\n  const entityConfig = config[entityType] as EntityConfig | undefined;\r\n  if (!entityConfig) return fallback;\r\n  \r\n  if (entityConfig.name) {\r\n    return entityConfig.name;\r\n  }\r\n\r\n  if (entityConfig.entity && hass?.states[entityConfig.entity]) {\r\n    return hass.states[entityConfig.entity].attributes.friendly_name || fallback;\r\n  }\r\n\r\n  return fallback;\r\n}\r\n\r\nexport function getIcon(\r\n  config: EnergyFlowCardConfig,\r\n  hass: HomeAssistant | undefined,\r\n  entityType: 'grid' | 'load' | 'production' | 'battery',\r\n  fallback: string\r\n): string {\r\n  const entityConfig = config[entityType] as EntityConfig | undefined;\r\n  if (!entityConfig) return fallback;\r\n  \r\n  if (entityConfig.icon) {\r\n    return entityConfig.icon;\r\n  }\r\n\r\n  if (entityConfig.entity && hass?.states[entityConfig.entity]) {\r\n    return hass.states[entityConfig.entity].attributes.icon || fallback;\r\n  }\r\n\r\n  return fallback;\r\n}\r\n\r\nexport function handleAction(\r\n  hass: HomeAssistant,\r\n  fireEvent: (type: string, detail?: any) => void,\r\n  actionConfig: any | undefined,\r\n  entityId?: string\r\n): void {\r\n  if (!hass) return;\r\n  \r\n  // Default to more-info if no action configured\r\n  const config = actionConfig || { action: 'more-info' as const };\r\n  const action = config.action || 'more-info';\r\n  \r\n  switch (action) {\r\n    case 'more-info':\r\n      const entityToShow = config.entity || entityId;\r\n      if (entityToShow) {\r\n        fireEvent('hass-more-info', { entityId: entityToShow });\r\n      }\r\n      break;\r\n      \r\n    case 'navigate':\r\n      if (config.path) {\r\n        history.pushState(null, '', config.path);\r\n        fireEvent('location-changed', { replace: false });\r\n      }\r\n      break;\r\n      \r\n    case 'url':\r\n      if (config.path) {\r\n        window.open(config.path);\r\n      }\r\n      break;\r\n      \r\n    case 'toggle':\r\n      if (entityId) {\r\n        hass.callService('homeassistant', 'toggle', { entity_id: entityId });\r\n      }\r\n      break;\r\n      \r\n    case 'call-service':\r\n      if (config.service) {\r\n        const [domain, service] = config.service.split('.');\r\n        hass.callService(domain, service, config.service_data || {}, config.target);\r\n      }\r\n      break;\r\n      \r\n    case 'none':\r\n      // Do nothing\r\n      break;\r\n  }\r\n}\r\n\r\nexport function updateSegmentVisibility(segment: Element, pixelWidth: number, hasValue: boolean): void {\r\n  if (!segment || !hasValue) {\r\n    segment?.setAttribute('data-width-px', '');\r\n    return;\r\n  }\r\n\r\n  // Thresholds for responsive hiding\r\n  const SHOW_LABEL_THRESHOLD = 80; // Show label if segment is at least 80px wide\r\n  const SHOW_ICON_THRESHOLD = 40;  // Show icon if segment is at least 40px wide\r\n\r\n  if (pixelWidth >= SHOW_LABEL_THRESHOLD) {\r\n    segment.setAttribute('data-width-px', 'show-label');\r\n  } else if (pixelWidth >= SHOW_ICON_THRESHOLD) {\r\n    segment.setAttribute('data-width-px', 'show-icon');\r\n  } else {\r\n    segment.setAttribute('data-width-px', '');\r\n  }\r\n}\r\n","/**\r\n * CompactRenderer\r\n * \r\n * Renders the compact bar view showing energy flow percentages\r\n * Supports two modes:\r\n * - 'compact': Shows only load bar with sources\r\n * - 'compact-battery': Shows load bar + battery bar\r\n */\r\n\r\nimport type { EnergyFlowCardConfig } from '../types/Config.d.ts';\r\nimport type { HomeAssistant } from '../types/HASS.d.ts';\r\nimport type { EnergyFlows } from '../types/EnergyFlow.d.ts';\r\nimport { updateSegmentVisibility } from '../utils/helpers';\r\n\r\nexport type CompactViewMode = 'compact' | 'compact-battery';\r\n\r\nexport interface CompactRenderData {\r\n  grid: number;\r\n  load: number;\r\n  production: number;\r\n  battery: number;\r\n  flows: EnergyFlows;\r\n  batterySoc: number | null;\r\n}\r\n\r\nexport type EntityType = 'grid' | 'load' | 'production' | 'battery';\r\n\r\n/**\r\n * CompactRenderer handles rendering the compact bar visualization\r\n */\r\nexport class CompactRenderer {\r\n  private container: HTMLElement;\r\n  private config: EnergyFlowCardConfig;\r\n  private hass: HomeAssistant;\r\n  private viewMode: CompactViewMode;\r\n  private lastViewMode?: CompactViewMode;\r\n  private getIconCallback: (type: EntityType, fallback: string) => string;\r\n  private handleActionCallback: (action: unknown, entity?: string) => void;\r\n\r\n  // Colors (darker hues - 50% brightness)\r\n  private readonly productionColor = '#256028'; // Dark green\r\n  private readonly batteryColor = '#104b79'; // Dark blue (load)\r\n  private readonly gridColor = '#7a211b'; // Dark red (import)\r\n  private readonly returnColor = '#7a6b1b'; // Dark yellow (export)\r\n\r\n  constructor(\r\n    container: HTMLElement,\r\n    config: EnergyFlowCardConfig,\r\n    hass: HomeAssistant,\r\n    viewMode: CompactViewMode,\r\n    getIconCallback: (type: EntityType, fallback: string) => string,\r\n    handleActionCallback: (action: unknown, entity?: string) => void\r\n  ) {\r\n    this.container = container;\r\n    this.config = config;\r\n    this.hass = hass;\r\n    this.viewMode = viewMode;\r\n    this.getIconCallback = getIconCallback;\r\n    this.handleActionCallback = handleActionCallback;\r\n  }\r\n\r\n  /**\r\n   * Render or update the compact view\r\n   */\r\n  render(data: CompactRenderData): void {\r\n    // Initialize structure if needed\r\n    if (!this.container.querySelector('.compact-view') || this.lastViewMode !== this.viewMode) {\r\n      this.initializeStructure();\r\n      this.attachEventHandlers();\r\n      this.lastViewMode = this.viewMode;\r\n    }\r\n\r\n    // Update values and segments\r\n    this.updateSegments(data);\r\n  }\r\n\r\n  /**\r\n   * Update the view mode\r\n   */\r\n  setViewMode(viewMode: CompactViewMode): void {\r\n    if (this.viewMode !== viewMode) {\r\n      this.viewMode = viewMode;\r\n      this.lastViewMode = undefined; // Force re-render\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initialize the HTML structure\r\n   */\r\n  private initializeStructure(): void {\r\n    this.container.innerHTML = `\r\n      <ha-card>\r\n        <style>\r\n          :host {\r\n            display: block;\r\n            width: 100%;\r\n            height: 100%;\r\n          }\r\n          ha-card {\r\n            padding: 16px;\r\n            box-sizing: border-box;\r\n            width: 100%;\r\n            height: 100%;\r\n            display: flex;\r\n            flex-direction: column;\r\n            justify-content: center;\r\n          }\r\n          .compact-view {\r\n            display: flex;\r\n            flex-direction: column;\r\n            gap: ${this.viewMode === 'compact-battery' ? '12px' : '0'};\r\n            width: 100%;\r\n          }\r\n          .compact-row {\r\n            display: flex;\r\n            align-items: center;\r\n            gap: 12px;\r\n            width: 100%;\r\n          }\r\n          .bar-container {\r\n            flex: 1;\r\n            height: 60px;\r\n            background: rgb(40, 40, 40);\r\n            border-radius: 8px;\r\n            overflow: hidden;\r\n            display: flex;\r\n            position: relative;\r\n          }\r\n          .bar-segment {\r\n            height: 100%;\r\n            display: flex;\r\n            align-items: center;\r\n            justify-content: center;\r\n            gap: 6px;\r\n            font-size: 14px;\r\n            font-weight: 600;\r\n            color: rgb(255, 255, 255);\r\n            transition: width 0.5s ease-out;\r\n            position: relative;\r\n            overflow: hidden;\r\n            cursor: pointer;\r\n          }\r\n          .bar-segment:hover {\r\n            filter: brightness(1.2);\r\n          }\r\n          .bar-segment-content {\r\n            display: flex;\r\n            align-items: center;\r\n            gap: 6px;\r\n            white-space: nowrap;\r\n          }\r\n          .bar-segment-icon {\r\n            width: 24px;\r\n            height: 24px;\r\n            flex-shrink: 0;\r\n            opacity: 1;\r\n            color: rgb(255, 255, 255);\r\n          }\r\n          .bar-segment-label {\r\n            text-shadow: 0 1px 2px rgba(0,0,0,0.3);\r\n          }\r\n          .bar-segment[data-width-px] .bar-segment-label {\r\n            display: none;\r\n          }\r\n          .bar-segment[data-width-px=\"show-label\"] .bar-segment-label {\r\n            display: inline;\r\n          }\r\n          .bar-segment[data-width-px] .bar-segment-icon {\r\n            display: none;\r\n          }\r\n          .bar-segment[data-width-px=\"show-icon\"] .bar-segment-icon,\r\n          .bar-segment[data-width-px=\"show-label\"] .bar-segment-icon {\r\n            display: block;\r\n          }\r\n          .row-value {\r\n            font-size: 24px;\r\n            font-weight: 600;\r\n            color: rgb(255, 255, 255);\r\n            white-space: nowrap;\r\n            min-width: 100px;\r\n            text-align: right;\r\n            display: flex;\r\n            align-items: center;\r\n            gap: 8px;\r\n            cursor: pointer;\r\n          }\r\n          .row-value:hover {\r\n            filter: brightness(1.1);\r\n          }\r\n          .row-value.battery-discharge {\r\n            text-align: left;\r\n            flex-direction: row-reverse;\r\n          }\r\n          .row-icon {\r\n            width: 28px;\r\n            height: 28px;\r\n            flex-shrink: 0;\r\n            color: rgb(160, 160, 160);\r\n            display: flex;\r\n            align-items: center;\r\n          }\r\n          .row-text {\r\n            display: flex;\r\n            align-items: baseline;\r\n            gap: 4px;\r\n            line-height: 1;\r\n          }\r\n          .row-unit {\r\n            font-size: 14px;\r\n            color: rgb(160, 160, 160);\r\n            margin-left: 4px;\r\n          }\r\n        </style>\r\n        <div class=\"compact-view\">\r\n          <!-- Load Row -->\r\n          <div class=\"compact-row\">\r\n            <div class=\"bar-container\">\r\n              <div id=\"grid-segment\" class=\"bar-segment\" style=\"background: ${this.gridColor}; width: 0%;\">\r\n                <div class=\"bar-segment-content\">\r\n                  <ha-icon class=\"bar-segment-icon\" icon=\"${this.getIconCallback('grid', 'mdi:transmission-tower')}\"></ha-icon>\r\n                  <span class=\"bar-segment-label\"></span>\r\n                </div>\r\n              </div>\r\n              <div id=\"battery-segment\" class=\"bar-segment\" style=\"background: ${this.batteryColor}; width: 0%;\">\r\n                <div class=\"bar-segment-content\">\r\n                  <ha-icon class=\"bar-segment-icon\" icon=\"${this.getIconCallback('battery', 'mdi:battery')}\"></ha-icon>\r\n                  <span class=\"bar-segment-label\"></span>\r\n                </div>\r\n              </div>\r\n              <div id=\"production-segment\" class=\"bar-segment\" style=\"background: ${this.productionColor}; width: 0%;\">\r\n                <div class=\"bar-segment-content\">\r\n                  <ha-icon class=\"bar-segment-icon\" icon=\"${this.getIconCallback('production', 'mdi:solar-power')}\"></ha-icon>\r\n                  <span class=\"bar-segment-label\"></span>\r\n                </div>\r\n              </div>\r\n            </div>\r\n            <div class=\"row-value\">\r\n              <ha-icon class=\"row-icon\" icon=\"${this.getIconCallback('load', 'mdi:home-lightning-bolt')}\"></ha-icon>\r\n              <div class=\"row-text\">\r\n                <span id=\"load-value-text\">0</span><span class=\"row-unit\">W</span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n          ${this.viewMode === 'compact-battery' ? `\r\n          <!-- Battery Row -->\r\n          <div class=\"compact-row\" id=\"battery-row\">\r\n            <div class=\"row-value\" id=\"battery-soc-left\" style=\"display: none;\">\r\n              <ha-icon class=\"row-icon\" icon=\"${this.getIconCallback('battery', 'mdi:battery')}\"></ha-icon>\r\n              <div class=\"row-text\">\r\n                <span id=\"battery-soc-text-left\">--</span><span class=\"row-unit\">%</span>\r\n              </div>\r\n            </div>\r\n            <div class=\"bar-container\">\r\n              <!-- Color order: red, yellow, blue, green (left to right) -->\r\n              <div id=\"battery-grid-segment\" class=\"bar-segment\" style=\"background: ${this.gridColor}; width: 0%;\">\r\n                <div class=\"bar-segment-content\">\r\n                  <ha-icon class=\"bar-segment-icon\" icon=\"${this.getIconCallback('grid', 'mdi:transmission-tower')}\"></ha-icon>\r\n                  <span class=\"bar-segment-label\"></span>\r\n                </div>\r\n              </div>\r\n              <div id=\"battery-load-segment\" class=\"bar-segment\" style=\"background: ${this.batteryColor}; width: 0%;\">\r\n                <div class=\"bar-segment-content\">\r\n                  <ha-icon class=\"bar-segment-icon\" icon=\"${this.getIconCallback('load', 'mdi:home')}\"></ha-icon>\r\n                  <span class=\"bar-segment-label\"></span>\r\n                </div>\r\n              </div>\r\n              <div id=\"battery-production-segment\" class=\"bar-segment\" style=\"background: ${this.productionColor}; width: 0%;\">\r\n                <div class=\"bar-segment-content\">\r\n                  <ha-icon class=\"bar-segment-icon\" icon=\"${this.getIconCallback('production', 'mdi:solar-power')}\"></ha-icon>\r\n                  <span class=\"bar-segment-label\"></span>\r\n                </div>\r\n              </div>\r\n            </div>\r\n            <div class=\"row-value\" id=\"battery-soc-right\">\r\n              <ha-icon class=\"row-icon\" icon=\"${this.getIconCallback('battery', 'mdi:battery')}\"></ha-icon>\r\n              <div class=\"row-text\">\r\n                <span id=\"battery-soc-text-right\">--</span><span class=\"row-unit\">%</span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n          ` : ''}\r\n        </div>\r\n      </ha-card>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Attach click event handlers\r\n   */\r\n  private attachEventHandlers(): void {\r\n    requestAnimationFrame(() => {\r\n      // Load row segments\r\n      const productionSeg = this.container.querySelector('#production-segment');\r\n      const batterySeg = this.container.querySelector('#battery-segment');\r\n      const gridSeg = this.container.querySelector('#grid-segment');\r\n      const loadValues = this.container.querySelectorAll('.row-value');\r\n      const loadValue = loadValues[0]; // First row-value is the load\r\n      \r\n      if (productionSeg) {\r\n        productionSeg.addEventListener('click', () => {\r\n          this.handleActionCallback(this.config.production?.tap, this.config.production?.entity);\r\n        });\r\n      }\r\n      if (batterySeg) {\r\n        batterySeg.addEventListener('click', () => {\r\n          this.handleActionCallback(this.config.battery?.tap, this.config.battery?.entity);\r\n        });\r\n      }\r\n      if (gridSeg) {\r\n        gridSeg.addEventListener('click', () => {\r\n          this.handleActionCallback(this.config.grid?.tap, this.config.grid?.entity);\r\n        });\r\n      }\r\n      if (loadValue) {\r\n        loadValue.addEventListener('click', () => {\r\n          this.handleActionCallback(this.config.load.tap, this.config.load.entity);\r\n        });\r\n      }\r\n      \r\n      // Battery row handlers if in compact-battery mode\r\n      if (this.viewMode === 'compact-battery') {\r\n        const batteryProdSeg = this.container.querySelector('#battery-production-segment');\r\n        const batteryLoadSeg = this.container.querySelector('#battery-load-segment');\r\n        const batteryGridSeg = this.container.querySelector('#battery-grid-segment');\r\n        const batterySocLeft = this.container.querySelector('#battery-soc-left');\r\n        const batterySocRight = this.container.querySelector('#battery-soc-right');\r\n        \r\n        if (batteryProdSeg) {\r\n          batteryProdSeg.addEventListener('click', () => {\r\n            this.handleActionCallback(this.config.production?.tap, this.config.production?.entity);\r\n          });\r\n        }\r\n        if (batteryLoadSeg) {\r\n          batteryLoadSeg.addEventListener('click', () => {\r\n            this.handleActionCallback(this.config.load.tap, this.config.load.entity);\r\n          });\r\n        }\r\n        if (batteryGridSeg) {\r\n          batteryGridSeg.addEventListener('click', () => {\r\n            this.handleActionCallback(this.config.grid?.tap, this.config.grid?.entity);\r\n          });\r\n        }\r\n        if (batterySocLeft) {\r\n          batterySocLeft.addEventListener('click', () => {\r\n            this.handleActionCallback(this.config.battery?.tap, this.config.battery?.entity);\r\n          });\r\n        }\r\n        if (batterySocRight) {\r\n          batterySocRight.addEventListener('click', () => {\r\n            this.handleActionCallback(this.config.battery?.tap, this.config.battery?.entity);\r\n          });\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update segment widths and labels\r\n   */\r\n  private updateSegments(data: CompactRenderData): void {\r\n    const { load, flows, battery, batterySoc } = data;\r\n\r\n    // Calculate load bar percentages\r\n    const productionValue = flows.productionToLoad;\r\n    const batteryToLoad = flows.batteryToLoad;\r\n    const gridToLoad = flows.gridToLoad;\r\n\r\n    // Calculate TRUE percentages for labels (these show accurate data)\r\n    const total = load || 1;\r\n    const productionPercent = (productionValue / total) * 100;\r\n    const batteryPercent = (batteryToLoad / total) * 100;\r\n    const gridPercent = (gridToLoad / total) * 100;\r\n    \r\n    // Calculate VISUAL percentages for bar widths (scaled to fill 100%)\r\n    const sumPercent = productionPercent + batteryPercent + gridPercent;\r\n    let visualProductionPercent = productionPercent;\r\n    let visualBatteryPercent = batteryPercent;\r\n    let visualGridPercent = gridPercent;\r\n    \r\n    if (sumPercent > 0) {\r\n      const scale = 100 / sumPercent;\r\n      visualProductionPercent = productionPercent * scale;\r\n      visualBatteryPercent = batteryPercent * scale;\r\n      visualGridPercent = gridPercent * scale;\r\n    }\r\n\r\n    // Calculate battery bar values\r\n    let batteryGridWatts = 0;\r\n    let batteryLoadWatts = 0;\r\n    let batteryProdWatts = 0;\r\n    let visualBatteryGridPercent = 0;\r\n    let visualBatteryLoadPercent = 0;\r\n    let visualBatteryProdPercent = 0;\r\n    \r\n    if (this.viewMode === 'compact-battery') {\r\n      if (battery < 0) {\r\n        // CHARGING\r\n        const batteryCharging = Math.abs(battery);\r\n        const batteryTotal = batteryCharging || 1;\r\n        \r\n        batteryGridWatts = flows.gridToBattery;\r\n        batteryProdWatts = flows.productionToBattery;\r\n        \r\n        const batteryGridPercent = (flows.gridToBattery / batteryTotal) * 100;\r\n        const batteryProdPercent = (flows.productionToBattery / batteryTotal) * 100;\r\n        \r\n        const chargeSum = batteryGridPercent + batteryProdPercent;\r\n        if (chargeSum > 0) {\r\n          const scale = 100 / chargeSum;\r\n          visualBatteryGridPercent = batteryGridPercent * scale;\r\n          visualBatteryProdPercent = batteryProdPercent * scale;\r\n        }\r\n      } else if (battery > 0) {\r\n        // DISCHARGING\r\n        const batteryTotal = battery || 1;\r\n        const batteryToGrid = battery - flows.batteryToLoad;\r\n        \r\n        batteryLoadWatts = flows.batteryToLoad;\r\n        batteryGridWatts = batteryToGrid;\r\n        \r\n        const batteryLoadPercent = (flows.batteryToLoad / batteryTotal) * 100;\r\n        const batteryGridPercent = (batteryToGrid / batteryTotal) * 100;\r\n        \r\n        const dischargeSum = batteryLoadPercent + batteryGridPercent;\r\n        if (dischargeSum > 0) {\r\n          const scale = 100 / dischargeSum;\r\n          visualBatteryLoadPercent = batteryLoadPercent * scale;\r\n          visualBatteryGridPercent = batteryGridPercent * scale;\r\n        }\r\n      }\r\n    }\r\n\r\n    requestAnimationFrame(() => {\r\n      this.updateLoadBar(\r\n        visualProductionPercent,\r\n        visualBatteryPercent,\r\n        visualGridPercent,\r\n        productionPercent,\r\n        batteryPercent,\r\n        gridPercent,\r\n        productionValue,\r\n        batteryToLoad,\r\n        gridToLoad,\r\n        load\r\n      );\r\n\r\n      if (this.viewMode === 'compact-battery') {\r\n        this.updateBatteryBar(\r\n          visualBatteryGridPercent,\r\n          visualBatteryLoadPercent,\r\n          visualBatteryProdPercent,\r\n          batteryGridWatts,\r\n          batteryLoadWatts,\r\n          batteryProdWatts,\r\n          battery,\r\n          batterySoc\r\n        );\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update the load bar segments\r\n   */\r\n  private updateLoadBar(\r\n    visualProductionPercent: number,\r\n    visualBatteryPercent: number,\r\n    visualGridPercent: number,\r\n    productionPercent: number,\r\n    batteryPercent: number,\r\n    gridPercent: number,\r\n    productionValue: number,\r\n    batteryToLoad: number,\r\n    gridToLoad: number,\r\n    load: number\r\n  ): void {\r\n    const productionSegment = this.container.querySelector('#production-segment');\r\n    const batterySegment = this.container.querySelector('#battery-segment');\r\n    const gridSegment = this.container.querySelector('#grid-segment');\r\n    const loadValueText = this.container.querySelector('#load-value-text');\r\n    const barContainer = this.container.querySelector('.bar-container');\r\n\r\n    if (productionSegment) {\r\n      (productionSegment as HTMLElement).style.width = `${visualProductionPercent}%`;\r\n      const label = productionSegment.querySelector('.bar-segment-label');\r\n      if (label && productionValue > 0) {\r\n        label.textContent = `${Math.round(productionPercent)}%`;\r\n      }\r\n      const widthPx = (visualProductionPercent / 100) * (barContainer?.clientWidth || 0);\r\n      updateSegmentVisibility(productionSegment as HTMLElement, widthPx, productionValue > 0);\r\n    }\r\n\r\n    if (batterySegment) {\r\n      (batterySegment as HTMLElement).style.width = `${visualBatteryPercent}%`;\r\n      const label = batterySegment.querySelector('.bar-segment-label');\r\n      if (label && batteryToLoad > 0) {\r\n        label.textContent = `${Math.round(batteryPercent)}%`;\r\n      }\r\n      const widthPx = (visualBatteryPercent / 100) * (barContainer?.clientWidth || 0);\r\n      updateSegmentVisibility(batterySegment as HTMLElement, widthPx, batteryToLoad > 0);\r\n    }\r\n\r\n    if (gridSegment) {\r\n      (gridSegment as HTMLElement).style.width = `${visualGridPercent}%`;\r\n      const label = gridSegment.querySelector('.bar-segment-label');\r\n      if (label && gridToLoad > 0) {\r\n        label.textContent = `${Math.round(gridPercent)}%`;\r\n      }\r\n      const widthPx = (visualGridPercent / 100) * (barContainer?.clientWidth || 0);\r\n      updateSegmentVisibility(gridSegment as HTMLElement, widthPx, gridToLoad > 0);\r\n    }\r\n\r\n    if (loadValueText) {\r\n      loadValueText.textContent = String(Math.round(load));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update the battery bar segments\r\n   */\r\n  private updateBatteryBar(\r\n    visualBatteryGridPercent: number,\r\n    visualBatteryLoadPercent: number,\r\n    visualBatteryProdPercent: number,\r\n    batteryGridWatts: number,\r\n    batteryLoadWatts: number,\r\n    batteryProdWatts: number,\r\n    battery: number,\r\n    batterySoc: number | null\r\n  ): void {\r\n    const batteryGridSegment = this.container.querySelector('#battery-grid-segment');\r\n    const batteryLoadSegment = this.container.querySelector('#battery-load-segment');\r\n    const batteryProdSegment = this.container.querySelector('#battery-production-segment');\r\n    const batterySocLeft = this.container.querySelector('#battery-soc-left') as HTMLElement | null;\r\n    const batterySocRight = this.container.querySelector('#battery-soc-right') as HTMLElement | null;\r\n    const batterySocTextLeft = this.container.querySelector('#battery-soc-text-left');\r\n    const batterySocTextRight = this.container.querySelector('#battery-soc-text-right');\r\n    const batteryBarContainers = this.container.querySelectorAll('.bar-container');\r\n    const batteryBarContainer = batteryBarContainers[1] as HTMLElement | null;\r\n    \r\n    let gridIsImport = false;\r\n    \r\n    if (battery < 0) {\r\n      // CHARGING\r\n      gridIsImport = true;\r\n      if (batterySocLeft) batterySocLeft.style.display = 'none';\r\n      if (batterySocRight) batterySocRight.style.display = 'flex';\r\n      if (batterySocTextRight && batterySoc !== null) {\r\n        batterySocTextRight.textContent = batterySoc.toFixed(1);\r\n      }\r\n    } else if (battery > 0) {\r\n      // DISCHARGING\r\n      gridIsImport = false;\r\n      if (batterySocLeft) batterySocLeft.style.display = 'flex';\r\n      if (batterySocRight) batterySocRight.style.display = 'none';\r\n      if (batterySocTextLeft && batterySoc !== null) {\r\n        batterySocTextLeft.textContent = batterySoc.toFixed(1);\r\n      }\r\n    } else {\r\n      // IDLE\r\n      if (batterySocLeft) batterySocLeft.style.display = 'none';\r\n      if (batterySocRight) batterySocRight.style.display = 'flex';\r\n      if (batterySocTextRight && batterySoc !== null) {\r\n        batterySocTextRight.textContent = batterySoc.toFixed(1);\r\n      }\r\n    }\r\n    \r\n    // Update grid segment\r\n    if (batteryGridSegment) {\r\n      const gridColorToUse = gridIsImport ? this.gridColor : this.returnColor;\r\n      (batteryGridSegment as HTMLElement).style.width = `${visualBatteryGridPercent}%`;\r\n      (batteryGridSegment as HTMLElement).style.background = gridColorToUse;\r\n      const label = batteryGridSegment.querySelector('.bar-segment-label');\r\n      if (label && batteryGridWatts > 0) {\r\n        label.textContent = `${Math.round(batteryGridWatts)}W`;\r\n      }\r\n      const pixelWidth = (visualBatteryGridPercent / 100) * (batteryBarContainer?.offsetWidth || 0);\r\n      updateSegmentVisibility(batteryGridSegment, pixelWidth, batteryGridWatts > 0);\r\n    }\r\n    \r\n    // Update load segment\r\n    if (batteryLoadSegment) {\r\n      (batteryLoadSegment as HTMLElement).style.width = `${visualBatteryLoadPercent}%`;\r\n      const label = batteryLoadSegment.querySelector('.bar-segment-label');\r\n      if (label && batteryLoadWatts > 0) {\r\n        label.textContent = `${Math.round(batteryLoadWatts)}W`;\r\n      }\r\n      const pixelWidth = (visualBatteryLoadPercent / 100) * (batteryBarContainer?.offsetWidth || 0);\r\n      updateSegmentVisibility(batteryLoadSegment, pixelWidth, batteryLoadWatts > 0);\r\n    }\r\n    \r\n    // Update production segment\r\n    if (batteryProdSegment) {\r\n      (batteryProdSegment as HTMLElement).style.width = `${visualBatteryProdPercent}%`;\r\n      const label = batteryProdSegment.querySelector('.bar-segment-label');\r\n      if (label && batteryProdWatts > 0) {\r\n        label.textContent = `${Math.round(batteryProdWatts)}W`;\r\n      }\r\n      const pixelWidth = (visualBatteryProdPercent / 100) * (batteryBarContainer?.offsetWidth || 0);\r\n      updateSegmentVisibility(batteryProdSegment, pixelWidth, batteryProdWatts > 0);\r\n    }\r\n  }\r\n}\r\n","/** Needle animation state for meters */\r\nexport interface NeedleState {\r\n  /** Target angle in degrees */\r\n  target: number;\r\n  /** Current angle in degrees */\r\n  current: number;\r\n  /** Ghost needle angle (lags behind current) */\r\n  ghost: number;\r\n}\r\n\r\n/** Action configuration (imported from Config types) */\r\nimport type { ActionConfig } from './types/Config.d.ts';\r\n\r\n/**\r\n * Meter class: Fully self-contained gauge meter with rendering and animation\r\n */\r\nexport class Meter {\r\n  id: string;\r\n  private _value: number;\r\n  min: number;\r\n  max: number;\r\n  bidirectional: boolean;\r\n  label: string;\r\n  icon: string;\r\n  units: string;\r\n  private _invertView: boolean;\r\n  showPlus: boolean;\r\n  \r\n  // Tap action configuration\r\n  private tapAction: ActionConfig | undefined;\r\n  private entityId: string | undefined;\r\n  private fireEventCallback: ((event: string, detail?: any) => void) | undefined;\r\n  \r\n  // DOM element this meter owns\r\n  element: SVGGElement | null;\r\n\r\n  // Meter geometry constants\r\n  radius: number;\r\n  boxWidth: number;\r\n  boxHeight: number;\r\n  boxRadius: number;\r\n  centerX: number;\r\n  centerY: number;\r\n  offsetX: number;\r\n  offsetY: number;\r\n\r\n  // Needle animation state\r\n  needleState: NeedleState;\r\n  private _lastAnimationTime: number | null;\r\n  private _animationFrameId: number | null;\r\n\r\n  constructor(\r\n    id: string,\r\n    value: number,\r\n    min: number,\r\n    max: number,\r\n    bidirectional: boolean,\r\n    label: string,\r\n    icon: string,\r\n    units: string,\r\n    invertView = false,\r\n    showPlus = false,\r\n    tapAction?: ActionConfig,\r\n    entityId?: string,\r\n    fireEventCallback?: (event: string, detail?: any) => void\r\n  ) {\r\n    this.id = id;\r\n    this._value = value;\r\n    this.min = min;\r\n    this.max = max;\r\n    this.bidirectional = bidirectional;\r\n    this.label = label;\r\n    this.icon = icon;\r\n    this.units = units;\r\n    this._invertView = invertView;\r\n    this.showPlus = showPlus;\r\n    this.tapAction = tapAction;\r\n    this.entityId = entityId;\r\n    this.fireEventCallback = fireEventCallback;\r\n    this.element = null;\r\n\r\n    // Meter geometry constants\r\n    this.radius = 50;\r\n    this.boxWidth = 120;\r\n    this.boxHeight = 135;\r\n    this.boxRadius = 16;\r\n    this.centerX = this.boxWidth / 2;\r\n    this.centerY = this.radius + 25;\r\n    this.offsetX = -this.centerX;\r\n    this.offsetY = -this.centerY;\r\n\r\n    // Needle animation state\r\n    this.needleState = { target: 0, current: 0, ghost: 0 };\r\n    this._lastAnimationTime = null;\r\n    this._animationFrameId = null;\r\n\r\n    // Calculate initial needle angle\r\n    this._updateNeedleAngle();\r\n  }\r\n\r\n  get value(): number {\r\n    return this._value;\r\n  }\r\n\r\n  set value(newValue: number) {\r\n    if (this._value === newValue) return; // No change, skip update\r\n\r\n    this._value = newValue;\r\n    this._updateNeedleAngle();\r\n\r\n    // Update value text immediately\r\n    if (this.element) {\r\n      const valueText = this.element.querySelector(`#value-${this.id}`);\r\n      if (valueText) {\r\n        valueText.textContent = this._formatValueText();\r\n      }\r\n\r\n      // Update dimming\r\n      this.updateDimming();\r\n    }\r\n  }\r\n\r\n  get invertView(): boolean {\r\n    return this._invertView;\r\n  }\r\n\r\n  set invertView(newInvertView: boolean) {\r\n    if (this._invertView === newInvertView) return; // No change, skip update\r\n\r\n    this._invertView = newInvertView;\r\n    this._updateNeedleAngle();\r\n\r\n    // Update value text immediately (displayValue depends on invertView)\r\n    if (this.element) {\r\n      const valueText = this.element.querySelector(`#value-${this.id}`);\r\n      if (valueText) {\r\n        valueText.textContent = this._formatValueText();\r\n      }\r\n    }\r\n  }\r\n\r\n  get displayValue(): number {\r\n    return this._invertView ? -this._value : this._value;\r\n  }\r\n\r\n  _formatValueText(): string {\r\n    const displayValue = this.displayValue;\r\n    const valueStr = displayValue.toFixed(0);\r\n\r\n    if (displayValue < 0) {\r\n      return valueStr + '\\u00A0'; // Negative with non-breaking space\r\n    } else if (displayValue > 0 && this.showPlus) {\r\n      return '+' + valueStr + '\\u00A0'; // Positive with + sign and non-breaking space\r\n    } else {\r\n      return valueStr; // Zero or positive without sign\r\n    }\r\n  }\r\n\r\n  _updateNeedleAngle(): void {\r\n    let percentage: number;\r\n    let angle: number;\r\n    const displayValue = this.displayValue;\r\n\r\n    if (this.bidirectional) {\r\n      const range = this.max - this.min;\r\n      percentage = Math.min(Math.max((displayValue - this.min) / range, 0), 1);\r\n      angle = 180 - percentage * 180;\r\n    } else {\r\n      percentage = Math.min(Math.max(displayValue / this.max, 0), 1);\r\n      angle = 180 - percentage * 180;\r\n    }\r\n\r\n    this.needleState.target = angle;\r\n  }\r\n\r\n  updateDimming(): void {\r\n    if (!this.element) return;\r\n\r\n    const dimmer = this.element.querySelector(`#dimmer-${this.id}`);\r\n    if (dimmer) {\r\n      const isZero = Math.abs(this.value) < 0.5;\r\n      dimmer.setAttribute('opacity', isZero ? '0.3' : '0');\r\n    }\r\n  }\r\n\r\n  startAnimation(): void {\r\n    if (this._animationFrameId) return; // Already animating\r\n\r\n    const animate = (timestamp: number) => {\r\n      if (!this._lastAnimationTime) {\r\n        this._lastAnimationTime = timestamp;\r\n      }\r\n\r\n      const deltaTime = timestamp - this._lastAnimationTime;\r\n      this._lastAnimationTime = timestamp;\r\n\r\n      if (!this.element) {\r\n        this._animationFrameId = null;\r\n        return;\r\n      }\r\n\r\n      const needleLength = this.radius - 5;\r\n\r\n      // Smoothly interpolate main needle (fast response)\r\n      const mainLerpFactor = Math.min(deltaTime / 150, 1); // 150ms response time\r\n      this.needleState.current += (this.needleState.target - this.needleState.current) * mainLerpFactor;\r\n\r\n      // Ghost needle lags behind (slower response)\r\n      const ghostLerpFactor = Math.min(deltaTime / 400, 1); // 400ms response time\r\n      this.needleState.ghost += (this.needleState.current - this.needleState.ghost) * ghostLerpFactor;\r\n\r\n      // Clamp ghost to maximum 10 degrees behind main needle\r\n      const maxLag = 10;\r\n      if (this.needleState.ghost < this.needleState.current - maxLag) {\r\n        this.needleState.ghost = this.needleState.current - maxLag;\r\n      } else if (this.needleState.ghost > this.needleState.current + maxLag) {\r\n        this.needleState.ghost = this.needleState.current + maxLag;\r\n      }\r\n\r\n      // Update main needle\r\n      const needle = this.element.querySelector(`#needle-${this.id}`);\r\n      if (needle) {\r\n        const needleRad = (this.needleState.current * Math.PI) / 180;\r\n        const needleX = this.centerX + needleLength * Math.cos(needleRad);\r\n        const needleY = this.centerY - needleLength * Math.sin(needleRad);\r\n        needle.setAttribute('x2', String(needleX));\r\n        needle.setAttribute('y2', String(needleY));\r\n      }\r\n\r\n      // Update ghost needle\r\n      const ghostNeedle = this.element.querySelector(`#ghost-needle-${this.id}`);\r\n      if (ghostNeedle) {\r\n        const ghostRad = (this.needleState.ghost * Math.PI) / 180;\r\n        const ghostX = this.centerX + needleLength * Math.cos(ghostRad);\r\n        const ghostY = this.centerY - needleLength * Math.sin(ghostRad);\r\n        ghostNeedle.setAttribute('x2', String(ghostX));\r\n        ghostNeedle.setAttribute('y2', String(ghostY));\r\n      }\r\n\r\n      this._animationFrameId = requestAnimationFrame(animate);\r\n    };\r\n\r\n    this._animationFrameId = requestAnimationFrame(animate);\r\n  }\r\n\r\n  stopAnimation(): void {\r\n    if (this._animationFrameId) {\r\n      cancelAnimationFrame(this._animationFrameId);\r\n      this._animationFrameId = null;\r\n      this._lastAnimationTime = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle tap action when meter is clicked\r\n   */\r\n  private _handleTapAction(): void {\r\n    if (!this.fireEventCallback) return;\r\n\r\n    // Default to more-info if no tap action configured\r\n    const config = this.tapAction || { action: 'more-info' as const };\r\n    const action = config.action || 'more-info';\r\n\r\n    switch (action) {\r\n      case 'more-info':\r\n        const entityId = config.entity || this.entityId;\r\n        if (entityId) {\r\n          this.fireEventCallback('hass-more-info', { entityId });\r\n        }\r\n        break;\r\n\r\n      case 'navigate':\r\n        if (config.path) {\r\n          history.pushState(null, '', config.path);\r\n          this.fireEventCallback('location-changed', { replace: false });\r\n        }\r\n        break;\r\n\r\n      case 'url':\r\n        if (config.path) {\r\n          window.open(config.path);\r\n        }\r\n        break;\r\n\r\n      case 'toggle':\r\n        if (this.entityId) {\r\n          this.fireEventCallback('call-service', {\r\n            domain: 'homeassistant',\r\n            service: 'toggle',\r\n            service_data: { entity_id: this.entityId }\r\n          });\r\n        }\r\n        break;\r\n\r\n      case 'call-service':\r\n        if (config.service) {\r\n          const [domain, service] = config.service.split('.');\r\n          this.fireEventCallback('call-service', {\r\n            domain,\r\n            service,\r\n            service_data: config.service_data || {},\r\n            target: config.target\r\n          });\r\n        }\r\n        break;\r\n\r\n      case 'none':\r\n        // Do nothing\r\n        break;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create and return the SVG element for this meter\r\n   */\r\n  /**\r\n   * Create and return the SVG element for this meter\r\n   */\r\n  createElement(): SVGGElement {\r\n    const displayValue = this.displayValue;\r\n\r\n    // Calculate percentage and angle for needle\r\n    let percentage: number;\r\n    let angle: number;\r\n    if (this.bidirectional) {\r\n      const range = this.max - this.min;\r\n      percentage = Math.min(Math.max((displayValue - this.min) / range, 0), 1);\r\n      angle = 180 - percentage * 180;\r\n    } else {\r\n      percentage = Math.min(Math.max(displayValue / this.max, 0), 1);\r\n      angle = 180 - percentage * 180;\r\n    }\r\n\r\n    // Initialize needle state\r\n    this.needleState.target = angle;\r\n    this.needleState.current = angle;\r\n    this.needleState.ghost = angle;\r\n\r\n    // Generate tick marks\r\n    const ticks = this.bidirectional ? [this.min, 0, this.max] : [0, this.max / 2, this.max];\r\n    const tickMarks = ticks\r\n      .map((tickValue) => {\r\n        const tickPercentage = this.bidirectional\r\n          ? (tickValue - this.min) / (this.max - this.min)\r\n          : tickValue / this.max;\r\n        const tickAngle = 180 - tickPercentage * 180;\r\n        const tickRad = (tickAngle * Math.PI) / 180;\r\n        const tickStartR = this.radius;\r\n        const tickEndR = this.radius - 8;\r\n\r\n        const x1 = this.centerX + tickStartR * Math.cos(tickRad);\r\n        const y1 = this.centerY - tickStartR * Math.sin(tickRad);\r\n        const x2 = this.centerX + tickEndR * Math.cos(tickRad);\r\n        const y2 = this.centerY - tickEndR * Math.sin(tickRad);\r\n\r\n        return `<line x1=\"${x1}\" y1=\"${y1}\" x2=\"${x2}\" y2=\"${y2}\" stroke=\"rgb(160, 160, 160)\" stroke-width=\"2\" />`;\r\n      })\r\n      .join('');\r\n\r\n    // Zero line\r\n    const zeroPercentage = this.bidirectional ? (0 - this.min) / (this.max - this.min) : 0;\r\n    const zeroAngle = 180 - zeroPercentage * 180;\r\n    const zeroRad = (zeroAngle * Math.PI) / 180;\r\n    const zeroX1 = this.centerX;\r\n    const zeroY1 = this.centerY;\r\n    const zeroX2 = this.centerX + this.radius * Math.cos(zeroRad);\r\n    const zeroY2 = this.centerY - this.radius * Math.sin(zeroRad);\r\n    const zeroLine = `<line x1=\"${zeroX1}\" y1=\"${zeroY1}\" x2=\"${zeroX2}\" y2=\"${zeroY2}\" stroke=\"rgb(100, 100, 100)\" stroke-width=\"2\" />`;\r\n\r\n    // Needle position\r\n    const needleRad = (angle * Math.PI) / 180;\r\n    const needleLength = this.radius - 5;\r\n    const needleX = this.centerX + needleLength * Math.cos(needleRad);\r\n    const needleY = this.centerY - needleLength * Math.sin(needleRad);\r\n\r\n    const clipHeight = this.centerY + 5;\r\n    const valueY = this.centerY + this.radius * 0.5;\r\n    const unitsY = this.centerY + this.radius * 0.7;\r\n\r\n    const svgMarkup = `\r\n      <g transform=\"translate(${this.offsetX}, ${this.offsetY})\">\r\n        <defs>\r\n          <clipPath id=\"clip-${this.id}-local\">\r\n            <rect x=\"0\" y=\"0\" width=\"${this.boxWidth}\" height=\"${clipHeight + 2}\" />\r\n          </clipPath>\r\n        </defs>\r\n        \r\n        <rect x=\"0\" y=\"0\" width=\"${this.boxWidth}\" height=\"${this.boxHeight}\" rx=\"${this.boxRadius}\" ry=\"${this.boxRadius}\" fill=\"rgb(40, 40, 40)\" filter=\"url(#drop-shadow)\" />\r\n        \r\n        <g clip-path=\"url(#clip-${this.id}-local)\">\r\n          <circle cx=\"${this.centerX}\" cy=\"${this.centerY}\" r=\"${this.radius}\" fill=\"rgb(70, 70, 70)\" />\r\n          ${zeroLine}\r\n        </g>\r\n        \r\n        ${tickMarks}\r\n        \r\n        <circle cx=\"${this.centerX}\" cy=\"${this.centerY}\" r=\"${this.radius}\" fill=\"none\" stroke=\"rgb(160, 160, 160)\" stroke-width=\"2\" />\r\n        \r\n        <text x=\"${this.centerX}\" y=\"15\" text-anchor=\"middle\" font-size=\"12\" fill=\"rgb(255, 255, 255)\" font-weight=\"500\">${this.label}</text>\r\n        \r\n        <!-- Icon rendered via foreignObject (for extraction source) -->\r\n        <foreignObject id=\"icon-source-${this.id}\" x=\"${this.centerX - 18}\" y=\"${this.centerY - 42}\" width=\"36\" height=\"36\">\r\n          <div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"width: 36px; height: 36px;\">\r\n            <ha-icon icon=\"${this.icon}\" style=\"--mdc-icon-size: 36px; color: rgb(160, 160, 160);\"></ha-icon>\r\n          </div>\r\n        </foreignObject>\r\n        \r\n        <!-- Icon rendered as native SVG path (populated after extraction, will overlay) -->\r\n        <g id=\"icon-display-${this.id}\" transform=\"translate(${this.centerX - 18}, ${this.centerY - 42}) scale(1.5)\">\r\n          <!-- Path will be inserted here by _extractIconPaths -->\r\n        </g>\r\n        \r\n        <line id=\"ghost-needle-${this.id}\" x1=\"${this.centerX}\" y1=\"${this.centerY}\" x2=\"${needleX}\" y2=\"${needleY}\" stroke=\"rgb(255, 255, 255)\" stroke-width=\"4\" stroke-linecap=\"round\" opacity=\"0.3\" />\r\n        \r\n        <line id=\"needle-${this.id}\" x1=\"${this.centerX}\" y1=\"${this.centerY}\" x2=\"${needleX}\" y2=\"${needleY}\" stroke=\"rgb(255, 255, 255)\" stroke-width=\"4\" stroke-linecap=\"round\" />\r\n        \r\n        <circle cx=\"${this.centerX}\" cy=\"${this.centerY}\" r=\"5\" fill=\"rgb(255, 255, 255)\" />\r\n        \r\n        <text id=\"value-${this.id}\" x=\"${this.centerX}\" y=\"${valueY}\" text-anchor=\"middle\" font-size=\"16\" fill=\"rgb(255, 255, 255)\" font-weight=\"600\">${this._formatValueText()}</text>\r\n        \r\n        <text x=\"${this.centerX}\" y=\"${unitsY}\" text-anchor=\"middle\" font-size=\"8\" fill=\"rgb(160, 160, 160)\" font-weight=\"400\" letter-spacing=\"0.5\">${this.units}</text>\r\n        \r\n        <rect id=\"dimmer-${this.id}\" x=\"0\" y=\"0\" width=\"${this.boxWidth}\" height=\"${this.boxHeight}\" rx=\"${this.boxRadius}\" ry=\"${this.boxRadius}\" fill=\"black\" opacity=\"0\" pointer-events=\"none\" style=\"transition: opacity 0.8s ease-in-out;\" />\r\n      </g>\r\n    `;\r\n\r\n    // Create element from markup using a temporary container\r\n    const container = document.createElementNS('http://www.w3.org/2000/svg', 'svg');\r\n    container.innerHTML = svgMarkup;\r\n    const element = container.firstElementChild as SVGGElement;\r\n\r\n    // Store reference to owned element\r\n    this.element = element;\r\n\r\n    // Attach click handler (defaults to more-info if no action configured)\r\n    // Only skip if explicitly set to 'none'\r\n    if (!this.tapAction || this.tapAction.action !== 'none') {\r\n      element.style.cursor = 'pointer';\r\n      element.addEventListener('click', (e) => {\r\n        this._handleTapAction();\r\n        e.stopPropagation();\r\n      });\r\n      \r\n      // Add hover effect\r\n      element.addEventListener('mouseenter', () => {\r\n        element.style.filter = 'brightness(1.1)';\r\n      });\r\n      element.addEventListener('mouseleave', () => {\r\n        element.style.filter = '';\r\n      });\r\n    }\r\n\r\n    return element;\r\n  }\r\n}\r\n","/**\r\n * Flow Renderer - Handles animated flow lines and dots between energy components\r\n */\r\n\r\n/** Position coordinates for flow paths */\r\nexport interface Position {\r\n  x: number;\r\n  y: number;\r\n}\r\n\r\n/** Animation state for flow dots */\r\nexport interface DotState {\r\n  /** Progress along path (0-1) */\r\n  progress: number;\r\n  /** Movement velocity in units per second */\r\n  velocity: number;\r\n}\r\n\r\n/**\r\n * FlowLine - Encapsulates a single animated flow line with glow effect and dots\r\n */\r\nclass FlowLine {\r\n  private glowPath: SVGPathElement;\r\n  private mainPath: SVGPathElement;\r\n  private dots: SVGCircleElement[] = [];\r\n  private dotStates: DotState[] = [];\r\n  private pathData: string;\r\n  private pathLength: number = 0;\r\n\r\n  constructor(\r\n    private group: SVGGElement,\r\n    private flowId: string,\r\n    from: Position,\r\n    to: Position,\r\n    power: number,\r\n    color: string,\r\n    private speedMultiplier: number,\r\n    private dotsPerFlow: number\r\n  ) {\r\n    const midX = (from.x + to.x) / 2;\r\n    const midY = (from.y + to.y) / 2;\r\n    this.pathData = `M ${from.x},${from.y} Q ${midX},${midY} ${to.x},${to.y}`;\r\n\r\n    // Calculate styles based on power\r\n    const { opacity, strokeWidth, dotRadius } = this.calculateStyles(power);\r\n    const velocity = this.calculateVelocity(power);\r\n\r\n    // Create glow path (wider, semi-transparent)\r\n    this.glowPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');\r\n    this.glowPath.setAttribute('d', this.pathData);\r\n    this.glowPath.setAttribute('class', 'flow-line');\r\n    this.glowPath.setAttribute('stroke', color);\r\n    this.glowPath.setAttribute('stroke-opacity', String(opacity * 0.5));\r\n    this.glowPath.setAttribute('stroke-width', String(strokeWidth * 2));\r\n    this.glowPath.setAttribute('fill', 'none');\r\n    this.glowPath.setAttribute('stroke-linecap', 'round');\r\n    this.glowPath.setAttribute('style', 'transition: stroke-opacity 0.5s ease-out, stroke-width 0.5s ease-out;');\r\n    this.glowPath.id = `glow-${flowId}`;\r\n    this.group.appendChild(this.glowPath);\r\n\r\n    // Create main path\r\n    this.mainPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');\r\n    this.mainPath.setAttribute('d', this.pathData);\r\n    this.mainPath.setAttribute('class', 'flow-line');\r\n    this.mainPath.setAttribute('stroke', color);\r\n    this.mainPath.setAttribute('stroke-opacity', String(opacity));\r\n    this.mainPath.setAttribute('stroke-width', String(strokeWidth));\r\n    this.mainPath.setAttribute('fill', 'none');\r\n    this.mainPath.setAttribute('stroke-linecap', 'round');\r\n    this.mainPath.setAttribute('style', 'transition: stroke-opacity 0.5s ease-out, stroke-width 0.5s ease-out;');\r\n    this.mainPath.id = `path-${flowId}`;\r\n    this.group.appendChild(this.mainPath);\r\n\r\n    // Get path length\r\n    this.pathLength = this.mainPath.getTotalLength();\r\n\r\n    // Create animated dots\r\n    for (let i = 0; i < this.dotsPerFlow; i++) {\r\n      const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');\r\n      dot.setAttribute('class', 'flow-dot');\r\n      dot.setAttribute('id', `dot-${flowId}-${i}`);\r\n      dot.setAttribute('r', String(dotRadius));\r\n      dot.setAttribute('fill', color);\r\n      dot.setAttribute('opacity', String(opacity));\r\n      dot.setAttribute('style', 'transition: opacity 0.5s ease-out, r 0.5s ease-out;');\r\n      this.group.appendChild(dot);\r\n      this.dots.push(dot);\r\n\r\n      const progress = i / this.dotsPerFlow;\r\n      this.dotStates.push({ progress, velocity });\r\n\r\n      // Set initial position\r\n      const point = this.mainPath.getPointAtLength(progress * this.pathLength);\r\n      dot.setAttribute('cx', String(point.x));\r\n      dot.setAttribute('cy', String(point.y));\r\n    }\r\n  }\r\n\r\n  private calculateStyles(power: number): { opacity: number; strokeWidth: number; dotRadius: number } {\r\n    let opacity: number;\r\n    if (power <= 100) {\r\n      opacity = 0.25;\r\n    } else if (power <= 200) {\r\n      opacity = 0.25 + ((power - 100) / 100) * 0.75;\r\n    } else {\r\n      opacity = 1;\r\n    }\r\n\r\n    const minWidth = 2;\r\n    const maxWidth = 23.76;\r\n    const maxPower = 10000;\r\n    let strokeWidth: number;\r\n    if (power <= 100) {\r\n      strokeWidth = minWidth;\r\n    } else {\r\n      const range = Math.min((power - 100) / (maxPower - 100), 1) * (maxWidth - minWidth);\r\n      strokeWidth = minWidth + range;\r\n    }\r\n\r\n    const baseDotRadius = 2.5;\r\n    const maxDotRadius = 3;\r\n    const scaledRadius = baseDotRadius * (strokeWidth / minWidth);\r\n    const dotRadius = Math.max(scaledRadius, maxDotRadius);\r\n\r\n    return { opacity, strokeWidth, dotRadius };\r\n  }\r\n\r\n  private calculateVelocity(power: number): number {\r\n    const baseSpeed = 40 * (power / 1000) * this.speedMultiplier;\r\n    return this.pathLength > 0 ? baseSpeed / this.pathLength : 0;\r\n  }\r\n\r\n  update(power: number, color: string): void {\r\n    const { opacity, strokeWidth, dotRadius } = this.calculateStyles(power);\r\n    const velocity = this.calculateVelocity(power);\r\n\r\n    // Update glow path\r\n    this.glowPath.setAttribute('stroke', color);\r\n    this.glowPath.setAttribute('stroke-opacity', String(opacity * 0.5));\r\n    this.glowPath.setAttribute('stroke-width', String(strokeWidth * 2));\r\n\r\n    // Update main path\r\n    this.mainPath.setAttribute('stroke', color);\r\n    this.mainPath.setAttribute('stroke-opacity', String(opacity));\r\n    this.mainPath.setAttribute('stroke-width', String(strokeWidth));\r\n\r\n    // Update dots\r\n    this.dots.forEach((dot, i) => {\r\n      dot.setAttribute('r', String(dotRadius));\r\n      dot.setAttribute('opacity', String(opacity));\r\n      dot.setAttribute('fill', color);\r\n      this.dotStates[i].velocity = velocity;\r\n    });\r\n  }\r\n\r\n  animate(deltaTime: number): void {\r\n    this.dotStates.forEach((state, i) => {\r\n      if (state.velocity > 0) {\r\n        // deltaTime is in milliseconds, convert to seconds\r\n        state.progress += state.velocity * (deltaTime / 1000);\r\n        if (state.progress >= 1) {\r\n          state.progress = state.progress % 1;\r\n        }\r\n\r\n        try {\r\n          if (this.pathLength > 0) {\r\n            const point = this.mainPath.getPointAtLength(state.progress * this.pathLength);\r\n            this.dots[i].setAttribute('cx', String(point.x));\r\n            this.dots[i].setAttribute('cy', String(point.y));\r\n          }\r\n        } catch (_e) {\r\n          // Ignore path errors\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  fadeOut(callback: () => void): void {\r\n    this.glowPath.setAttribute('stroke-opacity', '0');\r\n    this.mainPath.setAttribute('stroke-opacity', '0');\r\n    this.dots.forEach(dot => dot.setAttribute('opacity', '0'));\r\n    setTimeout(callback, 500);\r\n  }\r\n}\r\n\r\nexport class FlowRenderer {\r\n  private flowLines: Map<string, FlowLine> = new Map();\r\n  private animationFrameId: number | null = null;\r\n  private lastAnimationTime: number | null = null;\r\n  private speedMultiplier = 0.8;\r\n  private dotsPerFlow = 3;\r\n\r\n  constructor(\r\n    private container: SVGElement,\r\n    private positions: Record<string, Position>\r\n  ) {}\r\n\r\n  /**\r\n   * Update flows based on current power values\r\n   */\r\n  updateFlows(flows: {\r\n    productionToLoad: number;\r\n    productionToBattery: number;\r\n    productionToGrid: number;\r\n    gridToLoad: number;\r\n    gridToBattery: number;\r\n    batteryToLoad: number;\r\n  }): void {\r\n    const flowLayer = this.container.querySelector('#flow-layer') as SVGGElement;\r\n    if (!flowLayer) return;\r\n\r\n    const threshold = 0;\r\n    const batteryThreshold = 10;\r\n\r\n    // Update each flow with appropriate color\r\n    this.updateOrCreateFlow(flowLayer, 'production-to-load', this.positions.production, this.positions.load, flows.productionToLoad, '#4caf50', threshold);\r\n    this.updateOrCreateFlow(flowLayer, 'production-to-battery', this.positions.production, this.positions.battery, flows.productionToBattery, '#4caf50', threshold);\r\n    this.updateOrCreateFlow(flowLayer, 'battery-to-load', this.positions.battery, this.positions.load, flows.batteryToLoad, '#2196f3', batteryThreshold);\r\n    this.updateOrCreateFlow(flowLayer, 'grid-to-load', this.positions.grid, this.positions.load, flows.gridToLoad, '#f44336', threshold);\r\n    this.updateOrCreateFlow(flowLayer, 'grid-to-battery', this.positions.grid, this.positions.battery, flows.gridToBattery, '#f44336', threshold);\r\n    this.updateOrCreateFlow(flowLayer, 'production-to-grid', this.positions.production, this.positions.grid, flows.productionToGrid, '#ffeb3b', threshold);\r\n  }\r\n\r\n  /**\r\n   * Start animation loop\r\n   */\r\n  start(): void {\r\n    if (this.animationFrameId) return;\r\n    this.lastAnimationTime = performance.now();\r\n    this.animate();\r\n  }\r\n\r\n  /**\r\n   * Stop animation loop\r\n   */\r\n  stop(): void {\r\n    if (this.animationFrameId) {\r\n      cancelAnimationFrame(this.animationFrameId);\r\n      this.animationFrameId = null;\r\n      this.lastAnimationTime = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear all flows\r\n   */\r\n  clear(): void {\r\n    this.stop();\r\n    this.flowLines.clear();\r\n    const flowLayer = this.container.querySelector('#flow-layer') as SVGGElement;\r\n    if (flowLayer) {\r\n      flowLayer.innerHTML = '';\r\n    }\r\n  }\r\n\r\n  private animate = (): void => {\r\n    const now = performance.now();\r\n    const deltaTime = this.lastAnimationTime ? now - this.lastAnimationTime : 0;\r\n    this.lastAnimationTime = now;\r\n\r\n    // Animate each flow line\r\n    this.flowLines.forEach((flowLine) => {\r\n      flowLine.animate(deltaTime);\r\n    });\r\n\r\n    this.animationFrameId = requestAnimationFrame(this.animate);\r\n  };\r\n\r\n  private updateOrCreateFlow(\r\n    flowLayer: SVGGElement,\r\n    flowId: string,\r\n    from: Position,\r\n    to: Position,\r\n    power: number,\r\n    color: string,\r\n    threshold: number\r\n  ): void {\r\n    const existingFlowLine = this.flowLines.get(flowId);\r\n\r\n    if (power <= threshold) {\r\n      if (existingFlowLine) {\r\n        this.fadeOutFlow(flowLayer, flowId);\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (!existingFlowLine) {\r\n      this.drawFlow(flowLayer, flowId, from, to, power, color);\r\n    } else {\r\n      existingFlowLine.update(power, color);\r\n    }\r\n  }\r\n\r\n  private drawFlow(\r\n    flowLayer: SVGGElement,\r\n    flowId: string,\r\n    from: Position,\r\n    to: Position,\r\n    power: number,\r\n    color: string\r\n  ): void {\r\n    // Create flow group\r\n    const flowGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');\r\n    flowGroup.setAttribute('id', flowId);\r\n    flowLayer.appendChild(flowGroup);\r\n\r\n    // Create FlowLine instance\r\n    const flowLine = new FlowLine(\r\n      flowGroup,\r\n      flowId,\r\n      from,\r\n      to,\r\n      power,\r\n      color,\r\n      this.speedMultiplier,\r\n      this.dotsPerFlow\r\n    );\r\n\r\n    this.flowLines.set(flowId, flowLine);\r\n  }\r\n\r\n  private removeFlow(flowLayer: SVGGElement, flowId: string): void {\r\n    const flow = flowLayer.querySelector(`#${flowId}`);\r\n    if (flow) {\r\n      flow.remove();\r\n      this.flowLines.delete(flowId);\r\n    }\r\n  }\r\n\r\n  private fadeOutFlow(flowLayer: SVGGElement, flowId: string): void {\r\n    const flowLine = this.flowLines.get(flowId);\r\n    if (!flowLine) return;\r\n\r\n    flowLine.fadeOut(() => {\r\n      this.removeFlow(flowLayer, flowId);\r\n    });\r\n  }\r\n}\r\n","/**\r\n * DefaultRenderer\r\n * \r\n * Renders the default SVG view with meters and animated energy flows.\r\n * Works with Meter instances - does not abstract them away.\r\n */\r\n\r\nimport { Meter } from '../Meter';\r\nimport type { EnergyFlowCardConfig } from '../types/Config.d.ts';\r\nimport type { HomeAssistant } from '../types/HASS.d.ts';\r\nimport type { EnergyFlows } from '../types/EnergyFlow.d.ts';\r\nimport { FlowRenderer } from './FlowRenderer';\r\nimport type { Position } from './FlowRenderer';\r\n\r\nexport interface DefaultRenderData {\r\n  grid: number;\r\n  load: number;\r\n  production: number;\r\n  battery: number;\r\n  flows: EnergyFlows;\r\n}\r\n\r\n/**\r\n * DefaultRenderer coordinates the classic SVG meter visualization\r\n */\r\nexport class DefaultRenderer {\r\n  private container: HTMLElement;\r\n  private config: EnergyFlowCardConfig;\r\n  private hass: HomeAssistant;\r\n  private canvasWidth: number;\r\n  private canvasHeight: number;\r\n  private meterPositions: {\r\n    production: Position;\r\n    battery: Position;\r\n    grid: Position;\r\n    load: Position;\r\n  };\r\n  private meters: Map<string, Meter>;\r\n  private flowRenderer?: FlowRenderer;\r\n  private iconsExtracted: boolean;\r\n  private iconExtractionTimeouts: Set<number>;\r\n  private iconCache: Map<string, string>;\r\n  \r\n  private getDisplayNameCallback: (type: 'grid' | 'load' | 'production' | 'battery', fallback: string) => string;\r\n  private getIconCallback: (type: 'grid' | 'load' | 'production' | 'battery', fallback: string) => string;\r\n  private fireEventCallback: (event: string, detail?: any) => void;\r\n\r\n  constructor(\r\n    container: HTMLElement,\r\n    config: EnergyFlowCardConfig,\r\n    hass: HomeAssistant,\r\n    getDisplayNameCallback: (type: 'grid' | 'load' | 'production' | 'battery', fallback: string) => string,\r\n    getIconCallback: (type: 'grid' | 'load' | 'production' | 'battery', fallback: string) => string,\r\n    fireEventCallback: (event: string, detail?: any) => void\r\n  ) {\r\n    this.container = container;\r\n    this.config = config;\r\n    this.hass = hass;\r\n    this.getDisplayNameCallback = getDisplayNameCallback;\r\n    this.getIconCallback = getIconCallback;\r\n    this.fireEventCallback = fireEventCallback;\r\n    \r\n    this.meters = new Map();\r\n    this.iconsExtracted = false;\r\n    this.iconExtractionTimeouts = new Set();\r\n    this.iconCache = new Map();\r\n    \r\n    // Canvas dimensions\r\n    this.canvasWidth = 500;\r\n    this.canvasHeight = 470;\r\n    \r\n    // Global offset for all meters\r\n    const offsetX = 5;\r\n    const offsetY = 3;\r\n    \r\n    // Meter positions (circle centers) in SVG coordinates\r\n    this.meterPositions = {\r\n      production: { x: 60 + offsetX, y: 80 + offsetY },\r\n      battery: { x: 130 + offsetX, y: 240 + offsetY },\r\n      grid: { x: 60 + offsetX, y: 400 + offsetY },\r\n      load: { x: 360 + offsetX, y: 240 + offsetY }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Render the default view\r\n   */\r\n  render(data: DefaultRenderData): void {\r\n    const { grid, load, production, battery, flows } = data;\r\n\r\n    // Get min/max values with defaults\r\n    const gridMin = this.config.grid?.min ?? -5000;\r\n    const gridMax = this.config.grid?.max ?? 5000;\r\n    const loadMax = this.config.load.max ?? 5000;\r\n    const productionMax = this.config.production?.max ?? 5000;\r\n    const batteryMin = this.config.battery?.min ?? -5000;\r\n    const batteryMax = this.config.battery?.max ?? 5000;\r\n\r\n    // Only do full render if structure doesn't exist\r\n    if (!this.container.querySelector('.energy-flow-svg')) {\r\n      this.iconsExtracted = false;\r\n      this.initializeStructure(\r\n        grid, load, production, battery,\r\n        gridMin, gridMax, loadMax, productionMax, batteryMin, batteryMax\r\n      );\r\n      \r\n      // Extract icon paths\r\n      if (!this.iconsExtracted) {\r\n        requestAnimationFrame(() => {\r\n          this.extractIconPaths();\r\n        });\r\n      }\r\n      \r\n      // FlowRenderer will be initialized in initializeStructure's requestAnimationFrame\r\n    } else {\r\n      // Update existing meters\r\n      const productionMeter = this.meters.get('production');\r\n      const batteryMeter = this.meters.get('battery');\r\n      const gridMeter = this.meters.get('grid');\r\n      const loadMeter = this.meters.get('load');\r\n      \r\n      if (productionMeter) productionMeter.value = production;\r\n      if (batteryMeter) {\r\n        batteryMeter.invertView = this.config.battery?.invert?.view ?? false;\r\n        batteryMeter.value = battery;\r\n      }\r\n      if (gridMeter) gridMeter.value = grid;\r\n      if (loadMeter) loadMeter.value = load;\r\n      \r\n      // Initialize FlowRenderer if needed (for existing structure)\r\n      if (!this.flowRenderer) {\r\n        const svg = this.container.querySelector('.energy-flow-svg');\r\n        if (svg) {\r\n          this.flowRenderer = new FlowRenderer(svg as SVGElement, this.meterPositions);\r\n          this.flowRenderer.start(); // Start the animation loop\r\n        }\r\n      }\r\n    }\r\n\r\n    // Update flows\r\n    if (this.flowRenderer) {\r\n      this.flowRenderer.updateFlows(flows);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop animations and clean up\r\n   */\r\n  stop(): void {\r\n    // Stop flow animations\r\n    if (this.flowRenderer) {\r\n      this.flowRenderer.stop();\r\n    }\r\n    \r\n    // Stop meter animations\r\n    this.meters.forEach(meter => meter.stopAnimation());\r\n    \r\n    // Clear icon extraction timeouts\r\n    this.iconExtractionTimeouts.forEach(id => clearTimeout(id));\r\n    this.iconExtractionTimeouts.clear();\r\n  }\r\n\r\n  /**\r\n   * Clear all flows and stop animation\r\n   */\r\n  clear(): void {\r\n    this.stop();\r\n    if (this.flowRenderer) {\r\n      this.flowRenderer.clear();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initialize the HTML structure and create Meter instances\r\n   */\r\n  private initializeStructure(\r\n    grid: number,\r\n    load: number,\r\n    production: number,\r\n    battery: number,\r\n    gridMin: number,\r\n    gridMax: number,\r\n    loadMax: number,\r\n    productionMax: number,\r\n    batteryMin: number,\r\n    batteryMax: number\r\n  ): void {\r\n    // Create meter instances with tap actions\r\n    const productionMeter = new Meter('production', production, 0, productionMax, false, \r\n      this.getDisplayNameCallback('production', 'Production'),\r\n      this.getIconCallback('production', 'mdi:solar-power'),\r\n      'WATTS',\r\n      false,\r\n      false,\r\n      this.config.production?.tap,\r\n      this.config.production?.entity,\r\n      this.fireEventCallback);\r\n    const batteryMeter = new Meter('battery', battery, batteryMin, batteryMax, true,\r\n      this.getDisplayNameCallback('battery', 'Battery'),\r\n      this.getIconCallback('battery', 'mdi:battery'),\r\n      'WATTS',\r\n      this.config.battery?.invert?.view,\r\n      this.config.battery?.showPlus,\r\n      this.config.battery?.tap,\r\n      this.config.battery?.entity,\r\n      this.fireEventCallback);\r\n    const gridMeter = new Meter('grid', grid, gridMin, gridMax, true,\r\n      this.getDisplayNameCallback('grid', 'Grid'),\r\n      this.getIconCallback('grid', 'mdi:transmission-tower'),\r\n      'WATTS',\r\n      false,\r\n      false,\r\n      this.config.grid?.tap,\r\n      this.config.grid?.entity,\r\n      this.fireEventCallback);\r\n    const loadMeter = new Meter('load', load, 0, loadMax, false,\r\n      this.getDisplayNameCallback('load', 'Load'),\r\n      this.getIconCallback('load', 'mdi:home-lightning-bolt'),\r\n      'WATTS',\r\n      false,\r\n      false,\r\n      this.config.load.tap,\r\n      this.config.load.entity,\r\n      this.fireEventCallback);\r\n    \r\n    this.container.innerHTML = `\r\n      <ha-card>\r\n        <style>\r\n          :host {\r\n            display: block;\r\n            width: 100%;\r\n            height: 100%;\r\n          }\r\n          ha-card {\r\n            display: flex;\r\n            align-items: center;\r\n            justify-content: center;\r\n            width: 100%;\r\n            height: 100%;\r\n            padding: 8px;\r\n            box-sizing: border-box;\r\n            overflow: hidden;\r\n          }\r\n          .svg-wrapper {\r\n            width: 100%;\r\n            height: 100%;\r\n            display: flex;\r\n            align-items: center;\r\n            justify-content: center;\r\n          }\r\n          svg.energy-flow-svg {\r\n            display: block;\r\n            width: 100%;\r\n            height: 100%;\r\n          }\r\n          .flow-line {\r\n            fill: none;\r\n            stroke-linecap: round;\r\n          }\r\n          .flow-positive { stroke: var(--success-color, #4caf50); }\r\n          .flow-negative { stroke: var(--error-color, #f44336); }\r\n          .flow-dot {\r\n            offset-path: attr(data-path);\r\n            offset-distance: 0%;\r\n            animation: flow-move var(--flow-duration, 2s) linear infinite;\r\n          }\r\n          @keyframes flow-move {\r\n            from { offset-distance: 0%; }\r\n            to { offset-distance: 100%; }\r\n          }\r\n        </style>\r\n        <div class=\"svg-wrapper\">\r\n          <svg class=\"energy-flow-svg\" viewBox=\"0 0 ${this.canvasWidth} ${this.canvasHeight}\" xmlns=\"http://www.w3.org/2000/svg\" preserveAspectRatio=\"xMidYMid meet\">\r\n            <defs>\r\n              ${this.createMeterDefs()}\r\n            </defs>\r\n            \r\n            <!-- Flow lines layer (behind meters) -->\r\n            <g id=\"flow-layer\"></g>\r\n            \r\n            <!-- Production Meter (top left) -->\r\n            <g id=\"production-meter\" class=\"meter-group\" transform=\"translate(${this.meterPositions.production.x}, ${this.meterPositions.production.y})\"></g>\r\n            \r\n            <!-- Battery Meter (middle left, offset right) -->\r\n            <g id=\"battery-meter\" class=\"meter-group\" transform=\"translate(${this.meterPositions.battery.x}, ${this.meterPositions.battery.y})\"></g>\r\n            \r\n            <!-- Grid Meter (bottom left) -->\r\n            <g id=\"grid-meter\" class=\"meter-group\" transform=\"translate(${this.meterPositions.grid.x}, ${this.meterPositions.grid.y})\"></g>\r\n            \r\n            <!-- Load Meter (right, 2x size) -->\r\n            <g id=\"load-meter\" class=\"meter-group\" transform=\"translate(${this.meterPositions.load.x}, ${this.meterPositions.load.y}) scale(2)\"></g>\r\n          </svg>\r\n        </div>\r\n      </ha-card>\r\n    `;\r\n    \r\n    // Append meter elements and start animations\r\n    requestAnimationFrame(() => {\r\n      const productionContainer = this.container.querySelector('#production-meter');\r\n      const batteryContainer = this.container.querySelector('#battery-meter');\r\n      const gridContainer = this.container.querySelector('#grid-meter');\r\n      const loadContainer = this.container.querySelector('#load-meter');\r\n      \r\n      if (productionContainer) productionContainer.appendChild(productionMeter.createElement());\r\n      if (batteryContainer) batteryContainer.appendChild(batteryMeter.createElement());\r\n      if (gridContainer) gridContainer.appendChild(gridMeter.createElement());\r\n      if (loadContainer) loadContainer.appendChild(loadMeter.createElement());\r\n      \r\n      this.meters.set('production', productionMeter);\r\n      this.meters.set('battery', batteryMeter);\r\n      this.meters.set('grid', gridMeter);\r\n      this.meters.set('load', loadMeter);\r\n      \r\n      // Start each meter's animation\r\n      productionMeter.startAnimation();\r\n      batteryMeter.startAnimation();\r\n      gridMeter.startAnimation();\r\n      loadMeter.startAnimation();\r\n      \r\n      // Update initial dimming\r\n      productionMeter.updateDimming();\r\n      batteryMeter.updateDimming();\r\n      gridMeter.updateDimming();\r\n      loadMeter.updateDimming();\r\n      \r\n      // Initialize FlowRenderer now that SVG is ready\r\n      const svg = this.container.querySelector('.energy-flow-svg');\r\n      if (svg && !this.flowRenderer) {\r\n        this.flowRenderer = new FlowRenderer(svg as SVGElement, this.meterPositions);\r\n        this.flowRenderer.start(); // Start the animation loop\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create SVG filter definitions\r\n   */\r\n  private createMeterDefs(): string {\r\n    return `\r\n      <!-- Glow filter for flow lines -->\r\n      <filter id=\"glow\" x=\"-50%\" y=\"-50%\" width=\"200%\" height=\"200%\">\r\n        <feGaussianBlur in=\"SourceGraphic\" stdDeviation=\"3\" result=\"blur\" />\r\n        <feFlood flood-color=\"currentColor\" flood-opacity=\"0.5\" result=\"flood\" />\r\n        <feComposite in=\"flood\" in2=\"blur\" operator=\"in\" result=\"coloredBlur\" />\r\n        <feMerge>\r\n          <feMergeNode in=\"coloredBlur\" />\r\n          <feMergeNode in=\"SourceGraphic\" />\r\n        </feMerge>\r\n      </filter>\r\n      \r\n      <!-- Drop shadow filter for meters -->\r\n      <filter id=\"drop-shadow\" x=\"-50%\" y=\"-50%\" width=\"200%\" height=\"200%\">\r\n        <feGaussianBlur in=\"SourceAlpha\" stdDeviation=\"3\" result=\"blur\" />\r\n        <feOffset in=\"blur\" dx=\"0\" dy=\"2\" result=\"offsetBlur\" />\r\n        <feComponentTransfer in=\"offsetBlur\" result=\"shadow\">\r\n          <feFuncA type=\"linear\" slope=\"0.4\" />\r\n        </feComponentTransfer>\r\n        <feMerge>\r\n          <feMergeNode in=\"shadow\" />\r\n          <feMergeNode in=\"SourceGraphic\" />\r\n        </feMerge>\r\n      </filter>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Extract icon paths from ha-icon elements\r\n   */\r\n  private extractIconPaths(): void {\r\n    const meterIds = ['production', 'battery', 'grid', 'load'];\r\n    \r\n    meterIds.forEach(async (meterId) => {\r\n      const iconContainer = this.container.querySelector(`#icon-${meterId}`);\r\n      const iconSource = this.container.querySelector(`#ha-icon-${meterId}`);\r\n      \r\n      if (iconContainer && iconSource) {\r\n        const iconName = iconSource.getAttribute('icon') || 'unknown';\r\n        \r\n        // Check cache first\r\n        const cachedPath = this.iconCache.get(iconName);\r\n        if (cachedPath) {\r\n          this.renderIconPath(iconContainer, cachedPath);\r\n          return;\r\n        }\r\n        \r\n        const pathData = await this.extractIconPath(iconSource, iconName);\r\n        this.renderIconPath(iconContainer, pathData);\r\n      }\r\n    });\r\n    \r\n    this.iconsExtracted = true;\r\n  }\r\n\r\n  /**\r\n   * Extract SVG path from ha-icon element\r\n   */\r\n  private async extractIconPath(iconElement: Element, iconName: string, maxAttempts = 10): Promise<string | null> {\r\n    return new Promise((resolve) => {\r\n      const attemptExtraction = (attempt = 1, max = maxAttempts) => {\r\n        const delay = attempt === 1 ? 0 : 100 * attempt;\r\n        const timeoutId = window.setTimeout(async () => {\r\n          try {\r\n            const shadowRoot = (iconElement as any).shadowRoot;\r\n            if (!shadowRoot) {\r\n              if (attempt < max) {\r\n                attemptExtraction(attempt + 1, max);\r\n              } else {\r\n                resolve(null);\r\n              }\r\n              return;\r\n            }\r\n            \r\n            const svg = shadowRoot.querySelector('svg');\r\n            if (!svg) {\r\n              if (attempt < max) {\r\n                attemptExtraction(attempt + 1, max);\r\n              } else {\r\n                resolve(null);\r\n              }\r\n              return;\r\n            }\r\n            \r\n            const path = svg.querySelector('path');\r\n            if (path) {\r\n              const pathData = path.getAttribute('d');\r\n              if (pathData && this.iconCache) {\r\n                this.iconCache.set(iconName, pathData);\r\n              }\r\n              resolve(pathData);\r\n            } else {\r\n              if (attempt < max) {\r\n                attemptExtraction(attempt + 1, max);\r\n              } else {\r\n                resolve(null);\r\n              }\r\n            }\r\n          } catch (e) {\r\n            console.error(`Failed to extract icon path for ${iconName} (attempt ${attempt}):`, e);\r\n            if (attempt < max) {\r\n              attemptExtraction(attempt + 1, max);\r\n            } else {\r\n              resolve(null);\r\n            }\r\n          }\r\n        }, delay);\r\n        this.iconExtractionTimeouts.add(timeoutId);\r\n      };\r\n      \r\n      attemptExtraction();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Render an icon path in a container\r\n   */\r\n  private renderIconPath(container: Element, pathData: string | null): void {\r\n    container.innerHTML = '';\r\n    \r\n    if (pathData) {\r\n      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');\r\n      path.setAttribute('d', pathData);\r\n      path.setAttribute('fill', 'rgb(160, 160, 160)');\r\n      path.setAttribute('transform', 'scale(1)');\r\n      container.appendChild(path);\r\n    } else {\r\n      const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');\r\n      circle.setAttribute('cx', '12');\r\n      circle.setAttribute('cy', '12');\r\n      circle.setAttribute('r', '8');\r\n      circle.setAttribute('fill', 'rgb(160, 160, 160)');\r\n      container.appendChild(circle);\r\n    }\r\n  }\r\n}\r\n","/**\r\n * Chart utility functions for rendering SVG chart elements\r\n */\r\n\r\nexport function createGridLines(\r\n  chartWidth: number,\r\n  chartHeight: number,\r\n  margin: { top: number; left: number }\r\n): string {\r\n  const lines: string[] = [];\r\n  const numLines = 4;\r\n  \r\n  for (let i = 0; i <= numLines; i++) {\r\n    const y = margin.top + (i * chartHeight / numLines);\r\n    lines.push(`<line x1=\"${margin.left}\" y1=\"${y}\" x2=\"${margin.left + chartWidth}\" y2=\"${y}\" stroke=\"white\" stroke-width=\"1\" />`);\r\n  }\r\n  \r\n  return lines.join('\\n');\r\n}\r\n\r\nexport function createTimeLabels(\r\n  chartWidth: number,\r\n  chartHeight: number,\r\n  margin: { top: number; bottom: number; left: number },\r\n  hoursToShow: number\r\n): string {\r\n  const labels: string[] = [];\r\n  const numLabels = 6;\r\n  const now = new Date();\r\n  \r\n  for (let i = 0; i <= numLabels; i++) {\r\n    const hoursAgo = hoursToShow - (i * hoursToShow / numLabels);\r\n    const time = new Date(now.getTime() - hoursAgo * 60 * 60 * 1000);\r\n    \r\n    // Quantize to nearest 30-minute mark\r\n    const currentMinutes = time.getMinutes();\r\n    const quantizedMinutes = currentMinutes < 15 ? 0 : (currentMinutes < 45 ? 30 : 0);\r\n    const hourAdjust = (currentMinutes >= 45) ? 1 : 0;\r\n    \r\n    time.setMinutes(quantizedMinutes);\r\n    time.setSeconds(0);\r\n    time.setMilliseconds(0);\r\n    if (hourAdjust) {\r\n      time.setHours(time.getHours() + hourAdjust);\r\n    }\r\n    \r\n    const x = margin.left + (i * chartWidth / numLabels);\r\n    const y = margin.top + chartHeight + 20;\r\n    \r\n    // Format as 12-hour AM/PM\r\n    const hours = time.getHours();\r\n    const hours12 = hours === 0 ? 12 : (hours > 12 ? hours - 12 : hours);\r\n    const ampm = hours >= 12 ? 'PM' : 'AM';\r\n    \r\n    labels.push(`\r\n      <text x=\"${x}\" y=\"${y}\" text-anchor=\"middle\" fill=\"rgb(160, 160, 160)\" font-size=\"11\">\r\n        ${hours12} ${ampm}\r\n      </text>\r\n    `);\r\n  }\r\n  \r\n  return labels.join('\\n');\r\n}\r\n\r\nexport function createYAxisLabels(\r\n  supplyHeight: number,\r\n  demandHeight: number,\r\n  margin: { top: number; left: number },\r\n  maxSupply: number,\r\n  maxDemand: number,\r\n  zeroLineY: number\r\n): string {\r\n  const labels: string[] = [];\r\n  \r\n  // Top label (max supply)\r\n  labels.push(`<text x=\"${margin.left - 10}\" y=\"${margin.top + 5}\" text-anchor=\"end\" fill=\"rgb(160, 160, 160)\" font-size=\"11\">${Math.round(maxSupply)}W</text>`);\r\n  \r\n  // Zero line label\r\n  labels.push(`<text x=\"${margin.left - 10}\" y=\"${zeroLineY + 5}\" text-anchor=\"end\" fill=\"rgb(160, 160, 160)\" font-size=\"11\">0</text>`);\r\n  \r\n  // Bottom label (max demand, shown as negative)\r\n  labels.push(`<text x=\"${margin.left - 10}\" y=\"${zeroLineY + demandHeight + 5}\" text-anchor=\"end\" fill=\"rgb(160, 160, 160)\" font-size=\"11\">-${Math.round(maxDemand)}W</text>`);\r\n  \r\n  return labels.join('\\n');\r\n}\r\n\r\nexport function createAreaPath(\r\n  dataPoints: Array<any>,\r\n  xStep: number,\r\n  centerY: number,\r\n  yScale: number,\r\n  margin: { top: number; right: number; bottom: number; left: number },\r\n  valueGetter: (d: any) => number,\r\n  baseValueGetter: number | ((d: any) => number),\r\n  direction: 'up' | 'down'\r\n): string | null {\r\n  const points: Array<{ x: number; y: number }> = [];\r\n  const basePoints: Array<{ x: number; y: number }> = [];\r\n  \r\n  let hasData = false;\r\n\r\n  dataPoints.forEach((d, i) => {\r\n    const x = margin.left + i * xStep;\r\n    const value = valueGetter(d);\r\n    const baseValue = typeof baseValueGetter === 'function' ? baseValueGetter(d) : baseValueGetter;\r\n    \r\n    if (value > 0) hasData = true;\r\n    \r\n    const yOffset = direction === 'down' \r\n      ? -(value + baseValue) * yScale \r\n      : (value + baseValue) * yScale;\r\n    const baseYOffset = direction === 'down'\r\n      ? -baseValue * yScale\r\n      : baseValue * yScale;\r\n    \r\n    points.push({ x, y: centerY + yOffset });\r\n    basePoints.push({ x, y: centerY + baseYOffset });\r\n  });\r\n\r\n  if (!hasData) return null;\r\n\r\n  // Create path: go along top edge, then back along bottom edge\r\n  let path = `M ${points[0].x} ${points[0].y}`;\r\n  for (let i = 1; i < points.length; i++) {\r\n    path += ` L ${points[i].x} ${points[i].y}`;\r\n  }\r\n  for (let i = basePoints.length - 1; i >= 0; i--) {\r\n    path += ` L ${basePoints[i].x} ${basePoints[i].y}`;\r\n  }\r\n  path += ' Z';\r\n\r\n  return path;\r\n}\r\n\r\nexport function createLoadLine(\r\n  dataPoints: Array<any>,\r\n  chartWidth: number,\r\n  chartHeight: number,\r\n  yScale: number,\r\n  margin: { top: number; right: number; bottom: number; left: number },\r\n  zeroLineY: number\r\n): string {\r\n  if (!dataPoints || dataPoints.length === 0) return '';\r\n\r\n  const xStep = dataPoints.length > 1 ? chartWidth / (dataPoints.length - 1) : 0;\r\n\r\n  // Create line path showing load on the supply (positive) side\r\n  const pathPoints = dataPoints.map((d, i) => {\r\n    const x = margin.left + i * xStep;\r\n    const y = zeroLineY - d.load * yScale; // Positive values go up from zero line\r\n    return `${i === 0 ? 'M' : 'L'} ${x},${y}`;\r\n  }).join(' ');\r\n\r\n  return `<path d=\"${pathPoints}\" fill=\"none\" stroke=\"#CCCCCC\" stroke-width=\"3\" opacity=\"0.9\" />`;\r\n}\r\n","import { createGridLines, createTimeLabels, createYAxisLabels, createAreaPath, createLoadLine } from '../chart/chart-utils';\r\nimport { handleAction } from '../utils/helpers';\r\n\r\nexport interface ChartConfig {\r\n  production_entity: string;\r\n  grid_entity: string;\r\n  load_entity: string;\r\n  battery_entity: string;\r\n  invert_battery_data?: boolean;\r\n  production_icon?: string;\r\n  grid_icon?: string;\r\n  load_icon?: string;\r\n  battery_icon?: string;\r\n  production_tap_action?: any;\r\n  grid_tap_action?: any;\r\n  load_tap_action?: any;\r\n  battery_tap_action?: any;\r\n}\r\n\r\nexport interface DataPoint {\r\n  time: Date;\r\n  solar: number;\r\n  batteryDischarge: number;\r\n  batteryCharge: number;\r\n  gridImport: number;\r\n  gridExport: number;\r\n  load: number;\r\n}\r\n\r\nexport interface LiveChartValues {\r\n  grid: number;\r\n  load: number;\r\n  production: number;\r\n  battery: number;\r\n}\r\n\r\nexport interface ChartDataCache {\r\n  timestamp: number;\r\n  dataPoints: DataPoint[];\r\n}\r\n\r\n/**\r\n * ChartRenderer handles all chart mode rendering logic.\r\n * Responsibilities:\r\n * - Fetch and process historical data\r\n * - Render stacked area charts with proper scaling\r\n * - Extract and render icons from Home Assistant\r\n * - Update chart indicators with live values\r\n * - Handle click interactions on chart elements\r\n */\r\nexport class ChartRenderer {\r\n  private hass: any;\r\n  private config: ChartConfig;\r\n  private fireEvent: (type: string, detail?: any) => void;\r\n  private iconCache: Map<string, string> = new Map();\r\n  private chartDataCache?: ChartDataCache;\r\n  private chartRenderPending = false;\r\n  private indicatorUpdateTimeout?: number;\r\n  private lastIndicatorUpdate = 0;\r\n  private liveChartValues?: LiveChartValues;\r\n\r\n  constructor(hass: any, config: ChartConfig, fireEvent: (type: string, detail?: any) => void) {\r\n    this.hass = hass;\r\n    this.config = config;\r\n    this.fireEvent = fireEvent;\r\n  }\r\n\r\n  /**\r\n   * Update live chart values for indicators\r\n   */\r\n  updateLiveValues(values: LiveChartValues): void {\r\n    this.liveChartValues = values;\r\n  }\r\n\r\n  /**\r\n   * Render chart view (main entry point)\r\n   */\r\n  render(container: HTMLElement): void {\r\n    // Initialize chart structure if needed\r\n    if (!container.querySelector('.chart-view')) {\r\n      this.initializeChartStructure(container);\r\n    } else if (this.liveChartValues) {\r\n      // Update live values for indicators\r\n      this.throttledUpdateChartIndicators(container);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initialize chart HTML structure\r\n   */\r\n  private initializeChartStructure(container: HTMLElement): void {\r\n    container.innerHTML = `\r\n      <ha-card>\r\n        <style>\r\n          :host {\r\n            display: block;\r\n            width: 100%;\r\n            height: 100%;\r\n          }\r\n          ha-card {\r\n            padding: 0;\r\n            box-sizing: border-box;\r\n            width: 100%;\r\n            height: 100%;\r\n            display: flex;\r\n            flex-direction: column;\r\n          }\r\n          .chart-view {\r\n            display: flex;\r\n            flex-direction: column;\r\n            width: 100%;\r\n            flex: 1;\r\n            min-height: 0;\r\n          }\r\n          .chart-container {\r\n            flex: 1;\r\n            position: relative;\r\n            min-height: 200px;\r\n            overflow: hidden;\r\n          }\r\n          svg.chart-svg {\r\n            width: 100%;\r\n            height: 100%;\r\n          }\r\n          .loading-message {\r\n            position: absolute;\r\n            top: 50%;\r\n            left: 50%;\r\n            transform: translate(-50%, -50%);\r\n            color: rgb(160, 160, 160);\r\n            font-size: 14px;\r\n          }\r\n        </style>\r\n        <div class=\"chart-view\">\r\n          <div class=\"chart-container\">\r\n            <div class=\"loading-message\">Loading history data...</div>\r\n            <svg class=\"chart-svg\" viewBox=\"0 0 800 400\" preserveAspectRatio=\"xMidYMid meet\">\r\n              <!-- Chart will be rendered here -->\r\n            </svg>\r\n          </div>\r\n        </div>\r\n      </ha-card>\r\n    `;\r\n\r\n    // Fetch and render chart data\r\n    const svg = container.querySelector('.chart-svg');\r\n    if (svg) {\r\n      setTimeout(() => {\r\n        this.fetchAndRenderChart(svg, 12);\r\n      }, 100);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Throttle chart indicator updates\r\n   */\r\n  private throttledUpdateChartIndicators(container: HTMLElement): void {\r\n    if (this.indicatorUpdateTimeout) {\r\n      clearTimeout(this.indicatorUpdateTimeout);\r\n      this.indicatorUpdateTimeout = undefined;\r\n    }\r\n\r\n    const now = Date.now();\r\n    const timeSinceLastUpdate = now - this.lastIndicatorUpdate;\r\n    const minUpdateInterval = 250;\r\n\r\n    if (timeSinceLastUpdate >= minUpdateInterval) {\r\n      const svg = container.querySelector('.chart-svg');\r\n      if (svg) this.updateChartIndicators(svg);\r\n      this.lastIndicatorUpdate = now;\r\n    } else {\r\n      const delay = minUpdateInterval - timeSinceLastUpdate;\r\n      this.indicatorUpdateTimeout = window.setTimeout(() => {\r\n        const svg = container.querySelector('.chart-svg');\r\n        if (svg) this.updateChartIndicators(svg);\r\n        this.lastIndicatorUpdate = Date.now();\r\n        this.indicatorUpdateTimeout = undefined;\r\n      }, delay);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cleanup resources\r\n   */\r\n  cleanup(): void {\r\n    if (this.indicatorUpdateTimeout) {\r\n      clearTimeout(this.indicatorUpdateTimeout);\r\n      this.indicatorUpdateTimeout = undefined;\r\n    }\r\n    this.chartDataCache = undefined;\r\n  }\r\n\r\n  /**\r\n   * Get icon name from config or use default\r\n   */\r\n  private getIcon(iconConfigKey: string, entityConfigKey: string, fallback: string): string {\r\n    const configIcon = (this.config as any)[iconConfigKey];\r\n    if (configIcon) return configIcon;\r\n\r\n    const entityId = (this.config as any)[entityConfigKey];\r\n    if (entityId && this.hass.states[entityId]) {\r\n      const entityIcon = this.hass.states[entityId].attributes.icon;\r\n      if (entityIcon) return entityIcon;\r\n    }\r\n\r\n    return fallback;\r\n  }\r\n\r\n  /**\r\n   * Fetch and render chart, using cache if available\r\n   */\r\n  async fetchAndRenderChart(svgElement: Element, hoursToShow = 12): Promise<void> {\r\n    if (this.chartRenderPending) return;\r\n\r\n    const now = Date.now();\r\n    const cacheAge = this.chartDataCache ? now - this.chartDataCache.timestamp : Infinity;\r\n    const cacheMaxAge = 5 * 60 * 1000; // 5 minutes\r\n\r\n    // Clear expired cache\r\n    if (this.chartDataCache && cacheAge >= cacheMaxAge) {\r\n      this.chartDataCache = undefined;\r\n    }\r\n\r\n    // Use cached data if fresh\r\n    if (this.chartDataCache && cacheAge < cacheMaxAge) {\r\n      requestAnimationFrame(() => {\r\n        this.renderChartFromCache(svgElement);\r\n      });\r\n      return;\r\n    }\r\n\r\n    this.chartRenderPending = true;\r\n    const end = new Date();\r\n    const start = new Date(end.getTime() - hoursToShow * 60 * 60 * 1000);\r\n\r\n    try {\r\n      // Fetch history for all entities in parallel\r\n      const [productionHistory, gridHistory, loadHistory, batteryHistory] = await Promise.all([\r\n        this.fetchHistory(this.config.production_entity, start, end),\r\n        this.fetchHistory(this.config.grid_entity, start, end),\r\n        this.fetchHistory(this.config.load_entity, start, end),\r\n        this.fetchHistory(this.config.battery_entity, start, end),\r\n      ]);\r\n\r\n      // Process chart\r\n      const processChart = () => {\r\n        this.drawStackedAreaChart(svgElement, productionHistory, gridHistory, loadHistory, batteryHistory, hoursToShow);\r\n        this.chartRenderPending = false;\r\n      };\r\n\r\n      if ('requestIdleCallback' in window) {\r\n        (window as any).requestIdleCallback(processChart, { timeout: 2000 });\r\n      } else {\r\n        setTimeout(processChart, 0);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error fetching chart data:', error);\r\n      this.chartRenderPending = false;\r\n      svgElement.innerHTML = `\r\n        <text x=\"400\" y=\"200\" text-anchor=\"middle\" fill=\"rgb(160, 160, 160)\" font-size=\"14\">\r\n          Error loading chart data\r\n        </text>\r\n      `;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Fetch history from Home Assistant\r\n   */\r\n  private async fetchHistory(entityId: string, start: Date, end: Date): Promise<Array<{ state: string; last_changed: string }>> {\r\n    const url = `history/period/${start.toISOString()}?filter_entity_id=${entityId}&end_time=${end.toISOString()}&minimal_response&no_attributes`;\r\n    \r\n    const response = await this.hass.callApi('GET', url);\r\n    return response && response.length > 0 ? response[0] : [];\r\n  }\r\n\r\n  /**\r\n   * Render chart from cached data\r\n   */\r\n  renderChartFromCache(svgElement: Element): void {\r\n    if (!this.chartDataCache) return;\r\n\r\n    const dataPoints = this.chartDataCache.dataPoints;\r\n    \r\n    // Calculate scaling\r\n    const maxSupply = Math.max(...dataPoints.map(d => d.solar + d.batteryDischarge + d.gridImport), ...dataPoints.map(d => d.load));\r\n    const maxDemand = Math.max(...dataPoints.map(d => d.batteryCharge + d.gridExport));\r\n    const totalRange = maxSupply + maxDemand;\r\n    const supplyRatio = totalRange > 0 ? maxSupply / totalRange : 0.5;\r\n    const demandRatio = totalRange > 0 ? maxDemand / totalRange : 0.5;\r\n\r\n    const width = 800;\r\n    const height = 400;\r\n    const margin = { top: 20, right: 150, bottom: 40, left: 60 };\r\n    const chartWidth = width - margin.left - margin.right;\r\n    const chartHeight = height - margin.top - margin.bottom;\r\n\r\n    const supplyHeight = chartHeight * supplyRatio;\r\n    const demandHeight = chartHeight * demandRatio;\r\n    \r\n    const supplyScale = maxSupply > 0 ? supplyHeight / (maxSupply * 1.1) : 1;\r\n    const demandScale = maxDemand > 0 ? demandHeight / (maxDemand * 1.1) : 1;\r\n    const zeroLineY = margin.top + supplyHeight;\r\n\r\n    // Render chart paths\r\n    const supplyPaths = this.createStackedPaths(dataPoints, chartWidth, supplyHeight, supplyScale, margin, 'supply', zeroLineY);\r\n    const demandPaths = this.createStackedPaths(dataPoints, chartWidth, demandHeight, demandScale, margin, 'demand', zeroLineY);\r\n    const loadLine = createLoadLine(dataPoints, chartWidth, supplyHeight, supplyScale, margin, zeroLineY);\r\n\r\n    const chartContent = `\r\n      <g opacity=\"0.1\">\r\n        ${createGridLines(chartWidth, chartHeight, margin)}\r\n      </g>\r\n      <line x1=\"${margin.left}\" y1=\"${zeroLineY}\" x2=\"${margin.left + chartWidth}\" y2=\"${zeroLineY}\" stroke=\"rgb(160, 160, 160)\" stroke-width=\"1\" stroke-dasharray=\"4,4\" />\r\n      ${demandPaths}\r\n      ${supplyPaths}\r\n      ${createTimeLabels(chartWidth, chartHeight, margin, 12)}\r\n      ${createYAxisLabels(supplyHeight, demandHeight, margin, maxSupply, maxDemand, zeroLineY)}\r\n    `;\r\n\r\n    svgElement.innerHTML = chartContent;\r\n    \r\n    this.updateChartIndicators(svgElement);\r\n    this.addLoadLineOnTop(svgElement, loadLine);\r\n  }\r\n\r\n  /**\r\n   * Draw stacked area chart from history data\r\n   */\r\n  private async drawStackedAreaChart(\r\n    svgElement: Element,\r\n    productionHistory: Array<{ state: string; last_changed: string }>,\r\n    gridHistory: Array<{ state: string; last_changed: string }>,\r\n    loadHistory: Array<{ state: string; last_changed: string }>,\r\n    batteryHistory: Array<{ state: string; last_changed: string }>,\r\n    hoursToShow: number\r\n  ): Promise<void> {\r\n    const width = 800;\r\n    const height = 400;\r\n    const margin = { top: 20, right: 150, bottom: 40, left: 60 };\r\n    const chartWidth = width - margin.left - margin.right;\r\n    const chartHeight = height - margin.top - margin.bottom;\r\n\r\n    // Collect 30-second raw data, then average into 5-minute visible ticks\r\n    const rawPointsPerHour = 120;\r\n    const totalRawPoints = hoursToShow * rawPointsPerHour;\r\n    const visiblePointsPerHour = 12;\r\n    const totalVisiblePoints = hoursToShow * visiblePointsPerHour;\r\n    const rawPointsPerVisibleTick = 10;\r\n    \r\n    // Quantize to nearest 5-minute interval\r\n    const now = new Date();\r\n    const endMinutes = Math.floor(now.getMinutes() / 5) * 5;\r\n    const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours(), endMinutes, 0, 0);\r\n    const start = new Date(end.getTime() - hoursToShow * 60 * 60 * 1000);\r\n\r\n    // Process data in chunks\r\n    const chunkSize = 240;\r\n    const rawDataPoints: DataPoint[] = [];\r\n\r\n    for (let chunkStart = 0; chunkStart < totalRawPoints; chunkStart += chunkSize) {\r\n      const chunkEnd = Math.min(chunkStart + chunkSize, totalRawPoints);\r\n      \r\n      if (chunkStart > 0) {\r\n        await new Promise(resolve => setTimeout(resolve, 0));\r\n      }\r\n      \r\n      for (let i = chunkStart; i < chunkEnd; i++) {\r\n        const time = new Date(start.getTime() + i * 30 * 1000);\r\n        \r\n        const production = this.interpolateValue(productionHistory, time);\r\n        const grid = this.interpolateValue(gridHistory, time);\r\n        const load = this.interpolateValue(loadHistory, time);\r\n        let battery = this.interpolateValue(batteryHistory, time);\r\n        \r\n        if (this.config.invert_battery_data) {\r\n          battery = -battery;\r\n        }\r\n\r\n        rawDataPoints.push({\r\n          time,\r\n          solar: Math.max(0, production),\r\n          batteryDischarge: Math.max(0, battery),\r\n          batteryCharge: Math.max(0, -battery),\r\n          gridImport: Math.max(0, grid),\r\n          gridExport: Math.max(0, -grid),\r\n          load: Math.max(0, load),\r\n        });\r\n      }\r\n    }\r\n\r\n    // Average into 5-minute points\r\n    const dataPoints: DataPoint[] = [];\r\n\r\n    for (let i = 0; i < totalVisiblePoints; i++) {\r\n      const visibleTime = new Date(start.getTime() + (i + 1) * 5 * 60 * 1000);\r\n      const startIdx = i * rawPointsPerVisibleTick;\r\n      const endIdx = Math.min(startIdx + rawPointsPerVisibleTick, rawDataPoints.length);\r\n      const windowSize = endIdx - startIdx;\r\n      \r\n      let solarSum = 0, batteryDischargeSum = 0, batteryChargeSum = 0;\r\n      let gridImportSum = 0, gridExportSum = 0, loadSum = 0;\r\n      \r\n      for (let j = startIdx; j < endIdx; j++) {\r\n        solarSum += rawDataPoints[j].solar;\r\n        batteryDischargeSum += rawDataPoints[j].batteryDischarge;\r\n        batteryChargeSum += rawDataPoints[j].batteryCharge;\r\n        gridImportSum += rawDataPoints[j].gridImport;\r\n        gridExportSum += rawDataPoints[j].gridExport;\r\n        loadSum += rawDataPoints[j].load;\r\n      }\r\n\r\n      dataPoints.push({\r\n        time: visibleTime,\r\n        solar: solarSum / windowSize,\r\n        batteryDischarge: batteryDischargeSum / windowSize,\r\n        batteryCharge: batteryChargeSum / windowSize,\r\n        gridImport: gridImportSum / windowSize,\r\n        gridExport: gridExportSum / windowSize,\r\n        load: loadSum / windowSize,\r\n      });\r\n    }\r\n\r\n    // Cache processed data\r\n    this.chartDataCache = {\r\n      timestamp: Date.now(),\r\n      dataPoints\r\n    };\r\n\r\n    // Calculate scaling\r\n    const maxSupply = Math.max(...dataPoints.map(d => d.solar + d.batteryDischarge + d.gridImport), ...dataPoints.map(d => d.load));\r\n    const maxDemand = Math.max(...dataPoints.map(d => d.batteryCharge + d.gridExport));\r\n    \r\n    const totalRange = maxSupply + maxDemand;\r\n    const supplyRatio = totalRange > 0 ? maxSupply / totalRange : 0.5;\r\n    const demandRatio = totalRange > 0 ? maxDemand / totalRange : 0.5;\r\n    \r\n    const supplyScale = maxSupply > 0 ? (chartHeight * supplyRatio) / (maxSupply * 1.1) : 1;\r\n    const demandScale = maxDemand > 0 ? (chartHeight * demandRatio) / (maxDemand * 1.1) : 1;\r\n    const scale = Math.min(supplyScale, demandScale);\r\n    \r\n    const supplyHeight = maxSupply * scale * 1.1;\r\n    const demandHeight = maxDemand * scale * 1.1;\r\n    const zeroLineY = margin.top + supplyHeight;\r\n\r\n    // Create paths\r\n    const supplyPaths = this.createStackedPaths(dataPoints, chartWidth, supplyHeight, scale, margin, 'supply', zeroLineY);\r\n    const demandPaths = this.createStackedPaths(dataPoints, chartWidth, demandHeight, scale, margin, 'demand', zeroLineY);\r\n    const loadLine = createLoadLine(dataPoints, chartWidth, supplyHeight, scale, margin, zeroLineY);\r\n\r\n    // Build SVG content\r\n    const svgContent = `\r\n      <g opacity=\"0.1\">\r\n        ${createGridLines(chartWidth, chartHeight, margin)}\r\n      </g>\r\n      <line x1=\"${margin.left}\" y1=\"${zeroLineY}\" x2=\"${margin.left + chartWidth}\" y2=\"${zeroLineY}\" stroke=\"rgb(160, 160, 160)\" stroke-width=\"1\" stroke-dasharray=\"4,4\" />\r\n      ${demandPaths}\r\n      ${supplyPaths}\r\n      ${createTimeLabels(chartWidth, chartHeight, margin, hoursToShow)}\r\n      ${createYAxisLabels(supplyHeight, demandHeight, margin, maxSupply, maxDemand, zeroLineY)}\r\n      ${this.createChartIconSources()}\r\n    `;\r\n\r\n    svgElement.innerHTML = svgContent;\r\n    \r\n    // Add click handlers\r\n    this.attachChartAreaClickHandlers(svgElement);\r\n    \r\n    // Progressive rendering\r\n    requestAnimationFrame(() => {\r\n      requestAnimationFrame(() => {\r\n        requestAnimationFrame(() => {\r\n          this.extractChartIcons(svgElement, dataPoints, chartWidth, supplyHeight, demandHeight, scale, scale, margin, zeroLineY);\r\n          \r\n          requestAnimationFrame(() => {\r\n            this.addLoadLineOnTop(svgElement, loadLine);\r\n          });\r\n        });\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Interpolate value from history at specific time\r\n   */\r\n  private interpolateValue(history: Array<{ state: string; last_changed: string }>, targetTime: Date): number {\r\n    if (history.length === 0) return 0;\r\n\r\n    let closestPoint = history[0];\r\n    let minDiff = Math.abs(new Date(history[0].last_changed).getTime() - targetTime.getTime());\r\n\r\n    for (const point of history) {\r\n      const diff = Math.abs(new Date(point.last_changed).getTime() - targetTime.getTime());\r\n      if (diff < minDiff) {\r\n        minDiff = diff;\r\n        closestPoint = point;\r\n      }\r\n    }\r\n\r\n    return parseFloat(closestPoint.state) || 0;\r\n  }\r\n\r\n  /**\r\n   * Create stacked area paths for supply or demand\r\n   */\r\n  private createStackedPaths(\r\n    dataPoints: DataPoint[],\r\n    chartWidth: number,\r\n    chartHeight: number,\r\n    yScale: number,\r\n    margin: { top: number; right: number; bottom: number; left: number },\r\n    type: 'supply' | 'demand',\r\n    zeroLineY: number\r\n  ): string {\r\n    const totalPoints = dataPoints.length;\r\n    const xStep = chartWidth / (totalPoints - 1);\r\n\r\n    if (type === 'supply') {\r\n      const solarPath = createAreaPath(dataPoints, xStep, zeroLineY, yScale, margin, \r\n        d => d.solar, 0, 'down');\r\n      \r\n      const batteryPath = createAreaPath(dataPoints, xStep, zeroLineY, yScale, margin,\r\n        d => d.batteryDischarge, d => d.solar, 'down');\r\n      \r\n      const gridPath = createAreaPath(dataPoints, xStep, zeroLineY, yScale, margin,\r\n        d => d.gridImport, d => d.solar + d.batteryDischarge, 'down');\r\n\r\n      return `\r\n        ${gridPath ? `<path id=\"chart-area-grid-import\" d=\"${gridPath}\" fill=\"#c62828\" opacity=\"0.8\" style=\"cursor: pointer;\" />` : ''}\r\n        ${batteryPath ? `<path id=\"chart-area-battery-discharge\" d=\"${batteryPath}\" fill=\"#1976d2\" opacity=\"0.8\" style=\"cursor: pointer;\" />` : ''}\r\n        ${solarPath ? `<path id=\"chart-area-solar\" d=\"${solarPath}\" fill=\"#388e3c\" opacity=\"0.85\" style=\"cursor: pointer;\" />` : ''}\r\n      `;\r\n    } else {\r\n      const batteryChargePath = createAreaPath(dataPoints, xStep, zeroLineY, yScale, margin,\r\n        d => d.batteryCharge, 0, 'up');\r\n      \r\n      const gridExportPath = createAreaPath(dataPoints, xStep, zeroLineY, yScale, margin,\r\n        d => d.gridExport, d => d.batteryCharge, 'up');\r\n\r\n      return `\r\n        ${gridExportPath ? `<path id=\"chart-area-grid-export\" d=\"${gridExportPath}\" fill=\"#f9a825\" opacity=\"0.8\" style=\"cursor: pointer;\" />` : ''}\r\n        ${batteryChargePath ? `<path id=\"chart-area-battery-charge\" d=\"${batteryChargePath}\" fill=\"#1976d2\" opacity=\"0.8\" style=\"cursor: pointer;\" />` : ''}\r\n      `;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create hidden icon sources for extraction\r\n   */\r\n  private createChartIconSources(): string {\r\n    const loadIcon = this.getIcon('load_icon', 'load_entity', 'mdi:home-lightning-bolt');\r\n    const solarIcon = this.getIcon('production_icon', 'production_entity', 'mdi:solar-power');\r\n    const batteryIcon = this.getIcon('battery_icon', 'battery_entity', 'mdi:battery');\r\n    const gridIcon = this.getIcon('grid_icon', 'grid_entity', 'mdi:transmission-tower');\r\n\r\n    return `\r\n      <foreignObject id=\"chart-icon-source-load\" x=\"-100\" y=\"-100\" width=\"24\" height=\"24\">\r\n        <div xmlns=\"http://www.w3.org/1999/xhtml\">\r\n          <ha-icon icon=\"${loadIcon}\"></ha-icon>\r\n        </div>\r\n      </foreignObject>\r\n      <foreignObject id=\"chart-icon-source-solar\" x=\"-100\" y=\"-100\" width=\"24\" height=\"24\">\r\n        <div xmlns=\"http://www.w3.org/1999/xhtml\">\r\n          <ha-icon icon=\"${solarIcon}\"></ha-icon>\r\n        </div>\r\n      </foreignObject>\r\n      <foreignObject id=\"chart-icon-source-battery\" x=\"-100\" y=\"-100\" width=\"24\" height=\"24\">\r\n        <div xmlns=\"http://www.w3.org/1999/xhtml\">\r\n          <ha-icon icon=\"${batteryIcon}\"></ha-icon>\r\n        </div>\r\n      </foreignObject>\r\n      <foreignObject id=\"chart-icon-source-grid\" x=\"-100\" y=\"-100\" width=\"24\" height=\"24\">\r\n        <div xmlns=\"http://www.w3.org/1999/xhtml\">\r\n          <ha-icon icon=\"${gridIcon}\"></ha-icon>\r\n        </div>\r\n      </foreignObject>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Extract icon paths from Home Assistant icons\r\n   */\r\n  private async extractChartIcons(\r\n    svgElement: Element,\r\n    dataPoints: DataPoint[],\r\n    chartWidth: number,\r\n    supplyHeight: number,\r\n    demandHeight: number,\r\n    supplyScale: number,\r\n    demandScale: number,\r\n    margin: { top: number; right: number; bottom: number; left: number },\r\n    zeroLineY: number\r\n  ): Promise<void> {\r\n    if (dataPoints.length === 0) return;\r\n\r\n    const iconTypes = ['load', 'solar', 'battery', 'grid'];\r\n    const iconPaths: { [key: string]: string | null } = {};\r\n\r\n    for (const type of iconTypes) {\r\n      const iconSourceFO = svgElement.querySelector(`#chart-icon-source-${type}`);\r\n      if (!iconSourceFO) continue;\r\n\r\n      const haIconDiv = iconSourceFO.querySelector('div');\r\n      if (!haIconDiv) continue;\r\n\r\n      const iconSource = haIconDiv.querySelector('ha-icon');\r\n      if (!iconSource) continue;\r\n\r\n      const iconName = iconSource.getAttribute('icon');\r\n      if (!iconName) continue;\r\n\r\n      if (this.iconCache.has(iconName)) {\r\n        iconPaths[type] = this.iconCache.get(iconName) || null;\r\n        continue;\r\n      }\r\n\r\n      const pathData = await this.extractIconPath(iconSource, iconName);\r\n      iconPaths[type] = pathData;\r\n      if (pathData) {\r\n        this.iconCache.set(iconName, pathData);\r\n      }\r\n    }\r\n\r\n    this.renderChartIndicators(svgElement, dataPoints, chartWidth, supplyHeight, demandHeight, supplyScale, demandScale, margin, iconPaths, zeroLineY);\r\n  }\r\n\r\n  /**\r\n   * Extract single icon path from shadow DOM\r\n   */\r\n  private async extractIconPath(iconElement: Element, iconName: string, maxAttempts = 10): Promise<string | null> {\r\n    for (let attempt = 0; attempt < maxAttempts; attempt++) {\r\n      try {\r\n        const shadowRoot = iconElement.shadowRoot;\r\n        if (!shadowRoot) {\r\n          await new Promise(resolve => setTimeout(resolve, 100));\r\n          continue;\r\n        }\r\n\r\n        let svgElement = shadowRoot.querySelector('svg');\r\n        \r\n        if (!svgElement) {\r\n          const haSvgIcon = shadowRoot.querySelector('ha-svg-icon');\r\n          if (haSvgIcon && haSvgIcon.shadowRoot) {\r\n            svgElement = haSvgIcon.shadowRoot.querySelector('svg');\r\n          }\r\n        }\r\n\r\n        if (!svgElement) {\r\n          await new Promise(resolve => setTimeout(resolve, 100));\r\n          continue;\r\n        }\r\n\r\n        const pathElement = svgElement.querySelector('path');\r\n        if (!pathElement) {\r\n          await new Promise(resolve => setTimeout(resolve, 100));\r\n          continue;\r\n        }\r\n\r\n        const pathData = pathElement.getAttribute('d');\r\n        if (pathData) {\r\n          return pathData;\r\n        }\r\n      } catch (e) {\r\n        console.error(`Failed to extract icon path for ${iconName} (attempt ${attempt + 1}):`, e);\r\n      }\r\n      \r\n      await new Promise(resolve => setTimeout(resolve, 100));\r\n    }\r\n    \r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Render chart indicators with native SVG\r\n   */\r\n  private renderChartIndicators(\r\n    svgElement: Element,\r\n    dataPoints: DataPoint[],\r\n    chartWidth: number,\r\n    supplyHeight: number,\r\n    demandHeight: number,\r\n    supplyScale: number,\r\n    demandScale: number,\r\n    margin: { top: number; right: number; bottom: number; left: number },\r\n    iconPaths: { [key: string]: string | null },\r\n    zeroLineY: number\r\n  ): void {\r\n    let indicatorsGroup = svgElement.querySelector('#chart-indicators') as SVGGElement | null;\r\n    const isFirstRender = !indicatorsGroup;\r\n    \r\n    if (!indicatorsGroup) {\r\n      indicatorsGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');\r\n      indicatorsGroup.setAttribute('id', 'chart-indicators');\r\n      svgElement.appendChild(indicatorsGroup);\r\n    }\r\n\r\n    if (isFirstRender) {\r\n      const iconSources = svgElement.querySelectorAll('[id^=\"chart-icon-source-\"]');\r\n      iconSources.forEach(source => source.remove());\r\n    }\r\n\r\n    // Use live values or last historical point\r\n    let currentValues;\r\n    if (this.liveChartValues) {\r\n      const { grid, load, production, battery } = this.liveChartValues;\r\n      currentValues = {\r\n        load: Math.max(0, load),\r\n        solar: Math.max(0, production),\r\n        batteryDischarge: Math.max(0, battery),\r\n        batteryCharge: Math.max(0, -battery),\r\n        gridImport: Math.max(0, grid),\r\n        gridExport: Math.max(0, -grid),\r\n      };\r\n    } else {\r\n      currentValues = dataPoints[dataPoints.length - 1];\r\n    }\r\n\r\n    const rightX = margin.left + chartWidth;\r\n\r\n    // Calculate Y positions\r\n    const loadY = zeroLineY - currentValues.load * supplyScale;\r\n    const solarY = zeroLineY - currentValues.solar * supplyScale;\r\n    const batteryDischargeY = zeroLineY - (currentValues.solar + currentValues.batteryDischarge) * supplyScale;\r\n    const gridImportY = zeroLineY - (currentValues.solar + currentValues.batteryDischarge + currentValues.gridImport) * supplyScale;\r\n    const batteryChargeY = zeroLineY + currentValues.batteryCharge * demandScale;\r\n    const gridExportY = zeroLineY + (currentValues.batteryCharge + currentValues.gridExport) * demandScale;\r\n\r\n    const formatValue = (value: number): string => {\r\n      return `${Math.round(value)} W`;\r\n    };\r\n\r\n    const updateIndicator = (id: string, y: number, color: string, iconType: string, value: string, prefix = '', shouldShow = true, entity?: string, tapAction?: any) => {\r\n      let group = indicatorsGroup!.querySelector(`#${id}`) as SVGGElement | null;\r\n      \r\n      if (!shouldShow) {\r\n        if (group) group.remove();\r\n        return;\r\n      }\r\n      \r\n      if (!group) {\r\n        group = document.createElementNS('http://www.w3.org/2000/svg', 'g');\r\n        group.setAttribute('id', id);\r\n        group.style.cursor = 'pointer';\r\n        \r\n        const iconPath = iconPaths[iconType];\r\n        if (iconPath) {\r\n          const icon = document.createElementNS('http://www.w3.org/2000/svg', 'g');\r\n          icon.setAttribute('class', 'indicator-icon');\r\n          icon.setAttribute('transform', 'translate(10, -8) scale(0.67)');\r\n          \r\n          const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');\r\n          path.setAttribute('d', iconPath);\r\n          path.setAttribute('fill', color);\r\n          icon.appendChild(path);\r\n          \r\n          group.appendChild(icon);\r\n        }\r\n\r\n        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');\r\n        text.setAttribute('class', 'indicator-text');\r\n        text.setAttribute('x', '28');\r\n        text.setAttribute('y', '4');\r\n        text.setAttribute('fill', color);\r\n        text.setAttribute('font-size', '12');\r\n        text.setAttribute('font-weight', '600');\r\n        group.appendChild(text);\r\n        \r\n        if (entity && tapAction) {\r\n          group.addEventListener('click', () => {\r\n            handleAction(this.hass, this.fireEvent, tapAction, entity);\r\n          });\r\n        }\r\n        \r\n        indicatorsGroup!.appendChild(group);\r\n      }\r\n      \r\n      group.setAttribute('transform', `translate(${rightX + 10}, ${y})`);\r\n      \r\n      const text = group.querySelector('.indicator-text');\r\n      if (text) {\r\n        text.textContent = `${prefix}${value}`;\r\n      }\r\n    };\r\n\r\n    // Update all indicators\r\n    updateIndicator('indicator-solar', solarY, '#388e3c', 'solar', formatValue(currentValues.solar), '', currentValues.solar > 0, this.config.production_entity, this.config.production_tap_action);\r\n    updateIndicator('indicator-battery-discharge', batteryDischargeY, '#1976d2', 'battery', formatValue(currentValues.batteryDischarge), '+', currentValues.batteryDischarge > 0, this.config.battery_entity, this.config.battery_tap_action);\r\n    updateIndicator('indicator-grid-import', gridImportY, '#c62828', 'grid', formatValue(currentValues.gridImport), '', currentValues.gridImport > 0, this.config.grid_entity, this.config.grid_tap_action);\r\n    updateIndicator('indicator-battery-charge', batteryChargeY, '#1976d2', 'battery', formatValue(currentValues.batteryCharge), '-', currentValues.batteryCharge > 0, this.config.battery_entity, this.config.battery_tap_action);\r\n    updateIndicator('indicator-grid-export', gridExportY, '#f9a825', 'grid', formatValue(currentValues.gridExport), '', currentValues.gridExport > 0, this.config.grid_entity, this.config.grid_tap_action);\r\n    updateIndicator('indicator-load', loadY, '#CCCCCC', 'load', formatValue(currentValues.load), '', true, this.config.load_entity, this.config.load_tap_action);\r\n  }\r\n\r\n  /**\r\n   * Update chart indicators with throttling\r\n   */\r\n  updateChartIndicators(svgElement: Element): void {\r\n    if (!this.chartDataCache || !svgElement) return;\r\n\r\n    const dataPoints = this.chartDataCache.dataPoints;\r\n    const maxSupply = Math.max(...dataPoints.map(d => d.solar + d.batteryDischarge + d.gridImport), ...dataPoints.map(d => d.load));\r\n    const maxDemand = Math.max(...dataPoints.map(d => d.batteryCharge + d.gridExport));\r\n    \r\n    const totalRange = maxSupply + maxDemand;\r\n    const supplyRatio = totalRange > 0 ? maxSupply / totalRange : 0.5;\r\n    const demandRatio = totalRange > 0 ? maxDemand / totalRange : 0.5;\r\n\r\n    const width = 800;\r\n    const height = 400;\r\n    const margin = { top: 20, right: 150, bottom: 40, left: 60 };\r\n    const chartWidth = width - margin.left - margin.right;\r\n    const chartHeight = height - margin.top - margin.bottom;\r\n\r\n    const supplyHeight = chartHeight * supplyRatio;\r\n    const demandHeight = chartHeight * demandRatio;\r\n    \r\n    const supplyScale = maxSupply > 0 ? supplyHeight / (maxSupply * 1.1) : 1;\r\n    const demandScale = maxDemand > 0 ? demandHeight / (maxDemand * 1.1) : 1;\r\n    const zeroLineY = margin.top + supplyHeight;\r\n\r\n    // Get cached icon paths\r\n    const iconPaths: { [key: string]: string | null } = {};\r\n    ['load', 'solar', 'battery', 'grid'].forEach(type => {\r\n      const iconName = this.getIcon(`${type}_icon`, `${type}_entity`, '');\r\n      if (this.iconCache.has(iconName)) {\r\n        iconPaths[type] = this.iconCache.get(iconName) || null;\r\n      }\r\n    });\r\n\r\n    this.renderChartIndicators(svgElement, dataPoints, chartWidth, supplyHeight, demandHeight, supplyScale, demandScale, margin, iconPaths, zeroLineY);\r\n  }\r\n\r\n  /**\r\n   * Add load line on top of chart\r\n   */\r\n  private addLoadLineOnTop(svgElement: Element, loadLine: string): void {\r\n    if (!loadLine) return;\r\n    \r\n    const existingLoadLine = svgElement.querySelector('#load-line');\r\n    if (existingLoadLine) {\r\n      existingLoadLine.remove();\r\n    }\r\n    \r\n    const pathMatch = loadLine.match(/d=\"([^\"]+)\"/);\r\n    if (!pathMatch) return;\r\n    \r\n    const pathData = pathMatch[1];\r\n    \r\n    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');\r\n    path.setAttribute('id', 'load-line');\r\n    path.setAttribute('d', pathData);\r\n    path.setAttribute('fill', 'none');\r\n    path.setAttribute('stroke', '#CCCCCC');\r\n    path.setAttribute('stroke-width', '3');\r\n    path.setAttribute('opacity', '0.9');\r\n    path.style.cursor = 'pointer';\r\n    \r\n    path.addEventListener('click', () => {\r\n      handleAction(this.hass, this.fireEvent, this.config.load_tap_action, this.config.load_entity);\r\n    });\r\n    \r\n    svgElement.appendChild(path);\r\n  }\r\n\r\n  /**\r\n   * Attach click handlers to chart areas\r\n   */\r\n  private attachChartAreaClickHandlers(svgElement: Element): void {\r\n    const solarArea = svgElement.querySelector('#chart-area-solar');\r\n    if (solarArea) {\r\n      solarArea.addEventListener('click', () => {\r\n        handleAction(this.hass, this.fireEvent, this.config.production_tap_action, this.config.production_entity);\r\n      });\r\n    }\r\n    \r\n    const batteryDischargeArea = svgElement.querySelector('#chart-area-battery-discharge');\r\n    if (batteryDischargeArea) {\r\n      batteryDischargeArea.addEventListener('click', () => {\r\n        handleAction(this.hass, this.fireEvent, this.config.battery_tap_action, this.config.battery_entity);\r\n      });\r\n    }\r\n    \r\n    const batteryChargeArea = svgElement.querySelector('#chart-area-battery-charge');\r\n    if (batteryChargeArea) {\r\n      batteryChargeArea.addEventListener('click', () => {\r\n        handleAction(this.hass, this.fireEvent, this.config.battery_tap_action, this.config.battery_entity);\r\n      });\r\n    }\r\n    \r\n    const gridImportArea = svgElement.querySelector('#chart-area-grid-import');\r\n    if (gridImportArea) {\r\n      gridImportArea.addEventListener('click', () => {\r\n        handleAction(this.hass, this.fireEvent, this.config.grid_tap_action, this.config.grid_entity);\r\n      });\r\n    }\r\n    \r\n    const gridExportArea = svgElement.querySelector('#chart-area-grid-export');\r\n    if (gridExportArea) {\r\n      gridExportArea.addEventListener('click', () => {\r\n        handleAction(this.hass, this.fireEvent, this.config.grid_tap_action, this.config.grid_entity);\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear cache (e.g., when data becomes stale)\r\n   */\r\n  clearCache(): void {\r\n    this.chartDataCache = undefined;\r\n  }\r\n}\r\n","import { calculateEnergyFlows } from './flow-calculator';\r\nimport type { BatteryEntityConfig, EnergyFlowCardConfig, EntityConfig } from './types/Config.d.ts';\r\nimport type { HomeAssistant } from './types/HASS.d.ts';\r\nimport { CompactRenderer } from './renderers/CompactRenderer';\r\nimport type { CompactViewMode } from './renderers/CompactRenderer';\r\nimport { DefaultRenderer } from './renderers/DefaultRenderer';\r\nimport { ChartRenderer } from './renderers/chart-renderer';\r\n\r\n// Main card class\r\nclass EnergyFlowCard extends HTMLElement {\r\n  private _resizeObserver: ResizeObserver | null;\r\n  private _config?: EnergyFlowCardConfig;\r\n  private _hass?: HomeAssistant;\r\n  private _lastViewMode?: string;\r\n  private _compactRenderer?: CompactRenderer;\r\n  private _defaultRenderer?: DefaultRenderer;\r\n  private _chartRenderer?: ChartRenderer;\r\n\r\n  constructor() {\r\n    super();\r\n    this._resizeObserver = null;\r\n  }\r\n\r\n  static getStubConfig() {\r\n    return {};\r\n  }\r\n\r\n  static getConfigForm() {\r\n    return {\r\n      schema: [\r\n        { name: \"view_mode\", label: \"View Mode\", selector: { select: { options: [{value: \"default\", label: \"Default\"}, {value: \"compact\", label: \"Compact Bar\"}, {value: \"compact-battery\", label: \"Compact with Battery\"}, {value: \"chart\", label: \"Chart\"}] } } },\r\n        { name: \"grid_entity\", label: \"Grid\", required: true, selector: { entity: { domain: \"sensor\", device_class: \"power\" } } },\r\n        { name: \"grid_name\", selector: { entity_name: {} }, context: { entity: \"grid_entity\" } },\r\n        { name: \"grid_icon\", selector: { icon: {} }, context: { icon_entity: \"grid_entity\" } },\r\n        { name: \"grid_min\", label: \"Grid Min (W)\", selector: { number: { mode: \"box\" } } },\r\n        { name: \"grid_max\", label: \"Grid Max (W)\", selector: { number: { mode: \"box\" } } },\r\n        { name: \"grid_tap_action\", label: \"Grid Tap Action\", selector: { \"ui-action\": {} } },\r\n        { name: \"load_entity\", label: \"Load\", required: true, selector: { entity: { domain: \"sensor\", device_class: \"power\" } } },\r\n        { name: \"load_name\", selector: { entity_name: {} }, context: { entity: \"load_entity\" } },\r\n        { name: \"load_icon\", selector: { icon: {} }, context: { icon_entity: \"load_entity\" } },\r\n        { name: \"load_max\", label: \"Load Max (W)\", selector: { number: { mode: \"box\" } } },\r\n        { name: \"load_tap_action\", label: \"Load Tap Action\", selector: { \"ui-action\": {} } },\r\n        { name: \"production_entity\", label: \"Production\", required: true, selector: { entity: { domain: \"sensor\", device_class: \"power\" } } },\r\n        { name: \"production_name\", selector: { entity_name: {} }, context: { entity: \"production_entity\" } },\r\n        { name: \"production_icon\", selector: { icon: {} }, context: { icon_entity: \"production_entity\" } },\r\n        { name: \"production_max\", label: \"Production Max (W)\", selector: { number: { mode: \"box\" } } },\r\n        { name: \"production_tap_action\", label: \"Production Tap Action\", selector: { \"ui-action\": {} } },\r\n        { name: \"battery_entity\", label: \"Battery\", required: true, selector: { entity: { domain: \"sensor\", device_class: \"power\" } } },\r\n        { name: \"battery_name\", selector: { entity_name: {} }, context: { entity: \"battery_entity\" } },\r\n        { name: \"battery_icon\", selector: { icon: {} }, context: { icon_entity: \"battery_entity\" } },\r\n        { name: \"battery_min\", label: \"Battery Min (W)\", selector: { number: { mode: \"box\" } } },\r\n        { name: \"battery_max\", label: \"Battery Max (W)\", selector: { number: { mode: \"box\" } } },\r\n        { name: \"battery_tap_action\", label: \"Battery Tap Action\", selector: { \"ui-action\": {} } },\r\n        { name: \"battery_soc_entity\", label: \"Battery SOC (%) Entity\", selector: { entity: { domain: \"sensor\" } } },\r\n        { name: \"invert_battery_data\", label: \"Invert Battery Data\", selector: { boolean: {} } },\r\n        { name: \"invert_battery_view\", label: \"Invert Battery View\", selector: { boolean: {} } },\r\n        { name: \"show_plus\", label: \"Show + Sign\", selector: { boolean: {} } }\r\n      ]\r\n    };\r\n  }\r\n\r\n  connectedCallback() {\r\n    // Set up resize observer to redraw flows when card is resized\r\n    this._resizeObserver = new ResizeObserver(() => {\r\n      // Renderers handle their own resize logic\r\n    });\r\n    \r\n    // Observe the container, not the card itself\r\n    if (this.parentElement) {\r\n      this._resizeObserver.observe(this.parentElement);\r\n    }\r\n    this._resizeObserver.observe(this);\r\n    \r\n    // Animation loop will be started on first render to avoid race conditions\r\n  }\r\n\r\n  disconnectedCallback() {\r\n    if (this._resizeObserver) {\r\n      this._resizeObserver.disconnect();\r\n      this._resizeObserver = null;\r\n    }\r\n    \r\n    // Stop renderers\r\n    if (this._defaultRenderer) {\r\n      this._defaultRenderer.stop();\r\n    }\r\n    if (this._chartRenderer) {\r\n      this._chartRenderer.cleanup();\r\n    }\r\n  }\r\n\r\n  setConfig(config: EnergyFlowCardConfig): void {\r\n    this._config = this._normalizeConfig(config);\r\n    this._renderSafely('setConfig');\r\n  }\r\n\r\n  set hass(hass: HomeAssistant) {\r\n    this._hass = hass;\r\n    this._renderSafely('hass update');\r\n  }\r\n\r\n  private _renderSafely(context: string) {\r\n    try {\r\n      this._render();\r\n    } catch (error) {\r\n      console.error('[EnergyFlowCard] render failed during', context, error);\r\n      this.innerHTML = `\r\n        <ha-card>\r\n          <div style=\"padding:16px;\">\r\n            Energy Flow Card failed to render. Check browser console for details.\r\n          </div>\r\n        </ha-card>\r\n      `;\r\n    }\r\n  }\r\n\r\n  _render() {\r\n    if (!this._config || !this._hass) return;\r\n    if (!this._config.load) return; // Load entity is required\r\n\r\n    const gridState = this._getEntityState(this._config.grid?.entity);\r\n    const loadState = this._getEntityState(this._config.load.entity);\r\n    const productionState = this._getEntityState(this._config.production?.entity);\r\n    const batteryState = this._getEntityState(this._config.battery?.entity);\r\n\r\n    // Calculate flow directions and magnitudes\r\n    const grid = parseFloat(gridState?.state ?? '0') || 0;\r\n    const load = parseFloat(loadState?.state ?? '0') || 0;\r\n    const production = parseFloat(productionState?.state ?? '0') || 0;\r\n    let battery = parseFloat(batteryState?.state ?? '0') || 0;\r\n    \r\n    // Invert battery data if configured (affects interpretation)\r\n    if (this._config.battery?.invert?.data) {\r\n      battery = -battery;\r\n    }\r\n\r\n    // Check view mode\r\n    const viewMode = this._config.mode || 'default';\r\n    \r\n    // Clean up chart cache if switching away from chart view\r\n    if (this._lastViewMode === 'chart' && viewMode !== 'chart' && this._chartRenderer) {\r\n      this._chartRenderer.cleanup();\r\n    }\r\n    \r\n    if (viewMode === 'compact' || viewMode === 'compact-battery') {\r\n      this._renderCompactView(grid, load, production, battery, viewMode as CompactViewMode);\r\n      this._lastViewMode = viewMode;\r\n      return;\r\n    }\r\n    if (viewMode === 'chart') {\r\n      // Initialize ChartRenderer if needed\r\n      if (!this._chartRenderer) {\r\n        const chartConfig = {\r\n          production_entity: this._config.production?.entity || '',\r\n          grid_entity: this._config.grid?.entity || '',\r\n          load_entity: this._config.load.entity,\r\n          battery_entity: this._config.battery?.entity || '',\r\n          invert_battery_data: this._config.battery?.invert?.data,\r\n          production_icon: this._config.production?.icon,\r\n          grid_icon: this._config.grid?.icon,\r\n          load_icon: this._config.load.icon,\r\n          battery_icon: this._config.battery?.icon,\r\n          production_tap_action: this._config.production?.tap,\r\n          grid_tap_action: this._config.grid?.tap,\r\n          load_tap_action: this._config.load.tap,\r\n          battery_tap_action: this._config.battery?.tap\r\n        };\r\n        this._chartRenderer = new ChartRenderer(this._hass, chartConfig, this._fireEvent.bind(this));\r\n      }\r\n      \r\n      // Update live values and render\r\n      this._chartRenderer.updateLiveValues({ grid, load, production, battery });\r\n      this._chartRenderer.render(this);\r\n      this._lastViewMode = viewMode;\r\n      return;\r\n    }\r\n\r\n    // Initialize DefaultRenderer if needed\r\n    if (!this._defaultRenderer) {\r\n      this._defaultRenderer = new DefaultRenderer(\r\n        this,\r\n        this._config,\r\n        this._hass,\r\n        this._getDisplayName.bind(this),\r\n        this._getIcon.bind(this),\r\n        this._fireEvent.bind(this)\r\n      );\r\n    }\r\n    \r\n    // Calculate flows and render\r\n    const flows = this._calculateFlows(grid, production, load, battery);\r\n    this._defaultRenderer.render({ grid, load, production, battery, flows });\r\n\r\n    this._lastViewMode = viewMode;\r\n  }\r\n\r\n  private _getEntityState(entityId: string | undefined) {\r\n    if (!entityId) return undefined;\r\n    return this._hass?.states?.[entityId];\r\n  }\r\n\r\n  private _getEntityConfigByType(type: 'grid' | 'load' | 'production' | 'battery') {\r\n    return this._config?.[type];\r\n  }\r\n\r\n  private _getDisplayName(type: 'grid' | 'load' | 'production' | 'battery', fallback: string): string {\r\n    const entityConfig = this._getEntityConfigByType(type);\r\n    if (!entityConfig) return fallback;\r\n    \r\n    // Check if custom name is set in config\r\n    if (entityConfig.name) {\r\n      return entityConfig.name;\r\n    }\r\n    \r\n    // Fall back to entity friendly name\r\n    if (entityConfig.entity) {\r\n      const entityState = this._getEntityState(entityConfig.entity);\r\n      if (entityState?.attributes?.friendly_name) {\r\n        return entityState.attributes.friendly_name;\r\n      }\r\n    }\r\n    \r\n    // Fall back to default label\r\n    return fallback;\r\n  }\r\n\r\n  private _getIcon(type: 'grid' | 'load' | 'production' | 'battery', fallback: string): string {\r\n    const entityConfig = this._getEntityConfigByType(type);\r\n    if (!entityConfig) return fallback;\r\n    \r\n    // Check if custom icon is set in config\r\n    if (entityConfig.icon) {\r\n      return entityConfig.icon;\r\n    }\r\n    \r\n    // Fall back to entity icon\r\n    if (entityConfig.entity) {\r\n      const entityState = this._getEntityState(entityConfig.entity);\r\n      if (entityState?.attributes?.icon) {\r\n        return entityState.attributes.icon;\r\n      }\r\n    }\r\n    \r\n    // Fall back to default icon\r\n    return fallback;\r\n  }\r\n\r\n  private _handleAction(actionConfig: any | undefined, entityId?: string): void {\r\n    if (!this._hass) return;\r\n    \r\n    // Default to more-info if no action configured\r\n    const config = actionConfig || { action: 'more-info' };\r\n    const action = config.action || 'more-info';\r\n    \r\n    switch (action) {\r\n      case 'more-info':\r\n        const entityToShow = config.entity || entityId;\r\n        this._fireEvent('hass-more-info', { entityId: entityToShow });\r\n        break;\r\n        \r\n      case 'navigate':\r\n        if (config.navigation_path) {\r\n          history.pushState(null, '', config.navigation_path);\r\n          this._fireEvent('location-changed', { replace: config.navigation_replace || false });\r\n        }\r\n        break;\r\n        \r\n      case 'url':\r\n        if (config.url_path) {\r\n          window.open(config.url_path);\r\n        }\r\n        break;\r\n        \r\n      case 'toggle':\r\n        this._hass.callService('homeassistant', 'toggle', { entity_id: entityId });\r\n        break;\r\n        \r\n      case 'perform-action':\r\n        if (config.perform_action) {\r\n          const [domain, service] = config.perform_action.split('.');\r\n          this._hass.callService(domain, service, config.data || {}, config.target);\r\n        }\r\n        break;\r\n        \r\n      case 'assist':\r\n        this._fireEvent('show-dialog', {\r\n          dialogTag: 'ha-voice-command-dialog',\r\n          dialogParams: {\r\n            pipeline_id: config.pipeline_id || 'last_used',\r\n            start_listening: config.start_listening\r\n          }\r\n        });\r\n        break;\r\n        \r\n      case 'none':\r\n        // Do nothing\r\n        break;\r\n    }\r\n  }\r\n\r\n  private _fireEvent(type: string, detail: any = {}): void {\r\n    // Handle call-service events specially\r\n    if (type === 'call-service' && this._hass) {\r\n      this._hass.callService(detail.domain, detail.service, detail.service_data || {}, detail.target);\r\n      return;\r\n    }\r\n    \r\n    const event = new CustomEvent(type, {\r\n      detail,\r\n      bubbles: true,\r\n      composed: true\r\n    });\r\n    this.dispatchEvent(event);\r\n  }\r\n\r\n  /**\r\n   * Calculate energy flows between meters based on sensor readings.\r\n   * Uses the tested calculateEnergyFlows function.\r\n   */\r\n  private _calculateFlows(grid: number, production: number, load: number, battery: number) {\r\n    return calculateEnergyFlows({ grid, production, load, battery });\r\n  }\r\n\r\n  private _renderCompactView(grid: number, load: number, production: number, battery: number, viewMode: CompactViewMode): void {\r\n    if (!this._config || !this._hass) return;\r\n\r\n    // Initialize CompactRenderer if needed\r\n    if (!this._compactRenderer) {\r\n      this._compactRenderer = new CompactRenderer(\r\n        this,\r\n        this._config,\r\n        this._hass,\r\n        viewMode,\r\n        (type, fallback) => this._getIcon(type, fallback),\r\n        (action, entity) => this._handleAction(action, entity)\r\n      );\r\n    } else {\r\n      this._compactRenderer.setViewMode(viewMode);\r\n    }\r\n\r\n    // Use the same flow calculator to get accurate contributions to load\r\n    const flows = this._calculateFlows(grid, production, load, battery);\r\n\r\n    // Get battery SOC if available\r\n    let batterySoc: number | null = null;\r\n    if (this._config.battery?.soc_entity) {\r\n      const socState = this._getEntityState(this._config.battery.soc_entity);\r\n      batterySoc = parseFloat(socState?.state ?? '0') || 0;\r\n    }\r\n\r\n    // Render\r\n    this._compactRenderer.render({\r\n      grid,\r\n      load,\r\n      production,\r\n      battery,\r\n      flows,\r\n      batterySoc\r\n    });\r\n  }\r\n\r\n  private _normalizeConfig(config: EnergyFlowCardConfig | Record<string, any>): EnergyFlowCardConfig {\r\n    // If already in the expected nested shape, return as-is\r\n    if ((config as EnergyFlowCardConfig).load) {\r\n      return config as EnergyFlowCardConfig;\r\n    }\r\n\r\n    const normalizeEntity = (prefix: string): EntityConfig | undefined => {\r\n      const entityId = (config as any)[`${prefix}_entity`];\r\n      if (!entityId) return undefined;\r\n\r\n      const normalized: EntityConfig = { entity: entityId };\r\n      const name = (config as any)[`${prefix}_name`];\r\n      const icon = (config as any)[`${prefix}_icon`];\r\n      const min = (config as any)[`${prefix}_min`];\r\n      const max = (config as any)[`${prefix}_max`];\r\n      const tap = (config as any)[`${prefix}_tap_action`];\r\n      const hold = (config as any)[`${prefix}_hold_action`];\r\n\r\n      if (name !== undefined) normalized.name = name;\r\n      if (icon !== undefined) normalized.icon = icon;\r\n      if (min !== undefined) normalized.min = min;\r\n      if (max !== undefined) normalized.max = max;\r\n      if (tap !== undefined) normalized.tap = tap;\r\n      if (hold !== undefined) normalized.hold = hold;\r\n\r\n      return normalized;\r\n    };\r\n\r\n    const load = normalizeEntity('load');\r\n    const grid = normalizeEntity('grid');\r\n    const production = normalizeEntity('production');\r\n    const batteryEntity = normalizeEntity('battery') as BatteryEntityConfig | undefined;\r\n\r\n    if (batteryEntity) {\r\n      const soc = (config as any)['battery_soc_entity'];\r\n      const invertData = (config as any)['invert_battery_data'];\r\n      const invertView = (config as any)['invert_battery_view'];\r\n      const showPlus = (config as any)['show_plus'];\r\n\r\n      if (soc !== undefined) batteryEntity.soc_entity = soc;\r\n      if (invertData !== undefined || invertView !== undefined) {\r\n        batteryEntity.invert = {\r\n          data: invertData !== undefined ? invertData : batteryEntity.invert?.data,\r\n          view: invertView !== undefined ? invertView : batteryEntity.invert?.view,\r\n        };\r\n      }\r\n      if (showPlus !== undefined) batteryEntity.showPlus = showPlus;\r\n    }\r\n\r\n    // Map view mode\r\n    const mode = (config as any).view_mode || (config as any).mode;\r\n\r\n    // Ensure required load exists; if not, fall back to provided config as-is to avoid losing data\r\n    if (!load) {\r\n      return config as EnergyFlowCardConfig;\r\n    }\r\n\r\n    return {\r\n      mode,\r\n      load,\r\n      grid,\r\n      production,\r\n      battery: batteryEntity,\r\n    };\r\n  }\r\n\r\n}\r\n\r\n// Register custom element (guard against double registration)\r\nconst CARD_TAG = 'energy-flow-card';\r\nif (!customElements.get(CARD_TAG)) {\r\n  customElements.define(CARD_TAG, EnergyFlowCard);\r\n  console.info('[EnergyFlowCard] defined custom element');\r\n} else {\r\n  console.info('[EnergyFlowCard] custom element already defined');\r\n}\r\n\r\n// Register in card picker\r\ndeclare global {\r\n  interface Window {\r\n    customCards: Array<{ type: string; name: string; description: string }>;\r\n  }\r\n}\r\nwindow.customCards = window.customCards || [];\r\nwindow.customCards.push({\r\n  type: \"custom:energy-flow-card\",\r\n  name: \"Energy Flow Card\",\r\n  description: \"A test energy-flow card.\"\r\n});\r\n"],"names":["history","text"],"mappings":";;AAmBO,WAAS,qBAAqB,SAAoC;AACvE,UAAM,iBAAiB,KAAK,IAAI,GAAG,QAAQ,UAAU;AACrD,UAAM,WAAW,QAAQ;AACzB,UAAM,cAAc,QAAQ;AAC5B,UAAM,aAAa,KAAK,IAAI,GAAG,QAAQ,IAAI;AAG3C,UAAM,QAAqB;AAAA,MACzB,kBAAkB;AAAA,MAClB,qBAAqB;AAAA,MACrB,kBAAkB;AAAA,MAClB,YAAY;AAAA,MACZ,eAAe;AAAA,MACf,eAAe;AAAA,IAAA;AAIjB,QAAI,sBAAsB;AAC1B,QAAI,gBAAgB;AAIpB,QAAI,sBAAsB,KAAK,gBAAgB,GAAG;AAChD,YAAM,mBAAmB,KAAK,IAAI,qBAAqB,aAAa;AACpE,6BAAuB,MAAM;AAC7B,uBAAiB,MAAM;AAAA,IACzB;AAIA,QAAI,cAAc,KAAK,sBAAsB,GAAG;AAC9C,YAAM,sBAAsB,KAAK,IAAI,qBAAqB,KAAK,IAAI,WAAW,CAAC;AAC/E,6BAAuB,MAAM;AAAA,IAC/B;AAIA,QAAI,cAAc,KAAK,gBAAgB,GAAG;AACxC,YAAM,gBAAgB,KAAK,IAAI,aAAa,aAAa;AACzD,uBAAiB,MAAM;AAAA,IACzB;AAIA,QAAI,gBAAgB,KAAK,WAAW,GAAG;AACrC,YAAM,aAAa,KAAK,IAAI,UAAU,aAAa;AACnD,uBAAiB,MAAM;AAAA,IACzB;AAKA,QAAI,cAAc,KAAK,WAAW,IAAI;AACpC,YAAM,cAAc,KAAK,IAAI,WAAW,IAAI,MAAM;AAClD,UAAI,cAAc,GAAG;AACnB,cAAM,gBAAgB,KAAK,IAAI,WAAW,MAAM,YAAY,WAAW;AAAA,MACzE;AAAA,IACF;AAKA,QAAI,WAAW,KAAK;AAClB,YAAM,mBAAmB,KAAK,IAAI,QAAQ;AAAA,IAC5C;AAEA,WAAO;AAAA,EACT;ACvCO,WAAS,aACd,MACA,WACA,cACA,UACM;AACN,QAAI,CAAC,KAAM;AAGX,UAAM,SAAS,gBAAgB,EAAE,QAAQ,YAAA;AACzC,UAAM,SAAS,OAAO,UAAU;AAEhC,YAAQ,QAAA;AAAA,MACN,KAAK;AACH,cAAM,eAAe,OAAO,UAAU;AACtC,YAAI,cAAc;AAChB,oBAAU,kBAAkB,EAAE,UAAU,aAAA,CAAc;AAAA,QACxD;AACA;AAAA,MAEF,KAAK;AACH,YAAI,OAAO,MAAM;AACf,kBAAQ,UAAU,MAAM,IAAI,OAAO,IAAI;AACvC,oBAAU,oBAAoB,EAAE,SAAS,MAAA,CAAO;AAAA,QAClD;AACA;AAAA,MAEF,KAAK;AACH,YAAI,OAAO,MAAM;AACf,iBAAO,KAAK,OAAO,IAAI;AAAA,QACzB;AACA;AAAA,MAEF,KAAK;AACH,YAAI,UAAU;AACZ,eAAK,YAAY,iBAAiB,UAAU,EAAE,WAAW,UAAU;AAAA,QACrE;AACA;AAAA,MAEF,KAAK;AACH,YAAI,OAAO,SAAS;AAClB,gBAAM,CAAC,QAAQ,OAAO,IAAI,OAAO,QAAQ,MAAM,GAAG;AAClD,eAAK,YAAY,QAAQ,SAAS,OAAO,gBAAgB,CAAA,GAAI,OAAO,MAAM;AAAA,QAC5E;AACA;AAAA,IAIA;AAAA,EAEN;AAEO,WAAS,wBAAwB,SAAkB,YAAoB,UAAyB;AACrG,QAAI,CAAC,WAAW,CAAC,UAAU;AACzB,eAAS,aAAa,iBAAiB,EAAE;AACzC;AAAA,IACF;AAGA,UAAM,uBAAuB;AAC7B,UAAM,sBAAsB;AAE5B,QAAI,cAAc,sBAAsB;AACtC,cAAQ,aAAa,iBAAiB,YAAY;AAAA,IACpD,WAAW,cAAc,qBAAqB;AAC5C,cAAQ,aAAa,iBAAiB,WAAW;AAAA,IACnD,OAAO;AACL,cAAQ,aAAa,iBAAiB,EAAE;AAAA,IAC1C;AAAA,EACF;AAAA,ECtFO,MAAM,gBAAgB;AAAA;AAAA,IAe3B,YACE,WACA,QACA,MACA,UACA,iBACA,sBACA;AAZF,WAAiB,kBAAkB;AACnC,WAAiB,eAAe;AAChC,WAAiB,YAAY;AAC7B,WAAiB,cAAc;AAU7B,WAAK,YAAY;AACjB,WAAK,SAAS;AACd,WAAK,OAAO;AACZ,WAAK,WAAW;AAChB,WAAK,kBAAkB;AACvB,WAAK,uBAAuB;AAAA,IAC9B;AAAA;AAAA;AAAA;AAAA,IAKA,OAAO,MAA+B;AAEpC,UAAI,CAAC,KAAK,UAAU,cAAc,eAAe,KAAK,KAAK,iBAAiB,KAAK,UAAU;AACzF,aAAK,oBAAA;AACL,aAAK,oBAAA;AACL,aAAK,eAAe,KAAK;AAAA,MAC3B;AAGA,WAAK,eAAe,IAAI;AAAA,IAC1B;AAAA;AAAA;AAAA;AAAA,IAKA,YAAY,UAAiC;AAC3C,UAAI,KAAK,aAAa,UAAU;AAC9B,aAAK,WAAW;AAChB,aAAK,eAAe;AAAA,MACtB;AAAA,IACF;AAAA;AAAA;AAAA;AAAA,IAKQ,sBAA4B;AAClC,WAAK,UAAU,YAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAoBZ,KAAK,aAAa,oBAAoB,SAAS,GAAG;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,8EA2GS,KAAK,SAAS;AAAA;AAAA,4DAEhC,KAAK,gBAAgB,QAAQ,wBAAwB,CAAC;AAAA;AAAA;AAAA;AAAA,iFAIjC,KAAK,YAAY;AAAA;AAAA,4DAEtC,KAAK,gBAAgB,WAAW,aAAa,CAAC;AAAA;AAAA;AAAA;AAAA,oFAItB,KAAK,eAAe;AAAA;AAAA,4DAE5C,KAAK,gBAAgB,cAAc,iBAAiB,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gDAMjE,KAAK,gBAAgB,QAAQ,yBAAyB,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,YAM3F,KAAK,aAAa,oBAAoB;AAAA;AAAA;AAAA;AAAA,gDAIF,KAAK,gBAAgB,WAAW,aAAa,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,sFAOR,KAAK,SAAS;AAAA;AAAA,4DAExC,KAAK,gBAAgB,QAAQ,wBAAwB,CAAC;AAAA;AAAA;AAAA;AAAA,sFAI5B,KAAK,YAAY;AAAA;AAAA,4DAE3C,KAAK,gBAAgB,QAAQ,UAAU,CAAC;AAAA;AAAA;AAAA;AAAA,4FAIR,KAAK,eAAe;AAAA;AAAA,4DAEpD,KAAK,gBAAgB,cAAc,iBAAiB,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gDAMjE,KAAK,gBAAgB,WAAW,aAAa,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,cAMhF,EAAE;AAAA;AAAA;AAAA;AAAA,IAId;AAAA;AAAA;AAAA;AAAA,IAKQ,sBAA4B;AAClC,4BAAsB,MAAM;AAE1B,cAAM,gBAAgB,KAAK,UAAU,cAAc,qBAAqB;AACxE,cAAM,aAAa,KAAK,UAAU,cAAc,kBAAkB;AAClE,cAAM,UAAU,KAAK,UAAU,cAAc,eAAe;AAC5D,cAAM,aAAa,KAAK,UAAU,iBAAiB,YAAY;AAC/D,cAAM,YAAY,WAAW,CAAC;AAE9B,YAAI,eAAe;AACjB,wBAAc,iBAAiB,SAAS,MAAM;AAC5C,iBAAK,qBAAqB,KAAK,OAAO,YAAY,KAAK,KAAK,OAAO,YAAY,MAAM;AAAA,UACvF,CAAC;AAAA,QACH;AACA,YAAI,YAAY;AACd,qBAAW,iBAAiB,SAAS,MAAM;AACzC,iBAAK,qBAAqB,KAAK,OAAO,SAAS,KAAK,KAAK,OAAO,SAAS,MAAM;AAAA,UACjF,CAAC;AAAA,QACH;AACA,YAAI,SAAS;AACX,kBAAQ,iBAAiB,SAAS,MAAM;AACtC,iBAAK,qBAAqB,KAAK,OAAO,MAAM,KAAK,KAAK,OAAO,MAAM,MAAM;AAAA,UAC3E,CAAC;AAAA,QACH;AACA,YAAI,WAAW;AACb,oBAAU,iBAAiB,SAAS,MAAM;AACxC,iBAAK,qBAAqB,KAAK,OAAO,KAAK,KAAK,KAAK,OAAO,KAAK,MAAM;AAAA,UACzE,CAAC;AAAA,QACH;AAGA,YAAI,KAAK,aAAa,mBAAmB;AACvC,gBAAM,iBAAiB,KAAK,UAAU,cAAc,6BAA6B;AACjF,gBAAM,iBAAiB,KAAK,UAAU,cAAc,uBAAuB;AAC3E,gBAAM,iBAAiB,KAAK,UAAU,cAAc,uBAAuB;AAC3E,gBAAM,iBAAiB,KAAK,UAAU,cAAc,mBAAmB;AACvE,gBAAM,kBAAkB,KAAK,UAAU,cAAc,oBAAoB;AAEzE,cAAI,gBAAgB;AAClB,2BAAe,iBAAiB,SAAS,MAAM;AAC7C,mBAAK,qBAAqB,KAAK,OAAO,YAAY,KAAK,KAAK,OAAO,YAAY,MAAM;AAAA,YACvF,CAAC;AAAA,UACH;AACA,cAAI,gBAAgB;AAClB,2BAAe,iBAAiB,SAAS,MAAM;AAC7C,mBAAK,qBAAqB,KAAK,OAAO,KAAK,KAAK,KAAK,OAAO,KAAK,MAAM;AAAA,YACzE,CAAC;AAAA,UACH;AACA,cAAI,gBAAgB;AAClB,2BAAe,iBAAiB,SAAS,MAAM;AAC7C,mBAAK,qBAAqB,KAAK,OAAO,MAAM,KAAK,KAAK,OAAO,MAAM,MAAM;AAAA,YAC3E,CAAC;AAAA,UACH;AACA,cAAI,gBAAgB;AAClB,2BAAe,iBAAiB,SAAS,MAAM;AAC7C,mBAAK,qBAAqB,KAAK,OAAO,SAAS,KAAK,KAAK,OAAO,SAAS,MAAM;AAAA,YACjF,CAAC;AAAA,UACH;AACA,cAAI,iBAAiB;AACnB,4BAAgB,iBAAiB,SAAS,MAAM;AAC9C,mBAAK,qBAAqB,KAAK,OAAO,SAAS,KAAK,KAAK,OAAO,SAAS,MAAM;AAAA,YACjF,CAAC;AAAA,UACH;AAAA,QACF;AAAA,MACF,CAAC;AAAA,IACH;AAAA;AAAA;AAAA;AAAA,IAKQ,eAAe,MAA+B;AACpD,YAAM,EAAE,MAAM,OAAO,SAAS,eAAe;AAG7C,YAAM,kBAAkB,MAAM;AAC9B,YAAM,gBAAgB,MAAM;AAC5B,YAAM,aAAa,MAAM;AAGzB,YAAM,QAAQ,QAAQ;AACtB,YAAM,oBAAqB,kBAAkB,QAAS;AACtD,YAAM,iBAAkB,gBAAgB,QAAS;AACjD,YAAM,cAAe,aAAa,QAAS;AAG3C,YAAM,aAAa,oBAAoB,iBAAiB;AACxD,UAAI,0BAA0B;AAC9B,UAAI,uBAAuB;AAC3B,UAAI,oBAAoB;AAExB,UAAI,aAAa,GAAG;AAClB,cAAM,QAAQ,MAAM;AACpB,kCAA0B,oBAAoB;AAC9C,+BAAuB,iBAAiB;AACxC,4BAAoB,cAAc;AAAA,MACpC;AAGA,UAAI,mBAAmB;AACvB,UAAI,mBAAmB;AACvB,UAAI,mBAAmB;AACvB,UAAI,2BAA2B;AAC/B,UAAI,2BAA2B;AAC/B,UAAI,2BAA2B;AAE/B,UAAI,KAAK,aAAa,mBAAmB;AACvC,YAAI,UAAU,GAAG;AAEf,gBAAM,kBAAkB,KAAK,IAAI,OAAO;AACxC,gBAAM,eAAe,mBAAmB;AAExC,6BAAmB,MAAM;AACzB,6BAAmB,MAAM;AAEzB,gBAAM,qBAAsB,MAAM,gBAAgB,eAAgB;AAClE,gBAAM,qBAAsB,MAAM,sBAAsB,eAAgB;AAExE,gBAAM,YAAY,qBAAqB;AACvC,cAAI,YAAY,GAAG;AACjB,kBAAM,QAAQ,MAAM;AACpB,uCAA2B,qBAAqB;AAChD,uCAA2B,qBAAqB;AAAA,UAClD;AAAA,QACF,WAAW,UAAU,GAAG;AAEtB,gBAAM,eAAe,WAAW;AAChC,gBAAM,gBAAgB,UAAU,MAAM;AAEtC,6BAAmB,MAAM;AACzB,6BAAmB;AAEnB,gBAAM,qBAAsB,MAAM,gBAAgB,eAAgB;AAClE,gBAAM,qBAAsB,gBAAgB,eAAgB;AAE5D,gBAAM,eAAe,qBAAqB;AAC1C,cAAI,eAAe,GAAG;AACpB,kBAAM,QAAQ,MAAM;AACpB,uCAA2B,qBAAqB;AAChD,uCAA2B,qBAAqB;AAAA,UAClD;AAAA,QACF;AAAA,MACF;AAEA,4BAAsB,MAAM;AAC1B,aAAK;AAAA,UACH;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,QAAA;AAGF,YAAI,KAAK,aAAa,mBAAmB;AACvC,eAAK;AAAA,YACH;AAAA,YACA;AAAA,YACA;AAAA,YACA;AAAA,YACA;AAAA,YACA;AAAA,YACA;AAAA,YACA;AAAA,UAAA;AAAA,QAEJ;AAAA,MACF,CAAC;AAAA,IACH;AAAA;AAAA;AAAA;AAAA,IAKQ,cACN,yBACA,sBACA,mBACA,mBACA,gBACA,aACA,iBACA,eACA,YACA,MACM;AACN,YAAM,oBAAoB,KAAK,UAAU,cAAc,qBAAqB;AAC5E,YAAM,iBAAiB,KAAK,UAAU,cAAc,kBAAkB;AACtE,YAAM,cAAc,KAAK,UAAU,cAAc,eAAe;AAChE,YAAM,gBAAgB,KAAK,UAAU,cAAc,kBAAkB;AACrE,YAAM,eAAe,KAAK,UAAU,cAAc,gBAAgB;AAElE,UAAI,mBAAmB;AACpB,0BAAkC,MAAM,QAAQ,GAAG,uBAAuB;AAC3E,cAAM,QAAQ,kBAAkB,cAAc,oBAAoB;AAClE,YAAI,SAAS,kBAAkB,GAAG;AAChC,gBAAM,cAAc,GAAG,KAAK,MAAM,iBAAiB,CAAC;AAAA,QACtD;AACA,cAAM,UAAW,0BAA0B,OAAQ,cAAc,eAAe;AAChF,gCAAwB,mBAAkC,SAAS,kBAAkB,CAAC;AAAA,MACxF;AAEA,UAAI,gBAAgB;AACjB,uBAA+B,MAAM,QAAQ,GAAG,oBAAoB;AACrE,cAAM,QAAQ,eAAe,cAAc,oBAAoB;AAC/D,YAAI,SAAS,gBAAgB,GAAG;AAC9B,gBAAM,cAAc,GAAG,KAAK,MAAM,cAAc,CAAC;AAAA,QACnD;AACA,cAAM,UAAW,uBAAuB,OAAQ,cAAc,eAAe;AAC7E,gCAAwB,gBAA+B,SAAS,gBAAgB,CAAC;AAAA,MACnF;AAEA,UAAI,aAAa;AACd,oBAA4B,MAAM,QAAQ,GAAG,iBAAiB;AAC/D,cAAM,QAAQ,YAAY,cAAc,oBAAoB;AAC5D,YAAI,SAAS,aAAa,GAAG;AAC3B,gBAAM,cAAc,GAAG,KAAK,MAAM,WAAW,CAAC;AAAA,QAChD;AACA,cAAM,UAAW,oBAAoB,OAAQ,cAAc,eAAe;AAC1E,gCAAwB,aAA4B,SAAS,aAAa,CAAC;AAAA,MAC7E;AAEA,UAAI,eAAe;AACjB,sBAAc,cAAc,OAAO,KAAK,MAAM,IAAI,CAAC;AAAA,MACrD;AAAA,IACF;AAAA;AAAA;AAAA;AAAA,IAKQ,iBACN,0BACA,0BACA,0BACA,kBACA,kBACA,kBACA,SACA,YACM;AACN,YAAM,qBAAqB,KAAK,UAAU,cAAc,uBAAuB;AAC/E,YAAM,qBAAqB,KAAK,UAAU,cAAc,uBAAuB;AAC/E,YAAM,qBAAqB,KAAK,UAAU,cAAc,6BAA6B;AACrF,YAAM,iBAAiB,KAAK,UAAU,cAAc,mBAAmB;AACvE,YAAM,kBAAkB,KAAK,UAAU,cAAc,oBAAoB;AACzE,YAAM,qBAAqB,KAAK,UAAU,cAAc,wBAAwB;AAChF,YAAM,sBAAsB,KAAK,UAAU,cAAc,yBAAyB;AAClF,YAAM,uBAAuB,KAAK,UAAU,iBAAiB,gBAAgB;AAC7E,YAAM,sBAAsB,qBAAqB,CAAC;AAElD,UAAI,eAAe;AAEnB,UAAI,UAAU,GAAG;AAEf,uBAAe;AACf,YAAI,eAAgB,gBAAe,MAAM,UAAU;AACnD,YAAI,gBAAiB,iBAAgB,MAAM,UAAU;AACrD,YAAI,uBAAuB,eAAe,MAAM;AAC9C,8BAAoB,cAAc,WAAW,QAAQ,CAAC;AAAA,QACxD;AAAA,MACF,WAAW,UAAU,GAAG;AAEtB,uBAAe;AACf,YAAI,eAAgB,gBAAe,MAAM,UAAU;AACnD,YAAI,gBAAiB,iBAAgB,MAAM,UAAU;AACrD,YAAI,sBAAsB,eAAe,MAAM;AAC7C,6BAAmB,cAAc,WAAW,QAAQ,CAAC;AAAA,QACvD;AAAA,MACF,OAAO;AAEL,YAAI,eAAgB,gBAAe,MAAM,UAAU;AACnD,YAAI,gBAAiB,iBAAgB,MAAM,UAAU;AACrD,YAAI,uBAAuB,eAAe,MAAM;AAC9C,8BAAoB,cAAc,WAAW,QAAQ,CAAC;AAAA,QACxD;AAAA,MACF;AAGA,UAAI,oBAAoB;AACtB,cAAM,iBAAiB,eAAe,KAAK,YAAY,KAAK;AAC3D,2BAAmC,MAAM,QAAQ,GAAG,wBAAwB;AAC5E,2BAAmC,MAAM,aAAa;AACvD,cAAM,QAAQ,mBAAmB,cAAc,oBAAoB;AACnE,YAAI,SAAS,mBAAmB,GAAG;AACjC,gBAAM,cAAc,GAAG,KAAK,MAAM,gBAAgB,CAAC;AAAA,QACrD;AACA,cAAM,aAAc,2BAA2B,OAAQ,qBAAqB,eAAe;AAC3F,gCAAwB,oBAAoB,YAAY,mBAAmB,CAAC;AAAA,MAC9E;AAGA,UAAI,oBAAoB;AACrB,2BAAmC,MAAM,QAAQ,GAAG,wBAAwB;AAC7E,cAAM,QAAQ,mBAAmB,cAAc,oBAAoB;AACnE,YAAI,SAAS,mBAAmB,GAAG;AACjC,gBAAM,cAAc,GAAG,KAAK,MAAM,gBAAgB,CAAC;AAAA,QACrD;AACA,cAAM,aAAc,2BAA2B,OAAQ,qBAAqB,eAAe;AAC3F,gCAAwB,oBAAoB,YAAY,mBAAmB,CAAC;AAAA,MAC9E;AAGA,UAAI,oBAAoB;AACrB,2BAAmC,MAAM,QAAQ,GAAG,wBAAwB;AAC7E,cAAM,QAAQ,mBAAmB,cAAc,oBAAoB;AACnE,YAAI,SAAS,mBAAmB,GAAG;AACjC,gBAAM,cAAc,GAAG,KAAK,MAAM,gBAAgB,CAAC;AAAA,QACrD;AACA,cAAM,aAAc,2BAA2B,OAAQ,qBAAqB,eAAe;AAC3F,gCAAwB,oBAAoB,YAAY,mBAAmB,CAAC;AAAA,MAC9E;AAAA,IACF;AAAA,EACF;AAAA,EC1kBO,MAAM,MAAM;AAAA,IAmCjB,YACE,IACA,OACA,KACA,KACA,eACA,OACA,MACA,OACA,aAAa,OACb,WAAW,OACX,WACA,UACA,mBACA;AACA,WAAK,KAAK;AACV,WAAK,SAAS;AACd,WAAK,MAAM;AACX,WAAK,MAAM;AACX,WAAK,gBAAgB;AACrB,WAAK,QAAQ;AACb,WAAK,OAAO;AACZ,WAAK,QAAQ;AACb,WAAK,cAAc;AACnB,WAAK,WAAW;AAChB,WAAK,YAAY;AACjB,WAAK,WAAW;AAChB,WAAK,oBAAoB;AACzB,WAAK,UAAU;AAGf,WAAK,SAAS;AACd,WAAK,WAAW;AAChB,WAAK,YAAY;AACjB,WAAK,YAAY;AACjB,WAAK,UAAU,KAAK,WAAW;AAC/B,WAAK,UAAU,KAAK,SAAS;AAC7B,WAAK,UAAU,CAAC,KAAK;AACrB,WAAK,UAAU,CAAC,KAAK;AAGrB,WAAK,cAAc,EAAE,QAAQ,GAAG,SAAS,GAAG,OAAO,EAAA;AACnD,WAAK,qBAAqB;AAC1B,WAAK,oBAAoB;AAGzB,WAAK,mBAAA;AAAA,IACP;AAAA,IAEA,IAAI,QAAgB;AAClB,aAAO,KAAK;AAAA,IACd;AAAA,IAEA,IAAI,MAAM,UAAkB;AAC1B,UAAI,KAAK,WAAW,SAAU;AAE9B,WAAK,SAAS;AACd,WAAK,mBAAA;AAGL,UAAI,KAAK,SAAS;AAChB,cAAM,YAAY,KAAK,QAAQ,cAAc,UAAU,KAAK,EAAE,EAAE;AAChE,YAAI,WAAW;AACb,oBAAU,cAAc,KAAK,iBAAA;AAAA,QAC/B;AAGA,aAAK,cAAA;AAAA,MACP;AAAA,IACF;AAAA,IAEA,IAAI,aAAsB;AACxB,aAAO,KAAK;AAAA,IACd;AAAA,IAEA,IAAI,WAAW,eAAwB;AACrC,UAAI,KAAK,gBAAgB,cAAe;AAExC,WAAK,cAAc;AACnB,WAAK,mBAAA;AAGL,UAAI,KAAK,SAAS;AAChB,cAAM,YAAY,KAAK,QAAQ,cAAc,UAAU,KAAK,EAAE,EAAE;AAChE,YAAI,WAAW;AACb,oBAAU,cAAc,KAAK,iBAAA;AAAA,QAC/B;AAAA,MACF;AAAA,IACF;AAAA,IAEA,IAAI,eAAuB;AACzB,aAAO,KAAK,cAAc,CAAC,KAAK,SAAS,KAAK;AAAA,IAChD;AAAA,IAEA,mBAA2B;AACzB,YAAM,eAAe,KAAK;AAC1B,YAAM,WAAW,aAAa,QAAQ,CAAC;AAEvC,UAAI,eAAe,GAAG;AACpB,eAAO,WAAW;AAAA,MACpB,WAAW,eAAe,KAAK,KAAK,UAAU;AAC5C,eAAO,MAAM,WAAW;AAAA,MAC1B,OAAO;AACL,eAAO;AAAA,MACT;AAAA,IACF;AAAA,IAEA,qBAA2B;AACzB,UAAI;AACJ,UAAI;AACJ,YAAM,eAAe,KAAK;AAE1B,UAAI,KAAK,eAAe;AACtB,cAAM,QAAQ,KAAK,MAAM,KAAK;AAC9B,qBAAa,KAAK,IAAI,KAAK,KAAK,eAAe,KAAK,OAAO,OAAO,CAAC,GAAG,CAAC;AACvE,gBAAQ,MAAM,aAAa;AAAA,MAC7B,OAAO;AACL,qBAAa,KAAK,IAAI,KAAK,IAAI,eAAe,KAAK,KAAK,CAAC,GAAG,CAAC;AAC7D,gBAAQ,MAAM,aAAa;AAAA,MAC7B;AAEA,WAAK,YAAY,SAAS;AAAA,IAC5B;AAAA,IAEA,gBAAsB;AACpB,UAAI,CAAC,KAAK,QAAS;AAEnB,YAAM,SAAS,KAAK,QAAQ,cAAc,WAAW,KAAK,EAAE,EAAE;AAC9D,UAAI,QAAQ;AACV,cAAM,SAAS,KAAK,IAAI,KAAK,KAAK,IAAI;AACtC,eAAO,aAAa,WAAW,SAAS,QAAQ,GAAG;AAAA,MACrD;AAAA,IACF;AAAA,IAEA,iBAAuB;AACrB,UAAI,KAAK,kBAAmB;AAE5B,YAAM,UAAU,CAAC,cAAsB;AACrC,YAAI,CAAC,KAAK,oBAAoB;AAC5B,eAAK,qBAAqB;AAAA,QAC5B;AAEA,cAAM,YAAY,YAAY,KAAK;AACnC,aAAK,qBAAqB;AAE1B,YAAI,CAAC,KAAK,SAAS;AACjB,eAAK,oBAAoB;AACzB;AAAA,QACF;AAEA,cAAM,eAAe,KAAK,SAAS;AAGnC,cAAM,iBAAiB,KAAK,IAAI,YAAY,KAAK,CAAC;AAClD,aAAK,YAAY,YAAY,KAAK,YAAY,SAAS,KAAK,YAAY,WAAW;AAGnF,cAAM,kBAAkB,KAAK,IAAI,YAAY,KAAK,CAAC;AACnD,aAAK,YAAY,UAAU,KAAK,YAAY,UAAU,KAAK,YAAY,SAAS;AAGhF,cAAM,SAAS;AACf,YAAI,KAAK,YAAY,QAAQ,KAAK,YAAY,UAAU,QAAQ;AAC9D,eAAK,YAAY,QAAQ,KAAK,YAAY,UAAU;AAAA,QACtD,WAAW,KAAK,YAAY,QAAQ,KAAK,YAAY,UAAU,QAAQ;AACrE,eAAK,YAAY,QAAQ,KAAK,YAAY,UAAU;AAAA,QACtD;AAGA,cAAM,SAAS,KAAK,QAAQ,cAAc,WAAW,KAAK,EAAE,EAAE;AAC9D,YAAI,QAAQ;AACV,gBAAM,YAAa,KAAK,YAAY,UAAU,KAAK,KAAM;AACzD,gBAAM,UAAU,KAAK,UAAU,eAAe,KAAK,IAAI,SAAS;AAChE,gBAAM,UAAU,KAAK,UAAU,eAAe,KAAK,IAAI,SAAS;AAChE,iBAAO,aAAa,MAAM,OAAO,OAAO,CAAC;AACzC,iBAAO,aAAa,MAAM,OAAO,OAAO,CAAC;AAAA,QAC3C;AAGA,cAAM,cAAc,KAAK,QAAQ,cAAc,iBAAiB,KAAK,EAAE,EAAE;AACzE,YAAI,aAAa;AACf,gBAAM,WAAY,KAAK,YAAY,QAAQ,KAAK,KAAM;AACtD,gBAAM,SAAS,KAAK,UAAU,eAAe,KAAK,IAAI,QAAQ;AAC9D,gBAAM,SAAS,KAAK,UAAU,eAAe,KAAK,IAAI,QAAQ;AAC9D,sBAAY,aAAa,MAAM,OAAO,MAAM,CAAC;AAC7C,sBAAY,aAAa,MAAM,OAAO,MAAM,CAAC;AAAA,QAC/C;AAEA,aAAK,oBAAoB,sBAAsB,OAAO;AAAA,MACxD;AAEA,WAAK,oBAAoB,sBAAsB,OAAO;AAAA,IACxD;AAAA,IAEA,gBAAsB;AACpB,UAAI,KAAK,mBAAmB;AAC1B,6BAAqB,KAAK,iBAAiB;AAC3C,aAAK,oBAAoB;AACzB,aAAK,qBAAqB;AAAA,MAC5B;AAAA,IACF;AAAA;AAAA;AAAA;AAAA,IAKQ,mBAAyB;AAC/B,UAAI,CAAC,KAAK,kBAAmB;AAG7B,YAAM,SAAS,KAAK,aAAa,EAAE,QAAQ,YAAA;AAC3C,YAAM,SAAS,OAAO,UAAU;AAEhC,cAAQ,QAAA;AAAA,QACN,KAAK;AACH,gBAAM,WAAW,OAAO,UAAU,KAAK;AACvC,cAAI,UAAU;AACZ,iBAAK,kBAAkB,kBAAkB,EAAE,SAAA,CAAU;AAAA,UACvD;AACA;AAAA,QAEF,KAAK;AACH,cAAI,OAAO,MAAM;AACf,oBAAQ,UAAU,MAAM,IAAI,OAAO,IAAI;AACvC,iBAAK,kBAAkB,oBAAoB,EAAE,SAAS,OAAO;AAAA,UAC/D;AACA;AAAA,QAEF,KAAK;AACH,cAAI,OAAO,MAAM;AACf,mBAAO,KAAK,OAAO,IAAI;AAAA,UACzB;AACA;AAAA,QAEF,KAAK;AACH,cAAI,KAAK,UAAU;AACjB,iBAAK,kBAAkB,gBAAgB;AAAA,cACrC,QAAQ;AAAA,cACR,SAAS;AAAA,cACT,cAAc,EAAE,WAAW,KAAK,SAAA;AAAA,YAAS,CAC1C;AAAA,UACH;AACA;AAAA,QAEF,KAAK;AACH,cAAI,OAAO,SAAS;AAClB,kBAAM,CAAC,QAAQ,OAAO,IAAI,OAAO,QAAQ,MAAM,GAAG;AAClD,iBAAK,kBAAkB,gBAAgB;AAAA,cACrC;AAAA,cACA;AAAA,cACA,cAAc,OAAO,gBAAgB,CAAA;AAAA,cACrC,QAAQ,OAAO;AAAA,YAAA,CAChB;AAAA,UACH;AACA;AAAA,MAIA;AAAA,IAEN;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAQA,gBAA6B;AAC3B,YAAM,eAAe,KAAK;AAG1B,UAAI;AACJ,UAAI;AACJ,UAAI,KAAK,eAAe;AACtB,cAAM,QAAQ,KAAK,MAAM,KAAK;AAC9B,qBAAa,KAAK,IAAI,KAAK,KAAK,eAAe,KAAK,OAAO,OAAO,CAAC,GAAG,CAAC;AACvE,gBAAQ,MAAM,aAAa;AAAA,MAC7B,OAAO;AACL,qBAAa,KAAK,IAAI,KAAK,IAAI,eAAe,KAAK,KAAK,CAAC,GAAG,CAAC;AAC7D,gBAAQ,MAAM,aAAa;AAAA,MAC7B;AAGA,WAAK,YAAY,SAAS;AAC1B,WAAK,YAAY,UAAU;AAC3B,WAAK,YAAY,QAAQ;AAGzB,YAAM,QAAQ,KAAK,gBAAgB,CAAC,KAAK,KAAK,GAAG,KAAK,GAAG,IAAI,CAAC,GAAG,KAAK,MAAM,GAAG,KAAK,GAAG;AACvF,YAAM,YAAY,MACf,IAAI,CAAC,cAAc;AAClB,cAAM,iBAAiB,KAAK,iBACvB,YAAY,KAAK,QAAQ,KAAK,MAAM,KAAK,OAC1C,YAAY,KAAK;AACrB,cAAM,YAAY,MAAM,iBAAiB;AACzC,cAAM,UAAW,YAAY,KAAK,KAAM;AACxC,cAAM,aAAa,KAAK;AACxB,cAAM,WAAW,KAAK,SAAS;AAE/B,cAAM,KAAK,KAAK,UAAU,aAAa,KAAK,IAAI,OAAO;AACvD,cAAM,KAAK,KAAK,UAAU,aAAa,KAAK,IAAI,OAAO;AACvD,cAAM,KAAK,KAAK,UAAU,WAAW,KAAK,IAAI,OAAO;AACrD,cAAM,KAAK,KAAK,UAAU,WAAW,KAAK,IAAI,OAAO;AAErD,eAAO,aAAa,EAAE,SAAS,EAAE,SAAS,EAAE,SAAS,EAAE;AAAA,MACzD,CAAC,EACA,KAAK,EAAE;AAGV,YAAM,iBAAiB,KAAK,iBAAiB,IAAI,KAAK,QAAQ,KAAK,MAAM,KAAK,OAAO;AACrF,YAAM,YAAY,MAAM,iBAAiB;AACzC,YAAM,UAAW,YAAY,KAAK,KAAM;AACxC,YAAM,SAAS,KAAK;AACpB,YAAM,SAAS,KAAK;AACpB,YAAM,SAAS,KAAK,UAAU,KAAK,SAAS,KAAK,IAAI,OAAO;AAC5D,YAAM,SAAS,KAAK,UAAU,KAAK,SAAS,KAAK,IAAI,OAAO;AAC5D,YAAM,WAAW,aAAa,MAAM,SAAS,MAAM,SAAS,MAAM,SAAS,MAAM;AAGjF,YAAM,YAAa,QAAQ,KAAK,KAAM;AACtC,YAAM,eAAe,KAAK,SAAS;AACnC,YAAM,UAAU,KAAK,UAAU,eAAe,KAAK,IAAI,SAAS;AAChE,YAAM,UAAU,KAAK,UAAU,eAAe,KAAK,IAAI,SAAS;AAEhE,YAAM,aAAa,KAAK,UAAU;AAClC,YAAM,SAAS,KAAK,UAAU,KAAK,SAAS;AAC5C,YAAM,SAAS,KAAK,UAAU,KAAK,SAAS;AAE5C,YAAM,YAAY;AAAA,gCACU,KAAK,OAAO,KAAK,KAAK,OAAO;AAAA;AAAA,+BAE9B,KAAK,EAAE;AAAA,uCACC,KAAK,QAAQ,aAAa,aAAa,CAAC;AAAA;AAAA;AAAA;AAAA,mCAI5C,KAAK,QAAQ,aAAa,KAAK,SAAS,SAAS,KAAK,SAAS,SAAS,KAAK,SAAS;AAAA;AAAA,kCAEvF,KAAK,EAAE;AAAA,wBACjB,KAAK,OAAO,SAAS,KAAK,OAAO,QAAQ,KAAK,MAAM;AAAA,YAChE,QAAQ;AAAA;AAAA;AAAA,UAGV,SAAS;AAAA;AAAA,sBAEG,KAAK,OAAO,SAAS,KAAK,OAAO,QAAQ,KAAK,MAAM;AAAA;AAAA,mBAEvD,KAAK,OAAO,4FAA4F,KAAK,KAAK;AAAA;AAAA;AAAA,yCAG5F,KAAK,EAAE,QAAQ,KAAK,UAAU,EAAE,QAAQ,KAAK,UAAU,EAAE;AAAA;AAAA,6BAErE,KAAK,IAAI;AAAA;AAAA;AAAA;AAAA;AAAA,8BAKR,KAAK,EAAE,0BAA0B,KAAK,UAAU,EAAE,KAAK,KAAK,UAAU,EAAE;AAAA;AAAA;AAAA;AAAA,iCAIrE,KAAK,EAAE,SAAS,KAAK,OAAO,SAAS,KAAK,OAAO,SAAS,OAAO,SAAS,OAAO;AAAA;AAAA,2BAEvF,KAAK,EAAE,SAAS,KAAK,OAAO,SAAS,KAAK,OAAO,SAAS,OAAO,SAAS,OAAO;AAAA;AAAA,sBAEtF,KAAK,OAAO,SAAS,KAAK,OAAO;AAAA;AAAA,0BAE7B,KAAK,EAAE,QAAQ,KAAK,OAAO,QAAQ,MAAM,qFAAqF,KAAK,iBAAA,CAAkB;AAAA;AAAA,mBAE5J,KAAK,OAAO,QAAQ,MAAM,yGAAyG,KAAK,KAAK;AAAA;AAAA,2BAErI,KAAK,EAAE,wBAAwB,KAAK,QAAQ,aAAa,KAAK,SAAS,SAAS,KAAK,SAAS,SAAS,KAAK,SAAS;AAAA;AAAA;AAK5I,YAAM,YAAY,SAAS,gBAAgB,8BAA8B,KAAK;AAC9E,gBAAU,YAAY;AACtB,YAAM,UAAU,UAAU;AAG1B,WAAK,UAAU;AAIf,UAAI,CAAC,KAAK,aAAa,KAAK,UAAU,WAAW,QAAQ;AACvD,gBAAQ,MAAM,SAAS;AACvB,gBAAQ,iBAAiB,SAAS,CAAC,MAAM;AACvC,eAAK,iBAAA;AACL,YAAE,gBAAA;AAAA,QACJ,CAAC;AAGD,gBAAQ,iBAAiB,cAAc,MAAM;AAC3C,kBAAQ,MAAM,SAAS;AAAA,QACzB,CAAC;AACD,gBAAQ,iBAAiB,cAAc,MAAM;AAC3C,kBAAQ,MAAM,SAAS;AAAA,QACzB,CAAC;AAAA,MACH;AAEA,aAAO;AAAA,IACT;AAAA,EACF;AAAA,ECjbA,MAAM,SAAS;AAAA,IAQb,YACU,OACA,QACR,MACA,IACA,OACA,OACQ,iBACA,aACR;AARQ,WAAA,QAAA;AACA,WAAA,SAAA;AAKA,WAAA,kBAAA;AACA,WAAA,cAAA;AAbV,WAAQ,OAA2B,CAAA;AACnC,WAAQ,YAAwB,CAAA;AAEhC,WAAQ,aAAqB;AAY3B,YAAM,QAAQ,KAAK,IAAI,GAAG,KAAK;AAC/B,YAAM,QAAQ,KAAK,IAAI,GAAG,KAAK;AAC/B,WAAK,WAAW,KAAK,KAAK,CAAC,IAAI,KAAK,CAAC,MAAM,IAAI,IAAI,IAAI,IAAI,GAAG,CAAC,IAAI,GAAG,CAAC;AAGvE,YAAM,EAAE,SAAS,aAAa,cAAc,KAAK,gBAAgB,KAAK;AACtE,YAAM,WAAW,KAAK,kBAAkB,KAAK;AAG7C,WAAK,WAAW,SAAS,gBAAgB,8BAA8B,MAAM;AAC7E,WAAK,SAAS,aAAa,KAAK,KAAK,QAAQ;AAC7C,WAAK,SAAS,aAAa,SAAS,WAAW;AAC/C,WAAK,SAAS,aAAa,UAAU,KAAK;AAC1C,WAAK,SAAS,aAAa,kBAAkB,OAAO,UAAU,GAAG,CAAC;AAClE,WAAK,SAAS,aAAa,gBAAgB,OAAO,cAAc,CAAC,CAAC;AAClE,WAAK,SAAS,aAAa,QAAQ,MAAM;AACzC,WAAK,SAAS,aAAa,kBAAkB,OAAO;AACpD,WAAK,SAAS,aAAa,SAAS,uEAAuE;AAC3G,WAAK,SAAS,KAAK,QAAQ,MAAM;AACjC,WAAK,MAAM,YAAY,KAAK,QAAQ;AAGpC,WAAK,WAAW,SAAS,gBAAgB,8BAA8B,MAAM;AAC7E,WAAK,SAAS,aAAa,KAAK,KAAK,QAAQ;AAC7C,WAAK,SAAS,aAAa,SAAS,WAAW;AAC/C,WAAK,SAAS,aAAa,UAAU,KAAK;AAC1C,WAAK,SAAS,aAAa,kBAAkB,OAAO,OAAO,CAAC;AAC5D,WAAK,SAAS,aAAa,gBAAgB,OAAO,WAAW,CAAC;AAC9D,WAAK,SAAS,aAAa,QAAQ,MAAM;AACzC,WAAK,SAAS,aAAa,kBAAkB,OAAO;AACpD,WAAK,SAAS,aAAa,SAAS,uEAAuE;AAC3G,WAAK,SAAS,KAAK,QAAQ,MAAM;AACjC,WAAK,MAAM,YAAY,KAAK,QAAQ;AAGpC,WAAK,aAAa,KAAK,SAAS,eAAA;AAGhC,eAAS,IAAI,GAAG,IAAI,KAAK,aAAa,KAAK;AACzC,cAAM,MAAM,SAAS,gBAAgB,8BAA8B,QAAQ;AAC3E,YAAI,aAAa,SAAS,UAAU;AACpC,YAAI,aAAa,MAAM,OAAO,MAAM,IAAI,CAAC,EAAE;AAC3C,YAAI,aAAa,KAAK,OAAO,SAAS,CAAC;AACvC,YAAI,aAAa,QAAQ,KAAK;AAC9B,YAAI,aAAa,WAAW,OAAO,OAAO,CAAC;AAC3C,YAAI,aAAa,SAAS,qDAAqD;AAC/E,aAAK,MAAM,YAAY,GAAG;AAC1B,aAAK,KAAK,KAAK,GAAG;AAElB,cAAM,WAAW,IAAI,KAAK;AAC1B,aAAK,UAAU,KAAK,EAAE,UAAU,UAAU;AAG1C,cAAM,QAAQ,KAAK,SAAS,iBAAiB,WAAW,KAAK,UAAU;AACvE,YAAI,aAAa,MAAM,OAAO,MAAM,CAAC,CAAC;AACtC,YAAI,aAAa,MAAM,OAAO,MAAM,CAAC,CAAC;AAAA,MACxC;AAAA,IACF;AAAA,IAEQ,gBAAgB,OAA4E;AAClG,UAAI;AACJ,UAAI,SAAS,KAAK;AAChB,kBAAU;AAAA,MACZ,WAAW,SAAS,KAAK;AACvB,kBAAU,QAAS,QAAQ,OAAO,MAAO;AAAA,MAC3C,OAAO;AACL,kBAAU;AAAA,MACZ;AAEA,YAAM,WAAW;AACjB,YAAM,WAAW;AACjB,YAAM,WAAW;AACjB,UAAI;AACJ,UAAI,SAAS,KAAK;AAChB,sBAAc;AAAA,MAChB,OAAO;AACL,cAAM,QAAQ,KAAK,KAAK,QAAQ,QAAQ,WAAW,MAAM,CAAC,KAAK,WAAW;AAC1E,sBAAc,WAAW;AAAA,MAC3B;AAEA,YAAM,gBAAgB;AACtB,YAAM,eAAe;AACrB,YAAM,eAAe,iBAAiB,cAAc;AACpD,YAAM,YAAY,KAAK,IAAI,cAAc,YAAY;AAErD,aAAO,EAAE,SAAS,aAAa,UAAA;AAAA,IACjC;AAAA,IAEQ,kBAAkB,OAAuB;AAC/C,YAAM,YAAY,MAAM,QAAQ,OAAQ,KAAK;AAC7C,aAAO,KAAK,aAAa,IAAI,YAAY,KAAK,aAAa;AAAA,IAC7D;AAAA,IAEA,OAAO,OAAe,OAAqB;AACzC,YAAM,EAAE,SAAS,aAAa,cAAc,KAAK,gBAAgB,KAAK;AACtE,YAAM,WAAW,KAAK,kBAAkB,KAAK;AAG7C,WAAK,SAAS,aAAa,UAAU,KAAK;AAC1C,WAAK,SAAS,aAAa,kBAAkB,OAAO,UAAU,GAAG,CAAC;AAClE,WAAK,SAAS,aAAa,gBAAgB,OAAO,cAAc,CAAC,CAAC;AAGlE,WAAK,SAAS,aAAa,UAAU,KAAK;AAC1C,WAAK,SAAS,aAAa,kBAAkB,OAAO,OAAO,CAAC;AAC5D,WAAK,SAAS,aAAa,gBAAgB,OAAO,WAAW,CAAC;AAG9D,WAAK,KAAK,QAAQ,CAAC,KAAK,MAAM;AAC5B,YAAI,aAAa,KAAK,OAAO,SAAS,CAAC;AACvC,YAAI,aAAa,WAAW,OAAO,OAAO,CAAC;AAC3C,YAAI,aAAa,QAAQ,KAAK;AAC9B,aAAK,UAAU,CAAC,EAAE,WAAW;AAAA,MAC/B,CAAC;AAAA,IACH;AAAA,IAEA,QAAQ,WAAyB;AAC/B,WAAK,UAAU,QAAQ,CAAC,OAAO,MAAM;AACnC,YAAI,MAAM,WAAW,GAAG;AAEtB,gBAAM,YAAY,MAAM,YAAY,YAAY;AAChD,cAAI,MAAM,YAAY,GAAG;AACvB,kBAAM,WAAW,MAAM,WAAW;AAAA,UACpC;AAEA,cAAI;AACF,gBAAI,KAAK,aAAa,GAAG;AACvB,oBAAM,QAAQ,KAAK,SAAS,iBAAiB,MAAM,WAAW,KAAK,UAAU;AAC7E,mBAAK,KAAK,CAAC,EAAE,aAAa,MAAM,OAAO,MAAM,CAAC,CAAC;AAC/C,mBAAK,KAAK,CAAC,EAAE,aAAa,MAAM,OAAO,MAAM,CAAC,CAAC;AAAA,YACjD;AAAA,UACF,SAAS,IAAI;AAAA,UAEb;AAAA,QACF;AAAA,MACF,CAAC;AAAA,IACH;AAAA,IAEA,QAAQ,UAA4B;AAClC,WAAK,SAAS,aAAa,kBAAkB,GAAG;AAChD,WAAK,SAAS,aAAa,kBAAkB,GAAG;AAChD,WAAK,KAAK,QAAQ,CAAA,QAAO,IAAI,aAAa,WAAW,GAAG,CAAC;AACzD,iBAAW,UAAU,GAAG;AAAA,IAC1B;AAAA,EACF;AAAA,EAEO,MAAM,aAAa;AAAA,IAOxB,YACU,WACA,WACR;AAFQ,WAAA,YAAA;AACA,WAAA,YAAA;AARV,WAAQ,gCAAuC,IAAA;AAC/C,WAAQ,mBAAkC;AAC1C,WAAQ,oBAAmC;AAC3C,WAAQ,kBAAkB;AAC1B,WAAQ,cAAc;AAiEtB,WAAQ,UAAU,MAAY;AAC5B,cAAM,MAAM,YAAY,IAAA;AACxB,cAAM,YAAY,KAAK,oBAAoB,MAAM,KAAK,oBAAoB;AAC1E,aAAK,oBAAoB;AAGzB,aAAK,UAAU,QAAQ,CAAC,aAAa;AACnC,mBAAS,QAAQ,SAAS;AAAA,QAC5B,CAAC;AAED,aAAK,mBAAmB,sBAAsB,KAAK,OAAO;AAAA,MAC5D;AAAA,IAvEG;AAAA;AAAA;AAAA;AAAA,IAKH,YAAY,OAOH;AACP,YAAM,YAAY,KAAK,UAAU,cAAc,aAAa;AAC5D,UAAI,CAAC,UAAW;AAEhB,YAAM,YAAY;AAClB,YAAM,mBAAmB;AAGzB,WAAK,mBAAmB,WAAW,sBAAsB,KAAK,UAAU,YAAY,KAAK,UAAU,MAAM,MAAM,kBAAkB,WAAW,SAAS;AACrJ,WAAK,mBAAmB,WAAW,yBAAyB,KAAK,UAAU,YAAY,KAAK,UAAU,SAAS,MAAM,qBAAqB,WAAW,SAAS;AAC9J,WAAK,mBAAmB,WAAW,mBAAmB,KAAK,UAAU,SAAS,KAAK,UAAU,MAAM,MAAM,eAAe,WAAW,gBAAgB;AACnJ,WAAK,mBAAmB,WAAW,gBAAgB,KAAK,UAAU,MAAM,KAAK,UAAU,MAAM,MAAM,YAAY,WAAW,SAAS;AACnI,WAAK,mBAAmB,WAAW,mBAAmB,KAAK,UAAU,MAAM,KAAK,UAAU,SAAS,MAAM,eAAe,WAAW,SAAS;AAC5I,WAAK,mBAAmB,WAAW,sBAAsB,KAAK,UAAU,YAAY,KAAK,UAAU,MAAM,MAAM,kBAAkB,WAAW,SAAS;AAAA,IACvJ;AAAA;AAAA;AAAA;AAAA,IAKA,QAAc;AACZ,UAAI,KAAK,iBAAkB;AAC3B,WAAK,oBAAoB,YAAY,IAAA;AACrC,WAAK,QAAA;AAAA,IACP;AAAA;AAAA;AAAA;AAAA,IAKA,OAAa;AACX,UAAI,KAAK,kBAAkB;AACzB,6BAAqB,KAAK,gBAAgB;AAC1C,aAAK,mBAAmB;AACxB,aAAK,oBAAoB;AAAA,MAC3B;AAAA,IACF;AAAA;AAAA;AAAA;AAAA,IAKA,QAAc;AACZ,WAAK,KAAA;AACL,WAAK,UAAU,MAAA;AACf,YAAM,YAAY,KAAK,UAAU,cAAc,aAAa;AAC5D,UAAI,WAAW;AACb,kBAAU,YAAY;AAAA,MACxB;AAAA,IACF;AAAA,IAeQ,mBACN,WACA,QACA,MACA,IACA,OACA,OACA,WACM;AACN,YAAM,mBAAmB,KAAK,UAAU,IAAI,MAAM;AAElD,UAAI,SAAS,WAAW;AACtB,YAAI,kBAAkB;AACpB,eAAK,YAAY,WAAW,MAAM;AAAA,QACpC;AACA;AAAA,MACF;AAEA,UAAI,CAAC,kBAAkB;AACrB,aAAK,SAAS,WAAW,QAAQ,MAAM,IAAI,OAAO,KAAK;AAAA,MACzD,OAAO;AACL,yBAAiB,OAAO,OAAO,KAAK;AAAA,MACtC;AAAA,IACF;AAAA,IAEQ,SACN,WACA,QACA,MACA,IACA,OACA,OACM;AAEN,YAAM,YAAY,SAAS,gBAAgB,8BAA8B,GAAG;AAC5E,gBAAU,aAAa,MAAM,MAAM;AACnC,gBAAU,YAAY,SAAS;AAG/B,YAAM,WAAW,IAAI;AAAA,QACnB;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA,KAAK;AAAA,QACL,KAAK;AAAA,MAAA;AAGP,WAAK,UAAU,IAAI,QAAQ,QAAQ;AAAA,IACrC;AAAA,IAEQ,WAAW,WAAwB,QAAsB;AAC/D,YAAM,OAAO,UAAU,cAAc,IAAI,MAAM,EAAE;AACjD,UAAI,MAAM;AACR,aAAK,OAAA;AACL,aAAK,UAAU,OAAO,MAAM;AAAA,MAC9B;AAAA,IACF;AAAA,IAEQ,YAAY,WAAwB,QAAsB;AAChE,YAAM,WAAW,KAAK,UAAU,IAAI,MAAM;AAC1C,UAAI,CAAC,SAAU;AAEf,eAAS,QAAQ,MAAM;AACrB,aAAK,WAAW,WAAW,MAAM;AAAA,MACnC,CAAC;AAAA,IACH;AAAA,EACF;AAAA,ECxTO,MAAM,gBAAgB;AAAA,IAsB3B,YACE,WACA,QACA,MACA,wBACA,iBACA,mBACA;AACA,WAAK,YAAY;AACjB,WAAK,SAAS;AACd,WAAK,OAAO;AACZ,WAAK,yBAAyB;AAC9B,WAAK,kBAAkB;AACvB,WAAK,oBAAoB;AAEzB,WAAK,6BAAa,IAAA;AAClB,WAAK,iBAAiB;AACtB,WAAK,6CAA6B,IAAA;AAClC,WAAK,gCAAgB,IAAA;AAGrB,WAAK,cAAc;AACnB,WAAK,eAAe;AAGpB,YAAM,UAAU;AAChB,YAAM,UAAU;AAGhB,WAAK,iBAAiB;AAAA,QACpB,YAAY,EAAE,GAAG,KAAK,SAAS,GAAG,KAAK,QAAA;AAAA,QACvC,SAAS,EAAE,GAAG,MAAM,SAAS,GAAG,MAAM,QAAA;AAAA,QACtC,MAAM,EAAE,GAAG,KAAK,SAAS,GAAG,MAAM,QAAA;AAAA,QAClC,MAAM,EAAE,GAAG,MAAM,SAAS,GAAG,MAAM,QAAA;AAAA,MAAQ;AAAA,IAE/C;AAAA;AAAA;AAAA;AAAA,IAKA,OAAO,MAA+B;AACpC,YAAM,EAAE,MAAM,MAAM,YAAY,SAAS,UAAU;AAGnD,YAAM,UAAU,KAAK,OAAO,MAAM,OAAO;AACzC,YAAM,UAAU,KAAK,OAAO,MAAM,OAAO;AACzC,YAAM,UAAU,KAAK,OAAO,KAAK,OAAO;AACxC,YAAM,gBAAgB,KAAK,OAAO,YAAY,OAAO;AACrD,YAAM,aAAa,KAAK,OAAO,SAAS,OAAO;AAC/C,YAAM,aAAa,KAAK,OAAO,SAAS,OAAO;AAG/C,UAAI,CAAC,KAAK,UAAU,cAAc,kBAAkB,GAAG;AACrD,aAAK,iBAAiB;AACtB,aAAK;AAAA,UACH;AAAA,UAAM;AAAA,UAAM;AAAA,UAAY;AAAA,UACxB;AAAA,UAAS;AAAA,UAAS;AAAA,UAAS;AAAA,UAAe;AAAA,UAAY;AAAA,QAAA;AAIxD,YAAI,CAAC,KAAK,gBAAgB;AACxB,gCAAsB,MAAM;AAC1B,iBAAK,iBAAA;AAAA,UACP,CAAC;AAAA,QACH;AAAA,MAGF,OAAO;AAEL,cAAM,kBAAkB,KAAK,OAAO,IAAI,YAAY;AACpD,cAAM,eAAe,KAAK,OAAO,IAAI,SAAS;AAC9C,cAAM,YAAY,KAAK,OAAO,IAAI,MAAM;AACxC,cAAM,YAAY,KAAK,OAAO,IAAI,MAAM;AAExC,YAAI,iCAAiC,QAAQ;AAC7C,YAAI,cAAc;AAChB,uBAAa,aAAa,KAAK,OAAO,SAAS,QAAQ,QAAQ;AAC/D,uBAAa,QAAQ;AAAA,QACvB;AACA,YAAI,qBAAqB,QAAQ;AACjC,YAAI,qBAAqB,QAAQ;AAGjC,YAAI,CAAC,KAAK,cAAc;AACtB,gBAAM,MAAM,KAAK,UAAU,cAAc,kBAAkB;AAC3D,cAAI,KAAK;AACP,iBAAK,eAAe,IAAI,aAAa,KAAmB,KAAK,cAAc;AAC3E,iBAAK,aAAa,MAAA;AAAA,UACpB;AAAA,QACF;AAAA,MACF;AAGA,UAAI,KAAK,cAAc;AACrB,aAAK,aAAa,YAAY,KAAK;AAAA,MACrC;AAAA,IACF;AAAA;AAAA;AAAA;AAAA,IAKA,OAAa;AAEX,UAAI,KAAK,cAAc;AACrB,aAAK,aAAa,KAAA;AAAA,MACpB;AAGA,WAAK,OAAO,QAAQ,CAAA,UAAS,MAAM,eAAe;AAGlD,WAAK,uBAAuB,QAAQ,CAAA,OAAM,aAAa,EAAE,CAAC;AAC1D,WAAK,uBAAuB,MAAA;AAAA,IAC9B;AAAA;AAAA;AAAA;AAAA,IAKA,QAAc;AACZ,WAAK,KAAA;AACL,UAAI,KAAK,cAAc;AACrB,aAAK,aAAa,MAAA;AAAA,MACpB;AAAA,IACF;AAAA;AAAA;AAAA;AAAA,IAKQ,oBACN,MACA,MACA,YACA,SACA,SACA,SACA,SACA,eACA,YACA,YACM;AAEN,YAAM,kBAAkB,IAAI;AAAA,QAAM;AAAA,QAAc;AAAA,QAAY;AAAA,QAAG;AAAA,QAAe;AAAA,QAC5E,KAAK,uBAAuB,cAAc,YAAY;AAAA,QACtD,KAAK,gBAAgB,cAAc,iBAAiB;AAAA,QACpD;AAAA,QACA;AAAA,QACA;AAAA,QACA,KAAK,OAAO,YAAY;AAAA,QACxB,KAAK,OAAO,YAAY;AAAA,QACxB,KAAK;AAAA,MAAA;AACP,YAAM,eAAe,IAAI;AAAA,QAAM;AAAA,QAAW;AAAA,QAAS;AAAA,QAAY;AAAA,QAAY;AAAA,QACzE,KAAK,uBAAuB,WAAW,SAAS;AAAA,QAChD,KAAK,gBAAgB,WAAW,aAAa;AAAA,QAC7C;AAAA,QACA,KAAK,OAAO,SAAS,QAAQ;AAAA,QAC7B,KAAK,OAAO,SAAS;AAAA,QACrB,KAAK,OAAO,SAAS;AAAA,QACrB,KAAK,OAAO,SAAS;AAAA,QACrB,KAAK;AAAA,MAAA;AACP,YAAM,YAAY,IAAI;AAAA,QAAM;AAAA,QAAQ;AAAA,QAAM;AAAA,QAAS;AAAA,QAAS;AAAA,QAC1D,KAAK,uBAAuB,QAAQ,MAAM;AAAA,QAC1C,KAAK,gBAAgB,QAAQ,wBAAwB;AAAA,QACrD;AAAA,QACA;AAAA,QACA;AAAA,QACA,KAAK,OAAO,MAAM;AAAA,QAClB,KAAK,OAAO,MAAM;AAAA,QAClB,KAAK;AAAA,MAAA;AACP,YAAM,YAAY,IAAI;AAAA,QAAM;AAAA,QAAQ;AAAA,QAAM;AAAA,QAAG;AAAA,QAAS;AAAA,QACpD,KAAK,uBAAuB,QAAQ,MAAM;AAAA,QAC1C,KAAK,gBAAgB,QAAQ,yBAAyB;AAAA,QACtD;AAAA,QACA;AAAA,QACA;AAAA,QACA,KAAK,OAAO,KAAK;AAAA,QACjB,KAAK,OAAO,KAAK;AAAA,QACjB,KAAK;AAAA,MAAA;AAEP,WAAK,UAAU,YAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,sDA+CuB,KAAK,WAAW,IAAI,KAAK,YAAY;AAAA;AAAA,gBAE3E,KAAK,iBAAiB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gFAO0C,KAAK,eAAe,WAAW,CAAC,KAAK,KAAK,eAAe,WAAW,CAAC;AAAA;AAAA;AAAA,6EAGxE,KAAK,eAAe,QAAQ,CAAC,KAAK,KAAK,eAAe,QAAQ,CAAC;AAAA;AAAA;AAAA,0EAGlE,KAAK,eAAe,KAAK,CAAC,KAAK,KAAK,eAAe,KAAK,CAAC;AAAA;AAAA;AAAA,0EAGzD,KAAK,eAAe,KAAK,CAAC,KAAK,KAAK,eAAe,KAAK,CAAC;AAAA;AAAA;AAAA;AAAA;AAO/H,4BAAsB,MAAM;AAC1B,cAAM,sBAAsB,KAAK,UAAU,cAAc,mBAAmB;AAC5E,cAAM,mBAAmB,KAAK,UAAU,cAAc,gBAAgB;AACtE,cAAM,gBAAgB,KAAK,UAAU,cAAc,aAAa;AAChE,cAAM,gBAAgB,KAAK,UAAU,cAAc,aAAa;AAEhE,YAAI,oBAAqB,qBAAoB,YAAY,gBAAgB,eAAe;AACxF,YAAI,iBAAkB,kBAAiB,YAAY,aAAa,eAAe;AAC/E,YAAI,cAAe,eAAc,YAAY,UAAU,eAAe;AACtE,YAAI,cAAe,eAAc,YAAY,UAAU,eAAe;AAEtE,aAAK,OAAO,IAAI,cAAc,eAAe;AAC7C,aAAK,OAAO,IAAI,WAAW,YAAY;AACvC,aAAK,OAAO,IAAI,QAAQ,SAAS;AACjC,aAAK,OAAO,IAAI,QAAQ,SAAS;AAGjC,wBAAgB,eAAA;AAChB,qBAAa,eAAA;AACb,kBAAU,eAAA;AACV,kBAAU,eAAA;AAGV,wBAAgB,cAAA;AAChB,qBAAa,cAAA;AACb,kBAAU,cAAA;AACV,kBAAU,cAAA;AAGV,cAAM,MAAM,KAAK,UAAU,cAAc,kBAAkB;AAC3D,YAAI,OAAO,CAAC,KAAK,cAAc;AAC7B,eAAK,eAAe,IAAI,aAAa,KAAmB,KAAK,cAAc;AAC3E,eAAK,aAAa,MAAA;AAAA,QACpB;AAAA,MACF,CAAC;AAAA,IACH;AAAA;AAAA;AAAA;AAAA,IAKQ,kBAA0B;AAChC,aAAO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAyBT;AAAA;AAAA;AAAA;AAAA,IAKQ,mBAAyB;AAC/B,YAAM,WAAW,CAAC,cAAc,WAAW,QAAQ,MAAM;AAEzD,eAAS,QAAQ,OAAO,YAAY;AAClC,cAAM,gBAAgB,KAAK,UAAU,cAAc,SAAS,OAAO,EAAE;AACrE,cAAM,aAAa,KAAK,UAAU,cAAc,YAAY,OAAO,EAAE;AAErE,YAAI,iBAAiB,YAAY;AAC/B,gBAAM,WAAW,WAAW,aAAa,MAAM,KAAK;AAGpD,gBAAM,aAAa,KAAK,UAAU,IAAI,QAAQ;AAC9C,cAAI,YAAY;AACd,iBAAK,eAAe,eAAe,UAAU;AAC7C;AAAA,UACF;AAEA,gBAAM,WAAW,MAAM,KAAK,gBAAgB,YAAY,QAAQ;AAChE,eAAK,eAAe,eAAe,QAAQ;AAAA,QAC7C;AAAA,MACF,CAAC;AAED,WAAK,iBAAiB;AAAA,IACxB;AAAA;AAAA;AAAA;AAAA,IAKA,MAAc,gBAAgB,aAAsB,UAAkB,cAAc,IAA4B;AAC9G,aAAO,IAAI,QAAQ,CAAC,YAAY;AAC9B,cAAM,oBAAoB,CAAC,UAAU,GAAG,MAAM,gBAAgB;AAC5D,gBAAM,QAAQ,YAAY,IAAI,IAAI,MAAM;AACxC,gBAAM,YAAY,OAAO,WAAW,YAAY;AAC9C,gBAAI;AACF,oBAAM,aAAc,YAAoB;AACxC,kBAAI,CAAC,YAAY;AACf,oBAAI,UAAU,KAAK;AACjB,oCAAkB,UAAU,GAAG,GAAG;AAAA,gBACpC,OAAO;AACL,0BAAQ,IAAI;AAAA,gBACd;AACA;AAAA,cACF;AAEA,oBAAM,MAAM,WAAW,cAAc,KAAK;AAC1C,kBAAI,CAAC,KAAK;AACR,oBAAI,UAAU,KAAK;AACjB,oCAAkB,UAAU,GAAG,GAAG;AAAA,gBACpC,OAAO;AACL,0BAAQ,IAAI;AAAA,gBACd;AACA;AAAA,cACF;AAEA,oBAAM,OAAO,IAAI,cAAc,MAAM;AACrC,kBAAI,MAAM;AACR,sBAAM,WAAW,KAAK,aAAa,GAAG;AACtC,oBAAI,YAAY,KAAK,WAAW;AAC9B,uBAAK,UAAU,IAAI,UAAU,QAAQ;AAAA,gBACvC;AACA,wBAAQ,QAAQ;AAAA,cAClB,OAAO;AACL,oBAAI,UAAU,KAAK;AACjB,oCAAkB,UAAU,GAAG,GAAG;AAAA,gBACpC,OAAO;AACL,0BAAQ,IAAI;AAAA,gBACd;AAAA,cACF;AAAA,YACF,SAAS,GAAG;AACV,sBAAQ,MAAM,mCAAmC,QAAQ,aAAa,OAAO,MAAM,CAAC;AACpF,kBAAI,UAAU,KAAK;AACjB,kCAAkB,UAAU,GAAG,GAAG;AAAA,cACpC,OAAO;AACL,wBAAQ,IAAI;AAAA,cACd;AAAA,YACF;AAAA,UACF,GAAG,KAAK;AACR,eAAK,uBAAuB,IAAI,SAAS;AAAA,QAC3C;AAEA,0BAAA;AAAA,MACF,CAAC;AAAA,IACH;AAAA;AAAA;AAAA;AAAA,IAKQ,eAAe,WAAoB,UAA+B;AACxE,gBAAU,YAAY;AAEtB,UAAI,UAAU;AACZ,cAAM,OAAO,SAAS,gBAAgB,8BAA8B,MAAM;AAC1E,aAAK,aAAa,KAAK,QAAQ;AAC/B,aAAK,aAAa,QAAQ,oBAAoB;AAC9C,aAAK,aAAa,aAAa,UAAU;AACzC,kBAAU,YAAY,IAAI;AAAA,MAC5B,OAAO;AACL,cAAM,SAAS,SAAS,gBAAgB,8BAA8B,QAAQ;AAC9E,eAAO,aAAa,MAAM,IAAI;AAC9B,eAAO,aAAa,MAAM,IAAI;AAC9B,eAAO,aAAa,KAAK,GAAG;AAC5B,eAAO,aAAa,QAAQ,oBAAoB;AAChD,kBAAU,YAAY,MAAM;AAAA,MAC9B;AAAA,IACF;AAAA,EACF;ACrdO,WAAS,gBACd,YACA,aACA,QACQ;AACR,UAAM,QAAkB,CAAA;AACxB,UAAM,WAAW;AAEjB,aAAS,IAAI,GAAG,KAAK,UAAU,KAAK;AAClC,YAAM,IAAI,OAAO,MAAO,IAAI,cAAc;AAC1C,YAAM,KAAK,aAAa,OAAO,IAAI,SAAS,CAAC,SAAS,OAAO,OAAO,UAAU,SAAS,CAAC,sCAAsC;AAAA,IAChI;AAEA,WAAO,MAAM,KAAK,IAAI;AAAA,EACxB;AAEO,WAAS,iBACd,YACA,aACA,QACA,aACQ;AACR,UAAM,SAAmB,CAAA;AACzB,UAAM,YAAY;AAClB,UAAM,0BAAU,KAAA;AAEhB,aAAS,IAAI,GAAG,KAAK,WAAW,KAAK;AACnC,YAAM,WAAW,cAAe,IAAI,cAAc;AAClD,YAAM,OAAO,IAAI,KAAK,IAAI,YAAY,WAAW,KAAK,KAAK,GAAI;AAG/D,YAAM,iBAAiB,KAAK,WAAA;AAC5B,YAAM,mBAAmB,iBAAiB,KAAK,IAAK,iBAAiB,KAAK,KAAK;AAC/E,YAAM,aAAc,kBAAkB,KAAM,IAAI;AAEhD,WAAK,WAAW,gBAAgB;AAChC,WAAK,WAAW,CAAC;AACjB,WAAK,gBAAgB,CAAC;AACtB,UAAI,YAAY;AACd,aAAK,SAAS,KAAK,SAAA,IAAa,UAAU;AAAA,MAC5C;AAEA,YAAM,IAAI,OAAO,OAAQ,IAAI,aAAa;AAC1C,YAAM,IAAI,OAAO,MAAM,cAAc;AAGrC,YAAM,QAAQ,KAAK,SAAA;AACnB,YAAM,UAAU,UAAU,IAAI,KAAM,QAAQ,KAAK,QAAQ,KAAK;AAC9D,YAAM,OAAO,SAAS,KAAK,OAAO;AAElC,aAAO,KAAK;AAAA,iBACC,CAAC,QAAQ,CAAC;AAAA,UACjB,OAAO,IAAI,IAAI;AAAA;AAAA,KAEpB;AAAA,IACH;AAEA,WAAO,OAAO,KAAK,IAAI;AAAA,EACzB;AAEO,WAAS,kBACd,cACA,cACA,QACA,WACA,WACA,WACQ;AACR,UAAM,SAAmB,CAAA;AAGzB,WAAO,KAAK,YAAY,OAAO,OAAO,EAAE,QAAQ,OAAO,MAAM,CAAC,gEAAgE,KAAK,MAAM,SAAS,CAAC,UAAU;AAG7J,WAAO,KAAK,YAAY,OAAO,OAAO,EAAE,QAAQ,YAAY,CAAC,uEAAuE;AAGpI,WAAO,KAAK,YAAY,OAAO,OAAO,EAAE,QAAQ,YAAY,eAAe,CAAC,iEAAiE,KAAK,MAAM,SAAS,CAAC,UAAU;AAE5K,WAAO,OAAO,KAAK,IAAI;AAAA,EACzB;AAEO,WAAS,eACd,YACA,OACA,SACA,QACA,QACA,aACA,iBACA,WACe;AACf,UAAM,SAA0C,CAAA;AAChD,UAAM,aAA8C,CAAA;AAEpD,QAAI,UAAU;AAEd,eAAW,QAAQ,CAAC,GAAG,MAAM;AAC3B,YAAM,IAAI,OAAO,OAAO,IAAI;AAC5B,YAAM,QAAQ,YAAY,CAAC;AAC3B,YAAM,YAAY,OAAO,oBAAoB,aAAa,gBAAgB,CAAC,IAAI;AAE/E,UAAI,QAAQ,EAAG,WAAU;AAEzB,YAAM,UAAU,cAAc,SAC1B,EAAE,QAAQ,aAAa,UACtB,QAAQ,aAAa;AAC1B,YAAM,cAAc,cAAc,SAC9B,CAAC,YAAY,SACb,YAAY;AAEhB,aAAO,KAAK,EAAE,GAAG,GAAG,UAAU,SAAS;AACvC,iBAAW,KAAK,EAAE,GAAG,GAAG,UAAU,aAAa;AAAA,IACjD,CAAC;AAED,QAAI,CAAC,QAAS,QAAO;AAGrB,QAAI,OAAO,KAAK,OAAO,CAAC,EAAE,CAAC,IAAI,OAAO,CAAC,EAAE,CAAC;AAC1C,aAAS,IAAI,GAAG,IAAI,OAAO,QAAQ,KAAK;AACtC,cAAQ,MAAM,OAAO,CAAC,EAAE,CAAC,IAAI,OAAO,CAAC,EAAE,CAAC;AAAA,IAC1C;AACA,aAAS,IAAI,WAAW,SAAS,GAAG,KAAK,GAAG,KAAK;AAC/C,cAAQ,MAAM,WAAW,CAAC,EAAE,CAAC,IAAI,WAAW,CAAC,EAAE,CAAC;AAAA,IAClD;AACA,YAAQ;AAER,WAAO;AAAA,EACT;AAEO,WAAS,eACd,YACA,YACA,aACA,QACA,QACA,WACQ;AACR,QAAI,CAAC,cAAc,WAAW,WAAW,EAAG,QAAO;AAEnD,UAAM,QAAQ,WAAW,SAAS,IAAI,cAAc,WAAW,SAAS,KAAK;AAG7E,UAAM,aAAa,WAAW,IAAI,CAAC,GAAG,MAAM;AAC1C,YAAM,IAAI,OAAO,OAAO,IAAI;AAC5B,YAAM,IAAI,YAAY,EAAE,OAAO;AAC/B,aAAO,GAAG,MAAM,IAAI,MAAM,GAAG,IAAI,CAAC,IAAI,CAAC;AAAA,IACzC,CAAC,EAAE,KAAK,GAAG;AAEX,WAAO,YAAY,UAAU;AAAA,EAC/B;AAAA,ECxGO,MAAM,cAAc;AAAA,IAWzB,YAAY,MAAW,QAAqB,WAAiD;AAP7F,WAAQ,gCAAqC,IAAA;AAE7C,WAAQ,qBAAqB;AAE7B,WAAQ,sBAAsB;AAI5B,WAAK,OAAO;AACZ,WAAK,SAAS;AACd,WAAK,YAAY;AAAA,IACnB;AAAA;AAAA;AAAA;AAAA,IAKA,iBAAiB,QAA+B;AAC9C,WAAK,kBAAkB;AAAA,IACzB;AAAA;AAAA;AAAA;AAAA,IAKA,OAAO,WAA8B;AAEnC,UAAI,CAAC,UAAU,cAAc,aAAa,GAAG;AAC3C,aAAK,yBAAyB,SAAS;AAAA,MACzC,WAAW,KAAK,iBAAiB;AAE/B,aAAK,+BAA+B,SAAS;AAAA,MAC/C;AAAA,IACF;AAAA;AAAA;AAAA;AAAA,IAKQ,yBAAyB,WAA8B;AAC7D,gBAAU,YAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAsDtB,YAAM,MAAM,UAAU,cAAc,YAAY;AAChD,UAAI,KAAK;AACP,mBAAW,MAAM;AACf,eAAK,oBAAoB,KAAK,EAAE;AAAA,QAClC,GAAG,GAAG;AAAA,MACR;AAAA,IACF;AAAA;AAAA;AAAA;AAAA,IAKQ,+BAA+B,WAA8B;AACnE,UAAI,KAAK,wBAAwB;AAC/B,qBAAa,KAAK,sBAAsB;AACxC,aAAK,yBAAyB;AAAA,MAChC;AAEA,YAAM,MAAM,KAAK,IAAA;AACjB,YAAM,sBAAsB,MAAM,KAAK;AACvC,YAAM,oBAAoB;AAE1B,UAAI,uBAAuB,mBAAmB;AAC5C,cAAM,MAAM,UAAU,cAAc,YAAY;AAChD,YAAI,IAAK,MAAK,sBAAsB,GAAG;AACvC,aAAK,sBAAsB;AAAA,MAC7B,OAAO;AACL,cAAM,QAAQ,oBAAoB;AAClC,aAAK,yBAAyB,OAAO,WAAW,MAAM;AACpD,gBAAM,MAAM,UAAU,cAAc,YAAY;AAChD,cAAI,IAAK,MAAK,sBAAsB,GAAG;AACvC,eAAK,sBAAsB,KAAK,IAAA;AAChC,eAAK,yBAAyB;AAAA,QAChC,GAAG,KAAK;AAAA,MACV;AAAA,IACF;AAAA;AAAA;AAAA;AAAA,IAKA,UAAgB;AACd,UAAI,KAAK,wBAAwB;AAC/B,qBAAa,KAAK,sBAAsB;AACxC,aAAK,yBAAyB;AAAA,MAChC;AACA,WAAK,iBAAiB;AAAA,IACxB;AAAA;AAAA;AAAA;AAAA,IAKQ,QAAQ,eAAuB,iBAAyB,UAA0B;AACxF,YAAM,aAAc,KAAK,OAAe,aAAa;AACrD,UAAI,WAAY,QAAO;AAEvB,YAAM,WAAY,KAAK,OAAe,eAAe;AACrD,UAAI,YAAY,KAAK,KAAK,OAAO,QAAQ,GAAG;AAC1C,cAAM,aAAa,KAAK,KAAK,OAAO,QAAQ,EAAE,WAAW;AACzD,YAAI,WAAY,QAAO;AAAA,MACzB;AAEA,aAAO;AAAA,IACT;AAAA;AAAA;AAAA;AAAA,IAKA,MAAM,oBAAoB,YAAqB,cAAc,IAAmB;AAC9E,UAAI,KAAK,mBAAoB;AAE7B,YAAM,MAAM,KAAK,IAAA;AACjB,YAAM,WAAW,KAAK,iBAAiB,MAAM,KAAK,eAAe,YAAY;AAC7E,YAAM,cAAc,IAAI,KAAK;AAG7B,UAAI,KAAK,kBAAkB,YAAY,aAAa;AAClD,aAAK,iBAAiB;AAAA,MACxB;AAGA,UAAI,KAAK,kBAAkB,WAAW,aAAa;AACjD,8BAAsB,MAAM;AAC1B,eAAK,qBAAqB,UAAU;AAAA,QACtC,CAAC;AACD;AAAA,MACF;AAEA,WAAK,qBAAqB;AAC1B,YAAM,0BAAU,KAAA;AAChB,YAAM,QAAQ,IAAI,KAAK,IAAI,YAAY,cAAc,KAAK,KAAK,GAAI;AAEnE,UAAI;AAEF,cAAM,CAAC,mBAAmB,aAAa,aAAa,cAAc,IAAI,MAAM,QAAQ,IAAI;AAAA,UACtF,KAAK,aAAa,KAAK,OAAO,mBAAmB,OAAO,GAAG;AAAA,UAC3D,KAAK,aAAa,KAAK,OAAO,aAAa,OAAO,GAAG;AAAA,UACrD,KAAK,aAAa,KAAK,OAAO,aAAa,OAAO,GAAG;AAAA,UACrD,KAAK,aAAa,KAAK,OAAO,gBAAgB,OAAO,GAAG;AAAA,QAAA,CACzD;AAGD,cAAM,eAAe,MAAM;AACzB,eAAK,qBAAqB,YAAY,mBAAmB,aAAa,aAAa,gBAAgB,WAAW;AAC9G,eAAK,qBAAqB;AAAA,QAC5B;AAEA,YAAI,yBAAyB,QAAQ;AAClC,iBAAe,oBAAoB,cAAc,EAAE,SAAS,KAAM;AAAA,QACrE,OAAO;AACL,qBAAW,cAAc,CAAC;AAAA,QAC5B;AAAA,MACF,SAAS,OAAO;AACd,gBAAQ,MAAM,8BAA8B,KAAK;AACjD,aAAK,qBAAqB;AAC1B,mBAAW,YAAY;AAAA;AAAA;AAAA;AAAA;AAAA,MAKzB;AAAA,IACF;AAAA;AAAA;AAAA;AAAA,IAKA,MAAc,aAAa,UAAkB,OAAa,KAAoE;AAC5H,YAAM,MAAM,kBAAkB,MAAM,YAAA,CAAa,qBAAqB,QAAQ,aAAa,IAAI,YAAA,CAAa;AAE5G,YAAM,WAAW,MAAM,KAAK,KAAK,QAAQ,OAAO,GAAG;AACnD,aAAO,YAAY,SAAS,SAAS,IAAI,SAAS,CAAC,IAAI,CAAA;AAAA,IACzD;AAAA;AAAA;AAAA;AAAA,IAKA,qBAAqB,YAA2B;AAC9C,UAAI,CAAC,KAAK,eAAgB;AAE1B,YAAM,aAAa,KAAK,eAAe;AAGvC,YAAM,YAAY,KAAK,IAAI,GAAG,WAAW,IAAI,CAAA,MAAK,EAAE,QAAQ,EAAE,mBAAmB,EAAE,UAAU,GAAG,GAAG,WAAW,IAAI,CAAA,MAAK,EAAE,IAAI,CAAC;AAC9H,YAAM,YAAY,KAAK,IAAI,GAAG,WAAW,IAAI,CAAA,MAAK,EAAE,gBAAgB,EAAE,UAAU,CAAC;AACjF,YAAM,aAAa,YAAY;AAC/B,YAAM,cAAc,aAAa,IAAI,YAAY,aAAa;AAC9D,YAAM,cAAc,aAAa,IAAI,YAAY,aAAa;AAE9D,YAAM,QAAQ;AACd,YAAM,SAAS;AACf,YAAM,SAAS,EAAE,KAAK,IAAI,OAAO,KAAK,QAAQ,IAAI,MAAM,GAAA;AACxD,YAAM,aAAa,QAAQ,OAAO,OAAO,OAAO;AAChD,YAAM,cAAc,SAAS,OAAO,MAAM,OAAO;AAEjD,YAAM,eAAe,cAAc;AACnC,YAAM,eAAe,cAAc;AAEnC,YAAM,cAAc,YAAY,IAAI,gBAAgB,YAAY,OAAO;AACvE,YAAM,cAAc,YAAY,IAAI,gBAAgB,YAAY,OAAO;AACvE,YAAM,YAAY,OAAO,MAAM;AAG/B,YAAM,cAAc,KAAK,mBAAmB,YAAY,YAAY,cAAc,aAAa,QAAQ,UAAU,SAAS;AAC1H,YAAM,cAAc,KAAK,mBAAmB,YAAY,YAAY,cAAc,aAAa,QAAQ,UAAU,SAAS;AAC1H,YAAM,WAAW,eAAe,YAAY,YAAY,cAAc,aAAa,QAAQ,SAAS;AAEpG,YAAM,eAAe;AAAA;AAAA,UAEf,gBAAgB,YAAY,aAAa,MAAM,CAAC;AAAA;AAAA,kBAExC,OAAO,IAAI,SAAS,SAAS,SAAS,OAAO,OAAO,UAAU,SAAS,SAAS;AAAA,QAC1F,WAAW;AAAA,QACX,WAAW;AAAA,QACX,iBAAiB,YAAY,aAAa,QAAQ,EAAE,CAAC;AAAA,QACrD,kBAAkB,cAAc,cAAc,QAAQ,WAAW,WAAW,SAAS,CAAC;AAAA;AAG1F,iBAAW,YAAY;AAEvB,WAAK,sBAAsB,UAAU;AACrC,WAAK,iBAAiB,YAAY,QAAQ;AAAA,IAC5C;AAAA;AAAA;AAAA;AAAA,IAKA,MAAc,qBACZ,YACA,mBACA,aACA,aACA,gBACA,aACe;AACf,YAAM,QAAQ;AACd,YAAM,SAAS;AACf,YAAM,SAAS,EAAE,KAAK,IAAI,OAAO,KAAK,QAAQ,IAAI,MAAM,GAAA;AACxD,YAAM,aAAa,QAAQ,OAAO,OAAO,OAAO;AAChD,YAAM,cAAc,SAAS,OAAO,MAAM,OAAO;AAGjD,YAAM,mBAAmB;AACzB,YAAM,iBAAiB,cAAc;AACrC,YAAM,uBAAuB;AAC7B,YAAM,qBAAqB,cAAc;AACzC,YAAM,0BAA0B;AAGhC,YAAM,0BAAU,KAAA;AAChB,YAAM,aAAa,KAAK,MAAM,IAAI,WAAA,IAAe,CAAC,IAAI;AACtD,YAAM,MAAM,IAAI,KAAK,IAAI,YAAA,GAAe,IAAI,SAAA,GAAY,IAAI,WAAW,IAAI,YAAY,YAAY,GAAG,CAAC;AACvG,YAAM,QAAQ,IAAI,KAAK,IAAI,YAAY,cAAc,KAAK,KAAK,GAAI;AAGnE,YAAM,YAAY;AAClB,YAAM,gBAA6B,CAAA;AAEnC,eAAS,aAAa,GAAG,aAAa,gBAAgB,cAAc,WAAW;AAC7E,cAAM,WAAW,KAAK,IAAI,aAAa,WAAW,cAAc;AAEhE,YAAI,aAAa,GAAG;AAClB,gBAAM,IAAI,QAAQ,CAAA,YAAW,WAAW,SAAS,CAAC,CAAC;AAAA,QACrD;AAEA,iBAAS,IAAI,YAAY,IAAI,UAAU,KAAK;AAC1C,gBAAM,OAAO,IAAI,KAAK,MAAM,YAAY,IAAI,KAAK,GAAI;AAErD,gBAAM,aAAa,KAAK,iBAAiB,mBAAmB,IAAI;AAChE,gBAAM,OAAO,KAAK,iBAAiB,aAAa,IAAI;AACpD,gBAAM,OAAO,KAAK,iBAAiB,aAAa,IAAI;AACpD,cAAI,UAAU,KAAK,iBAAiB,gBAAgB,IAAI;AAExD,cAAI,KAAK,OAAO,qBAAqB;AACnC,sBAAU,CAAC;AAAA,UACb;AAEA,wBAAc,KAAK;AAAA,YACjB;AAAA,YACA,OAAO,KAAK,IAAI,GAAG,UAAU;AAAA,YAC7B,kBAAkB,KAAK,IAAI,GAAG,OAAO;AAAA,YACrC,eAAe,KAAK,IAAI,GAAG,CAAC,OAAO;AAAA,YACnC,YAAY,KAAK,IAAI,GAAG,IAAI;AAAA,YAC5B,YAAY,KAAK,IAAI,GAAG,CAAC,IAAI;AAAA,YAC7B,MAAM,KAAK,IAAI,GAAG,IAAI;AAAA,UAAA,CACvB;AAAA,QACH;AAAA,MACF;AAGA,YAAM,aAA0B,CAAA;AAEhC,eAAS,IAAI,GAAG,IAAI,oBAAoB,KAAK;AAC3C,cAAM,cAAc,IAAI,KAAK,MAAM,QAAA,KAAa,IAAI,KAAK,IAAI,KAAK,GAAI;AACtE,cAAM,WAAW,IAAI;AACrB,cAAM,SAAS,KAAK,IAAI,WAAW,yBAAyB,cAAc,MAAM;AAChF,cAAM,aAAa,SAAS;AAE5B,YAAI,WAAW,GAAG,sBAAsB,GAAG,mBAAmB;AAC9D,YAAI,gBAAgB,GAAG,gBAAgB,GAAG,UAAU;AAEpD,iBAAS,IAAI,UAAU,IAAI,QAAQ,KAAK;AACtC,sBAAY,cAAc,CAAC,EAAE;AAC7B,iCAAuB,cAAc,CAAC,EAAE;AACxC,8BAAoB,cAAc,CAAC,EAAE;AACrC,2BAAiB,cAAc,CAAC,EAAE;AAClC,2BAAiB,cAAc,CAAC,EAAE;AAClC,qBAAW,cAAc,CAAC,EAAE;AAAA,QAC9B;AAEA,mBAAW,KAAK;AAAA,UACd,MAAM;AAAA,UACN,OAAO,WAAW;AAAA,UAClB,kBAAkB,sBAAsB;AAAA,UACxC,eAAe,mBAAmB;AAAA,UAClC,YAAY,gBAAgB;AAAA,UAC5B,YAAY,gBAAgB;AAAA,UAC5B,MAAM,UAAU;AAAA,QAAA,CACjB;AAAA,MACH;AAGA,WAAK,iBAAiB;AAAA,QACpB,WAAW,KAAK,IAAA;AAAA,QAChB;AAAA,MAAA;AAIF,YAAM,YAAY,KAAK,IAAI,GAAG,WAAW,IAAI,CAAA,MAAK,EAAE,QAAQ,EAAE,mBAAmB,EAAE,UAAU,GAAG,GAAG,WAAW,IAAI,CAAA,MAAK,EAAE,IAAI,CAAC;AAC9H,YAAM,YAAY,KAAK,IAAI,GAAG,WAAW,IAAI,CAAA,MAAK,EAAE,gBAAgB,EAAE,UAAU,CAAC;AAEjF,YAAM,aAAa,YAAY;AAC/B,YAAM,cAAc,aAAa,IAAI,YAAY,aAAa;AAC9D,YAAM,cAAc,aAAa,IAAI,YAAY,aAAa;AAE9D,YAAM,cAAc,YAAY,IAAK,cAAc,eAAgB,YAAY,OAAO;AACtF,YAAM,cAAc,YAAY,IAAK,cAAc,eAAgB,YAAY,OAAO;AACtF,YAAM,QAAQ,KAAK,IAAI,aAAa,WAAW;AAE/C,YAAM,eAAe,YAAY,QAAQ;AACzC,YAAM,eAAe,YAAY,QAAQ;AACzC,YAAM,YAAY,OAAO,MAAM;AAG/B,YAAM,cAAc,KAAK,mBAAmB,YAAY,YAAY,cAAc,OAAO,QAAQ,UAAU,SAAS;AACpH,YAAM,cAAc,KAAK,mBAAmB,YAAY,YAAY,cAAc,OAAO,QAAQ,UAAU,SAAS;AACpH,YAAM,WAAW,eAAe,YAAY,YAAY,cAAc,OAAO,QAAQ,SAAS;AAG9F,YAAM,aAAa;AAAA;AAAA,UAEb,gBAAgB,YAAY,aAAa,MAAM,CAAC;AAAA;AAAA,kBAExC,OAAO,IAAI,SAAS,SAAS,SAAS,OAAO,OAAO,UAAU,SAAS,SAAS;AAAA,QAC1F,WAAW;AAAA,QACX,WAAW;AAAA,QACX,iBAAiB,YAAY,aAAa,QAAQ,WAAW,CAAC;AAAA,QAC9D,kBAAkB,cAAc,cAAc,QAAQ,WAAW,WAAW,SAAS,CAAC;AAAA,QACtF,KAAK,wBAAwB;AAAA;AAGjC,iBAAW,YAAY;AAGvB,WAAK,6BAA6B,UAAU;AAG5C,4BAAsB,MAAM;AAC1B,8BAAsB,MAAM;AAC1B,gCAAsB,MAAM;AAC1B,iBAAK,kBAAkB,YAAY,YAAY,YAAY,cAAc,cAAc,OAAO,OAAO,QAAQ,SAAS;AAEtH,kCAAsB,MAAM;AAC1B,mBAAK,iBAAiB,YAAY,QAAQ;AAAA,YAC5C,CAAC;AAAA,UACH,CAAC;AAAA,QACH,CAAC;AAAA,MACH,CAAC;AAAA,IACH;AAAA;AAAA;AAAA;AAAA,IAKQ,iBAAiBA,UAAyD,YAA0B;AAC1G,UAAIA,SAAQ,WAAW,EAAG,QAAO;AAEjC,UAAI,eAAeA,SAAQ,CAAC;AAC5B,UAAI,UAAU,KAAK,IAAI,IAAI,KAAKA,SAAQ,CAAC,EAAE,YAAY,EAAE,QAAA,IAAY,WAAW,SAAS;AAEzF,iBAAW,SAASA,UAAS;AAC3B,cAAM,OAAO,KAAK,IAAI,IAAI,KAAK,MAAM,YAAY,EAAE,QAAA,IAAY,WAAW,QAAA,CAAS;AACnF,YAAI,OAAO,SAAS;AAClB,oBAAU;AACV,yBAAe;AAAA,QACjB;AAAA,MACF;AAEA,aAAO,WAAW,aAAa,KAAK,KAAK;AAAA,IAC3C;AAAA;AAAA;AAAA;AAAA,IAKQ,mBACN,YACA,YACA,aACA,QACA,QACA,MACA,WACQ;AACR,YAAM,cAAc,WAAW;AAC/B,YAAM,QAAQ,cAAc,cAAc;AAE1C,UAAI,SAAS,UAAU;AACrB,cAAM,YAAY;AAAA,UAAe;AAAA,UAAY;AAAA,UAAO;AAAA,UAAW;AAAA,UAAQ;AAAA,UACrE,OAAK,EAAE;AAAA,UAAO;AAAA,UAAG;AAAA,QAAA;AAEnB,cAAM,cAAc;AAAA,UAAe;AAAA,UAAY;AAAA,UAAO;AAAA,UAAW;AAAA,UAAQ;AAAA,UACvE,OAAK,EAAE;AAAA,UAAkB,OAAK,EAAE;AAAA,UAAO;AAAA,QAAA;AAEzC,cAAM,WAAW;AAAA,UAAe;AAAA,UAAY;AAAA,UAAO;AAAA,UAAW;AAAA,UAAQ;AAAA,UACpE,OAAK,EAAE;AAAA,UAAY,CAAA,MAAK,EAAE,QAAQ,EAAE;AAAA,UAAkB;AAAA,QAAA;AAExD,eAAO;AAAA,UACH,WAAW,wCAAwC,QAAQ,+DAA+D,EAAE;AAAA,UAC5H,cAAc,8CAA8C,WAAW,+DAA+D,EAAE;AAAA,UACxI,YAAY,kCAAkC,SAAS,gEAAgE,EAAE;AAAA;AAAA,MAE/H,OAAO;AACL,cAAM,oBAAoB;AAAA,UAAe;AAAA,UAAY;AAAA,UAAO;AAAA,UAAW;AAAA,UAAQ;AAAA,UAC7E,OAAK,EAAE;AAAA,UAAe;AAAA,UAAG;AAAA,QAAA;AAE3B,cAAM,iBAAiB;AAAA,UAAe;AAAA,UAAY;AAAA,UAAO;AAAA,UAAW;AAAA,UAAQ;AAAA,UAC1E,OAAK,EAAE;AAAA,UAAY,OAAK,EAAE;AAAA,UAAe;AAAA,QAAA;AAE3C,eAAO;AAAA,UACH,iBAAiB,wCAAwC,cAAc,+DAA+D,EAAE;AAAA,UACxI,oBAAoB,2CAA2C,iBAAiB,+DAA+D,EAAE;AAAA;AAAA,MAEvJ;AAAA,IACF;AAAA;AAAA;AAAA;AAAA,IAKQ,yBAAiC;AACvC,YAAM,WAAW,KAAK,QAAQ,aAAa,eAAe,yBAAyB;AACnF,YAAM,YAAY,KAAK,QAAQ,mBAAmB,qBAAqB,iBAAiB;AACxF,YAAM,cAAc,KAAK,QAAQ,gBAAgB,kBAAkB,aAAa;AAChF,YAAM,WAAW,KAAK,QAAQ,aAAa,eAAe,wBAAwB;AAElF,aAAO;AAAA;AAAA;AAAA,2BAGgB,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA,2BAKR,SAAS;AAAA;AAAA;AAAA;AAAA;AAAA,2BAKT,WAAW;AAAA;AAAA;AAAA;AAAA;AAAA,2BAKX,QAAQ;AAAA;AAAA;AAAA;AAAA,IAIjC;AAAA;AAAA;AAAA;AAAA,IAKA,MAAc,kBACZ,YACA,YACA,YACA,cACA,cACA,aACA,aACA,QACA,WACe;AACf,UAAI,WAAW,WAAW,EAAG;AAE7B,YAAM,YAAY,CAAC,QAAQ,SAAS,WAAW,MAAM;AACrD,YAAM,YAA8C,CAAA;AAEpD,iBAAW,QAAQ,WAAW;AAC5B,cAAM,eAAe,WAAW,cAAc,sBAAsB,IAAI,EAAE;AAC1E,YAAI,CAAC,aAAc;AAEnB,cAAM,YAAY,aAAa,cAAc,KAAK;AAClD,YAAI,CAAC,UAAW;AAEhB,cAAM,aAAa,UAAU,cAAc,SAAS;AACpD,YAAI,CAAC,WAAY;AAEjB,cAAM,WAAW,WAAW,aAAa,MAAM;AAC/C,YAAI,CAAC,SAAU;AAEf,YAAI,KAAK,UAAU,IAAI,QAAQ,GAAG;AAChC,oBAAU,IAAI,IAAI,KAAK,UAAU,IAAI,QAAQ,KAAK;AAClD;AAAA,QACF;AAEA,cAAM,WAAW,MAAM,KAAK,gBAAgB,YAAY,QAAQ;AAChE,kBAAU,IAAI,IAAI;AAClB,YAAI,UAAU;AACZ,eAAK,UAAU,IAAI,UAAU,QAAQ;AAAA,QACvC;AAAA,MACF;AAEA,WAAK,sBAAsB,YAAY,YAAY,YAAY,cAAc,cAAc,aAAa,aAAa,QAAQ,WAAW,SAAS;AAAA,IACnJ;AAAA;AAAA;AAAA;AAAA,IAKA,MAAc,gBAAgB,aAAsB,UAAkB,cAAc,IAA4B;AAC9G,eAAS,UAAU,GAAG,UAAU,aAAa,WAAW;AACtD,YAAI;AACF,gBAAM,aAAa,YAAY;AAC/B,cAAI,CAAC,YAAY;AACf,kBAAM,IAAI,QAAQ,CAAA,YAAW,WAAW,SAAS,GAAG,CAAC;AACrD;AAAA,UACF;AAEA,cAAI,aAAa,WAAW,cAAc,KAAK;AAE/C,cAAI,CAAC,YAAY;AACf,kBAAM,YAAY,WAAW,cAAc,aAAa;AACxD,gBAAI,aAAa,UAAU,YAAY;AACrC,2BAAa,UAAU,WAAW,cAAc,KAAK;AAAA,YACvD;AAAA,UACF;AAEA,cAAI,CAAC,YAAY;AACf,kBAAM,IAAI,QAAQ,CAAA,YAAW,WAAW,SAAS,GAAG,CAAC;AACrD;AAAA,UACF;AAEA,gBAAM,cAAc,WAAW,cAAc,MAAM;AACnD,cAAI,CAAC,aAAa;AAChB,kBAAM,IAAI,QAAQ,CAAA,YAAW,WAAW,SAAS,GAAG,CAAC;AACrD;AAAA,UACF;AAEA,gBAAM,WAAW,YAAY,aAAa,GAAG;AAC7C,cAAI,UAAU;AACZ,mBAAO;AAAA,UACT;AAAA,QACF,SAAS,GAAG;AACV,kBAAQ,MAAM,mCAAmC,QAAQ,aAAa,UAAU,CAAC,MAAM,CAAC;AAAA,QAC1F;AAEA,cAAM,IAAI,QAAQ,CAAA,YAAW,WAAW,SAAS,GAAG,CAAC;AAAA,MACvD;AAEA,aAAO;AAAA,IACT;AAAA;AAAA;AAAA;AAAA,IAKQ,sBACN,YACA,YACA,YACA,cACA,cACA,aACA,aACA,QACA,WACA,WACM;AACN,UAAI,kBAAkB,WAAW,cAAc,mBAAmB;AAClE,YAAM,gBAAgB,CAAC;AAEvB,UAAI,CAAC,iBAAiB;AACpB,0BAAkB,SAAS,gBAAgB,8BAA8B,GAAG;AAC5E,wBAAgB,aAAa,MAAM,kBAAkB;AACrD,mBAAW,YAAY,eAAe;AAAA,MACxC;AAEA,UAAI,eAAe;AACjB,cAAM,cAAc,WAAW,iBAAiB,4BAA4B;AAC5E,oBAAY,QAAQ,CAAA,WAAU,OAAO,OAAA,CAAQ;AAAA,MAC/C;AAGA,UAAI;AACJ,UAAI,KAAK,iBAAiB;AACxB,cAAM,EAAE,MAAM,MAAM,YAAY,QAAA,IAAY,KAAK;AACjD,wBAAgB;AAAA,UACd,MAAM,KAAK,IAAI,GAAG,IAAI;AAAA,UACtB,OAAO,KAAK,IAAI,GAAG,UAAU;AAAA,UAC7B,kBAAkB,KAAK,IAAI,GAAG,OAAO;AAAA,UACrC,eAAe,KAAK,IAAI,GAAG,CAAC,OAAO;AAAA,UACnC,YAAY,KAAK,IAAI,GAAG,IAAI;AAAA,UAC5B,YAAY,KAAK,IAAI,GAAG,CAAC,IAAI;AAAA,QAAA;AAAA,MAEjC,OAAO;AACL,wBAAgB,WAAW,WAAW,SAAS,CAAC;AAAA,MAClD;AAEA,YAAM,SAAS,OAAO,OAAO;AAG7B,YAAM,QAAQ,YAAY,cAAc,OAAO;AAC/C,YAAM,SAAS,YAAY,cAAc,QAAQ;AACjD,YAAM,oBAAoB,aAAa,cAAc,QAAQ,cAAc,oBAAoB;AAC/F,YAAM,cAAc,aAAa,cAAc,QAAQ,cAAc,mBAAmB,cAAc,cAAc;AACpH,YAAM,iBAAiB,YAAY,cAAc,gBAAgB;AACjE,YAAM,cAAc,aAAa,cAAc,gBAAgB,cAAc,cAAc;AAE3F,YAAM,cAAc,CAAC,UAA0B;AAC7C,eAAO,GAAG,KAAK,MAAM,KAAK,CAAC;AAAA,MAC7B;AAEA,YAAM,kBAAkB,CAAC,IAAY,GAAW,OAAe,UAAkB,OAAe,SAAS,IAAI,aAAa,MAAM,QAAiB,cAAoB;AACnK,YAAI,QAAQ,gBAAiB,cAAc,IAAI,EAAE,EAAE;AAEnD,YAAI,CAAC,YAAY;AACf,cAAI,aAAa,OAAA;AACjB;AAAA,QACF;AAEA,YAAI,CAAC,OAAO;AACV,kBAAQ,SAAS,gBAAgB,8BAA8B,GAAG;AAClE,gBAAM,aAAa,MAAM,EAAE;AAC3B,gBAAM,MAAM,SAAS;AAErB,gBAAM,WAAW,UAAU,QAAQ;AACnC,cAAI,UAAU;AACZ,kBAAM,OAAO,SAAS,gBAAgB,8BAA8B,GAAG;AACvE,iBAAK,aAAa,SAAS,gBAAgB;AAC3C,iBAAK,aAAa,aAAa,+BAA+B;AAE9D,kBAAM,OAAO,SAAS,gBAAgB,8BAA8B,MAAM;AAC1E,iBAAK,aAAa,KAAK,QAAQ;AAC/B,iBAAK,aAAa,QAAQ,KAAK;AAC/B,iBAAK,YAAY,IAAI;AAErB,kBAAM,YAAY,IAAI;AAAA,UACxB;AAEA,gBAAMC,QAAO,SAAS,gBAAgB,8BAA8B,MAAM;AAC1EA,gBAAK,aAAa,SAAS,gBAAgB;AAC3CA,gBAAK,aAAa,KAAK,IAAI;AAC3BA,gBAAK,aAAa,KAAK,GAAG;AAC1BA,gBAAK,aAAa,QAAQ,KAAK;AAC/BA,gBAAK,aAAa,aAAa,IAAI;AACnCA,gBAAK,aAAa,eAAe,KAAK;AACtC,gBAAM,YAAYA,KAAI;AAEtB,cAAI,UAAU,WAAW;AACvB,kBAAM,iBAAiB,SAAS,MAAM;AACpC,2BAAa,KAAK,MAAM,KAAK,WAAW,WAAW,MAAM;AAAA,YAC3D,CAAC;AAAA,UACH;AAEA,0BAAiB,YAAY,KAAK;AAAA,QACpC;AAEA,cAAM,aAAa,aAAa,aAAa,SAAS,EAAE,KAAK,CAAC,GAAG;AAEjE,cAAM,OAAO,MAAM,cAAc,iBAAiB;AAClD,YAAI,MAAM;AACR,eAAK,cAAc,GAAG,MAAM,GAAG,KAAK;AAAA,QACtC;AAAA,MACF;AAGA,sBAAgB,mBAAmB,QAAQ,WAAW,SAAS,YAAY,cAAc,KAAK,GAAG,IAAI,cAAc,QAAQ,GAAG,KAAK,OAAO,mBAAmB,KAAK,OAAO,qBAAqB;AAC9L,sBAAgB,+BAA+B,mBAAmB,WAAW,WAAW,YAAY,cAAc,gBAAgB,GAAG,KAAK,cAAc,mBAAmB,GAAG,KAAK,OAAO,gBAAgB,KAAK,OAAO,kBAAkB;AACxO,sBAAgB,yBAAyB,aAAa,WAAW,QAAQ,YAAY,cAAc,UAAU,GAAG,IAAI,cAAc,aAAa,GAAG,KAAK,OAAO,aAAa,KAAK,OAAO,eAAe;AACtM,sBAAgB,4BAA4B,gBAAgB,WAAW,WAAW,YAAY,cAAc,aAAa,GAAG,KAAK,cAAc,gBAAgB,GAAG,KAAK,OAAO,gBAAgB,KAAK,OAAO,kBAAkB;AAC5N,sBAAgB,yBAAyB,aAAa,WAAW,QAAQ,YAAY,cAAc,UAAU,GAAG,IAAI,cAAc,aAAa,GAAG,KAAK,OAAO,aAAa,KAAK,OAAO,eAAe;AACtM,sBAAgB,kBAAkB,OAAO,WAAW,QAAQ,YAAY,cAAc,IAAI,GAAG,IAAI,MAAM,KAAK,OAAO,aAAa,KAAK,OAAO,eAAe;AAAA,IAC7J;AAAA;AAAA;AAAA;AAAA,IAKA,sBAAsB,YAA2B;AAC/C,UAAI,CAAC,KAAK,kBAAkB,CAAC,WAAY;AAEzC,YAAM,aAAa,KAAK,eAAe;AACvC,YAAM,YAAY,KAAK,IAAI,GAAG,WAAW,IAAI,CAAA,MAAK,EAAE,QAAQ,EAAE,mBAAmB,EAAE,UAAU,GAAG,GAAG,WAAW,IAAI,CAAA,MAAK,EAAE,IAAI,CAAC;AAC9H,YAAM,YAAY,KAAK,IAAI,GAAG,WAAW,IAAI,CAAA,MAAK,EAAE,gBAAgB,EAAE,UAAU,CAAC;AAEjF,YAAM,aAAa,YAAY;AAC/B,YAAM,cAAc,aAAa,IAAI,YAAY,aAAa;AAC9D,YAAM,cAAc,aAAa,IAAI,YAAY,aAAa;AAE9D,YAAM,QAAQ;AACd,YAAM,SAAS;AACf,YAAM,SAAS,EAAE,KAAK,IAAI,OAAO,KAAK,QAAQ,IAAI,MAAM,GAAA;AACxD,YAAM,aAAa,QAAQ,OAAO,OAAO,OAAO;AAChD,YAAM,cAAc,SAAS,OAAO,MAAM,OAAO;AAEjD,YAAM,eAAe,cAAc;AACnC,YAAM,eAAe,cAAc;AAEnC,YAAM,cAAc,YAAY,IAAI,gBAAgB,YAAY,OAAO;AACvE,YAAM,cAAc,YAAY,IAAI,gBAAgB,YAAY,OAAO;AACvE,YAAM,YAAY,OAAO,MAAM;AAG/B,YAAM,YAA8C,CAAA;AACpD,OAAC,QAAQ,SAAS,WAAW,MAAM,EAAE,QAAQ,CAAA,SAAQ;AACnD,cAAM,WAAW,KAAK,QAAQ,GAAG,IAAI,SAAS,GAAG,IAAI,WAAW,EAAE;AAClE,YAAI,KAAK,UAAU,IAAI,QAAQ,GAAG;AAChC,oBAAU,IAAI,IAAI,KAAK,UAAU,IAAI,QAAQ,KAAK;AAAA,QACpD;AAAA,MACF,CAAC;AAED,WAAK,sBAAsB,YAAY,YAAY,YAAY,cAAc,cAAc,aAAa,aAAa,QAAQ,WAAW,SAAS;AAAA,IACnJ;AAAA;AAAA;AAAA;AAAA,IAKQ,iBAAiB,YAAqB,UAAwB;AACpE,UAAI,CAAC,SAAU;AAEf,YAAM,mBAAmB,WAAW,cAAc,YAAY;AAC9D,UAAI,kBAAkB;AACpB,yBAAiB,OAAA;AAAA,MACnB;AAEA,YAAM,YAAY,SAAS,MAAM,aAAa;AAC9C,UAAI,CAAC,UAAW;AAEhB,YAAM,WAAW,UAAU,CAAC;AAE5B,YAAM,OAAO,SAAS,gBAAgB,8BAA8B,MAAM;AAC1E,WAAK,aAAa,MAAM,WAAW;AACnC,WAAK,aAAa,KAAK,QAAQ;AAC/B,WAAK,aAAa,QAAQ,MAAM;AAChC,WAAK,aAAa,UAAU,SAAS;AACrC,WAAK,aAAa,gBAAgB,GAAG;AACrC,WAAK,aAAa,WAAW,KAAK;AAClC,WAAK,MAAM,SAAS;AAEpB,WAAK,iBAAiB,SAAS,MAAM;AACnC,qBAAa,KAAK,MAAM,KAAK,WAAW,KAAK,OAAO,iBAAiB,KAAK,OAAO,WAAW;AAAA,MAC9F,CAAC;AAED,iBAAW,YAAY,IAAI;AAAA,IAC7B;AAAA;AAAA;AAAA;AAAA,IAKQ,6BAA6B,YAA2B;AAC9D,YAAM,YAAY,WAAW,cAAc,mBAAmB;AAC9D,UAAI,WAAW;AACb,kBAAU,iBAAiB,SAAS,MAAM;AACxC,uBAAa,KAAK,MAAM,KAAK,WAAW,KAAK,OAAO,uBAAuB,KAAK,OAAO,iBAAiB;AAAA,QAC1G,CAAC;AAAA,MACH;AAEA,YAAM,uBAAuB,WAAW,cAAc,+BAA+B;AACrF,UAAI,sBAAsB;AACxB,6BAAqB,iBAAiB,SAAS,MAAM;AACnD,uBAAa,KAAK,MAAM,KAAK,WAAW,KAAK,OAAO,oBAAoB,KAAK,OAAO,cAAc;AAAA,QACpG,CAAC;AAAA,MACH;AAEA,YAAM,oBAAoB,WAAW,cAAc,4BAA4B;AAC/E,UAAI,mBAAmB;AACrB,0BAAkB,iBAAiB,SAAS,MAAM;AAChD,uBAAa,KAAK,MAAM,KAAK,WAAW,KAAK,OAAO,oBAAoB,KAAK,OAAO,cAAc;AAAA,QACpG,CAAC;AAAA,MACH;AAEA,YAAM,iBAAiB,WAAW,cAAc,yBAAyB;AACzE,UAAI,gBAAgB;AAClB,uBAAe,iBAAiB,SAAS,MAAM;AAC7C,uBAAa,KAAK,MAAM,KAAK,WAAW,KAAK,OAAO,iBAAiB,KAAK,OAAO,WAAW;AAAA,QAC9F,CAAC;AAAA,MACH;AAEA,YAAM,iBAAiB,WAAW,cAAc,yBAAyB;AACzE,UAAI,gBAAgB;AAClB,uBAAe,iBAAiB,SAAS,MAAM;AAC7C,uBAAa,KAAK,MAAM,KAAK,WAAW,KAAK,OAAO,iBAAiB,KAAK,OAAO,WAAW;AAAA,QAC9F,CAAC;AAAA,MACH;AAAA,IACF;AAAA;AAAA;AAAA;AAAA,IAKA,aAAmB;AACjB,WAAK,iBAAiB;AAAA,IACxB;AAAA,EACF;AAAA,ECr4BA,MAAM,uBAAuB,YAAY;AAAA,IASvC,cAAc;AACZ,YAAA;AACA,WAAK,kBAAkB;AAAA,IACzB;AAAA,IAEA,OAAO,gBAAgB;AACrB,aAAO,CAAA;AAAA,IACT;AAAA,IAEA,OAAO,gBAAgB;AACrB,aAAO;AAAA,QACL,QAAQ;AAAA,UACN,EAAE,MAAM,aAAa,OAAO,aAAa,UAAU,EAAE,QAAQ,EAAE,SAAS,CAAC,EAAC,OAAO,WAAW,OAAO,aAAY,EAAC,OAAO,WAAW,OAAO,cAAA,GAAgB,EAAC,OAAO,mBAAmB,OAAO,uBAAA,GAAyB,EAAC,OAAO,SAAS,OAAO,SAAQ,EAAA,IAAI;AAAA,UACxP,EAAE,MAAM,eAAe,OAAO,QAAQ,UAAU,MAAM,UAAU,EAAE,QAAQ,EAAE,QAAQ,UAAU,cAAc,QAAA,IAAU;AAAA,UACtH,EAAE,MAAM,aAAa,UAAU,EAAE,aAAa,GAAC,GAAK,SAAS,EAAE,QAAQ,gBAAc;AAAA,UACrF,EAAE,MAAM,aAAa,UAAU,EAAE,MAAM,GAAC,GAAK,SAAS,EAAE,aAAa,gBAAc;AAAA,UACnF,EAAE,MAAM,YAAY,OAAO,gBAAgB,UAAU,EAAE,QAAQ,EAAE,MAAM,MAAA,IAAQ;AAAA,UAC/E,EAAE,MAAM,YAAY,OAAO,gBAAgB,UAAU,EAAE,QAAQ,EAAE,MAAM,MAAA,IAAQ;AAAA,UAC/E,EAAE,MAAM,mBAAmB,OAAO,mBAAmB,UAAU,EAAE,aAAa,CAAA,IAAG;AAAA,UACjF,EAAE,MAAM,eAAe,OAAO,QAAQ,UAAU,MAAM,UAAU,EAAE,QAAQ,EAAE,QAAQ,UAAU,cAAc,QAAA,IAAU;AAAA,UACtH,EAAE,MAAM,aAAa,UAAU,EAAE,aAAa,GAAC,GAAK,SAAS,EAAE,QAAQ,gBAAc;AAAA,UACrF,EAAE,MAAM,aAAa,UAAU,EAAE,MAAM,GAAC,GAAK,SAAS,EAAE,aAAa,gBAAc;AAAA,UACnF,EAAE,MAAM,YAAY,OAAO,gBAAgB,UAAU,EAAE,QAAQ,EAAE,MAAM,MAAA,IAAQ;AAAA,UAC/E,EAAE,MAAM,mBAAmB,OAAO,mBAAmB,UAAU,EAAE,aAAa,CAAA,IAAG;AAAA,UACjF,EAAE,MAAM,qBAAqB,OAAO,cAAc,UAAU,MAAM,UAAU,EAAE,QAAQ,EAAE,QAAQ,UAAU,cAAc,QAAA,IAAU;AAAA,UAClI,EAAE,MAAM,mBAAmB,UAAU,EAAE,aAAa,GAAC,GAAK,SAAS,EAAE,QAAQ,sBAAoB;AAAA,UACjG,EAAE,MAAM,mBAAmB,UAAU,EAAE,MAAM,GAAC,GAAK,SAAS,EAAE,aAAa,sBAAoB;AAAA,UAC/F,EAAE,MAAM,kBAAkB,OAAO,sBAAsB,UAAU,EAAE,QAAQ,EAAE,MAAM,MAAA,IAAQ;AAAA,UAC3F,EAAE,MAAM,yBAAyB,OAAO,yBAAyB,UAAU,EAAE,aAAa,CAAA,IAAG;AAAA,UAC7F,EAAE,MAAM,kBAAkB,OAAO,WAAW,UAAU,MAAM,UAAU,EAAE,QAAQ,EAAE,QAAQ,UAAU,cAAc,QAAA,IAAU;AAAA,UAC5H,EAAE,MAAM,gBAAgB,UAAU,EAAE,aAAa,GAAC,GAAK,SAAS,EAAE,QAAQ,mBAAiB;AAAA,UAC3F,EAAE,MAAM,gBAAgB,UAAU,EAAE,MAAM,GAAC,GAAK,SAAS,EAAE,aAAa,mBAAiB;AAAA,UACzF,EAAE,MAAM,eAAe,OAAO,mBAAmB,UAAU,EAAE,QAAQ,EAAE,MAAM,MAAA,IAAQ;AAAA,UACrF,EAAE,MAAM,eAAe,OAAO,mBAAmB,UAAU,EAAE,QAAQ,EAAE,MAAM,MAAA,IAAQ;AAAA,UACrF,EAAE,MAAM,sBAAsB,OAAO,sBAAsB,UAAU,EAAE,aAAa,CAAA,IAAG;AAAA,UACvF,EAAE,MAAM,sBAAsB,OAAO,0BAA0B,UAAU,EAAE,QAAQ,EAAE,QAAQ,SAAA,IAAW;AAAA,UACxG,EAAE,MAAM,uBAAuB,OAAO,uBAAuB,UAAU,EAAE,SAAS,CAAA,IAAG;AAAA,UACrF,EAAE,MAAM,uBAAuB,OAAO,uBAAuB,UAAU,EAAE,SAAS,CAAA,IAAG;AAAA,UACrF,EAAE,MAAM,aAAa,OAAO,eAAe,UAAU,EAAE,SAAS,GAAC,EAAE;AAAA,QAAE;AAAA,MACvE;AAAA,IAEJ;AAAA,IAEA,oBAAoB;AAElB,WAAK,kBAAkB,IAAI,eAAe,MAAM;AAAA,MAEhD,CAAC;AAGD,UAAI,KAAK,eAAe;AACtB,aAAK,gBAAgB,QAAQ,KAAK,aAAa;AAAA,MACjD;AACA,WAAK,gBAAgB,QAAQ,IAAI;AAAA,IAGnC;AAAA,IAEA,uBAAuB;AACrB,UAAI,KAAK,iBAAiB;AACxB,aAAK,gBAAgB,WAAA;AACrB,aAAK,kBAAkB;AAAA,MACzB;AAGA,UAAI,KAAK,kBAAkB;AACzB,aAAK,iBAAiB,KAAA;AAAA,MACxB;AACA,UAAI,KAAK,gBAAgB;AACvB,aAAK,eAAe,QAAA;AAAA,MACtB;AAAA,IACF;AAAA,IAEA,UAAU,QAAoC;AAC5C,WAAK,UAAU,KAAK,iBAAiB,MAAM;AAC3C,WAAK,cAAc,WAAW;AAAA,IAChC;AAAA,IAEA,IAAI,KAAK,MAAqB;AAC5B,WAAK,QAAQ;AACb,WAAK,cAAc,aAAa;AAAA,IAClC;AAAA,IAEQ,cAAc,SAAiB;AACrC,UAAI;AACF,aAAK,QAAA;AAAA,MACP,SAAS,OAAO;AACd,gBAAQ,MAAM,yCAAyC,SAAS,KAAK;AACrE,aAAK,YAAY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAOnB;AAAA,IACF;AAAA,IAEA,UAAU;AACR,UAAI,CAAC,KAAK,WAAW,CAAC,KAAK,MAAO;AAClC,UAAI,CAAC,KAAK,QAAQ,KAAM;AAExB,YAAM,YAAY,KAAK,gBAAgB,KAAK,QAAQ,MAAM,MAAM;AAChE,YAAM,YAAY,KAAK,gBAAgB,KAAK,QAAQ,KAAK,MAAM;AAC/D,YAAM,kBAAkB,KAAK,gBAAgB,KAAK,QAAQ,YAAY,MAAM;AAC5E,YAAM,eAAe,KAAK,gBAAgB,KAAK,QAAQ,SAAS,MAAM;AAGtE,YAAM,OAAO,WAAW,WAAW,SAAS,GAAG,KAAK;AACpD,YAAM,OAAO,WAAW,WAAW,SAAS,GAAG,KAAK;AACpD,YAAM,aAAa,WAAW,iBAAiB,SAAS,GAAG,KAAK;AAChE,UAAI,UAAU,WAAW,cAAc,SAAS,GAAG,KAAK;AAGxD,UAAI,KAAK,QAAQ,SAAS,QAAQ,MAAM;AACtC,kBAAU,CAAC;AAAA,MACb;AAGA,YAAM,WAAW,KAAK,QAAQ,QAAQ;AAGtC,UAAI,KAAK,kBAAkB,WAAW,aAAa,WAAW,KAAK,gBAAgB;AACjF,aAAK,eAAe,QAAA;AAAA,MACtB;AAEA,UAAI,aAAa,aAAa,aAAa,mBAAmB;AAC5D,aAAK,mBAAmB,MAAM,MAAM,YAAY,SAAS,QAA2B;AACpF,aAAK,gBAAgB;AACrB;AAAA,MACF;AACA,UAAI,aAAa,SAAS;AAExB,YAAI,CAAC,KAAK,gBAAgB;AACxB,gBAAM,cAAc;AAAA,YAClB,mBAAmB,KAAK,QAAQ,YAAY,UAAU;AAAA,YACtD,aAAa,KAAK,QAAQ,MAAM,UAAU;AAAA,YAC1C,aAAa,KAAK,QAAQ,KAAK;AAAA,YAC/B,gBAAgB,KAAK,QAAQ,SAAS,UAAU;AAAA,YAChD,qBAAqB,KAAK,QAAQ,SAAS,QAAQ;AAAA,YACnD,iBAAiB,KAAK,QAAQ,YAAY;AAAA,YAC1C,WAAW,KAAK,QAAQ,MAAM;AAAA,YAC9B,WAAW,KAAK,QAAQ,KAAK;AAAA,YAC7B,cAAc,KAAK,QAAQ,SAAS;AAAA,YACpC,uBAAuB,KAAK,QAAQ,YAAY;AAAA,YAChD,iBAAiB,KAAK,QAAQ,MAAM;AAAA,YACpC,iBAAiB,KAAK,QAAQ,KAAK;AAAA,YACnC,oBAAoB,KAAK,QAAQ,SAAS;AAAA,UAAA;AAE5C,eAAK,iBAAiB,IAAI,cAAc,KAAK,OAAO,aAAa,KAAK,WAAW,KAAK,IAAI,CAAC;AAAA,QAC7F;AAGA,aAAK,eAAe,iBAAiB,EAAE,MAAM,MAAM,YAAY,SAAS;AACxE,aAAK,eAAe,OAAO,IAAI;AAC/B,aAAK,gBAAgB;AACrB;AAAA,MACF;AAGA,UAAI,CAAC,KAAK,kBAAkB;AAC1B,aAAK,mBAAmB,IAAI;AAAA,UAC1B;AAAA,UACA,KAAK;AAAA,UACL,KAAK;AAAA,UACL,KAAK,gBAAgB,KAAK,IAAI;AAAA,UAC9B,KAAK,SAAS,KAAK,IAAI;AAAA,UACvB,KAAK,WAAW,KAAK,IAAI;AAAA,QAAA;AAAA,MAE7B;AAGA,YAAM,QAAQ,KAAK,gBAAgB,MAAM,YAAY,MAAM,OAAO;AAClE,WAAK,iBAAiB,OAAO,EAAE,MAAM,MAAM,YAAY,SAAS,OAAO;AAEvE,WAAK,gBAAgB;AAAA,IACvB;AAAA,IAEQ,gBAAgB,UAA8B;AACpD,UAAI,CAAC,SAAU,QAAO;AACtB,aAAO,KAAK,OAAO,SAAS,QAAQ;AAAA,IACtC;AAAA,IAEQ,uBAAuB,MAAkD;AAC/E,aAAO,KAAK,UAAU,IAAI;AAAA,IAC5B;AAAA,IAEQ,gBAAgB,MAAkD,UAA0B;AAClG,YAAM,eAAe,KAAK,uBAAuB,IAAI;AACrD,UAAI,CAAC,aAAc,QAAO;AAG1B,UAAI,aAAa,MAAM;AACrB,eAAO,aAAa;AAAA,MACtB;AAGA,UAAI,aAAa,QAAQ;AACvB,cAAM,cAAc,KAAK,gBAAgB,aAAa,MAAM;AAC5D,YAAI,aAAa,YAAY,eAAe;AAC1C,iBAAO,YAAY,WAAW;AAAA,QAChC;AAAA,MACF;AAGA,aAAO;AAAA,IACT;AAAA,IAEQ,SAAS,MAAkD,UAA0B;AAC3F,YAAM,eAAe,KAAK,uBAAuB,IAAI;AACrD,UAAI,CAAC,aAAc,QAAO;AAG1B,UAAI,aAAa,MAAM;AACrB,eAAO,aAAa;AAAA,MACtB;AAGA,UAAI,aAAa,QAAQ;AACvB,cAAM,cAAc,KAAK,gBAAgB,aAAa,MAAM;AAC5D,YAAI,aAAa,YAAY,MAAM;AACjC,iBAAO,YAAY,WAAW;AAAA,QAChC;AAAA,MACF;AAGA,aAAO;AAAA,IACT;AAAA,IAEQ,cAAc,cAA+B,UAAyB;AAC5E,UAAI,CAAC,KAAK,MAAO;AAGjB,YAAM,SAAS,gBAAgB,EAAE,QAAQ,YAAA;AACzC,YAAM,SAAS,OAAO,UAAU;AAEhC,cAAQ,QAAA;AAAA,QACN,KAAK;AACH,gBAAM,eAAe,OAAO,UAAU;AACtC,eAAK,WAAW,kBAAkB,EAAE,UAAU,cAAc;AAC5D;AAAA,QAEF,KAAK;AACH,cAAI,OAAO,iBAAiB;AAC1B,oBAAQ,UAAU,MAAM,IAAI,OAAO,eAAe;AAClD,iBAAK,WAAW,oBAAoB,EAAE,SAAS,OAAO,sBAAsB,OAAO;AAAA,UACrF;AACA;AAAA,QAEF,KAAK;AACH,cAAI,OAAO,UAAU;AACnB,mBAAO,KAAK,OAAO,QAAQ;AAAA,UAC7B;AACA;AAAA,QAEF,KAAK;AACH,eAAK,MAAM,YAAY,iBAAiB,UAAU,EAAE,WAAW,UAAU;AACzE;AAAA,QAEF,KAAK;AACH,cAAI,OAAO,gBAAgB;AACzB,kBAAM,CAAC,QAAQ,OAAO,IAAI,OAAO,eAAe,MAAM,GAAG;AACzD,iBAAK,MAAM,YAAY,QAAQ,SAAS,OAAO,QAAQ,CAAA,GAAI,OAAO,MAAM;AAAA,UAC1E;AACA;AAAA,QAEF,KAAK;AACH,eAAK,WAAW,eAAe;AAAA,YAC7B,WAAW;AAAA,YACX,cAAc;AAAA,cACZ,aAAa,OAAO,eAAe;AAAA,cACnC,iBAAiB,OAAO;AAAA,YAAA;AAAA,UAC1B,CACD;AACD;AAAA,MAIA;AAAA,IAEN;AAAA,IAEQ,WAAW,MAAc,SAAc,IAAU;AAEvD,UAAI,SAAS,kBAAkB,KAAK,OAAO;AACzC,aAAK,MAAM,YAAY,OAAO,QAAQ,OAAO,SAAS,OAAO,gBAAgB,IAAI,OAAO,MAAM;AAC9F;AAAA,MACF;AAEA,YAAM,QAAQ,IAAI,YAAY,MAAM;AAAA,QAClC;AAAA,QACA,SAAS;AAAA,QACT,UAAU;AAAA,MAAA,CACX;AACD,WAAK,cAAc,KAAK;AAAA,IAC1B;AAAA;AAAA;AAAA;AAAA;AAAA,IAMQ,gBAAgB,MAAc,YAAoB,MAAc,SAAiB;AACvF,aAAO,qBAAqB,EAAE,MAAM,YAAY,MAAM,SAAS;AAAA,IACjE;AAAA,IAEQ,mBAAmB,MAAc,MAAc,YAAoB,SAAiB,UAAiC;AAC3H,UAAI,CAAC,KAAK,WAAW,CAAC,KAAK,MAAO;AAGlC,UAAI,CAAC,KAAK,kBAAkB;AAC1B,aAAK,mBAAmB,IAAI;AAAA,UAC1B;AAAA,UACA,KAAK;AAAA,UACL,KAAK;AAAA,UACL;AAAA,UACA,CAAC,MAAM,aAAa,KAAK,SAAS,MAAM,QAAQ;AAAA,UAChD,CAAC,QAAQ,WAAW,KAAK,cAAc,QAAQ,MAAM;AAAA,QAAA;AAAA,MAEzD,OAAO;AACL,aAAK,iBAAiB,YAAY,QAAQ;AAAA,MAC5C;AAGA,YAAM,QAAQ,KAAK,gBAAgB,MAAM,YAAY,MAAM,OAAO;AAGlE,UAAI,aAA4B;AAChC,UAAI,KAAK,QAAQ,SAAS,YAAY;AACpC,cAAM,WAAW,KAAK,gBAAgB,KAAK,QAAQ,QAAQ,UAAU;AACrE,qBAAa,WAAW,UAAU,SAAS,GAAG,KAAK;AAAA,MACrD;AAGA,WAAK,iBAAiB,OAAO;AAAA,QAC3B;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,MAAA,CACD;AAAA,IACH;AAAA,IAEQ,iBAAiB,QAA0E;AAEjG,UAAK,OAAgC,MAAM;AACzC,eAAO;AAAA,MACT;AAEA,YAAM,kBAAkB,CAAC,WAA6C;AACpE,cAAM,WAAY,OAAe,GAAG,MAAM,SAAS;AACnD,YAAI,CAAC,SAAU,QAAO;AAEtB,cAAM,aAA2B,EAAE,QAAQ,SAAA;AAC3C,cAAM,OAAQ,OAAe,GAAG,MAAM,OAAO;AAC7C,cAAM,OAAQ,OAAe,GAAG,MAAM,OAAO;AAC7C,cAAM,MAAO,OAAe,GAAG,MAAM,MAAM;AAC3C,cAAM,MAAO,OAAe,GAAG,MAAM,MAAM;AAC3C,cAAM,MAAO,OAAe,GAAG,MAAM,aAAa;AAClD,cAAM,OAAQ,OAAe,GAAG,MAAM,cAAc;AAEpD,YAAI,SAAS,OAAW,YAAW,OAAO;AAC1C,YAAI,SAAS,OAAW,YAAW,OAAO;AAC1C,YAAI,QAAQ,OAAW,YAAW,MAAM;AACxC,YAAI,QAAQ,OAAW,YAAW,MAAM;AACxC,YAAI,QAAQ,OAAW,YAAW,MAAM;AACxC,YAAI,SAAS,OAAW,YAAW,OAAO;AAE1C,eAAO;AAAA,MACT;AAEA,YAAM,OAAO,gBAAgB,MAAM;AACnC,YAAM,OAAO,gBAAgB,MAAM;AACnC,YAAM,aAAa,gBAAgB,YAAY;AAC/C,YAAM,gBAAgB,gBAAgB,SAAS;AAE/C,UAAI,eAAe;AACjB,cAAM,MAAO,OAAe,oBAAoB;AAChD,cAAM,aAAc,OAAe,qBAAqB;AACxD,cAAM,aAAc,OAAe,qBAAqB;AACxD,cAAM,WAAY,OAAe,WAAW;AAE5C,YAAI,QAAQ,OAAW,eAAc,aAAa;AAClD,YAAI,eAAe,UAAa,eAAe,QAAW;AACxD,wBAAc,SAAS;AAAA,YACrB,MAAM,eAAe,SAAY,aAAa,cAAc,QAAQ;AAAA,YACpE,MAAM,eAAe,SAAY,aAAa,cAAc,QAAQ;AAAA,UAAA;AAAA,QAExE;AACA,YAAI,aAAa,OAAW,eAAc,WAAW;AAAA,MACvD;AAGA,YAAM,OAAQ,OAAe,aAAc,OAAe;AAG1D,UAAI,CAAC,MAAM;AACT,eAAO;AAAA,MACT;AAEA,aAAO;AAAA,QACL;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA,SAAS;AAAA,MAAA;AAAA,IAEb;AAAA,EAEF;AAGA,QAAM,WAAW;AACjB,MAAI,CAAC,eAAe,IAAI,QAAQ,GAAG;AACjC,mBAAe,OAAO,UAAU,cAAc;AAC9C,YAAQ,KAAK,yCAAyC;AAAA,EACxD,OAAO;AACL,YAAQ,KAAK,iDAAiD;AAAA,EAChE;AAQA,SAAO,cAAc,OAAO,eAAe,CAAA;AAC3C,SAAO,YAAY,KAAK;AAAA,IACtB,MAAM;AAAA,IACN,MAAM;AAAA,IACN,aAAa;AAAA,EACf,CAAC;;"}