{"version":3,"file":"energy-flow-card.js","sources":["../src/flow-calculator.ts","../src/Config.ts","../src/utils/helpers.ts","../src/renderers/CompactRenderer.ts","../src/Meter.ts","../src/renderers/FlowRenderer.ts","../src/renderers/DefaultRenderer.ts","../src/chart/chart-utils.ts","../src/renderers/ChartRenderer.ts","../src/energy-flow-card.ts"],"sourcesContent":["/**\r\n * Energy Flow Calculator\r\n * \r\n * Calculates energy flows between components (production, battery, grid, load)\r\n * based on sensor readings.\r\n */\r\n\r\nimport type { SensorValues, EnergyFlows } from './types/EnergyFlow';\r\n\r\n/**\r\n * Calculate energy flows between components based on sensor readings.\r\n * \r\n * Strategy: Trust sensor readings and only show flows when confirmed by the relevant sensors.\r\n * The sensors may not perfectly balance due to measurement timing, conversion losses, and \r\n * unaccounted consumption (e.g., battery charging inefficiency). This is normal and expected.\r\n * \r\n * @param sensors - Power sensor values for all components\r\n * @returns Calculated flow values for each connection between components\r\n */\r\nexport function calculateEnergyFlows(sensors: SensorValues): EnergyFlows {\r\n  const productionFlow = Math.max(0, sensors.production);\r\n  const gridFlow = sensors.grid; // positive = import, negative = export\r\n  const batteryFlow = sensors.battery; // positive = discharge, negative = charge\r\n  const loadDemand = Math.max(0, sensors.load);\r\n  \r\n  // Initialize all possible flows\r\n  const flows: EnergyFlows = {\r\n    productionToLoad: 0,\r\n    productionToBattery: 0,\r\n    productionToGrid: 0,\r\n    gridToLoad: 0,\r\n    gridToBattery: 0,\r\n    batteryToLoad: 0\r\n  };\r\n  \r\n  // Track remaining capacity\r\n  let remainingProduction = productionFlow;\r\n  let remainingLoad = loadDemand;\r\n  \r\n  // Step 1: Production → Load (highest priority)\r\n  // Production first serves the home load\r\n  if (remainingProduction > 0 && remainingLoad > 0) {\r\n    flows.productionToLoad = Math.min(remainingProduction, remainingLoad);\r\n    remainingProduction -= flows.productionToLoad;\r\n    remainingLoad -= flows.productionToLoad;\r\n  }\r\n  \r\n  // Step 2: Production → Battery (when charging)\r\n  // Excess production can charge the battery\r\n  if (batteryFlow < 0 && remainingProduction > 0) {\r\n    flows.productionToBattery = Math.min(remainingProduction, Math.abs(batteryFlow));\r\n    remainingProduction -= flows.productionToBattery;\r\n  }\r\n  \r\n  // Step 3: Battery → Load (when discharging)\r\n  // Battery can supplement production to meet load\r\n  if (batteryFlow > 0 && remainingLoad > 0) {\r\n    flows.batteryToLoad = Math.min(batteryFlow, remainingLoad);\r\n    remainingLoad -= flows.batteryToLoad;\r\n  }\r\n  \r\n  // Step 4: Grid → Load (importing)\r\n  // Grid imports to cover any remaining load\r\n  if (remainingLoad > 0 && gridFlow > 0) {\r\n    flows.gridToLoad = Math.min(gridFlow, remainingLoad);\r\n    remainingLoad -= flows.gridToLoad;\r\n  }\r\n  \r\n  // Step 5: Grid → Battery (importing to charge)\r\n  // Grid can charge battery when production is insufficient\r\n  // Use threshold to avoid showing noise from measurement fluctuations\r\n  if (batteryFlow < 0 && gridFlow > 10) {\r\n    const batteryNeed = Math.abs(batteryFlow) - flows.productionToBattery;\r\n    if (batteryNeed > 1) { // Threshold to avoid micro-flows from noise\r\n      flows.gridToBattery = Math.min(gridFlow - flows.gridToLoad, batteryNeed);\r\n    }\r\n  }\r\n  \r\n  // Step 6: Production → Grid (exporting)\r\n  // Only show export flow when grid sensor confirms export (negative value)\r\n  // Use threshold to avoid showing phantom exports at zero\r\n  if (gridFlow < -10) { // Threshold: grid must be clearly exporting\r\n    flows.productionToGrid = Math.abs(gridFlow);\r\n  }\r\n  \r\n  return flows;\r\n}\r\n","import type { BatteryEntityConfig, EnergyFlowCardConfig, EntityConfig } from './types/Config.d.ts';\r\n\r\n// UI schema used by Home Assistant's visual editor (flat keys)\r\nexport function getConfigForm() {\r\n  return {\r\n    schema: [\r\n      { name: 'view_mode', label: 'View Mode', selector: { select: { options: [\r\n        { value: 'default', label: 'Default' },\r\n        { value: 'compact', label: 'Compact Bar' },\r\n        { value: 'compact-battery', label: 'Compact with Battery' },\r\n        { value: 'chart', label: 'Chart' }\r\n      ] } } },\r\n      { name: 'grid_entity', label: 'Grid', required: true, selector: { entity: { domain: 'sensor', device_class: 'power' } } },\r\n      { name: 'grid_name', selector: { entity_name: {} }, context: { entity: 'grid_entity' } },\r\n      { name: 'grid_icon', selector: { icon: {} }, context: { icon_entity: 'grid_entity' } },\r\n      { name: 'grid_min', label: 'Grid Min (W)', selector: { number: { mode: 'box' } } },\r\n      { name: 'grid_max', label: 'Grid Max (W)', selector: { number: { mode: 'box' } } },\r\n      { name: 'grid_tap_action', label: 'Grid Tap Action', selector: { 'ui-action': {} } },\r\n      { name: 'grid_hold_action', label: 'Grid Hold Action', selector: { 'ui-action': {} } },\r\n      { name: 'load_entity', label: 'Load', required: true, selector: { entity: { domain: 'sensor', device_class: 'power' } } },\r\n      { name: 'load_name', selector: { entity_name: {} }, context: { entity: 'load_entity' } },\r\n      { name: 'load_icon', selector: { icon: {} }, context: { icon_entity: 'load_entity' } },\r\n      { name: 'load_max', label: 'Load Max (W)', selector: { number: { mode: 'box' } } },\r\n      { name: 'load_tap_action', label: 'Load Tap Action', selector: { 'ui-action': {} } },\r\n      { name: 'load_hold_action', label: 'Load Hold Action', selector: { 'ui-action': {} } },\r\n      { name: 'production_entity', label: 'Production', required: true, selector: { entity: { domain: 'sensor', device_class: 'power' } } },\r\n      { name: 'production_name', selector: { entity_name: {} }, context: { entity: 'production_entity' } },\r\n      { name: 'production_icon', selector: { icon: {} }, context: { icon_entity: 'production_entity' } },\r\n      { name: 'production_max', label: 'Production Max (W)', selector: { number: { mode: 'box' } } },\r\n      { name: 'production_tap_action', label: 'Production Tap Action', selector: { 'ui-action': {} } },\r\n      { name: 'production_hold_action', label: 'Production Hold Action', selector: { 'ui-action': {} } },\r\n      { name: 'battery_entity', label: 'Battery', required: true, selector: { entity: { domain: 'sensor', device_class: 'power' } } },\r\n      { name: 'battery_name', selector: { entity_name: {} }, context: { entity: 'battery_entity' } },\r\n      { name: 'battery_icon', selector: { icon: {} }, context: { icon_entity: 'battery_entity' } },\r\n      { name: 'battery_min', label: 'Battery Min (W)', selector: { number: { mode: 'box' } } },\r\n      { name: 'battery_max', label: 'Battery Max (W)', selector: { number: { mode: 'box' } } },\r\n      { name: 'battery_tap_action', label: 'Battery Tap Action', selector: { 'ui-action': {} } },\r\n      { name: 'battery_hold_action', label: 'Battery Hold Action', selector: { 'ui-action': {} } },\r\n      { name: 'battery_soc_entity', label: 'Battery SOC (%) Entity', selector: { entity: { domain: 'sensor' } } },\r\n      { name: 'invert_battery_data', label: 'Invert Battery Data', selector: { boolean: {} } },\r\n      { name: 'invert_battery_view', label: 'Invert Battery View', selector: { boolean: {} } },\r\n      { name: 'show_plus', label: 'Show + Sign', selector: { boolean: {} } },\r\n    ],\r\n  };\r\n}\r\n\r\n// Accept both flat (UI) and nested (YAML/custom) configs\r\nexport function normalizeConfig(config: EnergyFlowCardConfig | Record<string, any>): EnergyFlowCardConfig {\r\n  if ((config as EnergyFlowCardConfig).load) {\r\n    return config as EnergyFlowCardConfig;\r\n  }\r\n\r\n  const normalizeEntity = (prefix: string): EntityConfig | undefined => {\r\n    const entityId = (config as any)[`${prefix}_entity`];\r\n    if (!entityId) return undefined;\r\n\r\n    const normalized: EntityConfig = { entity: entityId };\r\n    const name = (config as any)[`${prefix}_name`];\r\n    const icon = (config as any)[`${prefix}_icon`];\r\n    const min = (config as any)[`${prefix}_min`];\r\n    const max = (config as any)[`${prefix}_max`];\r\n    const tap = (config as any)[`${prefix}_tap_action`];\r\n    const hold = (config as any)[`${prefix}_hold_action`];\r\n\r\n    if (name !== undefined) normalized.name = name;\r\n    if (icon !== undefined) normalized.icon = icon;\r\n    if (min !== undefined) normalized.min = min;\r\n    if (max !== undefined) normalized.max = max;\r\n    if (tap !== undefined) normalized.tap = tap;\r\n    if (hold !== undefined) normalized.hold = hold;\r\n\r\n    return normalized;\r\n  };\r\n\r\n  const load = normalizeEntity('load');\r\n  const grid = normalizeEntity('grid');\r\n  const production = normalizeEntity('production');\r\n  const batteryEntity = normalizeEntity('battery') as BatteryEntityConfig | undefined;\r\n\r\n  if (batteryEntity) {\r\n    const soc = (config as any)['battery_soc_entity'];\r\n    const invertData = (config as any)['invert_battery_data'];\r\n    const invertView = (config as any)['invert_battery_view'];\r\n    const showPlus = (config as any)['show_plus'];\r\n\r\n    if (soc !== undefined) batteryEntity.soc_entity = soc;\r\n    if (invertData !== undefined || invertView !== undefined) {\r\n      batteryEntity.invert = {\r\n        data: invertData !== undefined ? invertData : batteryEntity.invert?.data,\r\n        view: invertView !== undefined ? invertView : batteryEntity.invert?.view,\r\n      };\r\n    }\r\n    if (showPlus !== undefined) batteryEntity.showPlus = showPlus;\r\n  }\r\n\r\n  const mode = (config as any).view_mode || (config as any).mode;\r\n\r\n  if (!load) {\r\n    return config as EnergyFlowCardConfig;\r\n  }\r\n\r\n  return {\r\n    mode,\r\n    load,\r\n    grid,\r\n    production,\r\n    battery: batteryEntity,\r\n  };\r\n}","/**\r\n * General utility functions for the energy flow card\r\n */\r\n\r\nimport type { EnergyFlowCardConfig, EntityConfig } from '../types/Config.d.ts';\r\nimport type { HomeAssistant } from '../types/HASS.d.ts';\r\n\r\nexport function getDisplayName(\r\n  config: EnergyFlowCardConfig,\r\n  hass: HomeAssistant | undefined,\r\n  entityType: 'grid' | 'load' | 'production' | 'battery',\r\n  fallback: string\r\n): string {\r\n  const entityConfig = config[entityType] as EntityConfig | undefined;\r\n  if (!entityConfig) return fallback;\r\n  \r\n  if (entityConfig.name) {\r\n    return entityConfig.name;\r\n  }\r\n\r\n  if (entityConfig.entity && hass?.states[entityConfig.entity]) {\r\n    return hass.states[entityConfig.entity].attributes.friendly_name || fallback;\r\n  }\r\n\r\n  return fallback;\r\n}\r\n\r\nexport function getIcon(\r\n  config: EnergyFlowCardConfig,\r\n  hass: HomeAssistant | undefined,\r\n  entityType: 'grid' | 'load' | 'production' | 'battery',\r\n  fallback: string\r\n): string {\r\n  const entityConfig = config[entityType] as EntityConfig | undefined;\r\n  if (!entityConfig) return fallback;\r\n  \r\n  if (entityConfig.icon) {\r\n    return entityConfig.icon;\r\n  }\r\n\r\n  if (entityConfig.entity && hass?.states[entityConfig.entity]) {\r\n    return hass.states[entityConfig.entity].attributes.icon || fallback;\r\n  }\r\n\r\n  return fallback;\r\n}\r\n\r\nexport function handleAction(\r\n  hass: HomeAssistant,\r\n  fireEvent: (type: string, detail?: any) => void,\r\n  actionConfig: any | undefined,\r\n  entityId?: string\r\n): void {\r\n  if (!hass) return;\r\n  \r\n  // Default to more-info if no action configured\r\n  const config = actionConfig || { action: 'more-info' as const };\r\n  const rawAction = config.action || 'more-info';\r\n  const action = rawAction === 'default' ? 'more-info' : rawAction;\r\n  \r\n  switch (action) {\r\n    case 'more-info':\r\n      const entityToShow = config.entity || entityId;\r\n      if (entityToShow) {\r\n        fireEvent('hass-more-info', { entityId: entityToShow });\r\n      }\r\n      break;\r\n      \r\n    case 'navigate':\r\n      if (config.path) {\r\n        history.pushState(null, '', config.path);\r\n        fireEvent('location-changed', { replace: false });\r\n        // Also emit on window so HA router sees it even outside shadow roots\r\n        window.dispatchEvent(new CustomEvent('location-changed', { detail: { replace: false } }));\r\n      }\r\n      break;\r\n      \r\n    case 'url':\r\n      if (config.path) {\r\n        window.open(config.path);\r\n      }\r\n      break;\r\n      \r\n    case 'toggle':\r\n      if (entityId) {\r\n        hass.callService('homeassistant', 'toggle', { entity_id: entityId });\r\n      }\r\n      break;\r\n      \r\n    case 'call-service':\r\n      if (config.service) {\r\n        const [domain, service] = config.service.split('.');\r\n        hass.callService(domain, service, config.service_data || {}, config.target);\r\n      }\r\n      break;\r\n      \r\n    case 'none':\r\n      // Do nothing\r\n      break;\r\n  }\r\n}\r\n\r\nexport function updateSegmentVisibility(segment: Element, pixelWidth: number, hasValue: boolean): void {\r\n  if (!segment || !hasValue) {\r\n    segment?.setAttribute('data-width-px', '');\r\n    return;\r\n  }\r\n\r\n  // Thresholds for responsive hiding\r\n  const SHOW_LABEL_THRESHOLD = 80; // Show label if segment is at least 80px wide\r\n  const SHOW_ICON_THRESHOLD = 40;  // Show icon if segment is at least 40px wide\r\n\r\n  if (pixelWidth >= SHOW_LABEL_THRESHOLD) {\r\n    segment.setAttribute('data-width-px', 'show-label');\r\n  } else if (pixelWidth >= SHOW_ICON_THRESHOLD) {\r\n    segment.setAttribute('data-width-px', 'show-icon');\r\n  } else {\r\n    segment.setAttribute('data-width-px', '');\r\n  }\r\n}\r\n","/**\r\n * CompactRenderer\r\n * \r\n * Renders the compact bar view showing energy flow percentages\r\n * Supports two modes:\r\n * - 'compact': Shows only load bar with sources\r\n * - 'compact-battery': Shows load bar + battery bar\r\n */\r\n\r\nimport type { EnergyFlowCardConfig } from '../types/Config.d.ts';\r\nimport type { HomeAssistant } from '../types/HASS.d.ts';\r\nimport type { EnergyFlows } from '../types/EnergyFlow.d.ts';\r\nimport { updateSegmentVisibility } from '../utils/helpers';\r\n\r\nexport type CompactViewMode = 'compact' | 'compact-battery';\r\n\r\nexport interface CompactRenderData {\r\n  grid: number;\r\n  load: number;\r\n  production: number;\r\n  battery: number;\r\n  flows: EnergyFlows;\r\n  batterySoc: number | null;\r\n}\r\n\r\nexport type EntityType = 'grid' | 'load' | 'production' | 'battery';\r\n\r\n/**\r\n * CompactRenderer handles rendering the compact bar visualization\r\n */\r\nexport class CompactRenderer {\r\n  private container: HTMLElement;\r\n  private config: EnergyFlowCardConfig;\r\n  private hass: HomeAssistant;\r\n  private viewMode: CompactViewMode;\r\n  private lastViewMode?: CompactViewMode;\r\n  private getIconCallback: (type: EntityType, fallback: string) => string;\r\n  private handleActionCallback: (action: unknown, entity?: string) => void;\r\n\r\n  // Colors (darker hues - 50% brightness)\r\n  private readonly productionColor = '#256028'; // Dark green\r\n  private readonly batteryColor = '#104b79'; // Dark blue (load)\r\n  private readonly gridColor = '#7a211b'; // Dark red (import)\r\n  private readonly returnColor = '#7a6b1b'; // Dark yellow (export)\r\n\r\n  constructor(\r\n    container: HTMLElement,\r\n    config: EnergyFlowCardConfig,\r\n    hass: HomeAssistant,\r\n    viewMode: CompactViewMode,\r\n    getIconCallback: (type: EntityType, fallback: string) => string,\r\n    handleActionCallback: (action: unknown, entity?: string) => void\r\n  ) {\r\n    this.container = container;\r\n    this.config = config;\r\n    this.hass = hass;\r\n    this.viewMode = viewMode;\r\n    this.getIconCallback = getIconCallback;\r\n    this.handleActionCallback = handleActionCallback;\r\n  }\r\n\r\n  /**\r\n   * Render or update the compact view\r\n   */\r\n  render(data: CompactRenderData): void {\r\n    // Initialize structure if needed\r\n    if (!this.container.querySelector('.compact-view') || this.lastViewMode !== this.viewMode) {\r\n      this.initializeStructure();\r\n      this.attachEventHandlers();\r\n      this.lastViewMode = this.viewMode;\r\n    }\r\n\r\n    // Update values and segments\r\n    this.updateSegments(data);\r\n  }\r\n\r\n  /**\r\n   * Update the view mode\r\n   */\r\n  setViewMode(viewMode: CompactViewMode): void {\r\n    if (this.viewMode !== viewMode) {\r\n      this.viewMode = viewMode;\r\n      this.lastViewMode = undefined; // Force re-render\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initialize the HTML structure\r\n   */\r\n  private initializeStructure(): void {\r\n    this.container.innerHTML = `\r\n      <ha-card>\r\n        <style>\r\n          :host {\r\n            display: block;\r\n            width: 100%;\r\n            height: 100%;\r\n          }\r\n          ha-card {\r\n            padding: 16px;\r\n            box-sizing: border-box;\r\n            width: 100%;\r\n            height: 100%;\r\n            display: flex;\r\n            flex-direction: column;\r\n            justify-content: center;\r\n          }\r\n          .compact-view {\r\n            display: flex;\r\n            flex-direction: column;\r\n            gap: ${this.viewMode === 'compact-battery' ? '12px' : '0'};\r\n            width: 100%;\r\n          }\r\n          .compact-row {\r\n            display: flex;\r\n            align-items: center;\r\n            gap: 12px;\r\n            width: 100%;\r\n          }\r\n          .bar-container {\r\n            flex: 1;\r\n            height: 60px;\r\n            background: rgb(40, 40, 40);\r\n            border-radius: 8px;\r\n            overflow: hidden;\r\n            display: flex;\r\n            position: relative;\r\n          }\r\n          .bar-segment {\r\n            height: 100%;\r\n            display: flex;\r\n            align-items: center;\r\n            justify-content: center;\r\n            gap: 6px;\r\n            font-size: 14px;\r\n            font-weight: 600;\r\n            color: rgb(255, 255, 255);\r\n            transition: width 0.5s ease-out;\r\n            position: relative;\r\n            overflow: hidden;\r\n            cursor: pointer;\r\n          }\r\n          .bar-segment:hover {\r\n            filter: brightness(1.2);\r\n          }\r\n          .bar-segment-content {\r\n            display: flex;\r\n            align-items: center;\r\n            gap: 6px;\r\n            white-space: nowrap;\r\n          }\r\n          .bar-segment-icon {\r\n            width: 24px;\r\n            height: 24px;\r\n            flex-shrink: 0;\r\n            opacity: 1;\r\n            color: rgb(255, 255, 255);\r\n          }\r\n          .bar-segment-label {\r\n            text-shadow: 0 1px 2px rgba(0,0,0,0.3);\r\n          }\r\n          .bar-segment[data-width-px] .bar-segment-label {\r\n            display: none;\r\n          }\r\n          .bar-segment[data-width-px=\"show-label\"] .bar-segment-label {\r\n            display: inline;\r\n          }\r\n          .bar-segment[data-width-px] .bar-segment-icon {\r\n            display: none;\r\n          }\r\n          .bar-segment[data-width-px=\"show-icon\"] .bar-segment-icon,\r\n          .bar-segment[data-width-px=\"show-label\"] .bar-segment-icon {\r\n            display: block;\r\n          }\r\n          .row-value {\r\n            font-size: 24px;\r\n            font-weight: 600;\r\n            color: rgb(255, 255, 255);\r\n            white-space: nowrap;\r\n            min-width: 100px;\r\n            text-align: right;\r\n            display: flex;\r\n            align-items: center;\r\n            gap: 8px;\r\n            cursor: pointer;\r\n          }\r\n          .row-value:hover {\r\n            filter: brightness(1.1);\r\n          }\r\n          .row-value.battery-discharge {\r\n            text-align: left;\r\n            flex-direction: row-reverse;\r\n          }\r\n          .row-icon {\r\n            width: 28px;\r\n            height: 28px;\r\n            flex-shrink: 0;\r\n            color: rgb(160, 160, 160);\r\n            display: flex;\r\n            align-items: center;\r\n          }\r\n          .row-text {\r\n            display: flex;\r\n            align-items: baseline;\r\n            gap: 4px;\r\n            line-height: 1;\r\n          }\r\n          .row-unit {\r\n            font-size: 14px;\r\n            color: rgb(160, 160, 160);\r\n            margin-left: 4px;\r\n          }\r\n        </style>\r\n        <div class=\"compact-view\">\r\n          <!-- Load Row -->\r\n          <div class=\"compact-row\">\r\n            <div class=\"bar-container\">\r\n              <div id=\"grid-segment\" class=\"bar-segment\" style=\"background: ${this.gridColor}; width: 0%;\">\r\n                <div class=\"bar-segment-content\">\r\n                  <ha-icon class=\"bar-segment-icon\" icon=\"${this.getIconCallback('grid', 'mdi:transmission-tower')}\"></ha-icon>\r\n                  <span class=\"bar-segment-label\"></span>\r\n                </div>\r\n              </div>\r\n              <div id=\"battery-segment\" class=\"bar-segment\" style=\"background: ${this.batteryColor}; width: 0%;\">\r\n                <div class=\"bar-segment-content\">\r\n                  <ha-icon class=\"bar-segment-icon\" icon=\"${this.getIconCallback('battery', 'mdi:battery')}\"></ha-icon>\r\n                  <span class=\"bar-segment-label\"></span>\r\n                </div>\r\n              </div>\r\n              <div id=\"production-segment\" class=\"bar-segment\" style=\"background: ${this.productionColor}; width: 0%;\">\r\n                <div class=\"bar-segment-content\">\r\n                  <ha-icon class=\"bar-segment-icon\" icon=\"${this.getIconCallback('production', 'mdi:solar-power')}\"></ha-icon>\r\n                  <span class=\"bar-segment-label\"></span>\r\n                </div>\r\n              </div>\r\n            </div>\r\n            <div class=\"row-value\">\r\n              <ha-icon class=\"row-icon\" icon=\"${this.getIconCallback('load', 'mdi:home-lightning-bolt')}\"></ha-icon>\r\n              <div class=\"row-text\">\r\n                <span id=\"load-value-text\">0</span><span class=\"row-unit\">W</span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n          ${this.viewMode === 'compact-battery' ? `\r\n          <!-- Battery Row -->\r\n          <div class=\"compact-row\" id=\"battery-row\">\r\n            <div class=\"row-value\" id=\"battery-soc-left\" style=\"display: none;\">\r\n              <ha-icon class=\"row-icon\" icon=\"${this.getIconCallback('battery', 'mdi:battery')}\"></ha-icon>\r\n              <div class=\"row-text\">\r\n                <span id=\"battery-soc-text-left\">--</span><span class=\"row-unit\">%</span>\r\n              </div>\r\n            </div>\r\n            <div class=\"bar-container\">\r\n              <!-- Color order: red, yellow, blue, green (left to right) -->\r\n              <div id=\"battery-grid-segment\" class=\"bar-segment\" style=\"background: ${this.gridColor}; width: 0%;\">\r\n                <div class=\"bar-segment-content\">\r\n                  <ha-icon class=\"bar-segment-icon\" icon=\"${this.getIconCallback('grid', 'mdi:transmission-tower')}\"></ha-icon>\r\n                  <span class=\"bar-segment-label\"></span>\r\n                </div>\r\n              </div>\r\n              <div id=\"battery-load-segment\" class=\"bar-segment\" style=\"background: ${this.batteryColor}; width: 0%;\">\r\n                <div class=\"bar-segment-content\">\r\n                  <ha-icon class=\"bar-segment-icon\" icon=\"${this.getIconCallback('load', 'mdi:home')}\"></ha-icon>\r\n                  <span class=\"bar-segment-label\"></span>\r\n                </div>\r\n              </div>\r\n              <div id=\"battery-production-segment\" class=\"bar-segment\" style=\"background: ${this.productionColor}; width: 0%;\">\r\n                <div class=\"bar-segment-content\">\r\n                  <ha-icon class=\"bar-segment-icon\" icon=\"${this.getIconCallback('production', 'mdi:solar-power')}\"></ha-icon>\r\n                  <span class=\"bar-segment-label\"></span>\r\n                </div>\r\n              </div>\r\n            </div>\r\n            <div class=\"row-value\" id=\"battery-soc-right\">\r\n              <ha-icon class=\"row-icon\" icon=\"${this.getIconCallback('battery', 'mdi:battery')}\"></ha-icon>\r\n              <div class=\"row-text\">\r\n                <span id=\"battery-soc-text-right\">--</span><span class=\"row-unit\">%</span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n          ` : ''}\r\n        </div>\r\n      </ha-card>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Attach click event handlers\r\n   */\r\n  private attachEventHandlers(): void {\r\n    requestAnimationFrame(() => {\r\n      // Load row segments\r\n      const productionSeg = this.container.querySelector('#production-segment');\r\n      const batterySeg = this.container.querySelector('#battery-segment');\r\n      const gridSeg = this.container.querySelector('#grid-segment');\r\n      const loadValues = this.container.querySelectorAll('.row-value');\r\n      const loadValue = loadValues[0]; // First row-value is the load\r\n      \r\n      if (productionSeg) {\r\n        productionSeg.addEventListener('click', () => {\r\n          this.handleActionCallback(this.config.production?.tap, this.config.production?.entity);\r\n        });\r\n      }\r\n      if (batterySeg) {\r\n        batterySeg.addEventListener('click', () => {\r\n          this.handleActionCallback(this.config.battery?.tap, this.config.battery?.entity);\r\n        });\r\n      }\r\n      if (gridSeg) {\r\n        gridSeg.addEventListener('click', () => {\r\n          this.handleActionCallback(this.config.grid?.tap, this.config.grid?.entity);\r\n        });\r\n      }\r\n      if (loadValue) {\r\n        loadValue.addEventListener('click', () => {\r\n          this.handleActionCallback(this.config.load.tap, this.config.load.entity);\r\n        });\r\n      }\r\n      \r\n      // Battery row handlers if in compact-battery mode\r\n      if (this.viewMode === 'compact-battery') {\r\n        const batteryProdSeg = this.container.querySelector('#battery-production-segment');\r\n        const batteryLoadSeg = this.container.querySelector('#battery-load-segment');\r\n        const batteryGridSeg = this.container.querySelector('#battery-grid-segment');\r\n        const batterySocLeft = this.container.querySelector('#battery-soc-left');\r\n        const batterySocRight = this.container.querySelector('#battery-soc-right');\r\n        \r\n        if (batteryProdSeg) {\r\n          batteryProdSeg.addEventListener('click', () => {\r\n            this.handleActionCallback(this.config.production?.tap, this.config.production?.entity);\r\n          });\r\n        }\r\n        if (batteryLoadSeg) {\r\n          batteryLoadSeg.addEventListener('click', () => {\r\n            this.handleActionCallback(this.config.load.tap, this.config.load.entity);\r\n          });\r\n        }\r\n        if (batteryGridSeg) {\r\n          batteryGridSeg.addEventListener('click', () => {\r\n            this.handleActionCallback(this.config.grid?.tap, this.config.grid?.entity);\r\n          });\r\n        }\r\n        if (batterySocLeft) {\r\n          batterySocLeft.addEventListener('click', () => {\r\n            this.handleActionCallback(this.config.battery?.tap, this.config.battery?.entity);\r\n          });\r\n        }\r\n        if (batterySocRight) {\r\n          batterySocRight.addEventListener('click', () => {\r\n            this.handleActionCallback(this.config.battery?.tap, this.config.battery?.entity);\r\n          });\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update segment widths and labels\r\n   */\r\n  private updateSegments(data: CompactRenderData): void {\r\n    const { load, flows, battery, batterySoc } = data;\r\n\r\n    // Calculate load bar percentages\r\n    const productionValue = flows.productionToLoad;\r\n    const batteryToLoad = flows.batteryToLoad;\r\n    const gridToLoad = flows.gridToLoad;\r\n\r\n    // Calculate TRUE percentages for labels (these show accurate data)\r\n    const total = load || 1;\r\n    const productionPercent = (productionValue / total) * 100;\r\n    const batteryPercent = (batteryToLoad / total) * 100;\r\n    const gridPercent = (gridToLoad / total) * 100;\r\n    \r\n    // Calculate VISUAL percentages for bar widths (scaled to fill 100%)\r\n    const sumPercent = productionPercent + batteryPercent + gridPercent;\r\n    let visualProductionPercent = productionPercent;\r\n    let visualBatteryPercent = batteryPercent;\r\n    let visualGridPercent = gridPercent;\r\n    \r\n    if (sumPercent > 0) {\r\n      const scale = 100 / sumPercent;\r\n      visualProductionPercent = productionPercent * scale;\r\n      visualBatteryPercent = batteryPercent * scale;\r\n      visualGridPercent = gridPercent * scale;\r\n    }\r\n\r\n    // Calculate battery bar values\r\n    let batteryGridWatts = 0;\r\n    let batteryLoadWatts = 0;\r\n    let batteryProdWatts = 0;\r\n    let visualBatteryGridPercent = 0;\r\n    let visualBatteryLoadPercent = 0;\r\n    let visualBatteryProdPercent = 0;\r\n    \r\n    if (this.viewMode === 'compact-battery') {\r\n      if (battery < 0) {\r\n        // CHARGING\r\n        const batteryCharging = Math.abs(battery);\r\n        const batteryTotal = batteryCharging || 1;\r\n        \r\n        batteryGridWatts = flows.gridToBattery;\r\n        batteryProdWatts = flows.productionToBattery;\r\n        \r\n        const batteryGridPercent = (flows.gridToBattery / batteryTotal) * 100;\r\n        const batteryProdPercent = (flows.productionToBattery / batteryTotal) * 100;\r\n        \r\n        const chargeSum = batteryGridPercent + batteryProdPercent;\r\n        if (chargeSum > 0) {\r\n          const scale = 100 / chargeSum;\r\n          visualBatteryGridPercent = batteryGridPercent * scale;\r\n          visualBatteryProdPercent = batteryProdPercent * scale;\r\n        }\r\n      } else if (battery > 0) {\r\n        // DISCHARGING\r\n        const batteryTotal = battery || 1;\r\n        const batteryToGrid = battery - flows.batteryToLoad;\r\n        \r\n        batteryLoadWatts = flows.batteryToLoad;\r\n        batteryGridWatts = batteryToGrid;\r\n        \r\n        const batteryLoadPercent = (flows.batteryToLoad / batteryTotal) * 100;\r\n        const batteryGridPercent = (batteryToGrid / batteryTotal) * 100;\r\n        \r\n        const dischargeSum = batteryLoadPercent + batteryGridPercent;\r\n        if (dischargeSum > 0) {\r\n          const scale = 100 / dischargeSum;\r\n          visualBatteryLoadPercent = batteryLoadPercent * scale;\r\n          visualBatteryGridPercent = batteryGridPercent * scale;\r\n        }\r\n      }\r\n    }\r\n\r\n    requestAnimationFrame(() => {\r\n      this.updateLoadBar(\r\n        visualProductionPercent,\r\n        visualBatteryPercent,\r\n        visualGridPercent,\r\n        productionPercent,\r\n        batteryPercent,\r\n        gridPercent,\r\n        productionValue,\r\n        batteryToLoad,\r\n        gridToLoad,\r\n        load\r\n      );\r\n\r\n      if (this.viewMode === 'compact-battery') {\r\n        this.updateBatteryBar(\r\n          visualBatteryGridPercent,\r\n          visualBatteryLoadPercent,\r\n          visualBatteryProdPercent,\r\n          batteryGridWatts,\r\n          batteryLoadWatts,\r\n          batteryProdWatts,\r\n          battery,\r\n          batterySoc\r\n        );\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update the load bar segments\r\n   */\r\n  private updateLoadBar(\r\n    visualProductionPercent: number,\r\n    visualBatteryPercent: number,\r\n    visualGridPercent: number,\r\n    productionPercent: number,\r\n    batteryPercent: number,\r\n    gridPercent: number,\r\n    productionValue: number,\r\n    batteryToLoad: number,\r\n    gridToLoad: number,\r\n    load: number\r\n  ): void {\r\n    const productionSegment = this.container.querySelector('#production-segment');\r\n    const batterySegment = this.container.querySelector('#battery-segment');\r\n    const gridSegment = this.container.querySelector('#grid-segment');\r\n    const loadValueText = this.container.querySelector('#load-value-text');\r\n    const barContainer = this.container.querySelector('.bar-container');\r\n\r\n    if (productionSegment) {\r\n      (productionSegment as HTMLElement).style.width = `${visualProductionPercent}%`;\r\n      const label = productionSegment.querySelector('.bar-segment-label');\r\n      if (label && productionValue > 0) {\r\n        label.textContent = `${Math.round(productionPercent)}%`;\r\n      }\r\n      const widthPx = (visualProductionPercent / 100) * (barContainer?.clientWidth || 0);\r\n      updateSegmentVisibility(productionSegment as HTMLElement, widthPx, productionValue > 0);\r\n    }\r\n\r\n    if (batterySegment) {\r\n      (batterySegment as HTMLElement).style.width = `${visualBatteryPercent}%`;\r\n      const label = batterySegment.querySelector('.bar-segment-label');\r\n      if (label && batteryToLoad > 0) {\r\n        label.textContent = `${Math.round(batteryPercent)}%`;\r\n      }\r\n      const widthPx = (visualBatteryPercent / 100) * (barContainer?.clientWidth || 0);\r\n      updateSegmentVisibility(batterySegment as HTMLElement, widthPx, batteryToLoad > 0);\r\n    }\r\n\r\n    if (gridSegment) {\r\n      (gridSegment as HTMLElement).style.width = `${visualGridPercent}%`;\r\n      const label = gridSegment.querySelector('.bar-segment-label');\r\n      if (label && gridToLoad > 0) {\r\n        label.textContent = `${Math.round(gridPercent)}%`;\r\n      }\r\n      const widthPx = (visualGridPercent / 100) * (barContainer?.clientWidth || 0);\r\n      updateSegmentVisibility(gridSegment as HTMLElement, widthPx, gridToLoad > 0);\r\n    }\r\n\r\n    if (loadValueText) {\r\n      loadValueText.textContent = String(Math.round(load));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update the battery bar segments\r\n   */\r\n  private updateBatteryBar(\r\n    visualBatteryGridPercent: number,\r\n    visualBatteryLoadPercent: number,\r\n    visualBatteryProdPercent: number,\r\n    batteryGridWatts: number,\r\n    batteryLoadWatts: number,\r\n    batteryProdWatts: number,\r\n    battery: number,\r\n    batterySoc: number | null\r\n  ): void {\r\n    const batteryGridSegment = this.container.querySelector('#battery-grid-segment');\r\n    const batteryLoadSegment = this.container.querySelector('#battery-load-segment');\r\n    const batteryProdSegment = this.container.querySelector('#battery-production-segment');\r\n    const batterySocLeft = this.container.querySelector('#battery-soc-left') as HTMLElement | null;\r\n    const batterySocRight = this.container.querySelector('#battery-soc-right') as HTMLElement | null;\r\n    const batterySocTextLeft = this.container.querySelector('#battery-soc-text-left');\r\n    const batterySocTextRight = this.container.querySelector('#battery-soc-text-right');\r\n    const batteryBarContainers = this.container.querySelectorAll('.bar-container');\r\n    const batteryBarContainer = batteryBarContainers[1] as HTMLElement | null;\r\n    \r\n    let gridIsImport = false;\r\n    \r\n    if (battery < 0) {\r\n      // CHARGING\r\n      gridIsImport = true;\r\n      if (batterySocLeft) batterySocLeft.style.display = 'none';\r\n      if (batterySocRight) batterySocRight.style.display = 'flex';\r\n      if (batterySocTextRight && batterySoc !== null) {\r\n        batterySocTextRight.textContent = batterySoc.toFixed(1);\r\n      }\r\n    } else if (battery > 0) {\r\n      // DISCHARGING\r\n      gridIsImport = false;\r\n      if (batterySocLeft) batterySocLeft.style.display = 'flex';\r\n      if (batterySocRight) batterySocRight.style.display = 'none';\r\n      if (batterySocTextLeft && batterySoc !== null) {\r\n        batterySocTextLeft.textContent = batterySoc.toFixed(1);\r\n      }\r\n    } else {\r\n      // IDLE\r\n      if (batterySocLeft) batterySocLeft.style.display = 'none';\r\n      if (batterySocRight) batterySocRight.style.display = 'flex';\r\n      if (batterySocTextRight && batterySoc !== null) {\r\n        batterySocTextRight.textContent = batterySoc.toFixed(1);\r\n      }\r\n    }\r\n    \r\n    // Update grid segment\r\n    if (batteryGridSegment) {\r\n      const gridColorToUse = gridIsImport ? this.gridColor : this.returnColor;\r\n      (batteryGridSegment as HTMLElement).style.width = `${visualBatteryGridPercent}%`;\r\n      (batteryGridSegment as HTMLElement).style.background = gridColorToUse;\r\n      const label = batteryGridSegment.querySelector('.bar-segment-label');\r\n      if (label && batteryGridWatts > 0) {\r\n        label.textContent = `${Math.round(batteryGridWatts)}W`;\r\n      }\r\n      const pixelWidth = (visualBatteryGridPercent / 100) * (batteryBarContainer?.offsetWidth || 0);\r\n      updateSegmentVisibility(batteryGridSegment, pixelWidth, batteryGridWatts > 0);\r\n    }\r\n    \r\n    // Update load segment\r\n    if (batteryLoadSegment) {\r\n      (batteryLoadSegment as HTMLElement).style.width = `${visualBatteryLoadPercent}%`;\r\n      const label = batteryLoadSegment.querySelector('.bar-segment-label');\r\n      if (label && batteryLoadWatts > 0) {\r\n        label.textContent = `${Math.round(batteryLoadWatts)}W`;\r\n      }\r\n      const pixelWidth = (visualBatteryLoadPercent / 100) * (batteryBarContainer?.offsetWidth || 0);\r\n      updateSegmentVisibility(batteryLoadSegment, pixelWidth, batteryLoadWatts > 0);\r\n    }\r\n    \r\n    // Update production segment\r\n    if (batteryProdSegment) {\r\n      (batteryProdSegment as HTMLElement).style.width = `${visualBatteryProdPercent}%`;\r\n      const label = batteryProdSegment.querySelector('.bar-segment-label');\r\n      if (label && batteryProdWatts > 0) {\r\n        label.textContent = `${Math.round(batteryProdWatts)}W`;\r\n      }\r\n      const pixelWidth = (visualBatteryProdPercent / 100) * (batteryBarContainer?.offsetWidth || 0);\r\n      updateSegmentVisibility(batteryProdSegment, pixelWidth, batteryProdWatts > 0);\r\n    }\r\n  }\r\n}\r\n","/** Needle animation state for meters */\r\nexport interface NeedleState {\r\n  /** Target angle in degrees */\r\n  target: number;\r\n  /** Current angle in degrees */\r\n  current: number;\r\n  /** Ghost needle angle (lags behind current) */\r\n  ghost: number;\r\n}\r\n\r\n/** Action configuration (imported from Config types) */\r\nimport type { ActionConfig } from './types/Config.d.ts';\r\n\r\n/**\r\n * Meter class: Fully self-contained gauge meter with rendering and animation\r\n */\r\nexport class Meter {\r\n  id: string;\r\n  private _value: number;\r\n  min: number;\r\n  max: number;\r\n  bidirectional: boolean;\r\n  label: string;\r\n  icon: string;\r\n  units: string;\r\n  private _invertView: boolean;\r\n  showPlus: boolean;\r\n  \r\n  // Tap action configuration\r\n  private tapAction: ActionConfig | undefined;\r\n  private entityId: string | undefined;\r\n  private fireEventCallback: ((event: string, detail?: any) => void) | undefined;\r\n  \r\n  // DOM element this meter owns\r\n  element: SVGGElement | null;\r\n\r\n  // Meter geometry constants\r\n  radius: number;\r\n  boxWidth: number;\r\n  boxHeight: number;\r\n  boxRadius: number;\r\n  centerX: number;\r\n  centerY: number;\r\n  offsetX: number;\r\n  offsetY: number;\r\n\r\n  // Needle animation state\r\n  needleState: NeedleState;\r\n  private _lastAnimationTime: number | null;\r\n  private _animationFrameId: number | null;\r\n\r\n  constructor(\r\n    id: string,\r\n    value: number,\r\n    min: number,\r\n    max: number,\r\n    bidirectional: boolean,\r\n    label: string,\r\n    icon: string,\r\n    units: string,\r\n    invertView = false,\r\n    showPlus = false,\r\n    tapAction?: ActionConfig,\r\n    entityId?: string,\r\n    fireEventCallback?: (event: string, detail?: any) => void\r\n  ) {\r\n    this.id = id;\r\n    this._value = value;\r\n    this.min = min;\r\n    this.max = max;\r\n    this.bidirectional = bidirectional;\r\n    this.label = label;\r\n    this.icon = icon;\r\n    this.units = units;\r\n    this._invertView = invertView;\r\n    this.showPlus = showPlus;\r\n    this.tapAction = tapAction;\r\n    this.entityId = entityId;\r\n    this.fireEventCallback = fireEventCallback;\r\n    this.element = null;\r\n\r\n    // Meter geometry constants\r\n    this.radius = 50;\r\n    this.boxWidth = 120;\r\n    this.boxHeight = 135;\r\n    this.boxRadius = 16;\r\n    this.centerX = this.boxWidth / 2;\r\n    this.centerY = this.radius + 25;\r\n    this.offsetX = -this.centerX;\r\n    this.offsetY = -this.centerY;\r\n\r\n    // Needle animation state\r\n    this.needleState = { target: 0, current: 0, ghost: 0 };\r\n    this._lastAnimationTime = null;\r\n    this._animationFrameId = null;\r\n\r\n    // Calculate initial needle angle\r\n    this._updateNeedleAngle();\r\n  }\r\n\r\n  get value(): number {\r\n    return this._value;\r\n  }\r\n\r\n  set value(newValue: number) {\r\n    if (this._value === newValue) return; // No change, skip update\r\n\r\n    this._value = newValue;\r\n    this._updateNeedleAngle();\r\n\r\n    // Update value text immediately\r\n    if (this.element) {\r\n      const valueText = this.element.querySelector(`#value-${this.id}`);\r\n      if (valueText) {\r\n        valueText.textContent = this._formatValueText();\r\n      }\r\n\r\n      // Update dimming\r\n      this.updateDimming();\r\n    }\r\n  }\r\n\r\n  get invertView(): boolean {\r\n    return this._invertView;\r\n  }\r\n\r\n  set invertView(newInvertView: boolean) {\r\n    if (this._invertView === newInvertView) return; // No change, skip update\r\n\r\n    this._invertView = newInvertView;\r\n    this._updateNeedleAngle();\r\n\r\n    // Update value text immediately (displayValue depends on invertView)\r\n    if (this.element) {\r\n      const valueText = this.element.querySelector(`#value-${this.id}`);\r\n      if (valueText) {\r\n        valueText.textContent = this._formatValueText();\r\n      }\r\n    }\r\n  }\r\n\r\n  get displayValue(): number {\r\n    return this._invertView ? -this._value : this._value;\r\n  }\r\n\r\n  _formatValueText(): string {\r\n    const displayValue = this.displayValue;\r\n    const valueStr = displayValue.toFixed(0);\r\n\r\n    if (displayValue < 0) {\r\n      return valueStr + '\\u00A0'; // Negative with non-breaking space\r\n    } else if (displayValue > 0 && this.showPlus) {\r\n      return '+' + valueStr + '\\u00A0'; // Positive with + sign and non-breaking space\r\n    } else {\r\n      return valueStr; // Zero or positive without sign\r\n    }\r\n  }\r\n\r\n  _updateNeedleAngle(): void {\r\n    let percentage: number;\r\n    let angle: number;\r\n    const displayValue = this.displayValue;\r\n\r\n    if (this.bidirectional) {\r\n      const range = this.max - this.min;\r\n      percentage = Math.min(Math.max((displayValue - this.min) / range, 0), 1);\r\n      angle = 180 - percentage * 180;\r\n    } else {\r\n      percentage = Math.min(Math.max(displayValue / this.max, 0), 1);\r\n      angle = 180 - percentage * 180;\r\n    }\r\n\r\n    this.needleState.target = angle;\r\n  }\r\n\r\n  updateDimming(): void {\r\n    if (!this.element) return;\r\n\r\n    const dimmer = this.element.querySelector(`#dimmer-${this.id}`);\r\n    if (dimmer) {\r\n      const isZero = Math.abs(this.value) < 0.5;\r\n      dimmer.setAttribute('opacity', isZero ? '0.3' : '0');\r\n    }\r\n  }\r\n\r\n  startAnimation(): void {\r\n    if (this._animationFrameId) return; // Already animating\r\n\r\n    const animate = (timestamp: number) => {\r\n      if (!this._lastAnimationTime) {\r\n        this._lastAnimationTime = timestamp;\r\n      }\r\n\r\n      const deltaTime = timestamp - this._lastAnimationTime;\r\n      this._lastAnimationTime = timestamp;\r\n\r\n      if (!this.element) {\r\n        this._animationFrameId = null;\r\n        return;\r\n      }\r\n\r\n      const needleLength = this.radius - 5;\r\n\r\n      // Smoothly interpolate main needle (fast response)\r\n      const mainLerpFactor = Math.min(deltaTime / 150, 1); // 150ms response time\r\n      this.needleState.current += (this.needleState.target - this.needleState.current) * mainLerpFactor;\r\n\r\n      // Ghost needle lags behind (slower response)\r\n      const ghostLerpFactor = Math.min(deltaTime / 400, 1); // 400ms response time\r\n      this.needleState.ghost += (this.needleState.current - this.needleState.ghost) * ghostLerpFactor;\r\n\r\n      // Clamp ghost to maximum 10 degrees behind main needle\r\n      const maxLag = 10;\r\n      if (this.needleState.ghost < this.needleState.current - maxLag) {\r\n        this.needleState.ghost = this.needleState.current - maxLag;\r\n      } else if (this.needleState.ghost > this.needleState.current + maxLag) {\r\n        this.needleState.ghost = this.needleState.current + maxLag;\r\n      }\r\n\r\n      // Update main needle\r\n      const needle = this.element.querySelector(`#needle-${this.id}`);\r\n      if (needle) {\r\n        const needleRad = (this.needleState.current * Math.PI) / 180;\r\n        const needleX = this.centerX + needleLength * Math.cos(needleRad);\r\n        const needleY = this.centerY - needleLength * Math.sin(needleRad);\r\n        needle.setAttribute('x2', String(needleX));\r\n        needle.setAttribute('y2', String(needleY));\r\n      }\r\n\r\n      // Update ghost needle\r\n      const ghostNeedle = this.element.querySelector(`#ghost-needle-${this.id}`);\r\n      if (ghostNeedle) {\r\n        const ghostRad = (this.needleState.ghost * Math.PI) / 180;\r\n        const ghostX = this.centerX + needleLength * Math.cos(ghostRad);\r\n        const ghostY = this.centerY - needleLength * Math.sin(ghostRad);\r\n        ghostNeedle.setAttribute('x2', String(ghostX));\r\n        ghostNeedle.setAttribute('y2', String(ghostY));\r\n      }\r\n\r\n      this._animationFrameId = requestAnimationFrame(animate);\r\n    };\r\n\r\n    this._animationFrameId = requestAnimationFrame(animate);\r\n  }\r\n\r\n  stopAnimation(): void {\r\n    if (this._animationFrameId) {\r\n      cancelAnimationFrame(this._animationFrameId);\r\n      this._animationFrameId = null;\r\n      this._lastAnimationTime = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle tap action when meter is clicked\r\n   */\r\n  private _handleTapAction(): void {\r\n    if (!this.fireEventCallback) return;\r\n\r\n    // Default to more-info if no tap action configured\r\n    const config = this.tapAction || { action: 'more-info' as const };\r\n    const action = config.action || 'more-info';\r\n\r\n    switch (action) {\r\n      case 'more-info':\r\n        const entityId = config.entity || this.entityId;\r\n        if (entityId) {\r\n          this.fireEventCallback('hass-more-info', { entityId });\r\n        }\r\n        break;\r\n\r\n      case 'navigate':\r\n        if (config.path) {\r\n          history.pushState(null, '', config.path);\r\n          this.fireEventCallback('location-changed', { replace: false });\r\n        }\r\n        break;\r\n\r\n      case 'url':\r\n        if (config.path) {\r\n          window.open(config.path);\r\n        }\r\n        break;\r\n\r\n      case 'toggle':\r\n        if (this.entityId) {\r\n          this.fireEventCallback('call-service', {\r\n            domain: 'homeassistant',\r\n            service: 'toggle',\r\n            service_data: { entity_id: this.entityId }\r\n          });\r\n        }\r\n        break;\r\n\r\n      case 'call-service':\r\n        if (config.service) {\r\n          const [domain, service] = config.service.split('.');\r\n          this.fireEventCallback('call-service', {\r\n            domain,\r\n            service,\r\n            service_data: config.service_data || {},\r\n            target: config.target\r\n          });\r\n        }\r\n        break;\r\n\r\n      case 'none':\r\n        // Do nothing\r\n        break;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create and return the SVG element for this meter\r\n   */\r\n  /**\r\n   * Create and return the SVG element for this meter\r\n   */\r\n  createElement(): SVGGElement {\r\n    const displayValue = this.displayValue;\r\n\r\n    // Calculate percentage and angle for needle\r\n    let percentage: number;\r\n    let angle: number;\r\n    if (this.bidirectional) {\r\n      const range = this.max - this.min;\r\n      percentage = Math.min(Math.max((displayValue - this.min) / range, 0), 1);\r\n      angle = 180 - percentage * 180;\r\n    } else {\r\n      percentage = Math.min(Math.max(displayValue / this.max, 0), 1);\r\n      angle = 180 - percentage * 180;\r\n    }\r\n\r\n    // Initialize needle state\r\n    this.needleState.target = angle;\r\n    this.needleState.current = angle;\r\n    this.needleState.ghost = angle;\r\n\r\n    // Generate tick marks\r\n    const ticks = this.bidirectional ? [this.min, 0, this.max] : [0, this.max / 2, this.max];\r\n    const tickMarks = ticks\r\n      .map((tickValue) => {\r\n        const tickPercentage = this.bidirectional\r\n          ? (tickValue - this.min) / (this.max - this.min)\r\n          : tickValue / this.max;\r\n        const tickAngle = 180 - tickPercentage * 180;\r\n        const tickRad = (tickAngle * Math.PI) / 180;\r\n        const tickStartR = this.radius;\r\n        const tickEndR = this.radius - 8;\r\n\r\n        const x1 = this.centerX + tickStartR * Math.cos(tickRad);\r\n        const y1 = this.centerY - tickStartR * Math.sin(tickRad);\r\n        const x2 = this.centerX + tickEndR * Math.cos(tickRad);\r\n        const y2 = this.centerY - tickEndR * Math.sin(tickRad);\r\n\r\n        return `<line x1=\"${x1}\" y1=\"${y1}\" x2=\"${x2}\" y2=\"${y2}\" stroke=\"rgb(160, 160, 160)\" stroke-width=\"2\" />`;\r\n      })\r\n      .join('');\r\n\r\n    // Zero line\r\n    const zeroPercentage = this.bidirectional ? (0 - this.min) / (this.max - this.min) : 0;\r\n    const zeroAngle = 180 - zeroPercentage * 180;\r\n    const zeroRad = (zeroAngle * Math.PI) / 180;\r\n    const zeroX1 = this.centerX;\r\n    const zeroY1 = this.centerY;\r\n    const zeroX2 = this.centerX + this.radius * Math.cos(zeroRad);\r\n    const zeroY2 = this.centerY - this.radius * Math.sin(zeroRad);\r\n    const zeroLine = `<line x1=\"${zeroX1}\" y1=\"${zeroY1}\" x2=\"${zeroX2}\" y2=\"${zeroY2}\" stroke=\"rgb(100, 100, 100)\" stroke-width=\"2\" />`;\r\n\r\n    // Needle position\r\n    const needleRad = (angle * Math.PI) / 180;\r\n    const needleLength = this.radius - 5;\r\n    const needleX = this.centerX + needleLength * Math.cos(needleRad);\r\n    const needleY = this.centerY - needleLength * Math.sin(needleRad);\r\n\r\n    const clipHeight = this.centerY + 5;\r\n    const valueY = this.centerY + this.radius * 0.5;\r\n    const unitsY = this.centerY + this.radius * 0.7;\r\n\r\n    const svgMarkup = `\r\n      <g transform=\"translate(${this.offsetX}, ${this.offsetY})\">\r\n        <defs>\r\n          <clipPath id=\"clip-${this.id}-local\">\r\n            <rect x=\"0\" y=\"0\" width=\"${this.boxWidth}\" height=\"${clipHeight + 2}\" />\r\n          </clipPath>\r\n        </defs>\r\n        \r\n        <rect x=\"0\" y=\"0\" width=\"${this.boxWidth}\" height=\"${this.boxHeight}\" rx=\"${this.boxRadius}\" ry=\"${this.boxRadius}\" fill=\"rgb(40, 40, 40)\" filter=\"url(#drop-shadow)\" />\r\n        \r\n        <g clip-path=\"url(#clip-${this.id}-local)\">\r\n          <circle cx=\"${this.centerX}\" cy=\"${this.centerY}\" r=\"${this.radius}\" fill=\"rgb(70, 70, 70)\" />\r\n          ${zeroLine}\r\n        </g>\r\n        \r\n        ${tickMarks}\r\n        \r\n        <circle cx=\"${this.centerX}\" cy=\"${this.centerY}\" r=\"${this.radius}\" fill=\"none\" stroke=\"rgb(160, 160, 160)\" stroke-width=\"2\" />\r\n        \r\n        <text x=\"${this.centerX}\" y=\"15\" text-anchor=\"middle\" font-size=\"12\" fill=\"rgb(255, 255, 255)\" font-weight=\"500\">${this.label}</text>\r\n        \r\n        <!-- Icon rendered via foreignObject (for extraction source) -->\r\n        <foreignObject id=\"icon-source-${this.id}\" x=\"${this.centerX - 18}\" y=\"${this.centerY - 42}\" width=\"36\" height=\"36\">\r\n          <div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"width: 36px; height: 36px;\">\r\n            <ha-icon icon=\"${this.icon}\" style=\"--mdc-icon-size: 36px; color: rgb(160, 160, 160);\"></ha-icon>\r\n          </div>\r\n        </foreignObject>\r\n        \r\n        <!-- Icon rendered as native SVG path (populated after extraction, will overlay) -->\r\n        <g id=\"icon-display-${this.id}\" transform=\"translate(${this.centerX - 18}, ${this.centerY - 42}) scale(1.5)\">\r\n          <!-- Path will be inserted here by _extractIconPaths -->\r\n        </g>\r\n        \r\n        <line id=\"ghost-needle-${this.id}\" x1=\"${this.centerX}\" y1=\"${this.centerY}\" x2=\"${needleX}\" y2=\"${needleY}\" stroke=\"rgb(255, 255, 255)\" stroke-width=\"4\" stroke-linecap=\"round\" opacity=\"0.3\" />\r\n        \r\n        <line id=\"needle-${this.id}\" x1=\"${this.centerX}\" y1=\"${this.centerY}\" x2=\"${needleX}\" y2=\"${needleY}\" stroke=\"rgb(255, 255, 255)\" stroke-width=\"4\" stroke-linecap=\"round\" />\r\n        \r\n        <circle cx=\"${this.centerX}\" cy=\"${this.centerY}\" r=\"5\" fill=\"rgb(255, 255, 255)\" />\r\n        \r\n        <text id=\"value-${this.id}\" x=\"${this.centerX}\" y=\"${valueY}\" text-anchor=\"middle\" font-size=\"16\" fill=\"rgb(255, 255, 255)\" font-weight=\"600\">${this._formatValueText()}</text>\r\n        \r\n        <text x=\"${this.centerX}\" y=\"${unitsY}\" text-anchor=\"middle\" font-size=\"8\" fill=\"rgb(160, 160, 160)\" font-weight=\"400\" letter-spacing=\"0.5\">${this.units}</text>\r\n        \r\n        <rect id=\"dimmer-${this.id}\" x=\"0\" y=\"0\" width=\"${this.boxWidth}\" height=\"${this.boxHeight}\" rx=\"${this.boxRadius}\" ry=\"${this.boxRadius}\" fill=\"black\" opacity=\"0\" pointer-events=\"none\" style=\"transition: opacity 0.8s ease-in-out;\" />\r\n      </g>\r\n    `;\r\n\r\n    // Create element from markup using a temporary container\r\n    const container = document.createElementNS('http://www.w3.org/2000/svg', 'svg');\r\n    container.innerHTML = svgMarkup;\r\n    const element = container.firstElementChild as SVGGElement;\r\n\r\n    // Store reference to owned element\r\n    this.element = element;\r\n\r\n    // Attach click handler (defaults to more-info if no action configured)\r\n    // Only skip if explicitly set to 'none'\r\n    if (!this.tapAction || this.tapAction.action !== 'none') {\r\n      element.style.cursor = 'pointer';\r\n      element.addEventListener('click', (e) => {\r\n        this._handleTapAction();\r\n        e.stopPropagation();\r\n      });\r\n      \r\n      // Add hover effect\r\n      element.addEventListener('mouseenter', () => {\r\n        element.style.filter = 'brightness(1.1)';\r\n      });\r\n      element.addEventListener('mouseleave', () => {\r\n        element.style.filter = '';\r\n      });\r\n    }\r\n\r\n    return element;\r\n  }\r\n}\r\n","/**\r\n * Flow Renderer - Handles animated flow lines and dots between energy components\r\n */\r\n\r\n/** Position coordinates for flow paths */\r\nexport interface Position {\r\n  x: number;\r\n  y: number;\r\n}\r\n\r\n/** Animation state for flow dots */\r\nexport interface DotState {\r\n  /** Progress along path (0-1) */\r\n  progress: number;\r\n  /** Movement velocity in units per second */\r\n  velocity: number;\r\n}\r\n\r\n/**\r\n * FlowLine - Encapsulates a single animated flow line with glow effect and dots\r\n */\r\nclass FlowLine {\r\n  private glowPath: SVGPathElement;\r\n  private mainPath: SVGPathElement;\r\n  private dots: SVGCircleElement[] = [];\r\n  private dotStates: DotState[] = [];\r\n  private pathData: string;\r\n  private pathLength: number = 0;\r\n\r\n  constructor(\r\n    private group: SVGGElement,\r\n    private flowId: string,\r\n    from: Position,\r\n    to: Position,\r\n    power: number,\r\n    color: string,\r\n    private speedMultiplier: number,\r\n    private dotsPerFlow: number\r\n  ) {\r\n    const midX = (from.x + to.x) / 2;\r\n    const midY = (from.y + to.y) / 2;\r\n    this.pathData = `M ${from.x},${from.y} Q ${midX},${midY} ${to.x},${to.y}`;\r\n\r\n    // Calculate styles based on power\r\n    const { opacity, strokeWidth, dotRadius } = this.calculateStyles(power);\r\n    const velocity = this.calculateVelocity(power);\r\n\r\n    // Create glow path (wider, semi-transparent)\r\n    this.glowPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');\r\n    this.glowPath.setAttribute('d', this.pathData);\r\n    this.glowPath.setAttribute('class', 'flow-line');\r\n    this.glowPath.setAttribute('stroke', color);\r\n    this.glowPath.setAttribute('stroke-opacity', String(opacity * 0.5));\r\n    this.glowPath.setAttribute('stroke-width', String(strokeWidth * 2));\r\n    this.glowPath.setAttribute('fill', 'none');\r\n    this.glowPath.setAttribute('stroke-linecap', 'round');\r\n    this.glowPath.setAttribute('style', 'transition: stroke-opacity 0.5s ease-out, stroke-width 0.5s ease-out;');\r\n    this.glowPath.id = `glow-${flowId}`;\r\n    this.group.appendChild(this.glowPath);\r\n\r\n    // Create main path\r\n    this.mainPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');\r\n    this.mainPath.setAttribute('d', this.pathData);\r\n    this.mainPath.setAttribute('class', 'flow-line');\r\n    this.mainPath.setAttribute('stroke', color);\r\n    this.mainPath.setAttribute('stroke-opacity', String(opacity));\r\n    this.mainPath.setAttribute('stroke-width', String(strokeWidth));\r\n    this.mainPath.setAttribute('fill', 'none');\r\n    this.mainPath.setAttribute('stroke-linecap', 'round');\r\n    this.mainPath.setAttribute('style', 'transition: stroke-opacity 0.5s ease-out, stroke-width 0.5s ease-out;');\r\n    this.mainPath.id = `path-${flowId}`;\r\n    this.group.appendChild(this.mainPath);\r\n\r\n    // Get path length\r\n    this.pathLength = this.mainPath.getTotalLength();\r\n\r\n    // Create animated dots\r\n    for (let i = 0; i < this.dotsPerFlow; i++) {\r\n      const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');\r\n      dot.setAttribute('class', 'flow-dot');\r\n      dot.setAttribute('id', `dot-${flowId}-${i}`);\r\n      dot.setAttribute('r', String(dotRadius));\r\n      dot.setAttribute('fill', color);\r\n      dot.setAttribute('opacity', String(opacity));\r\n      dot.setAttribute('style', 'transition: opacity 0.5s ease-out, r 0.5s ease-out;');\r\n      this.group.appendChild(dot);\r\n      this.dots.push(dot);\r\n\r\n      const progress = i / this.dotsPerFlow;\r\n      this.dotStates.push({ progress, velocity });\r\n\r\n      // Set initial position\r\n      const point = this.mainPath.getPointAtLength(progress * this.pathLength);\r\n      dot.setAttribute('cx', String(point.x));\r\n      dot.setAttribute('cy', String(point.y));\r\n    }\r\n  }\r\n\r\n  private calculateStyles(power: number): { opacity: number; strokeWidth: number; dotRadius: number } {\r\n    let opacity: number;\r\n    if (power <= 100) {\r\n      opacity = 0.25;\r\n    } else if (power <= 200) {\r\n      opacity = 0.25 + ((power - 100) / 100) * 0.75;\r\n    } else {\r\n      opacity = 1;\r\n    }\r\n\r\n    const minWidth = 2;\r\n    const maxWidth = 23.76;\r\n    const maxPower = 10000;\r\n    let strokeWidth: number;\r\n    if (power <= 100) {\r\n      strokeWidth = minWidth;\r\n    } else {\r\n      const range = Math.min((power - 100) / (maxPower - 100), 1) * (maxWidth - minWidth);\r\n      strokeWidth = minWidth + range;\r\n    }\r\n\r\n    const baseDotRadius = 2.5;\r\n    const maxDotRadius = 3;\r\n    const scaledRadius = baseDotRadius * (strokeWidth / minWidth);\r\n    const dotRadius = Math.max(scaledRadius, maxDotRadius);\r\n\r\n    return { opacity, strokeWidth, dotRadius };\r\n  }\r\n\r\n  private calculateVelocity(power: number): number {\r\n    const baseSpeed = 40 * (power / 1000) * this.speedMultiplier;\r\n    return this.pathLength > 0 ? baseSpeed / this.pathLength : 0;\r\n  }\r\n\r\n  update(power: number, color: string): void {\r\n    const { opacity, strokeWidth, dotRadius } = this.calculateStyles(power);\r\n    const velocity = this.calculateVelocity(power);\r\n\r\n    // Update glow path\r\n    this.glowPath.setAttribute('stroke', color);\r\n    this.glowPath.setAttribute('stroke-opacity', String(opacity * 0.5));\r\n    this.glowPath.setAttribute('stroke-width', String(strokeWidth * 2));\r\n\r\n    // Update main path\r\n    this.mainPath.setAttribute('stroke', color);\r\n    this.mainPath.setAttribute('stroke-opacity', String(opacity));\r\n    this.mainPath.setAttribute('stroke-width', String(strokeWidth));\r\n\r\n    // Update dots\r\n    this.dots.forEach((dot, i) => {\r\n      dot.setAttribute('r', String(dotRadius));\r\n      dot.setAttribute('opacity', String(opacity));\r\n      dot.setAttribute('fill', color);\r\n      this.dotStates[i].velocity = velocity;\r\n    });\r\n  }\r\n\r\n  animate(deltaTime: number): void {\r\n    this.dotStates.forEach((state, i) => {\r\n      if (state.velocity > 0) {\r\n        // deltaTime is in milliseconds, convert to seconds\r\n        state.progress += state.velocity * (deltaTime / 1000);\r\n        if (state.progress >= 1) {\r\n          state.progress = state.progress % 1;\r\n        }\r\n\r\n        try {\r\n          if (this.pathLength > 0) {\r\n            const point = this.mainPath.getPointAtLength(state.progress * this.pathLength);\r\n            this.dots[i].setAttribute('cx', String(point.x));\r\n            this.dots[i].setAttribute('cy', String(point.y));\r\n          }\r\n        } catch (_e) {\r\n          // Ignore path errors\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  fadeOut(callback: () => void): void {\r\n    this.glowPath.setAttribute('stroke-opacity', '0');\r\n    this.mainPath.setAttribute('stroke-opacity', '0');\r\n    this.dots.forEach(dot => dot.setAttribute('opacity', '0'));\r\n    setTimeout(callback, 500);\r\n  }\r\n}\r\n\r\nexport class FlowRenderer {\r\n  private flowLines: Map<string, FlowLine> = new Map();\r\n  private animationFrameId: number | null = null;\r\n  private lastAnimationTime: number | null = null;\r\n  private speedMultiplier = 0.8;\r\n  private dotsPerFlow = 3;\r\n\r\n  constructor(\r\n    private container: SVGElement,\r\n    private positions: Record<string, Position>\r\n  ) {}\r\n\r\n  /**\r\n   * Update flows based on current power values\r\n   */\r\n  updateFlows(flows: {\r\n    productionToLoad: number;\r\n    productionToBattery: number;\r\n    productionToGrid: number;\r\n    gridToLoad: number;\r\n    gridToBattery: number;\r\n    batteryToLoad: number;\r\n  }): void {\r\n    const flowLayer = this.container.querySelector('#flow-layer') as SVGGElement;\r\n    if (!flowLayer) return;\r\n\r\n    const threshold = 0;\r\n    const batteryThreshold = 10;\r\n\r\n    // Update each flow with appropriate color\r\n    this.updateOrCreateFlow(flowLayer, 'production-to-load', this.positions.production, this.positions.load, flows.productionToLoad, '#4caf50', threshold);\r\n    this.updateOrCreateFlow(flowLayer, 'production-to-battery', this.positions.production, this.positions.battery, flows.productionToBattery, '#4caf50', threshold);\r\n    this.updateOrCreateFlow(flowLayer, 'battery-to-load', this.positions.battery, this.positions.load, flows.batteryToLoad, '#2196f3', batteryThreshold);\r\n    this.updateOrCreateFlow(flowLayer, 'grid-to-load', this.positions.grid, this.positions.load, flows.gridToLoad, '#f44336', threshold);\r\n    this.updateOrCreateFlow(flowLayer, 'grid-to-battery', this.positions.grid, this.positions.battery, flows.gridToBattery, '#f44336', threshold);\r\n    this.updateOrCreateFlow(flowLayer, 'production-to-grid', this.positions.production, this.positions.grid, flows.productionToGrid, '#ffeb3b', threshold);\r\n  }\r\n\r\n  /**\r\n   * Start animation loop\r\n   */\r\n  start(): void {\r\n    if (this.animationFrameId) return;\r\n    this.lastAnimationTime = performance.now();\r\n    this.animate();\r\n  }\r\n\r\n  /**\r\n   * Stop animation loop\r\n   */\r\n  stop(): void {\r\n    if (this.animationFrameId) {\r\n      cancelAnimationFrame(this.animationFrameId);\r\n      this.animationFrameId = null;\r\n      this.lastAnimationTime = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear all flows\r\n   */\r\n  clear(): void {\r\n    this.stop();\r\n    this.flowLines.clear();\r\n    const flowLayer = this.container.querySelector('#flow-layer') as SVGGElement;\r\n    if (flowLayer) {\r\n      flowLayer.innerHTML = '';\r\n    }\r\n  }\r\n\r\n  private animate = (): void => {\r\n    const now = performance.now();\r\n    const deltaTime = this.lastAnimationTime ? now - this.lastAnimationTime : 0;\r\n    this.lastAnimationTime = now;\r\n\r\n    // Animate each flow line\r\n    this.flowLines.forEach((flowLine) => {\r\n      flowLine.animate(deltaTime);\r\n    });\r\n\r\n    this.animationFrameId = requestAnimationFrame(this.animate);\r\n  };\r\n\r\n  private updateOrCreateFlow(\r\n    flowLayer: SVGGElement,\r\n    flowId: string,\r\n    from: Position,\r\n    to: Position,\r\n    power: number,\r\n    color: string,\r\n    threshold: number\r\n  ): void {\r\n    const existingFlowLine = this.flowLines.get(flowId);\r\n\r\n    if (power <= threshold) {\r\n      if (existingFlowLine) {\r\n        this.fadeOutFlow(flowLayer, flowId);\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (!existingFlowLine) {\r\n      this.drawFlow(flowLayer, flowId, from, to, power, color);\r\n    } else {\r\n      existingFlowLine.update(power, color);\r\n    }\r\n  }\r\n\r\n  private drawFlow(\r\n    flowLayer: SVGGElement,\r\n    flowId: string,\r\n    from: Position,\r\n    to: Position,\r\n    power: number,\r\n    color: string\r\n  ): void {\r\n    // Create flow group\r\n    const flowGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');\r\n    flowGroup.setAttribute('id', flowId);\r\n    flowLayer.appendChild(flowGroup);\r\n\r\n    // Create FlowLine instance\r\n    const flowLine = new FlowLine(\r\n      flowGroup,\r\n      flowId,\r\n      from,\r\n      to,\r\n      power,\r\n      color,\r\n      this.speedMultiplier,\r\n      this.dotsPerFlow\r\n    );\r\n\r\n    this.flowLines.set(flowId, flowLine);\r\n  }\r\n\r\n  private removeFlow(flowLayer: SVGGElement, flowId: string): void {\r\n    const flow = flowLayer.querySelector(`#${flowId}`);\r\n    if (flow) {\r\n      flow.remove();\r\n      this.flowLines.delete(flowId);\r\n    }\r\n  }\r\n\r\n  private fadeOutFlow(flowLayer: SVGGElement, flowId: string): void {\r\n    const flowLine = this.flowLines.get(flowId);\r\n    if (!flowLine) return;\r\n\r\n    flowLine.fadeOut(() => {\r\n      this.removeFlow(flowLayer, flowId);\r\n    });\r\n  }\r\n}\r\n","/**\r\n * DefaultRenderer\r\n * \r\n * Renders the default SVG view with meters and animated energy flows.\r\n * Works with Meter instances - does not abstract them away.\r\n */\r\n\r\nimport { Meter } from '../Meter';\r\nimport type { EnergyFlowCardConfig } from '../types/Config.d.ts';\r\nimport type { HomeAssistant } from '../types/HASS.d.ts';\r\nimport type { EnergyFlows } from '../types/EnergyFlow.d.ts';\r\nimport { FlowRenderer } from './FlowRenderer';\r\nimport type { Position } from './FlowRenderer';\r\n\r\nexport interface DefaultRenderData {\r\n  grid: number;\r\n  load: number;\r\n  production: number;\r\n  battery: number;\r\n  flows: EnergyFlows;\r\n}\r\n\r\n/**\r\n * DefaultRenderer coordinates the classic SVG meter visualization\r\n */\r\nexport class DefaultRenderer {\r\n  private container: HTMLElement;\r\n  private config: EnergyFlowCardConfig;\r\n  private hass: HomeAssistant;\r\n  private canvasWidth: number;\r\n  private canvasHeight: number;\r\n  private meterPositions: {\r\n    production: Position;\r\n    battery: Position;\r\n    grid: Position;\r\n    load: Position;\r\n  };\r\n  private meters: Map<string, Meter>;\r\n  private flowRenderer?: FlowRenderer;\r\n  private iconsExtracted: boolean;\r\n  private iconExtractionTimeouts: Set<number>;\r\n  private iconCache: Map<string, string>;\r\n  \r\n  private getDisplayNameCallback: (type: 'grid' | 'load' | 'production' | 'battery', fallback: string) => string;\r\n  private getIconCallback: (type: 'grid' | 'load' | 'production' | 'battery', fallback: string) => string;\r\n  private fireEventCallback: (event: string, detail?: any) => void;\r\n\r\n  constructor(\r\n    container: HTMLElement,\r\n    config: EnergyFlowCardConfig,\r\n    hass: HomeAssistant,\r\n    getDisplayNameCallback: (type: 'grid' | 'load' | 'production' | 'battery', fallback: string) => string,\r\n    getIconCallback: (type: 'grid' | 'load' | 'production' | 'battery', fallback: string) => string,\r\n    fireEventCallback: (event: string, detail?: any) => void\r\n  ) {\r\n    this.container = container;\r\n    this.config = config;\r\n    this.hass = hass;\r\n    this.getDisplayNameCallback = getDisplayNameCallback;\r\n    this.getIconCallback = getIconCallback;\r\n    this.fireEventCallback = fireEventCallback;\r\n    \r\n    this.meters = new Map();\r\n    this.iconsExtracted = false;\r\n    this.iconExtractionTimeouts = new Set();\r\n    this.iconCache = new Map();\r\n    \r\n    // Canvas dimensions\r\n    this.canvasWidth = 500;\r\n    this.canvasHeight = 470;\r\n    \r\n    // Global offset for all meters\r\n    const offsetX = 5;\r\n    const offsetY = 3;\r\n    \r\n    // Meter positions (circle centers) in SVG coordinates\r\n    this.meterPositions = {\r\n      production: { x: 60 + offsetX, y: 80 + offsetY },\r\n      battery: { x: 130 + offsetX, y: 240 + offsetY },\r\n      grid: { x: 60 + offsetX, y: 400 + offsetY },\r\n      load: { x: 360 + offsetX, y: 240 + offsetY }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Render the default view\r\n   */\r\n  render(data: DefaultRenderData): void {\r\n    const { grid, load, production, battery, flows } = data;\r\n\r\n    // Get min/max values with defaults\r\n    const gridMin = this.config.grid?.min ?? -5000;\r\n    const gridMax = this.config.grid?.max ?? 5000;\r\n    const loadMax = this.config.load.max ?? 5000;\r\n    const productionMax = this.config.production?.max ?? 5000;\r\n    const batteryMin = this.config.battery?.min ?? -5000;\r\n    const batteryMax = this.config.battery?.max ?? 5000;\r\n\r\n    // Only do full render if structure doesn't exist\r\n    if (!this.container.querySelector('.energy-flow-svg')) {\r\n      this.iconsExtracted = false;\r\n      this.initializeStructure(\r\n        grid, load, production, battery,\r\n        gridMin, gridMax, loadMax, productionMax, batteryMin, batteryMax\r\n      );\r\n      \r\n      // Extract icon paths\r\n      if (!this.iconsExtracted) {\r\n        requestAnimationFrame(() => {\r\n          this.extractIconPaths();\r\n        });\r\n      }\r\n      \r\n      // FlowRenderer will be initialized in initializeStructure's requestAnimationFrame\r\n    } else {\r\n      // Update existing meters\r\n      const productionMeter = this.meters.get('production');\r\n      const batteryMeter = this.meters.get('battery');\r\n      const gridMeter = this.meters.get('grid');\r\n      const loadMeter = this.meters.get('load');\r\n      \r\n      if (productionMeter) productionMeter.value = production;\r\n      if (batteryMeter) {\r\n        batteryMeter.invertView = this.config.battery?.invert?.view ?? false;\r\n        batteryMeter.value = battery;\r\n      }\r\n      if (gridMeter) gridMeter.value = grid;\r\n      if (loadMeter) loadMeter.value = load;\r\n      \r\n      // Initialize FlowRenderer if needed (for existing structure)\r\n      if (!this.flowRenderer) {\r\n        const svg = this.container.querySelector('.energy-flow-svg');\r\n        if (svg) {\r\n          this.flowRenderer = new FlowRenderer(svg as SVGElement, this.meterPositions);\r\n          this.flowRenderer.start(); // Start the animation loop\r\n        }\r\n      }\r\n    }\r\n\r\n    // Update flows\r\n    if (this.flowRenderer) {\r\n      this.flowRenderer.updateFlows(flows);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop animations and clean up\r\n   */\r\n  stop(): void {\r\n    // Stop flow animations\r\n    if (this.flowRenderer) {\r\n      this.flowRenderer.stop();\r\n    }\r\n    \r\n    // Stop meter animations\r\n    this.meters.forEach(meter => meter.stopAnimation());\r\n    \r\n    // Clear icon extraction timeouts\r\n    this.iconExtractionTimeouts.forEach(id => clearTimeout(id));\r\n    this.iconExtractionTimeouts.clear();\r\n  }\r\n\r\n  /**\r\n   * Clear all flows and stop animation\r\n   */\r\n  clear(): void {\r\n    this.stop();\r\n    if (this.flowRenderer) {\r\n      this.flowRenderer.clear();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initialize the HTML structure and create Meter instances\r\n   */\r\n  private initializeStructure(\r\n    grid: number,\r\n    load: number,\r\n    production: number,\r\n    battery: number,\r\n    gridMin: number,\r\n    gridMax: number,\r\n    loadMax: number,\r\n    productionMax: number,\r\n    batteryMin: number,\r\n    batteryMax: number\r\n  ): void {\r\n    // Create meter instances with tap actions\r\n    const productionMeter = new Meter('production', production, 0, productionMax, false, \r\n      this.getDisplayNameCallback('production', 'Production'),\r\n      this.getIconCallback('production', 'mdi:solar-power'),\r\n      'WATTS',\r\n      false,\r\n      false,\r\n      this.config.production?.tap,\r\n      this.config.production?.entity,\r\n      this.fireEventCallback);\r\n    const batteryMeter = new Meter('battery', battery, batteryMin, batteryMax, true,\r\n      this.getDisplayNameCallback('battery', 'Battery'),\r\n      this.getIconCallback('battery', 'mdi:battery'),\r\n      'WATTS',\r\n      this.config.battery?.invert?.view,\r\n      this.config.battery?.showPlus,\r\n      this.config.battery?.tap,\r\n      this.config.battery?.entity,\r\n      this.fireEventCallback);\r\n    const gridMeter = new Meter('grid', grid, gridMin, gridMax, true,\r\n      this.getDisplayNameCallback('grid', 'Grid'),\r\n      this.getIconCallback('grid', 'mdi:transmission-tower'),\r\n      'WATTS',\r\n      false,\r\n      false,\r\n      this.config.grid?.tap,\r\n      this.config.grid?.entity,\r\n      this.fireEventCallback);\r\n    const loadMeter = new Meter('load', load, 0, loadMax, false,\r\n      this.getDisplayNameCallback('load', 'Load'),\r\n      this.getIconCallback('load', 'mdi:home-lightning-bolt'),\r\n      'WATTS',\r\n      false,\r\n      false,\r\n      this.config.load.tap,\r\n      this.config.load.entity,\r\n      this.fireEventCallback);\r\n    \r\n    this.container.innerHTML = `\r\n      <ha-card>\r\n        <style>\r\n          :host {\r\n            display: block;\r\n            width: 100%;\r\n            height: 100%;\r\n          }\r\n          ha-card {\r\n            display: flex;\r\n            align-items: center;\r\n            justify-content: center;\r\n            width: 100%;\r\n            height: 100%;\r\n            padding: 8px;\r\n            box-sizing: border-box;\r\n            overflow: hidden;\r\n          }\r\n          .svg-wrapper {\r\n            width: 100%;\r\n            height: 100%;\r\n            display: flex;\r\n            align-items: center;\r\n            justify-content: center;\r\n          }\r\n          svg.energy-flow-svg {\r\n            display: block;\r\n            width: 100%;\r\n            height: 100%;\r\n          }\r\n          .flow-line {\r\n            fill: none;\r\n            stroke-linecap: round;\r\n          }\r\n          .flow-positive { stroke: var(--success-color, #4caf50); }\r\n          .flow-negative { stroke: var(--error-color, #f44336); }\r\n          .flow-dot {\r\n            offset-path: attr(data-path);\r\n            offset-distance: 0%;\r\n            animation: flow-move var(--flow-duration, 2s) linear infinite;\r\n          }\r\n          @keyframes flow-move {\r\n            from { offset-distance: 0%; }\r\n            to { offset-distance: 100%; }\r\n          }\r\n        </style>\r\n        <div class=\"svg-wrapper\">\r\n          <svg class=\"energy-flow-svg\" viewBox=\"0 0 ${this.canvasWidth} ${this.canvasHeight}\" xmlns=\"http://www.w3.org/2000/svg\" preserveAspectRatio=\"xMidYMid meet\">\r\n            <defs>\r\n              ${this.createMeterDefs()}\r\n            </defs>\r\n            \r\n            <!-- Flow lines layer (behind meters) -->\r\n            <g id=\"flow-layer\"></g>\r\n            \r\n            <!-- Production Meter (top left) -->\r\n            <g id=\"production-meter\" class=\"meter-group\" transform=\"translate(${this.meterPositions.production.x}, ${this.meterPositions.production.y})\"></g>\r\n            \r\n            <!-- Battery Meter (middle left, offset right) -->\r\n            <g id=\"battery-meter\" class=\"meter-group\" transform=\"translate(${this.meterPositions.battery.x}, ${this.meterPositions.battery.y})\"></g>\r\n            \r\n            <!-- Grid Meter (bottom left) -->\r\n            <g id=\"grid-meter\" class=\"meter-group\" transform=\"translate(${this.meterPositions.grid.x}, ${this.meterPositions.grid.y})\"></g>\r\n            \r\n            <!-- Load Meter (right, 2x size) -->\r\n            <g id=\"load-meter\" class=\"meter-group\" transform=\"translate(${this.meterPositions.load.x}, ${this.meterPositions.load.y}) scale(2)\"></g>\r\n          </svg>\r\n        </div>\r\n      </ha-card>\r\n    `;\r\n    \r\n    // Append meter elements and start animations\r\n    requestAnimationFrame(() => {\r\n      const productionContainer = this.container.querySelector('#production-meter');\r\n      const batteryContainer = this.container.querySelector('#battery-meter');\r\n      const gridContainer = this.container.querySelector('#grid-meter');\r\n      const loadContainer = this.container.querySelector('#load-meter');\r\n      \r\n      if (productionContainer) productionContainer.appendChild(productionMeter.createElement());\r\n      if (batteryContainer) batteryContainer.appendChild(batteryMeter.createElement());\r\n      if (gridContainer) gridContainer.appendChild(gridMeter.createElement());\r\n      if (loadContainer) loadContainer.appendChild(loadMeter.createElement());\r\n      \r\n      this.meters.set('production', productionMeter);\r\n      this.meters.set('battery', batteryMeter);\r\n      this.meters.set('grid', gridMeter);\r\n      this.meters.set('load', loadMeter);\r\n      \r\n      // Start each meter's animation\r\n      productionMeter.startAnimation();\r\n      batteryMeter.startAnimation();\r\n      gridMeter.startAnimation();\r\n      loadMeter.startAnimation();\r\n      \r\n      // Update initial dimming\r\n      productionMeter.updateDimming();\r\n      batteryMeter.updateDimming();\r\n      gridMeter.updateDimming();\r\n      loadMeter.updateDimming();\r\n      \r\n      // Initialize FlowRenderer now that SVG is ready\r\n      const svg = this.container.querySelector('.energy-flow-svg');\r\n      if (svg && !this.flowRenderer) {\r\n        this.flowRenderer = new FlowRenderer(svg as SVGElement, this.meterPositions);\r\n        this.flowRenderer.start(); // Start the animation loop\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create SVG filter definitions\r\n   */\r\n  private createMeterDefs(): string {\r\n    return `\r\n      <!-- Glow filter for flow lines -->\r\n      <filter id=\"glow\" x=\"-50%\" y=\"-50%\" width=\"200%\" height=\"200%\">\r\n        <feGaussianBlur in=\"SourceGraphic\" stdDeviation=\"3\" result=\"blur\" />\r\n        <feFlood flood-color=\"currentColor\" flood-opacity=\"0.5\" result=\"flood\" />\r\n        <feComposite in=\"flood\" in2=\"blur\" operator=\"in\" result=\"coloredBlur\" />\r\n        <feMerge>\r\n          <feMergeNode in=\"coloredBlur\" />\r\n          <feMergeNode in=\"SourceGraphic\" />\r\n        </feMerge>\r\n      </filter>\r\n      \r\n      <!-- Drop shadow filter for meters -->\r\n      <filter id=\"drop-shadow\" x=\"-50%\" y=\"-50%\" width=\"200%\" height=\"200%\">\r\n        <feGaussianBlur in=\"SourceAlpha\" stdDeviation=\"3\" result=\"blur\" />\r\n        <feOffset in=\"blur\" dx=\"0\" dy=\"2\" result=\"offsetBlur\" />\r\n        <feComponentTransfer in=\"offsetBlur\" result=\"shadow\">\r\n          <feFuncA type=\"linear\" slope=\"0.4\" />\r\n        </feComponentTransfer>\r\n        <feMerge>\r\n          <feMergeNode in=\"shadow\" />\r\n          <feMergeNode in=\"SourceGraphic\" />\r\n        </feMerge>\r\n      </filter>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Extract icon paths from ha-icon elements\r\n   */\r\n  private extractIconPaths(): void {\r\n    const meterIds = ['production', 'battery', 'grid', 'load'];\r\n    \r\n    meterIds.forEach(async (meterId) => {\r\n      const iconContainer = this.container.querySelector(`#icon-${meterId}`);\r\n      const iconSource = this.container.querySelector(`#ha-icon-${meterId}`);\r\n      \r\n      if (iconContainer && iconSource) {\r\n        const iconName = iconSource.getAttribute('icon') || 'unknown';\r\n        \r\n        // Check cache first\r\n        const cachedPath = this.iconCache.get(iconName);\r\n        if (cachedPath) {\r\n          this.renderIconPath(iconContainer, cachedPath);\r\n          return;\r\n        }\r\n        \r\n        const pathData = await this.extractIconPath(iconSource, iconName);\r\n        this.renderIconPath(iconContainer, pathData);\r\n      }\r\n    });\r\n    \r\n    this.iconsExtracted = true;\r\n  }\r\n\r\n  /**\r\n   * Extract SVG path from ha-icon element\r\n   */\r\n  private async extractIconPath(iconElement: Element, iconName: string, maxAttempts = 10): Promise<string | null> {\r\n    return new Promise((resolve) => {\r\n      const attemptExtraction = (attempt = 1, max = maxAttempts) => {\r\n        const delay = attempt === 1 ? 0 : 100 * attempt;\r\n        const timeoutId = window.setTimeout(async () => {\r\n          try {\r\n            const shadowRoot = (iconElement as any).shadowRoot;\r\n            if (!shadowRoot) {\r\n              if (attempt < max) {\r\n                attemptExtraction(attempt + 1, max);\r\n              } else {\r\n                resolve(null);\r\n              }\r\n              return;\r\n            }\r\n            \r\n            const svg = shadowRoot.querySelector('svg');\r\n            if (!svg) {\r\n              if (attempt < max) {\r\n                attemptExtraction(attempt + 1, max);\r\n              } else {\r\n                resolve(null);\r\n              }\r\n              return;\r\n            }\r\n            \r\n            const path = svg.querySelector('path');\r\n            if (path) {\r\n              const pathData = path.getAttribute('d');\r\n              if (pathData && this.iconCache) {\r\n                this.iconCache.set(iconName, pathData);\r\n              }\r\n              resolve(pathData);\r\n            } else {\r\n              if (attempt < max) {\r\n                attemptExtraction(attempt + 1, max);\r\n              } else {\r\n                resolve(null);\r\n              }\r\n            }\r\n          } catch (e) {\r\n            console.error(`Failed to extract icon path for ${iconName} (attempt ${attempt}):`, e);\r\n            if (attempt < max) {\r\n              attemptExtraction(attempt + 1, max);\r\n            } else {\r\n              resolve(null);\r\n            }\r\n          }\r\n        }, delay);\r\n        this.iconExtractionTimeouts.add(timeoutId);\r\n      };\r\n      \r\n      attemptExtraction();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Render an icon path in a container\r\n   */\r\n  private renderIconPath(container: Element, pathData: string | null): void {\r\n    container.innerHTML = '';\r\n    \r\n    if (pathData) {\r\n      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');\r\n      path.setAttribute('d', pathData);\r\n      path.setAttribute('fill', 'rgb(160, 160, 160)');\r\n      path.setAttribute('transform', 'scale(1)');\r\n      container.appendChild(path);\r\n    } else {\r\n      const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');\r\n      circle.setAttribute('cx', '12');\r\n      circle.setAttribute('cy', '12');\r\n      circle.setAttribute('r', '8');\r\n      circle.setAttribute('fill', 'rgb(160, 160, 160)');\r\n      container.appendChild(circle);\r\n    }\r\n  }\r\n}\r\n","/**\r\n * Chart utility functions for rendering SVG chart elements\r\n */\r\n\r\nexport function createGridLines(\r\n  chartWidth: number,\r\n  chartHeight: number,\r\n  margin: { top: number; left: number }\r\n): string {\r\n  const lines: string[] = [];\r\n  const numLines = 4;\r\n  \r\n  for (let i = 0; i <= numLines; i++) {\r\n    const y = margin.top + (i * chartHeight / numLines);\r\n    lines.push(`<line x1=\"${margin.left}\" y1=\"${y}\" x2=\"${margin.left + chartWidth}\" y2=\"${y}\" stroke=\"white\" stroke-width=\"1\" />`);\r\n  }\r\n  \r\n  return lines.join('\\n');\r\n}\r\n\r\nexport function createTimeLabels(\r\n  chartWidth: number,\r\n  chartHeight: number,\r\n  margin: { top: number; bottom: number; left: number },\r\n  hoursToShow: number\r\n): string {\r\n  const labels: string[] = [];\r\n  const numLabels = 6;\r\n  const now = new Date();\r\n  \r\n  for (let i = 0; i <= numLabels; i++) {\r\n    const hoursAgo = hoursToShow - (i * hoursToShow / numLabels);\r\n    const time = new Date(now.getTime() - hoursAgo * 60 * 60 * 1000);\r\n    \r\n    // Quantize to nearest 30-minute mark\r\n    const currentMinutes = time.getMinutes();\r\n    const quantizedMinutes = currentMinutes < 15 ? 0 : (currentMinutes < 45 ? 30 : 0);\r\n    const hourAdjust = (currentMinutes >= 45) ? 1 : 0;\r\n    \r\n    time.setMinutes(quantizedMinutes);\r\n    time.setSeconds(0);\r\n    time.setMilliseconds(0);\r\n    if (hourAdjust) {\r\n      time.setHours(time.getHours() + hourAdjust);\r\n    }\r\n    \r\n    const x = margin.left + (i * chartWidth / numLabels);\r\n    const y = margin.top + chartHeight + 20;\r\n    \r\n    // Format as 12-hour AM/PM\r\n    const hours = time.getHours();\r\n    const hours12 = hours === 0 ? 12 : (hours > 12 ? hours - 12 : hours);\r\n    const ampm = hours >= 12 ? 'PM' : 'AM';\r\n    \r\n    labels.push(`\r\n      <text x=\"${x}\" y=\"${y}\" text-anchor=\"middle\" fill=\"rgb(160, 160, 160)\" font-size=\"11\">\r\n        ${hours12} ${ampm}\r\n      </text>\r\n    `);\r\n  }\r\n  \r\n  return labels.join('\\n');\r\n}\r\n\r\nexport function createYAxisLabels(\r\n  supplyHeight: number,\r\n  demandHeight: number,\r\n  margin: { top: number; left: number },\r\n  maxSupply: number,\r\n  maxDemand: number,\r\n  zeroLineY: number\r\n): string {\r\n  const labels: string[] = [];\r\n  \r\n  // Top label (max supply)\r\n  labels.push(`<text x=\"${margin.left - 10}\" y=\"${margin.top + 5}\" text-anchor=\"end\" fill=\"rgb(160, 160, 160)\" font-size=\"11\">${Math.round(maxSupply)}W</text>`);\r\n  \r\n  // Zero line label\r\n  labels.push(`<text x=\"${margin.left - 10}\" y=\"${zeroLineY + 5}\" text-anchor=\"end\" fill=\"rgb(160, 160, 160)\" font-size=\"11\">0</text>`);\r\n  \r\n  // Bottom label (max demand, shown as negative)\r\n  labels.push(`<text x=\"${margin.left - 10}\" y=\"${zeroLineY + demandHeight + 5}\" text-anchor=\"end\" fill=\"rgb(160, 160, 160)\" font-size=\"11\">-${Math.round(maxDemand)}W</text>`);\r\n  \r\n  return labels.join('\\n');\r\n}\r\n\r\nexport function createAreaPath(\r\n  dataPoints: Array<any>,\r\n  xStep: number,\r\n  centerY: number,\r\n  yScale: number,\r\n  margin: { top: number; right: number; bottom: number; left: number },\r\n  valueGetter: (d: any) => number,\r\n  baseValueGetter: number | ((d: any) => number),\r\n  direction: 'up' | 'down'\r\n): string | null {\r\n  const points: Array<{ x: number; y: number }> = [];\r\n  const basePoints: Array<{ x: number; y: number }> = [];\r\n  \r\n  let hasData = false;\r\n\r\n  dataPoints.forEach((d, i) => {\r\n    const x = margin.left + i * xStep;\r\n    const value = valueGetter(d);\r\n    const baseValue = typeof baseValueGetter === 'function' ? baseValueGetter(d) : baseValueGetter;\r\n    \r\n    if (value > 0) hasData = true;\r\n    \r\n    const yOffset = direction === 'down' \r\n      ? -(value + baseValue) * yScale \r\n      : (value + baseValue) * yScale;\r\n    const baseYOffset = direction === 'down'\r\n      ? -baseValue * yScale\r\n      : baseValue * yScale;\r\n    \r\n    points.push({ x, y: centerY + yOffset });\r\n    basePoints.push({ x, y: centerY + baseYOffset });\r\n  });\r\n\r\n  if (!hasData) return null;\r\n\r\n  // Create path: go along top edge, then back along bottom edge\r\n  let path = `M ${points[0].x} ${points[0].y}`;\r\n  for (let i = 1; i < points.length; i++) {\r\n    path += ` L ${points[i].x} ${points[i].y}`;\r\n  }\r\n  for (let i = basePoints.length - 1; i >= 0; i--) {\r\n    path += ` L ${basePoints[i].x} ${basePoints[i].y}`;\r\n  }\r\n  path += ' Z';\r\n\r\n  return path;\r\n}\r\n\r\nexport function createLoadLine(\r\n  dataPoints: Array<any>,\r\n  chartWidth: number,\r\n  chartHeight: number,\r\n  yScale: number,\r\n  margin: { top: number; right: number; bottom: number; left: number },\r\n  zeroLineY: number\r\n): string {\r\n  if (!dataPoints || dataPoints.length === 0) return '';\r\n\r\n  const xStep = dataPoints.length > 1 ? chartWidth / (dataPoints.length - 1) : 0;\r\n\r\n  // Create line path showing load on the supply (positive) side\r\n  const pathPoints = dataPoints.map((d, i) => {\r\n    const x = margin.left + i * xStep;\r\n    const y = zeroLineY - d.load * yScale; // Positive values go up from zero line\r\n    return `${i === 0 ? 'M' : 'L'} ${x},${y}`;\r\n  }).join(' ');\r\n\r\n  return `<path d=\"${pathPoints}\" fill=\"none\" stroke=\"#CCCCCC\" stroke-width=\"3\" opacity=\"0.9\" />`;\r\n}\r\n","import { createGridLines, createTimeLabels, createYAxisLabels, createAreaPath, createLoadLine } from '../chart/chart-utils';\r\nimport { handleAction } from '../utils/helpers';\r\n\r\nexport interface ChartConfig {\r\n  production_entity: string;\r\n  grid_entity: string;\r\n  load_entity: string;\r\n  battery_entity: string;\r\n  invert_battery_data?: boolean;\r\n  production_icon?: string;\r\n  grid_icon?: string;\r\n  load_icon?: string;\r\n  battery_icon?: string;\r\n  production_tap_action?: any;\r\n  grid_tap_action?: any;\r\n  load_tap_action?: any;\r\n  battery_tap_action?: any;\r\n}\r\n\r\nexport interface DataPoint {\r\n  time: Date;\r\n  solar: number;\r\n  batteryDischarge: number;\r\n  batteryCharge: number;\r\n  gridImport: number;\r\n  gridExport: number;\r\n  load: number;\r\n}\r\n\r\nexport interface LiveChartValues {\r\n  grid: number;\r\n  load: number;\r\n  production: number;\r\n  battery: number;\r\n}\r\n\r\nexport interface ChartDataCache {\r\n  timestamp: number;\r\n  dataPoints: DataPoint[];\r\n}\r\n\r\n/**\r\n * ChartRenderer handles all chart mode rendering logic.\r\n * Responsibilities:\r\n * - Fetch and process historical data\r\n * - Render stacked area charts with proper scaling\r\n * - Extract and render icons from Home Assistant\r\n * - Update chart indicators with live values\r\n * - Handle click interactions on chart elements\r\n */\r\nexport class ChartRenderer {\r\n  private hass: any;\r\n  private config: ChartConfig;\r\n  private fireEvent: (type: string, detail?: any) => void;\r\n  private iconCache: Map<string, string> = new Map();\r\n  private chartDataCache?: ChartDataCache;\r\n  private chartRenderPending = false;\r\n  private indicatorUpdateTimeout?: number;\r\n  private lastIndicatorUpdate = 0;\r\n  private liveChartValues?: LiveChartValues;\r\n\r\n  constructor(hass: any, config: ChartConfig, fireEvent: (type: string, detail?: any) => void) {\r\n    this.hass = hass;\r\n    this.config = config;\r\n    this.fireEvent = fireEvent;\r\n  }\r\n\r\n  /**\r\n   * Update live chart values for indicators\r\n   */\r\n  updateLiveValues(values: LiveChartValues): void {\r\n    this.liveChartValues = values;\r\n  }\r\n\r\n  /**\r\n   * Render chart view (main entry point)\r\n   */\r\n  render(container: HTMLElement): void {\r\n    // Initialize chart structure if needed\r\n    if (!container.querySelector('.chart-view')) {\r\n      this.initializeChartStructure(container);\r\n    } else if (this.liveChartValues) {\r\n      // Update live values for indicators\r\n      this.throttledUpdateChartIndicators(container);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initialize chart HTML structure\r\n   */\r\n  private initializeChartStructure(container: HTMLElement): void {\r\n    container.innerHTML = `\r\n      <ha-card>\r\n        <style>\r\n          :host {\r\n            display: block;\r\n            width: 100%;\r\n            height: 100%;\r\n          }\r\n          ha-card {\r\n            padding: 0;\r\n            box-sizing: border-box;\r\n            width: 100%;\r\n            height: 100%;\r\n            display: flex;\r\n            flex-direction: column;\r\n          }\r\n          .chart-view {\r\n            display: flex;\r\n            flex-direction: column;\r\n            width: 100%;\r\n            flex: 1;\r\n            min-height: 0;\r\n          }\r\n          .chart-container {\r\n            flex: 1;\r\n            position: relative;\r\n            min-height: 200px;\r\n            overflow: hidden;\r\n          }\r\n          svg.chart-svg {\r\n            width: 100%;\r\n            height: 100%;\r\n          }\r\n          .loading-message {\r\n            position: absolute;\r\n            top: 50%;\r\n            left: 50%;\r\n            transform: translate(-50%, -50%);\r\n            color: rgb(160, 160, 160);\r\n            font-size: 14px;\r\n          }\r\n        </style>\r\n        <div class=\"chart-view\">\r\n          <div class=\"chart-container\">\r\n            <div class=\"loading-message\">Loading history data...</div>\r\n            <svg class=\"chart-svg\" viewBox=\"0 0 800 400\" preserveAspectRatio=\"xMidYMid meet\">\r\n              <!-- Chart will be rendered here -->\r\n            </svg>\r\n          </div>\r\n        </div>\r\n      </ha-card>\r\n    `;\r\n\r\n    // Fetch and render chart data\r\n    const svg = container.querySelector('.chart-svg');\r\n    if (svg) {\r\n      setTimeout(() => {\r\n        this.fetchAndRenderChart(svg, 12);\r\n      }, 100);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Throttle chart indicator updates\r\n   */\r\n  private throttledUpdateChartIndicators(container: HTMLElement): void {\r\n    if (this.indicatorUpdateTimeout) {\r\n      clearTimeout(this.indicatorUpdateTimeout);\r\n      this.indicatorUpdateTimeout = undefined;\r\n    }\r\n\r\n    const now = Date.now();\r\n    const timeSinceLastUpdate = now - this.lastIndicatorUpdate;\r\n    const minUpdateInterval = 250;\r\n\r\n    if (timeSinceLastUpdate >= minUpdateInterval) {\r\n      const svg = container.querySelector('.chart-svg');\r\n      if (svg) this.updateChartIndicators(svg);\r\n      this.lastIndicatorUpdate = now;\r\n    } else {\r\n      const delay = minUpdateInterval - timeSinceLastUpdate;\r\n      this.indicatorUpdateTimeout = window.setTimeout(() => {\r\n        const svg = container.querySelector('.chart-svg');\r\n        if (svg) this.updateChartIndicators(svg);\r\n        this.lastIndicatorUpdate = Date.now();\r\n        this.indicatorUpdateTimeout = undefined;\r\n      }, delay);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cleanup resources\r\n   */\r\n  cleanup(): void {\r\n    if (this.indicatorUpdateTimeout) {\r\n      clearTimeout(this.indicatorUpdateTimeout);\r\n      this.indicatorUpdateTimeout = undefined;\r\n    }\r\n    this.chartDataCache = undefined;\r\n  }\r\n\r\n  /** Hide the loading overlay once data is ready or on error */\r\n  private hideLoading(svgElement: Element): void {\r\n    const container = svgElement.parentElement;\r\n    const loading = container?.querySelector('.loading-message') as HTMLElement | null;\r\n    if (loading) {\r\n      loading.style.display = 'none';\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get icon name from config or use default\r\n   */\r\n  private getIcon(iconConfigKey: string, entityConfigKey: string, fallback: string): string {\r\n    const configIcon = (this.config as any)[iconConfigKey];\r\n    if (configIcon) return configIcon;\r\n\r\n    const entityId = (this.config as any)[entityConfigKey];\r\n    if (entityId && this.hass.states[entityId]) {\r\n      const entityIcon = this.hass.states[entityId].attributes.icon;\r\n      if (entityIcon) return entityIcon;\r\n    }\r\n\r\n    return fallback;\r\n  }\r\n\r\n  /**\r\n   * Fetch and render chart, using cache if available\r\n   */\r\n  async fetchAndRenderChart(svgElement: Element, hoursToShow = 12): Promise<void> {\r\n    if (this.chartRenderPending) return;\r\n\r\n    const now = Date.now();\r\n    const cacheAge = this.chartDataCache ? now - this.chartDataCache.timestamp : Infinity;\r\n    const cacheMaxAge = 5 * 60 * 1000; // 5 minutes\r\n\r\n    // Clear expired cache\r\n    if (this.chartDataCache && cacheAge >= cacheMaxAge) {\r\n      this.chartDataCache = undefined;\r\n    }\r\n\r\n    // Use cached data if fresh\r\n    if (this.chartDataCache && cacheAge < cacheMaxAge) {\r\n      requestAnimationFrame(() => {\r\n        this.renderChartFromCache(svgElement);\r\n      });\r\n      return;\r\n    }\r\n\r\n    this.chartRenderPending = true;\r\n    const end = new Date();\r\n    const start = new Date(end.getTime() - hoursToShow * 60 * 60 * 1000);\r\n\r\n    try {\r\n      // Fetch history for all entities in parallel\r\n      const [productionHistory, gridHistory, loadHistory, batteryHistory] = await Promise.all([\r\n        this.fetchHistory(this.config.production_entity, start, end),\r\n        this.fetchHistory(this.config.grid_entity, start, end),\r\n        this.fetchHistory(this.config.load_entity, start, end),\r\n        this.fetchHistory(this.config.battery_entity, start, end),\r\n      ]);\r\n\r\n      // Process chart\r\n      const processChart = () => {\r\n        this.drawStackedAreaChart(svgElement, productionHistory, gridHistory, loadHistory, batteryHistory, hoursToShow);\r\n        this.chartRenderPending = false;\r\n      };\r\n\r\n      if ('requestIdleCallback' in window) {\r\n        (window as any).requestIdleCallback(processChart, { timeout: 2000 });\r\n      } else {\r\n        setTimeout(processChart, 0);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error fetching chart data:', error);\r\n      this.chartRenderPending = false;\r\n      svgElement.innerHTML = `\r\n        <text x=\"400\" y=\"200\" text-anchor=\"middle\" fill=\"rgb(160, 160, 160)\" font-size=\"14\">\r\n          Error loading chart data\r\n        </text>\r\n      `;\r\n      this.hideLoading(svgElement);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Fetch history from Home Assistant\r\n   */\r\n  private async fetchHistory(entityId: string, start: Date, end: Date): Promise<Array<{ state: string; last_changed: string }>> {\r\n    const url = `history/period/${start.toISOString()}?filter_entity_id=${entityId}&end_time=${end.toISOString()}&minimal_response&no_attributes`;\r\n    \r\n    const response = await this.hass.callApi('GET', url);\r\n    return response && response.length > 0 ? response[0] : [];\r\n  }\r\n\r\n  /**\r\n   * Render chart from cached data\r\n   */\r\n  renderChartFromCache(svgElement: Element): void {\r\n    if (!this.chartDataCache) return;\r\n\r\n    const dataPoints = this.chartDataCache.dataPoints;\r\n    \r\n    // Calculate scaling\r\n    const maxSupply = Math.max(...dataPoints.map(d => d.solar + d.batteryDischarge + d.gridImport), ...dataPoints.map(d => d.load));\r\n    const maxDemand = Math.max(...dataPoints.map(d => d.batteryCharge + d.gridExport));\r\n    const totalRange = maxSupply + maxDemand;\r\n    const supplyRatio = totalRange > 0 ? maxSupply / totalRange : 0.5;\r\n    const demandRatio = totalRange > 0 ? maxDemand / totalRange : 0.5;\r\n\r\n    const width = 800;\r\n    const height = 400;\r\n    const margin = { top: 20, right: 150, bottom: 40, left: 60 };\r\n    const chartWidth = width - margin.left - margin.right;\r\n    const chartHeight = height - margin.top - margin.bottom;\r\n\r\n    const supplyHeight = chartHeight * supplyRatio;\r\n    const demandHeight = chartHeight * demandRatio;\r\n    \r\n    const supplyScale = maxSupply > 0 ? supplyHeight / (maxSupply * 1.1) : 1;\r\n    const demandScale = maxDemand > 0 ? demandHeight / (maxDemand * 1.1) : 1;\r\n    const zeroLineY = margin.top + supplyHeight;\r\n\r\n    // Render chart paths\r\n    const supplyPaths = this.createStackedPaths(dataPoints, chartWidth, supplyHeight, supplyScale, margin, 'supply', zeroLineY);\r\n    const demandPaths = this.createStackedPaths(dataPoints, chartWidth, demandHeight, demandScale, margin, 'demand', zeroLineY);\r\n    const loadLine = createLoadLine(dataPoints, chartWidth, supplyHeight, supplyScale, margin, zeroLineY);\r\n\r\n    const chartContent = `\r\n      <g opacity=\"0.1\">\r\n        ${createGridLines(chartWidth, chartHeight, margin)}\r\n      </g>\r\n      <line x1=\"${margin.left}\" y1=\"${zeroLineY}\" x2=\"${margin.left + chartWidth}\" y2=\"${zeroLineY}\" stroke=\"rgb(160, 160, 160)\" stroke-width=\"1\" stroke-dasharray=\"4,4\" />\r\n      ${demandPaths}\r\n      ${supplyPaths}\r\n      ${createTimeLabels(chartWidth, chartHeight, margin, 12)}\r\n      ${createYAxisLabels(supplyHeight, demandHeight, margin, maxSupply, maxDemand, zeroLineY)}\r\n    `;\r\n\r\n    svgElement.innerHTML = chartContent;\r\n    \r\n    this.updateChartIndicators(svgElement);\r\n    this.addLoadLineOnTop(svgElement, loadLine);\r\n    this.hideLoading(svgElement);\r\n  }\r\n\r\n  /**\r\n   * Draw stacked area chart from history data\r\n   */\r\n  private async drawStackedAreaChart(\r\n    svgElement: Element,\r\n    productionHistory: Array<{ state: string; last_changed: string }>,\r\n    gridHistory: Array<{ state: string; last_changed: string }>,\r\n    loadHistory: Array<{ state: string; last_changed: string }>,\r\n    batteryHistory: Array<{ state: string; last_changed: string }>,\r\n    hoursToShow: number\r\n  ): Promise<void> {\r\n    const width = 800;\r\n    const height = 400;\r\n    const margin = { top: 20, right: 150, bottom: 40, left: 60 };\r\n    const chartWidth = width - margin.left - margin.right;\r\n    const chartHeight = height - margin.top - margin.bottom;\r\n\r\n    // Collect 30-second raw data, then average into 5-minute visible ticks\r\n    const rawPointsPerHour = 120;\r\n    const totalRawPoints = hoursToShow * rawPointsPerHour;\r\n    const visiblePointsPerHour = 12;\r\n    const totalVisiblePoints = hoursToShow * visiblePointsPerHour;\r\n    const rawPointsPerVisibleTick = 10;\r\n    \r\n    // Quantize to nearest 5-minute interval\r\n    const now = new Date();\r\n    const endMinutes = Math.floor(now.getMinutes() / 5) * 5;\r\n    const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours(), endMinutes, 0, 0);\r\n    const start = new Date(end.getTime() - hoursToShow * 60 * 60 * 1000);\r\n\r\n    // Process data in chunks\r\n    const chunkSize = 240;\r\n    const rawDataPoints: DataPoint[] = [];\r\n\r\n    for (let chunkStart = 0; chunkStart < totalRawPoints; chunkStart += chunkSize) {\r\n      const chunkEnd = Math.min(chunkStart + chunkSize, totalRawPoints);\r\n      \r\n      if (chunkStart > 0) {\r\n        await new Promise(resolve => setTimeout(resolve, 0));\r\n      }\r\n      \r\n      for (let i = chunkStart; i < chunkEnd; i++) {\r\n        const time = new Date(start.getTime() + i * 30 * 1000);\r\n        \r\n        const production = this.interpolateValue(productionHistory, time);\r\n        const grid = this.interpolateValue(gridHistory, time);\r\n        const load = this.interpolateValue(loadHistory, time);\r\n        let battery = this.interpolateValue(batteryHistory, time);\r\n        \r\n        if (this.config.invert_battery_data) {\r\n          battery = -battery;\r\n        }\r\n\r\n        rawDataPoints.push({\r\n          time,\r\n          solar: Math.max(0, production),\r\n          batteryDischarge: Math.max(0, battery),\r\n          batteryCharge: Math.max(0, -battery),\r\n          gridImport: Math.max(0, grid),\r\n          gridExport: Math.max(0, -grid),\r\n          load: Math.max(0, load),\r\n        });\r\n      }\r\n    }\r\n\r\n    // Average into 5-minute points\r\n    const dataPoints: DataPoint[] = [];\r\n\r\n    for (let i = 0; i < totalVisiblePoints; i++) {\r\n      const visibleTime = new Date(start.getTime() + (i + 1) * 5 * 60 * 1000);\r\n      const startIdx = i * rawPointsPerVisibleTick;\r\n      const endIdx = Math.min(startIdx + rawPointsPerVisibleTick, rawDataPoints.length);\r\n      const windowSize = endIdx - startIdx;\r\n      \r\n      let solarSum = 0, batteryDischargeSum = 0, batteryChargeSum = 0;\r\n      let gridImportSum = 0, gridExportSum = 0, loadSum = 0;\r\n      \r\n      for (let j = startIdx; j < endIdx; j++) {\r\n        solarSum += rawDataPoints[j].solar;\r\n        batteryDischargeSum += rawDataPoints[j].batteryDischarge;\r\n        batteryChargeSum += rawDataPoints[j].batteryCharge;\r\n        gridImportSum += rawDataPoints[j].gridImport;\r\n        gridExportSum += rawDataPoints[j].gridExport;\r\n        loadSum += rawDataPoints[j].load;\r\n      }\r\n\r\n      dataPoints.push({\r\n        time: visibleTime,\r\n        solar: solarSum / windowSize,\r\n        batteryDischarge: batteryDischargeSum / windowSize,\r\n        batteryCharge: batteryChargeSum / windowSize,\r\n        gridImport: gridImportSum / windowSize,\r\n        gridExport: gridExportSum / windowSize,\r\n        load: loadSum / windowSize,\r\n      });\r\n    }\r\n\r\n    // Cache processed data\r\n    this.chartDataCache = {\r\n      timestamp: Date.now(),\r\n      dataPoints\r\n    };\r\n\r\n    // Calculate scaling\r\n    const maxSupply = Math.max(...dataPoints.map(d => d.solar + d.batteryDischarge + d.gridImport), ...dataPoints.map(d => d.load));\r\n    const maxDemand = Math.max(...dataPoints.map(d => d.batteryCharge + d.gridExport));\r\n    \r\n    const totalRange = maxSupply + maxDemand;\r\n    const supplyRatio = totalRange > 0 ? maxSupply / totalRange : 0.5;\r\n    const demandRatio = totalRange > 0 ? maxDemand / totalRange : 0.5;\r\n    \r\n    const supplyScale = maxSupply > 0 ? (chartHeight * supplyRatio) / (maxSupply * 1.1) : 1;\r\n    const demandScale = maxDemand > 0 ? (chartHeight * demandRatio) / (maxDemand * 1.1) : 1;\r\n    const scale = Math.min(supplyScale, demandScale);\r\n    \r\n    const supplyHeight = maxSupply * scale * 1.1;\r\n    const demandHeight = maxDemand * scale * 1.1;\r\n    const zeroLineY = margin.top + supplyHeight;\r\n\r\n    // Create paths\r\n    const supplyPaths = this.createStackedPaths(dataPoints, chartWidth, supplyHeight, scale, margin, 'supply', zeroLineY);\r\n    const demandPaths = this.createStackedPaths(dataPoints, chartWidth, demandHeight, scale, margin, 'demand', zeroLineY);\r\n    const loadLine = createLoadLine(dataPoints, chartWidth, supplyHeight, scale, margin, zeroLineY);\r\n\r\n    // Build SVG content\r\n    const svgContent = `\r\n      <g opacity=\"0.1\">\r\n        ${createGridLines(chartWidth, chartHeight, margin)}\r\n      </g>\r\n      <line x1=\"${margin.left}\" y1=\"${zeroLineY}\" x2=\"${margin.left + chartWidth}\" y2=\"${zeroLineY}\" stroke=\"rgb(160, 160, 160)\" stroke-width=\"1\" stroke-dasharray=\"4,4\" />\r\n      ${demandPaths}\r\n      ${supplyPaths}\r\n      ${createTimeLabels(chartWidth, chartHeight, margin, hoursToShow)}\r\n      ${createYAxisLabels(supplyHeight, demandHeight, margin, maxSupply, maxDemand, zeroLineY)}\r\n      ${this.createChartIconSources()}\r\n    `;\r\n\r\n    svgElement.innerHTML = svgContent;\r\n    this.hideLoading(svgElement);\r\n    \r\n    // Add click handlers\r\n    this.attachChartAreaClickHandlers(svgElement);\r\n    \r\n    // Progressive rendering\r\n    requestAnimationFrame(() => {\r\n      requestAnimationFrame(() => {\r\n        requestAnimationFrame(() => {\r\n          this.extractChartIcons(svgElement, dataPoints, chartWidth, supplyHeight, demandHeight, scale, scale, margin, zeroLineY);\r\n          \r\n          requestAnimationFrame(() => {\r\n            this.addLoadLineOnTop(svgElement, loadLine);\r\n          });\r\n        });\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Interpolate value from history at specific time\r\n   */\r\n  private interpolateValue(history: Array<{ state: string; last_changed: string }>, targetTime: Date): number {\r\n    if (history.length === 0) return 0;\r\n\r\n    let closestPoint = history[0];\r\n    let minDiff = Math.abs(new Date(history[0].last_changed).getTime() - targetTime.getTime());\r\n\r\n    for (const point of history) {\r\n      const diff = Math.abs(new Date(point.last_changed).getTime() - targetTime.getTime());\r\n      if (diff < minDiff) {\r\n        minDiff = diff;\r\n        closestPoint = point;\r\n      }\r\n    }\r\n\r\n    return parseFloat(closestPoint.state) || 0;\r\n  }\r\n\r\n  /**\r\n   * Create stacked area paths for supply or demand\r\n   */\r\n  private createStackedPaths(\r\n    dataPoints: DataPoint[],\r\n    chartWidth: number,\r\n    chartHeight: number,\r\n    yScale: number,\r\n    margin: { top: number; right: number; bottom: number; left: number },\r\n    type: 'supply' | 'demand',\r\n    zeroLineY: number\r\n  ): string {\r\n    const totalPoints = dataPoints.length;\r\n    const xStep = chartWidth / (totalPoints - 1);\r\n\r\n    if (type === 'supply') {\r\n      const solarPath = createAreaPath(dataPoints, xStep, zeroLineY, yScale, margin, \r\n        d => d.solar, 0, 'down');\r\n      \r\n      const batteryPath = createAreaPath(dataPoints, xStep, zeroLineY, yScale, margin,\r\n        d => d.batteryDischarge, d => d.solar, 'down');\r\n      \r\n      const gridPath = createAreaPath(dataPoints, xStep, zeroLineY, yScale, margin,\r\n        d => d.gridImport, d => d.solar + d.batteryDischarge, 'down');\r\n\r\n      return `\r\n        ${gridPath ? `<path id=\"chart-area-grid-import\" d=\"${gridPath}\" fill=\"#c62828\" opacity=\"0.8\" style=\"cursor: pointer;\" />` : ''}\r\n        ${batteryPath ? `<path id=\"chart-area-battery-discharge\" d=\"${batteryPath}\" fill=\"#1976d2\" opacity=\"0.8\" style=\"cursor: pointer;\" />` : ''}\r\n        ${solarPath ? `<path id=\"chart-area-solar\" d=\"${solarPath}\" fill=\"#388e3c\" opacity=\"0.85\" style=\"cursor: pointer;\" />` : ''}\r\n      `;\r\n    } else {\r\n      const batteryChargePath = createAreaPath(dataPoints, xStep, zeroLineY, yScale, margin,\r\n        d => d.batteryCharge, 0, 'up');\r\n      \r\n      const gridExportPath = createAreaPath(dataPoints, xStep, zeroLineY, yScale, margin,\r\n        d => d.gridExport, d => d.batteryCharge, 'up');\r\n\r\n      return `\r\n        ${gridExportPath ? `<path id=\"chart-area-grid-export\" d=\"${gridExportPath}\" fill=\"#f9a825\" opacity=\"0.8\" style=\"cursor: pointer;\" />` : ''}\r\n        ${batteryChargePath ? `<path id=\"chart-area-battery-charge\" d=\"${batteryChargePath}\" fill=\"#1976d2\" opacity=\"0.8\" style=\"cursor: pointer;\" />` : ''}\r\n      `;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create hidden icon sources for extraction\r\n   */\r\n  private createChartIconSources(): string {\r\n    const loadIcon = this.getIcon('load_icon', 'load_entity', 'mdi:home-lightning-bolt');\r\n    const solarIcon = this.getIcon('production_icon', 'production_entity', 'mdi:solar-power');\r\n    const batteryIcon = this.getIcon('battery_icon', 'battery_entity', 'mdi:battery');\r\n    const gridIcon = this.getIcon('grid_icon', 'grid_entity', 'mdi:transmission-tower');\r\n\r\n    return `\r\n      <foreignObject id=\"chart-icon-source-load\" x=\"-100\" y=\"-100\" width=\"24\" height=\"24\">\r\n        <div xmlns=\"http://www.w3.org/1999/xhtml\">\r\n          <ha-icon icon=\"${loadIcon}\"></ha-icon>\r\n        </div>\r\n      </foreignObject>\r\n      <foreignObject id=\"chart-icon-source-solar\" x=\"-100\" y=\"-100\" width=\"24\" height=\"24\">\r\n        <div xmlns=\"http://www.w3.org/1999/xhtml\">\r\n          <ha-icon icon=\"${solarIcon}\"></ha-icon>\r\n        </div>\r\n      </foreignObject>\r\n      <foreignObject id=\"chart-icon-source-battery\" x=\"-100\" y=\"-100\" width=\"24\" height=\"24\">\r\n        <div xmlns=\"http://www.w3.org/1999/xhtml\">\r\n          <ha-icon icon=\"${batteryIcon}\"></ha-icon>\r\n        </div>\r\n      </foreignObject>\r\n      <foreignObject id=\"chart-icon-source-grid\" x=\"-100\" y=\"-100\" width=\"24\" height=\"24\">\r\n        <div xmlns=\"http://www.w3.org/1999/xhtml\">\r\n          <ha-icon icon=\"${gridIcon}\"></ha-icon>\r\n        </div>\r\n      </foreignObject>\r\n    `;\r\n  }\r\n\r\n  /**\r\n   * Extract icon paths from Home Assistant icons\r\n   */\r\n  private async extractChartIcons(\r\n    svgElement: Element,\r\n    dataPoints: DataPoint[],\r\n    chartWidth: number,\r\n    supplyHeight: number,\r\n    demandHeight: number,\r\n    supplyScale: number,\r\n    demandScale: number,\r\n    margin: { top: number; right: number; bottom: number; left: number },\r\n    zeroLineY: number\r\n  ): Promise<void> {\r\n    if (dataPoints.length === 0) return;\r\n\r\n    const iconTypes = ['load', 'solar', 'battery', 'grid'];\r\n    const iconPaths: { [key: string]: string | null } = {};\r\n\r\n    for (const type of iconTypes) {\r\n      const iconSourceFO = svgElement.querySelector(`#chart-icon-source-${type}`);\r\n      if (!iconSourceFO) continue;\r\n\r\n      const haIconDiv = iconSourceFO.querySelector('div');\r\n      if (!haIconDiv) continue;\r\n\r\n      const iconSource = haIconDiv.querySelector('ha-icon');\r\n      if (!iconSource) continue;\r\n\r\n      const iconName = iconSource.getAttribute('icon');\r\n      if (!iconName) continue;\r\n\r\n      if (this.iconCache.has(iconName)) {\r\n        iconPaths[type] = this.iconCache.get(iconName) || null;\r\n        continue;\r\n      }\r\n\r\n      const pathData = await this.extractIconPath(iconSource, iconName);\r\n      iconPaths[type] = pathData;\r\n      if (pathData) {\r\n        this.iconCache.set(iconName, pathData);\r\n      }\r\n    }\r\n\r\n    this.renderChartIndicators(svgElement, dataPoints, chartWidth, supplyHeight, demandHeight, supplyScale, demandScale, margin, iconPaths, zeroLineY);\r\n  }\r\n\r\n  /**\r\n   * Extract single icon path from shadow DOM\r\n   */\r\n  private async extractIconPath(iconElement: Element, iconName: string, maxAttempts = 10): Promise<string | null> {\r\n    for (let attempt = 0; attempt < maxAttempts; attempt++) {\r\n      try {\r\n        const shadowRoot = iconElement.shadowRoot;\r\n        if (!shadowRoot) {\r\n          await new Promise(resolve => setTimeout(resolve, 100));\r\n          continue;\r\n        }\r\n\r\n        let svgElement = shadowRoot.querySelector('svg');\r\n        \r\n        if (!svgElement) {\r\n          const haSvgIcon = shadowRoot.querySelector('ha-svg-icon');\r\n          if (haSvgIcon && haSvgIcon.shadowRoot) {\r\n            svgElement = haSvgIcon.shadowRoot.querySelector('svg');\r\n          }\r\n        }\r\n\r\n        if (!svgElement) {\r\n          await new Promise(resolve => setTimeout(resolve, 100));\r\n          continue;\r\n        }\r\n\r\n        const pathElement = svgElement.querySelector('path');\r\n        if (!pathElement) {\r\n          await new Promise(resolve => setTimeout(resolve, 100));\r\n          continue;\r\n        }\r\n\r\n        const pathData = pathElement.getAttribute('d');\r\n        if (pathData) {\r\n          return pathData;\r\n        }\r\n      } catch (e) {\r\n        console.error(`Failed to extract icon path for ${iconName} (attempt ${attempt + 1}):`, e);\r\n      }\r\n      \r\n      await new Promise(resolve => setTimeout(resolve, 100));\r\n    }\r\n    \r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Render chart indicators with native SVG\r\n   */\r\n  private renderChartIndicators(\r\n    svgElement: Element,\r\n    dataPoints: DataPoint[],\r\n    chartWidth: number,\r\n    supplyHeight: number,\r\n    demandHeight: number,\r\n    supplyScale: number,\r\n    demandScale: number,\r\n    margin: { top: number; right: number; bottom: number; left: number },\r\n    iconPaths: { [key: string]: string | null },\r\n    zeroLineY: number\r\n  ): void {\r\n    let indicatorsGroup = svgElement.querySelector('#chart-indicators') as SVGGElement | null;\r\n    const isFirstRender = !indicatorsGroup;\r\n    \r\n    if (!indicatorsGroup) {\r\n      indicatorsGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');\r\n      indicatorsGroup.setAttribute('id', 'chart-indicators');\r\n      svgElement.appendChild(indicatorsGroup);\r\n    }\r\n\r\n    if (isFirstRender) {\r\n      const iconSources = svgElement.querySelectorAll('[id^=\"chart-icon-source-\"]');\r\n      iconSources.forEach(source => source.remove());\r\n    }\r\n\r\n    // Use live values or last historical point\r\n    let currentValues;\r\n    if (this.liveChartValues) {\r\n      const { grid, load, production, battery } = this.liveChartValues;\r\n      currentValues = {\r\n        load: Math.max(0, load),\r\n        solar: Math.max(0, production),\r\n        batteryDischarge: Math.max(0, battery),\r\n        batteryCharge: Math.max(0, -battery),\r\n        gridImport: Math.max(0, grid),\r\n        gridExport: Math.max(0, -grid),\r\n      };\r\n    } else {\r\n      currentValues = dataPoints[dataPoints.length - 1];\r\n    }\r\n\r\n    const rightX = margin.left + chartWidth;\r\n\r\n    // Calculate Y positions\r\n    const loadY = zeroLineY - currentValues.load * supplyScale;\r\n    const solarY = zeroLineY - currentValues.solar * supplyScale;\r\n    const batteryDischargeY = zeroLineY - (currentValues.solar + currentValues.batteryDischarge) * supplyScale;\r\n    const gridImportY = zeroLineY - (currentValues.solar + currentValues.batteryDischarge + currentValues.gridImport) * supplyScale;\r\n    const batteryChargeY = zeroLineY + currentValues.batteryCharge * demandScale;\r\n    const gridExportY = zeroLineY + (currentValues.batteryCharge + currentValues.gridExport) * demandScale;\r\n\r\n    const formatValue = (value: number): string => {\r\n      return `${Math.round(value)} W`;\r\n    };\r\n\r\n    const updateIndicator = (id: string, y: number, color: string, iconType: string, value: string, prefix = '', shouldShow = true, entity?: string, tapAction?: any) => {\r\n      let group = indicatorsGroup!.querySelector(`#${id}`) as SVGGElement | null;\r\n      \r\n      if (!shouldShow) {\r\n        if (group) group.remove();\r\n        return;\r\n      }\r\n      \r\n      if (!group) {\r\n        group = document.createElementNS('http://www.w3.org/2000/svg', 'g');\r\n        group.setAttribute('id', id);\r\n        group.style.cursor = 'pointer';\r\n        \r\n        const iconPath = iconPaths[iconType];\r\n        if (iconPath) {\r\n          const icon = document.createElementNS('http://www.w3.org/2000/svg', 'g');\r\n          icon.setAttribute('class', 'indicator-icon');\r\n          icon.setAttribute('transform', 'translate(10, -8) scale(0.67)');\r\n          \r\n          const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');\r\n          path.setAttribute('d', iconPath);\r\n          path.setAttribute('fill', color);\r\n          icon.appendChild(path);\r\n          \r\n          group.appendChild(icon);\r\n        }\r\n\r\n        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');\r\n        text.setAttribute('class', 'indicator-text');\r\n        text.setAttribute('x', '28');\r\n        text.setAttribute('y', '4');\r\n        text.setAttribute('fill', color);\r\n        text.setAttribute('font-size', '12');\r\n        text.setAttribute('font-weight', '600');\r\n        group.appendChild(text);\r\n        \r\n        if (entity && tapAction) {\r\n          group.addEventListener('click', () => {\r\n            handleAction(this.hass, this.fireEvent, tapAction, entity);\r\n          });\r\n        }\r\n        \r\n        indicatorsGroup!.appendChild(group);\r\n      }\r\n      \r\n      group.setAttribute('transform', `translate(${rightX + 10}, ${y})`);\r\n      \r\n      const text = group.querySelector('.indicator-text');\r\n      if (text) {\r\n        text.textContent = `${prefix}${value}`;\r\n      }\r\n    };\r\n\r\n    // Update all indicators\r\n    updateIndicator('indicator-solar', solarY, '#388e3c', 'solar', formatValue(currentValues.solar), '', currentValues.solar > 0, this.config.production_entity, this.config.production_tap_action);\r\n    updateIndicator('indicator-battery-discharge', batteryDischargeY, '#1976d2', 'battery', formatValue(currentValues.batteryDischarge), '+', currentValues.batteryDischarge > 0, this.config.battery_entity, this.config.battery_tap_action);\r\n    updateIndicator('indicator-grid-import', gridImportY, '#c62828', 'grid', formatValue(currentValues.gridImport), '', currentValues.gridImport > 0, this.config.grid_entity, this.config.grid_tap_action);\r\n    updateIndicator('indicator-battery-charge', batteryChargeY, '#1976d2', 'battery', formatValue(currentValues.batteryCharge), '-', currentValues.batteryCharge > 0, this.config.battery_entity, this.config.battery_tap_action);\r\n    updateIndicator('indicator-grid-export', gridExportY, '#f9a825', 'grid', formatValue(currentValues.gridExport), '', currentValues.gridExport > 0, this.config.grid_entity, this.config.grid_tap_action);\r\n    updateIndicator('indicator-load', loadY, '#CCCCCC', 'load', formatValue(currentValues.load), '', true, this.config.load_entity, this.config.load_tap_action);\r\n  }\r\n\r\n  /**\r\n   * Update chart indicators with throttling\r\n   */\r\n  updateChartIndicators(svgElement: Element): void {\r\n    if (!this.chartDataCache || !svgElement) return;\r\n\r\n    const dataPoints = this.chartDataCache.dataPoints;\r\n    const maxSupply = Math.max(...dataPoints.map(d => d.solar + d.batteryDischarge + d.gridImport), ...dataPoints.map(d => d.load));\r\n    const maxDemand = Math.max(...dataPoints.map(d => d.batteryCharge + d.gridExport));\r\n    \r\n    const totalRange = maxSupply + maxDemand;\r\n    const supplyRatio = totalRange > 0 ? maxSupply / totalRange : 0.5;\r\n    const demandRatio = totalRange > 0 ? maxDemand / totalRange : 0.5;\r\n\r\n    const width = 800;\r\n    const height = 400;\r\n    const margin = { top: 20, right: 150, bottom: 40, left: 60 };\r\n    const chartWidth = width - margin.left - margin.right;\r\n    const chartHeight = height - margin.top - margin.bottom;\r\n\r\n    const supplyHeight = chartHeight * supplyRatio;\r\n    const demandHeight = chartHeight * demandRatio;\r\n    \r\n    const supplyScale = maxSupply > 0 ? supplyHeight / (maxSupply * 1.1) : 1;\r\n    const demandScale = maxDemand > 0 ? demandHeight / (maxDemand * 1.1) : 1;\r\n    const zeroLineY = margin.top + supplyHeight;\r\n\r\n    // Get cached icon paths\r\n    const iconPaths: { [key: string]: string | null } = {};\r\n    ['load', 'solar', 'battery', 'grid'].forEach(type => {\r\n      const iconName = this.getIcon(`${type}_icon`, `${type}_entity`, '');\r\n      if (this.iconCache.has(iconName)) {\r\n        iconPaths[type] = this.iconCache.get(iconName) || null;\r\n      }\r\n    });\r\n\r\n    this.renderChartIndicators(svgElement, dataPoints, chartWidth, supplyHeight, demandHeight, supplyScale, demandScale, margin, iconPaths, zeroLineY);\r\n  }\r\n\r\n  /**\r\n   * Add load line on top of chart\r\n   */\r\n  private addLoadLineOnTop(svgElement: Element, loadLine: string): void {\r\n    if (!loadLine) return;\r\n    \r\n    const existingLoadLine = svgElement.querySelector('#load-line');\r\n    if (existingLoadLine) {\r\n      existingLoadLine.remove();\r\n    }\r\n    \r\n    const pathMatch = loadLine.match(/d=\"([^\"]+)\"/);\r\n    if (!pathMatch) return;\r\n    \r\n    const pathData = pathMatch[1];\r\n    \r\n    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');\r\n    path.setAttribute('id', 'load-line');\r\n    path.setAttribute('d', pathData);\r\n    path.setAttribute('fill', 'none');\r\n    path.setAttribute('stroke', '#CCCCCC');\r\n    path.setAttribute('stroke-width', '3');\r\n    path.setAttribute('opacity', '0.9');\r\n    path.style.cursor = 'pointer';\r\n    \r\n    path.addEventListener('click', () => {\r\n      handleAction(this.hass, this.fireEvent, this.config.load_tap_action, this.config.load_entity);\r\n    });\r\n    \r\n    svgElement.appendChild(path);\r\n  }\r\n\r\n  /**\r\n   * Attach click handlers to chart areas\r\n   */\r\n  private attachChartAreaClickHandlers(svgElement: Element): void {\r\n    const solarArea = svgElement.querySelector('#chart-area-solar');\r\n    if (solarArea) {\r\n      solarArea.addEventListener('click', () => {\r\n        handleAction(this.hass, this.fireEvent, this.config.production_tap_action, this.config.production_entity);\r\n      });\r\n    }\r\n    \r\n    const batteryDischargeArea = svgElement.querySelector('#chart-area-battery-discharge');\r\n    if (batteryDischargeArea) {\r\n      batteryDischargeArea.addEventListener('click', () => {\r\n        handleAction(this.hass, this.fireEvent, this.config.battery_tap_action, this.config.battery_entity);\r\n      });\r\n    }\r\n    \r\n    const batteryChargeArea = svgElement.querySelector('#chart-area-battery-charge');\r\n    if (batteryChargeArea) {\r\n      batteryChargeArea.addEventListener('click', () => {\r\n        handleAction(this.hass, this.fireEvent, this.config.battery_tap_action, this.config.battery_entity);\r\n      });\r\n    }\r\n    \r\n    const gridImportArea = svgElement.querySelector('#chart-area-grid-import');\r\n    if (gridImportArea) {\r\n      gridImportArea.addEventListener('click', () => {\r\n        handleAction(this.hass, this.fireEvent, this.config.grid_tap_action, this.config.grid_entity);\r\n      });\r\n    }\r\n    \r\n    const gridExportArea = svgElement.querySelector('#chart-area-grid-export');\r\n    if (gridExportArea) {\r\n      gridExportArea.addEventListener('click', () => {\r\n        handleAction(this.hass, this.fireEvent, this.config.grid_tap_action, this.config.grid_entity);\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear cache (e.g., when data becomes stale)\r\n   */\r\n  clearCache(): void {\r\n    this.chartDataCache = undefined;\r\n  }\r\n}\r\n","import { calculateEnergyFlows } from './flow-calculator';\r\nimport { getConfigForm, normalizeConfig } from './Config';\r\nimport { getDisplayName, getIcon, handleAction } from './utils/helpers';\r\nimport type { EnergyFlowCardConfig } from './types/Config.d.ts';\r\nimport type { HomeAssistant } from './types/HASS.d.ts';\r\nimport { CompactRenderer } from './renderers/CompactRenderer';\r\nimport type { CompactViewMode } from './renderers/CompactRenderer';\r\nimport { DefaultRenderer } from './renderers/DefaultRenderer';\r\nimport { ChartRenderer } from './renderers/ChartRenderer';\r\n\r\n// Main card class\r\nclass EnergyFlowCard extends HTMLElement {\r\n  private _resizeObserver: ResizeObserver | null;\r\n  private _config?: EnergyFlowCardConfig;\r\n  private _hass?: HomeAssistant;\r\n  private _lastViewMode?: string;\r\n  private _compactRenderer?: CompactRenderer;\r\n  private _defaultRenderer?: DefaultRenderer;\r\n  private _chartRenderer?: ChartRenderer;\r\n\r\n  constructor() {\r\n    super();\r\n    this._resizeObserver = null;\r\n  }\r\n\r\n  static getStubConfig() {\r\n    return {};\r\n  }\r\n\r\n  static getConfigForm() {\r\n    return getConfigForm();\r\n  }\r\n\r\n  connectedCallback() {\r\n    // Set up resize observer to redraw flows when card is resized\r\n    this._resizeObserver = new ResizeObserver(() => {\r\n      // Renderers handle their own resize logic\r\n    });\r\n    \r\n    // Observe the container, not the card itself\r\n    if (this.parentElement) {\r\n      this._resizeObserver.observe(this.parentElement);\r\n    }\r\n    this._resizeObserver.observe(this);\r\n    \r\n    // Animation loop will be started on first render to avoid race conditions\r\n  }\r\n\r\n  disconnectedCallback() {\r\n    if (this._resizeObserver) {\r\n      this._resizeObserver.disconnect();\r\n      this._resizeObserver = null;\r\n    }\r\n    \r\n    // Stop renderers\r\n    if (this._defaultRenderer) {\r\n      this._defaultRenderer.stop();\r\n    }\r\n    if (this._chartRenderer) {\r\n      this._chartRenderer.cleanup();\r\n    }\r\n  }\r\n\r\n  setConfig(config: EnergyFlowCardConfig): void {\r\n    this._config = normalizeConfig(config);\r\n    this._renderSafely('setConfig');\r\n  }\r\n\r\n  set hass(hass: HomeAssistant) {\r\n    this._hass = hass;\r\n    this._renderSafely('hass update');\r\n  }\r\n\r\n  private _renderSafely(context: string) {\r\n    try {\r\n      this._render();\r\n    } catch (error) {\r\n      console.error('[EnergyFlowCard] render failed during', context, error);\r\n      this.innerHTML = `\r\n        <ha-card>\r\n          <div style=\"padding:16px;\">\r\n            Energy Flow Card failed to render. Check browser console for details.\r\n          </div>\r\n        </ha-card>\r\n      `;\r\n    }\r\n  }\r\n\r\n  _render() {\r\n    if (!this._config || !this._hass) return;\r\n    if (!this._config.load) return; // Load entity is required\r\n\r\n    const gridState = this._getEntityState(this._config.grid?.entity);\r\n    const loadState = this._getEntityState(this._config.load.entity);\r\n    const productionState = this._getEntityState(this._config.production?.entity);\r\n    const batteryState = this._getEntityState(this._config.battery?.entity);\r\n\r\n    // Calculate flow directions and magnitudes\r\n    const grid = parseFloat(gridState?.state ?? '0') || 0;\r\n    const load = parseFloat(loadState?.state ?? '0') || 0;\r\n    const production = parseFloat(productionState?.state ?? '0') || 0;\r\n    let battery = parseFloat(batteryState?.state ?? '0') || 0;\r\n    \r\n    // Invert battery data if configured (affects interpretation)\r\n    if (this._config.battery?.invert?.data) {\r\n      battery = -battery;\r\n    }\r\n\r\n    // Check view mode\r\n    const viewMode = this._config.mode || 'default';\r\n    \r\n    // Clean up chart cache if switching away from chart view\r\n    if (this._lastViewMode === 'chart' && viewMode !== 'chart' && this._chartRenderer) {\r\n      this._chartRenderer.cleanup();\r\n    }\r\n    \r\n    if (viewMode === 'compact' || viewMode === 'compact-battery') {\r\n      this._renderCompactView(grid, load, production, battery, viewMode as CompactViewMode);\r\n      this._lastViewMode = viewMode;\r\n      return;\r\n    }\r\n    if (viewMode === 'chart') {\r\n      // Initialize ChartRenderer if needed\r\n      if (!this._chartRenderer) {\r\n        const chartConfig = {\r\n          production_entity: this._config.production?.entity || '',\r\n          grid_entity: this._config.grid?.entity || '',\r\n          load_entity: this._config.load.entity,\r\n          battery_entity: this._config.battery?.entity || '',\r\n          invert_battery_data: this._config.battery?.invert?.data,\r\n          production_icon: this._config.production?.icon,\r\n          grid_icon: this._config.grid?.icon,\r\n          load_icon: this._config.load.icon,\r\n          battery_icon: this._config.battery?.icon,\r\n          production_tap_action: this._config.production?.tap,\r\n          grid_tap_action: this._config.grid?.tap,\r\n          load_tap_action: this._config.load.tap,\r\n          battery_tap_action: this._config.battery?.tap\r\n        };\r\n        this._chartRenderer = new ChartRenderer(this._hass, chartConfig, this._fireEvent.bind(this));\r\n      }\r\n      \r\n      // Update live values and render\r\n      this._chartRenderer.updateLiveValues({ grid, load, production, battery });\r\n      this._chartRenderer.render(this);\r\n      this._lastViewMode = viewMode;\r\n      return;\r\n    }\r\n\r\n    // Initialize DefaultRenderer if needed\r\n    if (!this._defaultRenderer) {\r\n      this._defaultRenderer = new DefaultRenderer(\r\n        this,\r\n        this._config,\r\n        this._hass,\r\n        (type, fallback) => getDisplayName(this._config!, this._hass, type, fallback),\r\n        (type, fallback) => getIcon(this._config!, this._hass, type, fallback),\r\n        this._fireEvent.bind(this)\r\n      );\r\n    }\r\n    \r\n    // Calculate flows and render\r\n    const flows = this._calculateFlows(grid, production, load, battery);\r\n    this._defaultRenderer.render({ grid, load, production, battery, flows });\r\n\r\n    this._lastViewMode = viewMode;\r\n  }\r\n\r\n  private _getEntityState(entityId: string | undefined) {\r\n    if (!entityId) return undefined;\r\n    return this._hass?.states?.[entityId];\r\n  }\r\n\r\n  private _fireEvent(type: string, detail: any = {}): void {\r\n    // Handle call-service events specially\r\n    if (type === 'call-service' && this._hass) {\r\n      this._hass.callService(detail.domain, detail.service, detail.service_data || {}, detail.target);\r\n      return;\r\n    }\r\n    \r\n    const event = new CustomEvent(type, {\r\n      detail,\r\n      bubbles: true,\r\n      composed: true\r\n    });\r\n    this.dispatchEvent(event);\r\n  }\r\n\r\n  /**\r\n   * Calculate energy flows between meters based on sensor readings.\r\n   * Uses the tested calculateEnergyFlows function.\r\n   */\r\n  private _calculateFlows(grid: number, production: number, load: number, battery: number) {\r\n    return calculateEnergyFlows({ grid, production, load, battery });\r\n  }\r\n\r\n  private _renderCompactView(grid: number, load: number, production: number, battery: number, viewMode: CompactViewMode): void {\r\n    if (!this._config || !this._hass) return;\r\n\r\n    // Initialize CompactRenderer if needed\r\n    if (!this._compactRenderer) {\r\n      this._compactRenderer = new CompactRenderer(\r\n        this,\r\n        this._config,\r\n        this._hass,\r\n        viewMode,\r\n        (type, fallback) => getIcon(this._config!, this._hass, type, fallback),\r\n        (action, entity) => handleAction(this._hass as HomeAssistant, this._fireEvent.bind(this), action, entity)\r\n      );\r\n    } else {\r\n      this._compactRenderer.setViewMode(viewMode);\r\n    }\r\n\r\n    // Use the same flow calculator to get accurate contributions to load\r\n    const flows = this._calculateFlows(grid, production, load, battery);\r\n\r\n    // Get battery SOC if available\r\n    let batterySoc: number | null = null;\r\n    if (this._config.battery?.soc_entity) {\r\n      const socState = this._getEntityState(this._config.battery.soc_entity);\r\n      batterySoc = parseFloat(socState?.state ?? '0') || 0;\r\n    }\r\n\r\n    // Render\r\n    this._compactRenderer.render({\r\n      grid,\r\n      load,\r\n      production,\r\n      battery,\r\n      flows,\r\n      batterySoc\r\n    });\r\n  }\r\n\r\n}\r\n\r\n// Register custom element (guard against double registration)\r\nconst CARD_TAG = 'energy-flow-card';\r\nif (!customElements.get(CARD_TAG)) {\r\n  customElements.define(CARD_TAG, EnergyFlowCard);\r\n  console.info('[EnergyFlowCard] defined custom element');\r\n} else {\r\n  console.info('[EnergyFlowCard] custom element already defined');\r\n}\r\n\r\n// Register in card picker\r\ndeclare global {\r\n  interface Window {\r\n    customCards: Array<{ type: string; name: string; description: string }>;\r\n  }\r\n}\r\nwindow.customCards = window.customCards || [];\r\nwindow.customCards.push({\r\n  type: \"custom:energy-flow-card\",\r\n  name: \"Energy Flow Card\",\r\n  description: \"A test energy-flow card.\"\r\n});\r\n"],"names":["calculateEnergyFlows","sensors","productionFlow","gridFlow","batteryFlow","loadDemand","flows","remainingProduction","remainingLoad","batteryNeed","getConfigForm","normalizeConfig","config","normalizeEntity","prefix","entityId","normalized","name","icon","min","max","tap","hold","load","grid","production","batteryEntity","soc","invertData","invertView","showPlus","mode","getDisplayName","hass","entityType","fallback","entityConfig","getIcon","handleAction","fireEvent","actionConfig","rawAction","entityToShow","domain","service","updateSegmentVisibility","segment","pixelWidth","hasValue","CompactRenderer","container","viewMode","getIconCallback","handleActionCallback","data","productionSeg","batterySeg","gridSeg","loadValue","batteryProdSeg","batteryLoadSeg","batteryGridSeg","batterySocLeft","batterySocRight","battery","batterySoc","productionValue","batteryToLoad","gridToLoad","total","productionPercent","batteryPercent","gridPercent","sumPercent","visualProductionPercent","visualBatteryPercent","visualGridPercent","scale","batteryGridWatts","batteryLoadWatts","batteryProdWatts","visualBatteryGridPercent","visualBatteryLoadPercent","visualBatteryProdPercent","batteryTotal","batteryGridPercent","batteryProdPercent","chargeSum","batteryToGrid","batteryLoadPercent","dischargeSum","productionSegment","batterySegment","gridSegment","loadValueText","barContainer","label","widthPx","batteryGridSegment","batteryLoadSegment","batteryProdSegment","batterySocTextLeft","batterySocTextRight","batteryBarContainer","gridIsImport","gridColorToUse","Meter","id","value","bidirectional","units","tapAction","fireEventCallback","newValue","valueText","newInvertView","displayValue","valueStr","percentage","angle","range","dimmer","isZero","animate","timestamp","deltaTime","needleLength","mainLerpFactor","ghostLerpFactor","maxLag","needle","needleRad","needleX","needleY","ghostNeedle","ghostRad","ghostX","ghostY","tickMarks","tickValue","tickRad","tickStartR","tickEndR","x1","y1","x2","y2","zeroRad","zeroX1","zeroY1","zeroX2","zeroY2","zeroLine","clipHeight","valueY","unitsY","svgMarkup","element","e","FlowLine","group","flowId","from","to","power","color","speedMultiplier","dotsPerFlow","midX","midY","opacity","strokeWidth","dotRadius","velocity","i","dot","progress","point","minWidth","maxWidth","maxPower","baseDotRadius","maxDotRadius","scaledRadius","baseSpeed","state","callback","FlowRenderer","positions","now","flowLine","flowLayer","threshold","batteryThreshold","existingFlowLine","flowGroup","flow","DefaultRenderer","getDisplayNameCallback","offsetX","offsetY","gridMin","gridMax","loadMax","productionMax","batteryMin","batteryMax","productionMeter","batteryMeter","gridMeter","loadMeter","svg","meter","productionContainer","batteryContainer","gridContainer","loadContainer","meterId","iconContainer","iconSource","iconName","cachedPath","pathData","iconElement","maxAttempts","resolve","attemptExtraction","attempt","delay","timeoutId","shadowRoot","path","circle","createGridLines","chartWidth","chartHeight","margin","lines","y","createTimeLabels","hoursToShow","labels","hoursAgo","time","currentMinutes","quantizedMinutes","hourAdjust","x","hours","hours12","ampm","createYAxisLabels","supplyHeight","demandHeight","maxSupply","maxDemand","zeroLineY","createAreaPath","dataPoints","xStep","centerY","yScale","valueGetter","baseValueGetter","direction","points","basePoints","hasData","d","baseValue","yOffset","baseYOffset","createLoadLine","ChartRenderer","values","timeSinceLastUpdate","minUpdateInterval","svgElement","loading","iconConfigKey","entityConfigKey","configIcon","entityIcon","cacheAge","cacheMaxAge","end","start","productionHistory","gridHistory","loadHistory","batteryHistory","processChart","error","url","response","totalRange","supplyRatio","demandRatio","width","height","supplyScale","demandScale","supplyPaths","demandPaths","loadLine","chartContent","totalRawPoints","totalVisiblePoints","rawPointsPerVisibleTick","endMinutes","chunkSize","rawDataPoints","chunkStart","chunkEnd","visibleTime","startIdx","endIdx","windowSize","solarSum","batteryDischargeSum","batteryChargeSum","gridImportSum","gridExportSum","loadSum","j","svgContent","history","targetTime","closestPoint","minDiff","diff","type","totalPoints","solarPath","batteryPath","gridPath","batteryChargePath","gridExportPath","loadIcon","solarIcon","batteryIcon","gridIcon","iconTypes","iconPaths","iconSourceFO","haIconDiv","haSvgIcon","pathElement","indicatorsGroup","isFirstRender","source","currentValues","rightX","loadY","solarY","batteryDischargeY","gridImportY","batteryChargeY","gridExportY","formatValue","updateIndicator","iconType","shouldShow","entity","iconPath","text","existingLoadLine","pathMatch","solarArea","batteryDischargeArea","batteryChargeArea","gridImportArea","gridExportArea","EnergyFlowCard","context","gridState","loadState","productionState","batteryState","chartConfig","detail","event","action","socState","CARD_TAG"],"mappings":"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"}